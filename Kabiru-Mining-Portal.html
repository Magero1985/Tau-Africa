<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>KABIRU Mining App</title>
    
    <!-- Firebase SDK v9 -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/firebase/9.23.0/firebase-app-compat.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/firebase/9.23.0/firebase-auth-compat.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/firebase/9.23.0/firebase-firestore-compat.min.js"></script>
    
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: 'Arial', sans-serif;
            background: linear-gradient(135deg, #1a1a2e 0%, #16213e 50%, #0f3460 100%);
            background-attachment: fixed;
            min-height: 100vh;
            color: white;
            overflow-x: hidden;
        }

        .login-page {
            display: flex;
            align-items: center;
            justify-content: center;
            padding: 20px;
            min-height: 100vh;
        }

        .auth-container {
            background: rgba(255, 255, 255, 0.1);
            backdrop-filter: blur(10px);
            border-radius: 20px;
            padding: 40px 30px;
            border: 1px solid rgba(255, 255, 255, 0.2);
            box-shadow: 0 15px 50px rgba(0, 0, 0, 0.3);
            width: 100%;
            max-width: 400px;
            animation: fadeInUp 0.8s ease-out;
        }

        .auth-logo {
            text-align: center;
            margin-bottom: 30px;
        }

        .auth-logo-img {
            width: 80px;
            height: 80px;
            background: linear-gradient(45deg, #FFD700, #FFA500);
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 16px;
            font-weight: bold;
            color: #333;
            box-shadow: 0 8px 25px rgba(255, 215, 0, 0.3);
            animation: pulse 2s infinite;
            border: 2px solid #FFD700;
            margin: 0 auto 15px;
        }

        .auth-title {
            font-size: 28px;
            font-weight: bold;
            color: #FFD700;
            text-shadow: 2px 2px 4px rgba(0, 0, 0, 0.3);
            margin-bottom: 8px;
        }

        .auth-subtitle {
            font-size: 14px;
            opacity: 0.8;
            margin-bottom: 20px;
        }

        .form-group {
            margin-bottom: 20px;
            position: relative;
        }

        .form-label {
            display: block;
            margin-bottom: 8px;
            font-size: 14px;
            color: #FFD700;
            font-weight: 500;
        }

        .form-input {
            width: 100%;
            padding: 15px;
            border: 1px solid rgba(255, 255, 255, 0.3);
            border-radius: 12px;
            background: rgba(255, 255, 255, 0.1);
            color: white;
            font-size: 16px;
            outline: none;
            transition: all 0.3s ease;
        }

        .form-input:focus {
            border-color: #FFD700;
            background: rgba(255, 255, 255, 0.15);
            box-shadow: 0 0 15px rgba(255, 215, 0, 0.2);
        }

        .form-input::placeholder {
            color: rgba(255, 255, 255, 0.6);
        }

        .auth-button {
            width: 100%;
            padding: 15px;
            background: linear-gradient(45deg, #FFD700, #FFA500);
            border: none;
            border-radius: 12px;
            color: #333;
            font-size: 16px;
            font-weight: bold;
            cursor: pointer;
            transition: all 0.3s ease;
            margin-bottom: 15px;
            text-transform: uppercase;
            letter-spacing: 0.5px;
        }

        .auth-button:hover {
            transform: translateY(-2px);
            box-shadow: 0 8px 25px rgba(255, 215, 0, 0.4);
        }

        .auth-button:disabled {
            opacity: 0.6;
            cursor: not-allowed;
            transform: none;
        }

        .auth-toggle {
            text-align: center;
            margin-top: 20px;
            font-size: 14px;
        }

        .auth-toggle-link {
            color: #FFD700;
            cursor: pointer;
            text-decoration: underline;
            transition: all 0.3s ease;
        }

        .auth-toggle-link:hover {
            opacity: 0.8;
        }

        .success-message, .error-message {
            padding: 15px;
            border-radius: 10px;
            margin-bottom: 20px;
            text-align: center;
            display: none;
        }

        .success-message {
            background: rgba(0, 255, 135, 0.1);
            border: 1px solid rgba(0, 255, 135, 0.3);
            color: #00ff87;
        }

        .error-message {
            background: rgba(255, 107, 107, 0.1);
            border: 1px solid rgba(255, 107, 107, 0.3);
            color: #ff6b6b;
        }

        .mining-app {
            display: none;
            min-height: 100vh;
            padding: 20px;
        }

        .app-header {
            text-align: center;
            margin-bottom: 30px;
        }

        .balance-display {
            background: rgba(255, 255, 255, 0.1);
            backdrop-filter: blur(10px);
            border-radius: 20px;
            padding: 30px;
            text-align: center;
            margin-bottom: 30px;
        }

        .balance-amount {
            font-size: 36px;
            font-weight: bold;
            color: #FFD700;
            margin: 15px 0;
        }

        .logout-btn {
            background: rgba(255, 107, 107, 0.2);
            border: 1px solid rgba(255, 107, 107, 0.5);
            color: white;
            padding: 10px 20px;
            border-radius: 10px;
            cursor: pointer;
            margin-top: 20px;
        }

        .stats-grid {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 15px;
            margin: 20px 0;
            max-width: 600px;
            margin-left: auto;
            margin-right: auto;
        }

        .stat-card {
            background: rgba(255, 255, 255, 0.1);
            backdrop-filter: blur(10px);
            padding: 20px;
            border-radius: 15px;
            text-align: center;
            border: 1px solid rgba(255, 255, 255, 0.2);
        }

        .stat-label {
            font-size: 12px;
            opacity: 0.7;
            text-transform: uppercase;
            letter-spacing: 1px;
            margin-bottom: 8px;
        }

        .stat-value {
            font-size: 20px;
            font-weight: bold;
            color: #FFD700;
        }

        .wallet-section {
            background: rgba(255, 255, 255, 0.1);
            backdrop-filter: blur(10px);
            padding: 20px;
            border-radius: 15px;
            margin: 20px auto;
            max-width: 600px;
            border: 1px solid rgba(255, 255, 255, 0.2);
        }

        .wallet-address {
            background: rgba(0, 0, 0, 0.3);
            padding: 12px;
            border-radius: 8px;
            font-size: 11px;
            word-break: break-all;
            margin: 10px 0;
            color: #00ff87;
        }

        .modal {
            display: none;
            position: fixed;
            z-index: 1000;
            left: 0;
            top: 0;
            width: 100%;
            height: 100%;
            background-color: rgba(0, 0, 0, 0.8);
            overflow-y: auto;
        }

        .modal-content {
            background: rgba(255, 255, 255, 0.1);
            backdrop-filter: blur(10px);
            margin: 5% auto;
            padding: 30px;
            border-radius: 20px;
            width: 90%;
            max-width: 500px;
            border: 1px solid rgba(255, 255, 255, 0.2);
            animation: fadeInUp 0.3s ease-out;
            max-height: 90vh;
            overflow-y: auto;
        }

        .modal-title {
            color: #FFD700;
            font-size: 22px;
            font-weight: bold;
            margin-bottom: 20px;
            text-align: center;
        }

        .close {
            color: #aaa;
            float: right;
            font-size: 28px;
            font-weight: bold;
            cursor: pointer;
            line-height: 1;
        }

        .close:hover {
            color: #FFD700;
        }

        .action-button {
            background: linear-gradient(45deg, #667eea, #764ba2);
            border: none;
            padding: 15px 20px;
            border-radius: 12px;
            color: white;
            font-size: 14px;
            font-weight: bold;
            cursor: pointer;
            transition: all 0.3s ease;
            margin: 10px 5px;
            width: calc(100% - 10px);
        }

        .action-button:hover {
            transform: translateY(-2px);
            box-shadow: 0 8px 25px rgba(102, 126, 234, 0.4);
        }

        .action-button:disabled {
            opacity: 0.5;
            cursor: not-allowed;
            transform: none;
        }

        .member-status {
            background: rgba(255, 215, 0, 0.1);
            border: 1px solid rgba(255, 215, 0, 0.3);
            padding: 15px;
            border-radius: 10px;
            margin: 15px 0;
        }

        .status-verified {
            color: #00ff87;
        }

        .status-pending {
            color: #FFA500;
        }

        .notification {
            position: fixed;
            top: 20px;
            left: 50%;
            transform: translateX(-50%);
            background: rgba(0, 0, 0, 0.9);
            color: white;
            padding: 15px 25px;
            border-radius: 25px;
            font-size: 14px;
            opacity: 0;
            transition: opacity 0.3s ease;
            z-index: 10000;
            max-width: 90%;
            text-align: center;
        }

        .notification.show {
            opacity: 1;
        }

        .mining-section {
            background: rgba(255, 255, 255, 0.1);
            backdrop-filter: blur(10px);
            padding: 20px;
            border-radius: 15px;
            margin: 20px auto;
            max-width: 600px;
            border: 1px solid rgba(255, 255, 255, 0.2);
        }

        .mining-tiers {
            display: grid;
            grid-template-columns: repeat(3, 1fr);
            gap: 10px;
            margin: 20px 0;
        }

        .tier-card {
            background: rgba(255, 255, 255, 0.1);
            border: 2px solid rgba(255, 255, 255, 0.2);
            border-radius: 12px;
            padding: 15px 10px;
            text-align: center;
            cursor: pointer;
            transition: all 0.3s ease;
        }

        .tier-card:hover {
            transform: translateY(-3px);
            border-color: #FFD700;
            box-shadow: 0 5px 15px rgba(255, 215, 0, 0.3);
        }

        .tier-card.locked {
            opacity: 0.5;
            cursor: not-allowed;
        }

        .tier-card.active-mining {
            border-color: #00ff87;
            background: rgba(0, 255, 135, 0.1);
            animation: pulse 2s infinite;
        }

        .tier-level {
            font-size: 11px;
            font-weight: bold;
            color: #FFD700;
            margin-bottom: 5px;
        }

        .tier-name {
            font-size: 13px;
            font-weight: bold;
            margin-bottom: 5px;
        }

        .tier-rate {
            font-size: 10px;
            opacity: 0.8;
        }

        .mining-progress {
            background: rgba(0, 0, 0, 0.3);
            border-radius: 10px;
            height: 20px;
            margin: 15px 0;
            overflow: hidden;
            position: relative;
        }

        .mining-progress-bar {
            height: 100%;
            background: linear-gradient(90deg, #FFD700, #FFA500);
            width: 0%;
            transition: width 0.5s linear;
            border-radius: 10px;
        }

        .mining-progress-text {
            position: absolute;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            font-size: 11px;
            font-weight: bold;
            color: white;
            text-shadow: 1px 1px 2px rgba(0,0,0,0.8);
        }

        .mining-status {
            text-align: center;
            padding: 15px;
            background: rgba(255, 215, 0, 0.1);
            border-radius: 10px;
            margin: 15px 0;
        }

        .mining-timer {
            font-size: 18px;
            font-weight: bold;
            color: #00ff87;
            margin: 5px 0;
        }

        .value-declaration {
            background: rgba(255, 165, 0, 0.1);
            border: 1px solid rgba(255, 165, 0, 0.3);
            padding: 15px;
            border-radius: 10px;
            margin: 15px 0;
        }

        .referral-section {
            background: rgba(102, 126, 234, 0.1);
            border: 1px solid rgba(102, 126, 234, 0.3);
            padding: 20px;
            border-radius: 15px;
            margin: 20px auto;
            max-width: 600px;
        }

        .referral-link-box {
            background: rgba(0, 0, 0, 0.3);
            padding: 12px;
            border-radius: 8px;
            font-size: 11px;
            word-break: break-all;
            margin: 10px 0;
            color: #667eea;
            cursor: pointer;
            transition: all 0.3s ease;
        }

        .referral-link-box:hover {
            background: rgba(0, 0, 0, 0.4);
        }

        .share-buttons {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 10px;
            margin-top: 15px;
        }

        .share-btn {
            padding: 10px;
            border-radius: 8px;
            border: none;
            font-size: 12px;
            font-weight: bold;
            cursor: pointer;
            transition: all 0.3s ease;
        }

        .share-btn.copy {
            background: linear-gradient(45deg, #00ff87, #60efff);
            color: #333;
        }

        .share-btn.share {
            background: linear-gradient(45deg, #667eea, #764ba2);
            color: white;
        }

        .share-btn:hover {
            transform: translateY(-2px);
            box-shadow: 0 5px 15px rgba(0, 0, 0, 0.3);
        }

        .referral-stats {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 10px;
            margin: 15px 0;
        }

        .referral-stat-card {
            background: rgba(255, 255, 255, 0.05);
            padding: 15px;
            border-radius: 10px;
            text-align: center;
        }

        .referral-stat-value {
            font-size: 20px;
            font-weight: bold;
            color: #FFD700;
            margin-bottom: 5px;
        }

        .referral-stat-label {
            font-size: 11px;
            opacity: 0.8;
        }

        .transaction-section {
            background: rgba(255, 255, 255, 0.1);
            backdrop-filter: blur(10px);
            padding: 20px;
            border-radius: 15px;
            margin: 20px auto;
            max-width: 600px;
            border: 1px solid rgba(255, 255, 255, 0.2);
        }

        .transaction-buttons {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 15px;
            margin: 20px 0;
        }

        .transaction-btn {
            padding: 15px;
            border-radius: 12px;
            border: none;
            font-size: 14px;
            font-weight: bold;
            cursor: pointer;
            transition: all 0.3s ease;
            text-align: center;
        }

        .transaction-btn.send {
            background: linear-gradient(45deg, #ff6b6b, #ffa726);
            color: white;
        }

        .transaction-btn.receive {
            background: linear-gradient(45deg, #00ff87, #60efff);
            color: #333;
        }

        .transaction-btn:hover {
            transform: translateY(-2px);
            box-shadow: 0 8px 25px rgba(0, 0, 0, 0.3);
        }

        .transaction-list {
            max-height: 400px;
            overflow-y: auto;
            margin-top: 15px;
        }

        .transaction-item {
            background: rgba(255, 255, 255, 0.05);
            padding: 12px;
            border-radius: 8px;
            margin-bottom: 8px;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .transaction-icon {
            font-size: 20px;
            margin-right: 10px;
        }

        .transaction-details {
            flex: 1;
        }

        .transaction-amount {
            font-size: 14px;
            font-weight: bold;
        }

        .transaction-amount.positive {
            color: #00ff87;
        }

        .transaction-amount.negative {
            color: #ff6b6b;
        }

        .reserve-section {
            background: rgba(255, 165, 0, 0.1);
            border: 1px solid rgba(255, 165, 0, 0.3);
            padding: 20px;
            border-radius: 15px;
            margin: 20px auto;
            max-width: 600px;
        }

        .lockup-options {
            display: grid;
            grid-template-columns: repeat(3, 1fr);
            gap: 10px;
            margin: 15px 0;
        }

        .lockup-card {
            background: rgba(255, 107, 107, 0.1);
            border: 2px solid rgba(255, 107, 107, 0.3);
            padding: 15px 10px;
            border-radius: 10px;
            text-align: center;
            cursor: pointer;
            transition: all 0.3s ease;
        }

        .lockup-card:hover {
            transform: translateY(-3px);
            border-color: #FFD700;
            box-shadow: 0 5px 15px rgba(255, 215, 0, 0.3);
        }

        .lockup-duration {
            font-size: 16px;
            font-weight: bold;
            color: #FFD700;
            margin-bottom: 5px;
        }

        .lockup-bonus {
            font-size: 12px;
            color: #00ff87;
            font-weight: bold;
        }

        .reserve-info {
            background: rgba(255, 255, 255, 0.05);
            padding: 15px;
            border-radius: 10px;
            margin: 15px 0;
        }

        .reserve-balance {
            font-size: 24px;
            font-weight: bold;
            color: #FFA500;
            text-align: center;
            margin: 10px 0;
        }

        @keyframes fadeInUp {
            from { opacity: 0; transform: translateY(30px); }
            to { opacity: 1; transform: translateY(0); }
        }

        @keyframes pulse {
            0% { transform: scale(1); }
            50% { transform: scale(1.05); }
            100% { transform: scale(1); }
        }
    </style>
</head>
<body>
    <!-- Login Page -->
    <div id="loginPage" class="login-page">
        <div class="auth-container">
            <div class="auth-logo">
                <div class="auth-logo-img">iKb</div>
                <div class="auth-title">KABIRU</div>
                <div class="auth-subtitle">Secure Login Portal</div>
            </div>

            <div id="errorMessage" class="error-message">
                <div id="errorText">Something went wrong</div>
            </div>

            <div id="successMessage" class="success-message">
                <div id="successText">Success!</div>
            </div>

            <!-- Login Form -->
            <div id="loginContainer">
                <div class="form-group">
                    <label class="form-label">Email</label>
                    <input type="email" class="form-input" id="loginEmail" placeholder="Enter your email">
                </div>
                <div class="form-group">
                    <label class="form-label">Password</label>
                    <input type="password" class="form-input" id="loginPassword" placeholder="Enter your password">
                </div>
                <button type="button" class="auth-button" id="loginBtn">Sign In</button>
                
                <div class="auth-toggle">
                    Don't have an account? <span class="auth-toggle-link" id="showSignupLink">Sign Up</span>
                </div>
            </div>

            <!-- Signup Form -->
            <div id="signupContainer" style="display: none;">
                <div class="form-group">
                    <label class="form-label">Full Name</label>
                    <input type="text" class="form-input" id="signupName" placeholder="Enter your full name">
                </div>
                <div class="form-group">
                    <label class="form-label">Email</label>
                    <input type="email" class="form-input" id="signupEmail" placeholder="Enter your email">
                </div>
                <div class="form-group">
                    <label class="form-label">Password</label>
                    <input type="password" class="form-input" id="signupPassword" placeholder="Create a password (min 6 chars)">
                </div>
                <div class="form-group">
                    <label class="form-label">Confirm Password</label>
                    <input type="password" class="form-input" id="confirmPassword" placeholder="Confirm your password">
                </div>
                <button type="button" class="auth-button" id="signupBtn">Create Account</button>
                
                <div class="auth-toggle">
                    Already have an account? <span class="auth-toggle-link" id="showLoginLink">Sign In</span>
                </div>
            </div>
        </div>
    </div>

    <!-- Mining App -->
    <div id="miningApp" class="mining-app">
        <div class="app-header">
            <div class="auth-logo-img" style="margin: 0 auto 20px;">iKb</div>
            <h1 style="color: #FFD700;">KABIRU Mining</h1>
        </div>
        
        <div class="balance-display">
            <div style="font-size: 14px; opacity: 0.8; margin-bottom: 10px;">Your Balance</div>
            <div class="balance-amount" id="userBalance">0.0000 iKb</div>
            <div style="font-size: 14px; opacity: 0.7;">Welcome, <span id="userName">User</span></div>
            <div style="font-size: 12px; opacity: 0.6; margin-top: 5px;"><span id="userEmail">user@example.com</span></div>
        </div>

        <!-- Balance Breakdown -->
        <div class="stats-grid">
            <div class="stat-card">
                <div class="stat-label">Mined</div>
                <div class="stat-value" id="minedBalance">0.0000 iKb</div>
            </div>
            <div class="stat-card">
                <div class="stat-label">Received</div>
                <div class="stat-value" id="receivedBalance">0.0000 iKb</div>
            </div>
            <div class="stat-card">
                <div class="stat-label">Reserved</div>
                <div class="stat-value" id="reserveBalance">0.0000 iKb</div>
            </div>
            <div class="stat-card">
                <div class="stat-label">Locked</div>
                <div class="stat-value" id="lockedBalance">0.0000 iKb</div>
            </div>
        </div>

        <!-- Wallet Section -->
        <div class="wallet-section">
            <div style="font-size: 14px; font-weight: bold; color: #FFD700; margin-bottom: 10px;">üíº Your Wallet Address</div>
            <div class="wallet-address" id="walletAddress">Loading...</div>
            <div style="font-size: 11px; opacity: 0.7; margin-top: 10px;">
                üîê Referral Code: <span style="color: #FFD700; font-weight: bold;" id="referralCode">KABIRU_XXXXX</span>
            </div>
        </div>

        <!-- TAU Member Status -->
        <div class="member-status" id="memberStatus">
            <div style="font-size: 14px; font-weight: bold; margin-bottom: 10px;">üéØ TAU Africa Member Status</div>
            <div id="memberStatusText" class="status-pending">‚ö†Ô∏è Not Linked - Link your TAU Member ID to start mining!</div>
            <button class="action-button" id="linkMemberIdBtn" style="margin-top: 10px;">üîó Link TAU Member ID</button>
        </div>

        <!-- Mining Section -->
        <div class="mining-section">
            <div style="font-size: 16px; font-weight: bold; color: #FFD700; margin-bottom: 15px; text-align: center;">
                ‚õèÔ∏è KABIRU Mining
            </div>

            <!-- Value Declaration Warning -->
            <div class="value-declaration" id="declarationWarning" style="display: none;">
                <div style="font-size: 12px; font-weight: bold; color: #FFA500; margin-bottom: 8px;">
                    ‚ö†Ô∏è Value Declaration Required
                </div>
                <div style="font-size: 11px; line-height: 1.5;">
                    Declare your values to activate mining for 30 days
                </div>
                <button class="action-button" onclick="openValueDeclarationModal()" style="margin-top: 10px; font-size: 12px; padding: 10px;">
                    üìù Declare Values Now
                </button>
            </div>

            <!-- Mining Status -->
            <div class="mining-status" id="miningStatus">
                <div style="font-size: 12px; opacity: 0.8; margin-bottom: 5px;">Mining Status</div>
                <div id="statusText" style="font-size: 14px; font-weight: bold; color: #FFD700;">Ready to Mine</div>
                <div class="mining-timer" id="miningTimer">--:--:--</div>
            </div>

            <!-- Mining Progress Bar -->
            <div class="mining-progress" id="miningProgressContainer" style="display: none;">
                <div class="mining-progress-bar" id="miningProgressBar"></div>
                <div class="mining-progress-text" id="miningProgressText">0%</div>
            </div>

            <!-- Mining Tiers -->
            <div class="mining-tiers">
                <div class="tier-card" id="basicTier" onclick="startMiningSession('basic')">
                    <div class="tier-level">LEVEL I</div>
                    <div class="tier-name">Basic</div>
                    <div class="tier-rate">0.005 iKb/day</div>
                </div>
                <div class="tier-card" id="communityTier" onclick="startMiningSession('community')">
                    <div class="tier-level">LEVEL II</div>
                    <div class="tier-name">Community</div>
                    <div class="tier-rate">0.01 iKb/day</div>
                </div>
                <div class="tier-card" id="sovereignTier" onclick="startMiningSession('sovereign')">
                    <div class="tier-level">LEVEL III</div>
                    <div class="tier-name">Sovereign</div>
                    <div class="tier-rate">0.1 iKb/day</div>
                </div>
            </div>

            <div style="font-size: 11px; opacity: 0.7; text-align: center; margin-top: 10px;">
                üí° Each mining session lasts 24 hours
            </div>
        </div>

        <!-- Referral Section -->
        <div class="referral-section">
            <div style="font-size: 16px; font-weight: bold; color: #667eea; margin-bottom: 15px; text-align: center;">
                üéÅ Referral Program
            </div>

            <div style="font-size: 12px; line-height: 1.6; margin-bottom: 15px; text-align: center; opacity: 0.9;">
                Invite friends and earn <strong style="color: #FFD700;">10% of their mining rewards</strong> + bonus for each signup!
            </div>

            <!-- Referral Stats -->
            <div class="referral-stats">
                <div class="referral-stat-card">
                    <div class="referral-stat-value" id="totalReferrals">0</div>
                    <div class="referral-stat-label">Total Referrals</div>
                </div>
                <div class="referral-stat-card">
                    <div class="referral-stat-value" id="totalReferralEarnings">0.0000 iKb</div>
                    <div class="referral-stat-label">Total Earned</div>
                </div>
            </div>

            <!-- Referral Link -->
            <div style="margin: 15px 0;">
                <div style="font-size: 12px; font-weight: bold; color: #667eea; margin-bottom: 8px;">
                    üìã Your Referral Link
                </div>
                <div class="referral-link-box" id="referralLinkBox" onclick="copyReferralLink()">
                    <div id="referralLink">Loading...</div>
                </div>
                <div style="font-size: 10px; opacity: 0.7; text-align: center; margin-top: 5px;">
                    Click to copy
                </div>
            </div>

            <!-- Share Buttons -->
            <div class="share-buttons">
                <button class="share-btn copy" onclick="copyReferralLink()">
                    üìã Copy Link
                </button>
                <button class="share-btn share" onclick="shareReferralLink()">
                    üì± Share Link
                </button>
            </div>

            <!-- View Earnings Button -->
            <button class="action-button" onclick="viewReferralEarnings()" style="margin-top: 15px; font-size: 12px; padding: 10px;">
                üìä View Referral Earnings
            </button>

            <div style="font-size: 10px; opacity: 0.7; text-align: center; margin-top: 15px; line-height: 1.5;">
                üéØ <strong>Welcome Bonus:</strong> New users get 0.01 iKb<br>
                üí∞ <strong>Signup Bonus:</strong> You get 0.005 iKb per referral<br>
                ‚õèÔ∏è <strong>Mining Bonus:</strong> Earn 10% of their mining forever
            </div>
        </div>

        <!-- Send/Receive Section -->
        <div class="transaction-section">
            <div style="font-size: 16px; font-weight: bold; color: #FFD700; margin-bottom: 15px; text-align: center;">
                üí∏ Send & Receive iKb
            </div>

            <div class="transaction-buttons">
                <button class="transaction-btn send" onclick="openSendModal()">
                    üì§ Send iKb
                </button>
                <button class="transaction-btn receive" onclick="openReceiveModal()">
                    üì• Receive iKb
                </button>
            </div>

            <div style="text-align: center; margin: 15px 0;">
                <button class="action-button" onclick="viewTransactionHistory()" style="font-size: 12px; padding: 10px;">
                    üìä View Transaction History
                </button>
            </div>

            <div style="font-size: 10px; opacity: 0.7; text-align: center; line-height: 1.5;">
                üí° Transaction fee: 0.0001 iKb per transfer
            </div>
        </div>

        <!-- Reserve & Lockup Section -->
        <div class="reserve-section">
            <div style="font-size: 16px; font-weight: bold; color: #FFA500; margin-bottom: 15px; text-align: center;">
                üîê Reserve & Lockup
            </div>

            <!-- Reserve Balance -->
            <div class="reserve-info">
                <div style="font-size: 12px; opacity: 0.8; text-align: center; margin-bottom: 8px;">
                    Reserve Balance (2% annual interest)
                </div>
                <div class="reserve-balance" id="reserveBalanceDisplay">0.0000 iKb</div>
            </div>

            <!-- Reserve Actions -->
            <div class="transaction-buttons">
                <button class="transaction-btn" style="background: linear-gradient(45deg, #FFA500, #FF8C00);" onclick="openAddToReserveModal()">
                    üíé Add to Reserve
                </button>
                <button class="transaction-btn" style="background: linear-gradient(45deg, #667eea, #764ba2);" onclick="openWithdrawReserveModal()">
                    üí∞ Withdraw Reserve
                </button>
            </div>

            <!-- Lockup Options -->
            <div style="margin-top: 25px;">
                <div style="font-size: 14px; font-weight: bold; color: #ff6b6b; margin-bottom: 10px; text-align: center;">
                    üîí Lockup Options (Earn Bonus!)
                </div>
                
                <div class="lockup-options">
                    <div class="lockup-card" onclick="openLockupModal(3, 0.05)">
                        <div class="lockup-duration">3 Months</div>
                        <div class="lockup-bonus">+5% Bonus</div>
                    </div>
                    <div class="lockup-card" onclick="openLockupModal(6, 0.12)">
                        <div class="lockup-duration">6 Months</div>
                        <div class="lockup-bonus">+12% Bonus</div>
                    </div>
                    <div class="lockup-card" onclick="openLockupModal(12, 0.25)">
                        <div class="lockup-duration">12 Months</div>
                        <div class="lockup-bonus">+25% Bonus</div>
                    </div>
                </div>

                <div style="font-size: 11px; opacity: 0.7; text-align: center; margin-top: 15px;">
                    üí° Lock tokens to earn instant bonus + secure your investment
                </div>
            </div>

            <!-- Locked Balance Display -->
            <div style="background: rgba(255, 107, 107, 0.1); padding: 12px; border-radius: 8px; margin-top: 15px; text-align: center; border: 1px solid rgba(255, 107, 107, 0.3);">
                <div style="font-size: 11px; opacity: 0.8;">Currently Locked</div>
                <div style="font-size: 18px; font-weight: bold; color: #ff6b6b;" id="lockedBalanceDisplay">0.0000 iKb</div>
            </div>

            <button class="action-button" onclick="viewLockupPeriods()" style="margin-top: 15px; font-size: 12px; padding: 10px;">
                üìä View Active Lockups
            </button>
        </div>

        <div style="text-align: center;">
            <button class="logout-btn" id="logoutBtn">Logout</button>
        </div>
    </div>

    <!-- Add to Reserve Modal -->
    <div id="addToReserveModal" class="modal">
        <div class="modal-content">
            <span class="close" onclick="closeModal('addToReserveModal')">&times;</span>
            <h2 class="modal-title">üíé Add to Reserve</h2>
            <div style="margin-bottom: 20px;">
                <div style="background: rgba(255, 165, 0, 0.1); padding: 15px; border-radius: 10px; margin-bottom: 15px; border: 1px solid rgba(255, 165, 0, 0.3);">
                    
                    <div style="font-size: 12px; line-height: 1.6; margin-bottom: 15px;">
                        Reserve tokens earn <strong style="color: #00ff87;">2% annual interest</strong> and can be withdrawn anytime.
                    </div>

                    <div style="background: rgba(255, 255, 255, 0.05); padding: 10px; border-radius: 8px; margin: 10px 0;">
                        <div style="font-size: 11px; margin-bottom: 5px;">Available Balance:</div>
                        <div style="font-size: 18px; font-weight: bold; color: #FFD700;" id="addReserveAvailable">0.0000 iKb</div>
                    </div>
                    
                    <div style="margin: 15px 0;">
                        <label class="form-label">Amount to Reserve</label>
                        <input type="number" id="reserveAmount" class="form-input" placeholder="0.0000" step="0.0001" min="0.0001">
                    </div>
                    
                    <button class="auth-button" onclick="addToReserve()" style="background: linear-gradient(45deg, #FFA500, #FF8C00);">
                        üíé Add to Reserve
                    </button>
                </div>
            </div>
        </div>
    </div>

    <!-- Withdraw from Reserve Modal -->
    <div id="withdrawReserveModal" class="modal">
        <div class="modal-content">
            <span class="close" onclick="closeModal('withdrawReserveModal')">&times;</span>
            <h2 class="modal-title">üí∞ Withdraw from Reserve</h2>
            <div style="margin-bottom: 20px;">
                <div style="background: rgba(102, 126, 234, 0.1); padding: 15px; border-radius: 10px; margin-bottom: 15px; border: 1px solid rgba(102, 126, 234, 0.3);">
                    
                    <div style="background: rgba(255, 255, 255, 0.05); padding: 10px; border-radius: 8px; margin: 10px 0;">
                        <div style="font-size: 11px; margin-bottom: 5px;">Reserve Balance:</div>
                        <div style="font-size: 18px; font-weight: bold; color: #FFA500;" id="withdrawReserveAvailable">0.0000 iKb</div>
                    </div>
                    
                    <div style="margin: 15px 0;">
                        <label class="form-label">Amount to Withdraw</label>
                        <input type="number" id="withdrawReserveAmount" class="form-input" placeholder="0.0000" step="0.0001" min="0.0001">
                    </div>
                    
                    <button class="auth-button" onclick="withdrawFromReserve()">
                        üí∞ Withdraw to Available Balance
                    </button>
                </div>
            </div>
        </div>
    </div>

    <!-- Lockup Modal -->
    <div id="lockupModal" class="modal">
        <div class="modal-content">
            <span class="close" onclick="closeModal('lockupModal')">&times;</span>
            <h2 class="modal-title">üîí Lock Tokens</h2>
            <div style="margin-bottom: 20px;">
                <div style="background: rgba(255, 107, 107, 0.1); padding: 15px; border-radius: 10px; margin-bottom: 15px; border: 1px solid rgba(255, 107, 107, 0.3);">
                    
                    <div style="text-align: center; margin-bottom: 15px;">
                        <div style="font-size: 24px; font-weight: bold; color: #FFD700;" id="lockupDurationText">3 Months</div>
                        <div style="font-size: 16px; color: #00ff87; font-weight: bold;" id="lockupBonusText">+5% Instant Bonus</div>
                    </div>

                    <div style="background: rgba(255, 255, 255, 0.05); padding: 10px; border-radius: 8px; margin: 10px 0;">
                        <div style="font-size: 11px; margin-bottom: 5px;">Available Balance:</div>
                        <div style="font-size: 18px; font-weight: bold; color: #FFD700;" id="lockupAvailable">0.0000 iKb</div>
                    </div>
                    
                    <div style="margin: 15px 0;">
                        <label class="form-label">Amount to Lock</label>
                        <input type="number" id="lockupAmount" class="form-input" placeholder="0.0000" step="0.0001" min="0.0001" oninput="calculateLockupBonus()">
                    </div>

                    <div style="background: rgba(0, 255, 135, 0.1); padding: 12px; border-radius: 8px; margin: 15px 0; border: 1px solid rgba(0, 255, 135, 0.3);">
                        <div style="display: flex; justify-content: space-between; margin-bottom: 5px;">
                            <span style="font-size: 11px;">Amount to Lock:</span>
                            <span style="font-size: 12px; font-weight: bold;" id="lockupAmountDisplay">0.0000 iKb</span>
                        </div>
                        <div style="display: flex; justify-content: space-between; margin-bottom: 5px;">
                            <span style="font-size: 11px;">Instant Bonus:</span>
                            <span style="font-size: 12px; font-weight: bold; color: #00ff87;" id="lockupBonusDisplay">0.0000 iKb</span>
                        </div>
                        <div style="display: flex; justify-content: space-between; padding-top: 8px; border-top: 1px solid rgba(255,255,255,0.1);">
                            <span style="font-size: 12px; font-weight: bold;">Total Locked:</span>
                            <span style="font-size: 14px; font-weight: bold; color: #FFD700;" id="lockupTotalDisplay">0.0000 iKb</span>
                        </div>
                    </div>

                    <div style="font-size: 11px; opacity: 0.8; text-align: center; margin: 10px 0; line-height: 1.5;">
                        üîì Unlock Date: <strong style="color: #FFD700;" id="lockupUnlockDate">--</strong>
                    </div>
                    
                    <button class="auth-button" onclick="executeLockup()" style="background: linear-gradient(45deg, #ff6b6b, #ffa726);">
                        üîí Lock Tokens
                    </button>
                </div>
            </div>
        </div>
    </div>

    <!-- Active Lockups Modal -->
    <div id="lockupsModal" class="modal">
        <div class="modal-content">
            <span class="close" onclick="closeModal('lockupsModal')">&times;</span>
            <h2 class="modal-title">üìä Active Lockups</h2>
            <div id="lockupsContent" style="margin-bottom: 20px;">
                <div style="text-align: center; padding: 20px;">
                    <div style="font-size: 14px; opacity: 0.7;">Loading...</div>
                </div>
            </div>
        </div>
    </div>

    <!-- Send iKb Modal -->
    <div id="sendModal" class="modal">
        <div class="modal-content">
            <span class="close" onclick="closeModal('sendModal')">&times;</span>
            <h2 class="modal-title">üì§ Send KABIRU</h2>
            <div style="margin-bottom: 20px;">
                <div style="background: rgba(255, 107, 107, 0.1); padding: 15px; border-radius: 10px; margin-bottom: 15px; border: 1px solid rgba(255, 107, 107, 0.3);">
                    
                    <div style="margin: 15px 0;">
                        <label class="form-label">Recipient Email Address</label>
                        <input type="email" id="sendRecipient" class="form-input" placeholder="recipient@example.com">
                    </div>
                    
                    <div style="margin: 15px 0;">
                        <label class="form-label">Amount (iKb)</label>
                        <input type="number" id="sendAmount" class="form-input" placeholder="0.0000" step="0.0001" min="0.0001">
                    </div>
                    
                    <div style="background: rgba(255, 255, 255, 0.05); padding: 10px; border-radius: 8px; margin: 10px 0;">
                        <div style="font-size: 11px; display: flex; justify-content: space-between; margin-bottom: 5px;">
                            <span>Available Balance:</span>
                            <span style="color: #FFD700; font-weight: bold;" id="sendAvailableBalance">0.0000 iKb</span>
                        </div>
                        <div style="font-size: 11px; display: flex; justify-content: space-between; margin-bottom: 5px;">
                            <span>Transaction Fee:</span>
                            <span style="color: #FFA500;">0.0001 iKb</span>
                        </div>
                        <div style="font-size: 12px; display: flex; justify-content: space-between; margin-top: 8px; padding-top: 8px; border-top: 1px solid rgba(255,255,255,0.1);">
                            <span style="font-weight: bold;">Total:</span>
                            <span style="color: #ff6b6b; font-weight: bold;" id="sendTotal">0.0001 iKb</span>
                        </div>
                    </div>
                    
                    <button class="auth-button" onclick="sendKabiru()" style="background: linear-gradient(45deg, #ff6b6b, #ffa726);">
                        üí∏ Send KABIRU
                    </button>
                </div>
            </div>
        </div>
    </div>

    <!-- Receive iKb Modal -->
    <div id="receiveModal" class="modal">
        <div class="modal-content">
            <span class="close" onclick="closeModal('receiveModal')">&times;</span>
            <h2 class="modal-title">üì• Receive KABIRU</h2>
            <div style="margin-bottom: 20px;">
                <div style="background: rgba(0, 255, 135, 0.1); padding: 15px; border-radius: 10px; margin-bottom: 15px; border: 1px solid rgba(0, 255, 135, 0.3);">
                    
                    <div style="text-align: center; margin-bottom: 15px;">
                        <div style="font-size: 14px; font-weight: bold; color: #00ff87; margin-bottom: 10px;">
                            Share your email to receive iKb
                        </div>
                    </div>
                    
                    <div style="background: rgba(0, 0, 0, 0.3); padding: 12px; border-radius: 8px; margin: 15px 0;">
                        <div style="font-size: 11px; opacity: 0.8; margin-bottom: 5px;">Your Email Address:</div>
                        <div style="font-size: 13px; color: #00ff87; font-weight: bold; word-break: break-all;" id="receiveEmail">user@example.com</div>
                    </div>

                    <div style="background: rgba(0, 0, 0, 0.3); padding: 12px; border-radius: 8px; margin: 15px 0;">
                        <div style="font-size: 11px; opacity: 0.8; margin-bottom: 5px;">Your Wallet Address:</div>
                        <div style="font-size: 10px; color: #00ff87; word-break: break-all;" id="receiveWalletAddress">0x...</div>
                    </div>
                    
                    <div class="share-buttons">
                        <button class="share-btn copy" onclick="copyReceiveInfo()">
                            üìã Copy Email
                        </button>
                        <button class="share-btn share" onclick="shareReceiveInfo()">
                            üì± Share Info
                        </button>
                    </div>

                    <div style="font-size: 11px; opacity: 0.7; text-align: center; margin-top: 15px;">
                        üí° Ask senders to use your email address when sending iKb
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Transaction History Modal -->
    <div id="transactionHistoryModal" class="modal">
        <div class="modal-content">
            <span class="close" onclick="closeModal('transactionHistoryModal')">&times;</span>
            <h2 class="modal-title">üìä Transaction History</h2>
            <div id="transactionHistoryContent" style="margin-bottom: 20px;">
                <div style="text-align: center; padding: 20px;">
                    <div style="font-size: 14px; opacity: 0.7;">Loading...</div>
                </div>
            </div>
        </div>
    </div>

    <!-- Referral Earnings Modal -->
    <div id="referralEarningsModal" class="modal">
        <div class="modal-content">
            <span class="close" onclick="closeModal('referralEarningsModal')">&times;</span>
            <h2 class="modal-title">üí∞ Referral Earnings Dashboard</h2>
            <div id="referralEarningsContent" style="margin-bottom: 20px;">
                <div style="text-align: center; padding: 20px;">
                    <div style="font-size: 14px; opacity: 0.7;">Loading...</div>
                </div>
            </div>
        </div>
    </div>

    <!-- Value Declaration Modal -->
    <div id="valueDeclarationModal" class="modal">
        <div class="modal-content">
            <span class="close" onclick="closeModal('valueDeclarationModal')">&times;</span>
            <h2 class="modal-title">üìù Declare Your Values</h2>
            <div style="margin-bottom: 20px;">
                <div style="background: rgba(255, 215, 0, 0.1); padding: 15px; border-radius: 10px; margin-bottom: 15px;">
                    <p style="font-size: 13px; line-height: 1.6; margin-bottom: 15px;">
                        Value declarations activate your mining for <strong>30 days</strong>. Choose values that represent your contribution to the community:
                    </p>

                    <div style="margin: 15px 0;">
                        <label class="form-label">Select Value Category</label>
                        <select id="valueCategory" class="form-input">
                            <option value="">-- Choose Category --</option>
                            <option value="service">Service Value - Community service</option>
                            <option value="skill">Skill Value - Professional expertise</option>
                            <option value="knowledge">Knowledge Value - Information sharing</option>
                            <option value="innovation">Innovation Value - Creative solutions</option>
                            <option value="leadership">Leadership Value - Guidance & mentorship</option>
                        </select>
                    </div>

                    <div style="margin: 15px 0;">
                        <label class="form-label">Describe Your Value (Optional)</label>
                        <textarea id="valueDescription" class="form-input" rows="3" placeholder="Brief description of how you contribute..."></textarea>
                    </div>

                    <button class="auth-button" onclick="submitValueDeclaration()">
                        ‚úÖ Submit Declaration
                    </button>
                </div>

                <div style="font-size: 11px; opacity: 0.8; text-align: center;">
                    Declaration valid for 30 days. You'll need to renew after expiry.
                </div>
            </div>
        </div>
    </div>

    <!-- TAU Member ID Link Modal -->
    <div id="memberIDModal" class="modal">
        <div class="modal-content">
            <span class="close" onclick="closeModal('memberIDModal')">&times;</span>
            <h2 class="modal-title">üîó Link TAU Africa Member ID</h2>
            <div style="margin-bottom: 20px;">
                <div style="background: rgba(255, 215, 0, 0.1); padding: 15px; border-radius: 10px; margin-bottom: 15px; border: 1px solid rgba(255, 215, 0, 0.3);">
                    <p style="font-size: 14px; margin-bottom: 15px; line-height: 1.5;">
                        Enter your TAU Africa Member ID to activate mining. Your mining rate depends on your membership level:
                    </p>
                    <ul style="font-size: 12px; opacity: 0.9; line-height: 1.8; padding-left: 20px;">
                        <li><strong>Level 1 (Basic):</strong> 0.005 iKb/day</li>
                        <li><strong>Level 2 (Community):</strong> 0.01 iKb/day</li>
                        <li><strong>Level 3 (Sovereign):</strong> 0.1 iKb/day</li>
                    </ul>
                    
                    <div style="margin-top: 15px;">
                        <label class="form-label">TAU Member ID *</label>
                        <input type="text" id="linkMemberID" class="form-input" placeholder="TSK-XXXXXX-XXX or TLK-XXXXXX-XXX" style="margin-bottom: 10px;">
                        <div style="font-size: 11px; opacity: 0.7;">Format: TSK-123456-789 or TLK-123456-789</div>
                    </div>
                    
                    <button class="auth-button" onclick="verifyAndLinkMemberID()" style="margin-top: 15px;">
                        üîç Verify & Link Member ID
                    </button>
                </div>
                
                <div style="font-size: 12px; opacity: 0.8; text-align: center; margin-top: 15px;">
                    Don't have a Member ID? 
                    <a href="https://magero1985.github.io/Tau-Africa/" target="_blank" style="color: #FFD700; text-decoration: underline;">Register at TAU Africa</a>
                </div>
            </div>
        </div>
    </div>

    <!-- Notification Toast -->
    <div id="notification" class="notification"></div>

    <script>
        // Firebase Configuration
        const firebaseConfig = {
            apiKey: "AIzaSyCZhPjrl18PuyBh01Ou2KQMs-Ph3x2GP7o",
            authDomain: "kabiru-mining-app.firebaseapp.com",
            projectId: "kabiru-mining-app",
            storageBucket: "kabiru-mining-app.appspot.com",
            messagingSenderId: "217095254990",
            appId: "1:217095254990:web:9eb44eff825666995fb19f",
            measurementId: "G-W6070RT4PB"
        };

        // Initialize Firebase
        let app, db, auth;

        try {
            app = firebase.initializeApp(firebaseConfig);
            db = firebase.firestore();
            auth = firebase.auth();
            console.log('‚úÖ Firebase initialized');
        } catch (error) {
            console.error('‚ùå Firebase error:', error);
        }

        // ============================================
        // USER DATA STRUCTURE
        // ============================================
        let currentUser = null;
        let userBalance = 0.0000;
        let minedBalance = 0.0000;
        let receivedBalance = 0.0000;
        let reserveBalance = 0.0000;
        let lockedBalance = 0.0000;
        let kabiruPoints = 0.0000;
        let totalTasksCompleted = 0;
        let miningRate = 0.005;
        let userWalletAddress = '';
        let transactionHistory = [];
        let referralCode = '';
        let lockupPeriods = [];

        // Referral tracking
        let referredBy = null;
        let totalReferrals = 0;
        let totalReferralEarnings = 0;

        // Lockup state
        let currentLockupMonths = 0;
        let currentLockupBonus = 0;

        // TAU Member ID variables
        let tauMemberId = null;
        let tauMemberLevel = 1;
        let tauMemberName = '';
        let lastDeclarationDate = 0;

        // Mining Session State
        let miningSession = {
            active: false,
            startTime: null,
            endTime: null,
            ratePerHour: 0,
            intervalId: null,
            type: null,
            tierName: ''
        };

        // Mining Tier Configurations
        const MINING_TIERS = {
            basic: { 
                rate: 0.005,           // Daily rate
                hrRate: 0.0002083333,  // Hourly rate (0.005 / 24)
                reqLevel: 1,
                name: 'Basic'
            },
            community: { 
                rate: 0.01,
                hrRate: 0.0004166667,  // 0.01 / 24
                reqLevel: 2,
                name: 'Community'
            },
            sovereign: { 
                rate: 0.1,
                hrRate: 0.0041666667,  // 0.1 / 24
                reqLevel: 3,
                name: 'Sovereign'
            }
        };

        // ============================================
        // UTILITY FUNCTIONS
        // ============================================
        function generateWalletAddress() {
            const chars = '0123456789abcdef';
            let address = '0x';
            for (let i = 0; i < 40; i++) {
                address += chars[Math.floor(Math.random() * chars.length)];
            }
            return address;
        }

        function generateReferralCode(uid) {
            return 'KABIRU_' + (uid?.substr(-6) || Math.random().toString(36).substr(2, 6)).toUpperCase();
        }

        function generateTransactionId() {
            return 'tx_' + Date.now() + '_' + Math.random().toString(36).substr(2, 9);
        }

        // ============================================
        // SAVE/LOAD USER DATA
        // ============================================
        async function saveUserData() {
            const userData = {
                balance: userBalance,
                minedBalance: minedBalance,
                receivedBalance: receivedBalance,
                reserveBalance: reserveBalance,
                lockedBalance: lockedBalance,
                kabiruPoints: kabiruPoints,
                tasksCompleted: totalTasksCompleted,
                miningRate: miningRate,
                walletAddress: userWalletAddress,
                transactionHistory: transactionHistory,
                referralCode: referralCode,
                lockupPeriods: lockupPeriods,
                lastActive: new Date().toISOString()
            };

            // Save to localStorage
            localStorage.setItem('kabiruMiningData', JSON.stringify(userData));

            // Save to Firestore
            if (currentUser && currentUser.uid && db) {
                try {
                    await db.collection('users').doc(currentUser.uid).update({
                        ...userData,
                        lastActive: firebase.firestore.FieldValue.serverTimestamp()
                    });
                    console.log('üíæ User data saved to Firestore');
                } catch (error) {
                    console.error('‚ùå Error saving to Firestore:', error);
                }
            }
        }

        async function loadUserData(firebaseUser) {
            try {
                console.log('üìä Loading user data for:', firebaseUser.uid);
                
                const userDoc = await db.collection('users').doc(firebaseUser.uid).get();
                
                if (userDoc.exists) {
                    // EXISTING USER - Load their data
                    const userData = userDoc.data();
                    console.log('üë§ Existing user found');
                    
                    minedBalance = userData.minedBalance || 0.0000;
                    receivedBalance = userData.receivedBalance || 0.0000;
                    userBalance = minedBalance + receivedBalance;
                    reserveBalance = userData.reserveBalance || 0.0000;
                    lockedBalance = userData.lockedBalance || 0.0000;
                    kabiruPoints = userData.kabiruPoints || 0.0000;
                    totalTasksCompleted = userData.tasksCompleted || 0;
                    miningRate = userData.miningRate || 0.005;
                    userWalletAddress = userData.walletAddress || generateWalletAddress();
                    transactionHistory = userData.transactionHistory || [];
                    referralCode = userData.referralCode || generateReferralCode(firebaseUser.uid);
                    lockupPeriods = userData.lockupPeriods || [];
                    
                    // Load referral data
                    referredBy = userData.referredBy || null;
                    totalReferrals = userData.totalReferrals || 0;
                    totalReferralEarnings = userData.totalReferralEarnings || 0;
                    
                } else {
                    // NEW USER - Initialize
                    console.log('üÜï New user - initializing');
                    
                    userWalletAddress = generateWalletAddress();
                    referralCode = generateReferralCode(firebaseUser.uid);
                    
                    // Check for referral code in URL
                    const urlParams = new URLSearchParams(window.location.search);
                    const referralCodeParam = urlParams.get('ref');
                    
                    let welcomeBonus = 0;
                    
                    if (referralCodeParam) {
                        try {
                            console.log('üîç Processing referral code:', referralCodeParam);
                            
                            const referrerQuery = await db.collection('users')
                                .where('referralCode', '==', referralCodeParam)
                                .limit(1)
                                .get();
                            
                            if (!referrerQuery.empty) {
                                const referrerDoc = referrerQuery.docs[0];
                                referredBy = referrerDoc.id;
                                const referrerData = referrerDoc.data();
                                
                                console.log('‚úÖ Valid referrer found:', referrerData.email);
                                
                                // Award welcome bonus to new user
                                welcomeBonus = 0.01;
                                receivedBalance = welcomeBonus;
                                userBalance = welcomeBonus;
                                
                                // Award signup bonus to referrer (using transaction)
                                const signupBonus = 0.005;
                                
                                await db.runTransaction(async (transaction) => {
                                    const referrerRef = db.collection('users').doc(referredBy);
                                    const referrerSnapshot = await transaction.get(referrerRef);
                                    
                                    if (referrerSnapshot.exists) {
                                        const currentData = referrerSnapshot.data();
                                        
                                        const newReceivedBalance = (currentData.receivedBalance || 0) + signupBonus;
                                        const newTotalReferrals = (currentData.totalReferrals || 0) + 1;
                                        const newTotalEarnings = (currentData.totalReferralEarnings || 0) + signupBonus;
                                        
                                        const txHistory = currentData.transactionHistory || [];
                                        txHistory.unshift({
                                            id: generateTransactionId(),
                                            type: 'referral_signup_bonus',
                                            amount: signupBonus,
                                            from: firebaseUser.uid,
                                            fromEmail: firebaseUser.email,
                                            fromName: firebaseUser.displayName || 'New User',
                                            timestamp: new Date().toISOString(),
                                            status: 'completed'
                                        });
                                        
                                        transaction.update(referrerRef, {
                                            receivedBalance: newReceivedBalance,
                                            totalReferrals: newTotalReferrals,
                                            totalReferralEarnings: newTotalEarnings,
                                            transactionHistory: txHistory.slice(0, 50),
                                            lastReferralBonus: firebase.firestore.FieldValue.serverTimestamp()
                                        });
                                        
                                        console.log('‚úÖ Signup bonus credited to referrer:', signupBonus);
                                    }
                                });
                                
                                // Add transaction to new user's history
                                transactionHistory.push({
                                    id: generateTransactionId(),
                                    type: 'referral_welcome_bonus',
                                    amount: welcomeBonus,
                                    from: 'system',
                                    referrer: referrerData.email,
                                    referrerId: referredBy,
                                    timestamp: new Date().toISOString(),
                                    status: 'completed'
                                });
                                
                                setTimeout(() => {
                                    showNotification(`üéâ Welcome Bonus!\n\n+${welcomeBonus.toFixed(4)} iKb credited\n\nReferred by: ${referrerData.email}`);
                                }, 2000);
                            }
                        } catch (error) {
                            console.error('‚ùå Error processing referral:', error);
                        }
                    }
                    
                    // Create new user document
                    await db.collection('users').doc(firebaseUser.uid).set({
                        uid: firebaseUser.uid,
                        email: firebaseUser.email,
                        displayName: firebaseUser.displayName || 'User',
                        balance: userBalance,
                        minedBalance: 0,
                        receivedBalance: receivedBalance,
                        reserveBalance: 0,
                        lockedBalance: 0,
                        kabiruPoints: 0,
                        tasksCompleted: 0,
                        miningRate: 0.005,
                        walletAddress: userWalletAddress,
                        transactionHistory: transactionHistory,
                        referralCode: referralCode,
                        referredBy: referredBy,
                        totalReferrals: 0,
                        totalReferralEarnings: 0,
                        lockupPeriods: [],
                        createdAt: firebase.firestore.FieldValue.serverTimestamp(),
                        lastActive: firebase.firestore.FieldValue.serverTimestamp()
                    });
                    
                    console.log('‚úÖ New user created');
                    
                    // Clean URL
                    if (referralCodeParam) {
                        window.history.replaceState({}, document.title, window.location.pathname);
                    }
                }
                
                // Set current user object
                currentUser = {
                    uid: firebaseUser.uid,
                    email: firebaseUser.email,
                    displayName: firebaseUser.displayName || 'User',
                    balance: userBalance,
                    tasksCompleted: totalTasksCompleted,
                    miningRate: miningRate,
                    walletAddress: userWalletAddress,
                    tauMemberId: tauMemberId,
                    tauMemberLevel: tauMemberLevel,
                    tauMemberName: tauMemberName,
                    referredBy: referredBy,
                    totalReferrals: totalReferrals,
                    totalReferralEarnings: totalReferralEarnings
                };
                
                updateUserDisplay();
                checkExistingMemberLink();
                
            } catch (error) {
                console.error('‚ùå Error loading user data:', error);
            }
        }

        // ============================================
        // UPDATE UI FUNCTIONS
        // ============================================
        function updateUserDisplay() {
            if (!currentUser) return;
            
            document.getElementById('userName').textContent = currentUser.displayName || 'User';
            document.getElementById('userEmail').textContent = currentUser.email || '';
            document.getElementById('userBalance').textContent = userBalance.toFixed(4) + ' iKb';
            document.getElementById('minedBalance').textContent = minedBalance.toFixed(4) + ' iKb';
            document.getElementById('receivedBalance').textContent = receivedBalance.toFixed(4) + ' iKb';
            document.getElementById('reserveBalance').textContent = reserveBalance.toFixed(4) + ' iKb';
            document.getElementById('lockedBalance').textContent = lockedBalance.toFixed(4) + ' iKb';
            document.getElementById('walletAddress').textContent = userWalletAddress;
            document.getElementById('referralCode').textContent = referralCode;
            
            // Update referral stats
            document.getElementById('totalReferrals').textContent = totalReferrals;
            document.getElementById('totalReferralEarnings').textContent = totalReferralEarnings.toFixed(4) + ' iKb';
            
            // Update reserve and locked displays
            document.getElementById('reserveBalanceDisplay').textContent = reserveBalance.toFixed(4) + ' iKb';
            document.getElementById('lockedBalanceDisplay').textContent = lockedBalance.toFixed(4) + ' iKb';
            
            // Update referral link
            const referralLink = generateReferralLink();
            document.getElementById('referralLink').textContent = referralLink;
            
            // Update member status
            updateMemberStatus();
        }

        function updateMemberStatus() {
            const statusDiv = document.getElementById('memberStatusText');
            const linkBtn = document.getElementById('linkMemberIdBtn');
            
            if (tauMemberId) {
                statusDiv.className = 'status-verified';
                statusDiv.innerHTML = `‚úÖ Verified - ${tauMemberName || 'Member'}<br>
                    <small style="font-size: 11px;">ID: ${tauMemberId} | Level ${tauMemberLevel} | Rate: ${miningRate} iKb/day</small>`;
                linkBtn.style.display = 'none';
            } else {
                statusDiv.className = 'status-pending';
                statusDiv.innerHTML = '‚ö†Ô∏è Not Linked - Link your TAU Member ID to start mining!';
                linkBtn.style.display = 'block';
            }
        }

        // ============================================
        // NOTIFICATION SYSTEM
        // ============================================
        function showNotification(message) {
            const notification = document.getElementById('notification');
            notification.textContent = message;
            notification.classList.add('show');
            
            setTimeout(() => {
                notification.classList.remove('show');
            }, 4000);
        }

        // ============================================
        // MODAL FUNCTIONS
        // ============================================
        function openModal(modalId) {
            document.getElementById(modalId).style.display = 'block';
        }

        function closeModal(modalId) {
            document.getElementById(modalId).style.display = 'none';
        }

        // Close modal when clicking outside
        window.onclick = function(event) {
            const modals = document.querySelectorAll('.modal');
            modals.forEach(modal => {
                if (event.target == modal) {
                    modal.style.display = 'none';
                }
            });
        }

        // ============================================
        // TAU MEMBER ID VERIFICATION
        // ============================================
        async function verifyAndLinkMemberID() {
            const memberId = document.getElementById('linkMemberID').value.trim();
            
            // Validate format
            if (!memberId || !memberId.match(/^(TSK|TLK)-\d{6}-\d{3}$/)) {
                showNotification('‚ùå Invalid Member ID format. Use: TSK-XXXXXX-XXX or TLK-XXXXXX-XXX');
                return;
            }
            
            try {
                showNotification('üîç Verifying Member ID...');
                console.log('üîç Searching for Member ID:', memberId);
                console.log('üìß Current user email:', currentUser.email);
                
                // Strategy 1: Search by member ID
                let memberQuery = await db.collection('members')
                    .where('id', '==', memberId)
                    .limit(1)
                    .get();
                
                console.log('üìä Query results:', memberQuery.size, 'documents found');
                
                // Strategy 2: If not found, search by email
                if (memberQuery.empty) {
                    console.log('üîç Searching by email...');
                    memberQuery = await db.collection('members')
                        .where('email', '==', currentUser.email)
                        .limit(1)
                        .get();
                    
                    if (!memberQuery.empty) {
                        const foundMember = memberQuery.docs[0].data();
                        if (foundMember.id !== memberId) {
                            showNotification(`‚ùå Your email is registered with ID: ${foundMember.id}\nPlease use that ID instead.`);
                            document.getElementById('linkMemberID').value = foundMember.id;
                            return;
                        }
                    }
                }
                
                // Check if member exists anywhere
                if (memberQuery.empty) {
                    const idOnlyQuery = await db.collection('members')
                        .where('id', '==', memberId)
                        .limit(1)
                        .get();
                    
                    if (!idOnlyQuery.empty) {
                        const existingMember = idOnlyQuery.docs[0].data();
                        showNotification(
                            `‚ùå Member ID exists but email mismatch.\n\n` +
                            `This ID is registered with: ${existingMember.email}\n` +
                            `Your account: ${currentUser.email}\n\n` +
                            `Please use the correct Member ID for your email.`
                        );
                        return;
                    }
                    
                    showNotification(
                        `‚ùå Member ID not found.\n\n` +
                        `Please check:\n` +
                        `1. ID format is correct (TSK-XXXXXX-XXX)\n` +
                        `2. You are registered in TAU Africa\n` +
                        `3. Your email matches: ${currentUser.email}`
                    );
                    return;
                }
                
                // SUCCESS: Member found and verified
                const memberDoc = memberQuery.docs[0];
                const memberData = memberDoc.data();
                console.log('‚úÖ Member verified:', memberData);
                
                const memberLevel = memberData.level || 1;
                const memberTeam = memberData.team || 'General';
                const memberName = memberData.fullName || memberData.name || 'Member';
                
                // Set mining rate based on level
                const levelRates = {
                    1: 0.005,  // Basic: 0.005 iKb/day
                    2: 0.01,   // Community: 0.01 iKb/day
                    3: 0.1,    // Sovereign: 0.1 iKb/day
                    4: 0.2     // Elite: 0.2 iKb/day
                };
                
                tauMemberId = memberId;
                tauMemberLevel = memberLevel;
                tauMemberName = memberName;
                miningRate = levelRates[memberLevel] || 0.005;
                lastDeclarationDate = 0; // Will need to declare values
                
                // Update Firestore
                await db.collection('users').doc(currentUser.uid).update({
                    tauMemberId: memberId,
                    tauMemberName: memberName,
                    tauMemberTeam: memberTeam,
                    tauMemberLevel: memberLevel,
                    tauMemberEmail: memberData.email,
                    memberVerified: true,
                    miningRate: miningRate,
                    linkedAt: firebase.firestore.FieldValue.serverTimestamp()
                });
                
                // Update currentUser object
                currentUser.tauMemberId = memberId;
                currentUser.tauMemberLevel = memberLevel;
                currentUser.tauMemberName = memberName;
                
                await saveUserData();
                updateUserDisplay();
                
                showNotification(
                    `‚úÖ Member ID Verified Successfully!\n\n` +
                    `Name: ${memberName}\n` +
                    `Level: ${memberLevel}\n` +
                    `Team: ${memberTeam}\n` +
                    `Mining Rate: ${miningRate} iKb/day\n\n` +
                    `‚ö†Ô∏è Next Step: Declare your values to activate mining!`
                );
                
                closeModal('memberIDModal');
                
            } catch (error) {
                console.error('‚ùå Verification error:', error);
                
                let errorMsg = '‚ùå Verification failed.\n\n';
                
                if (error.code === 'permission-denied') {
                    errorMsg += 'Database access denied. Please check Firebase security rules.';
                } else if (error.code === 'unavailable') {
                    errorMsg += 'Cannot connect to database. Please check your internet connection.';
                } else {
                    errorMsg += `Error: ${error.message}\n\nPlease try again or contact support.`;
                }
                
                showNotification(errorMsg);
            }
        }

        // Check if member ID is already linked on load
        async function checkExistingMemberLink() {
            if (!currentUser || !currentUser.uid || !db) return;
            
            try {
                const userDoc = await db.collection('users').doc(currentUser.uid).get();
                
                if (userDoc.exists) {
                    const userData = userDoc.data();
                    
                    if (userData.tauMemberId && userData.memberVerified) {
                        tauMemberId = userData.tauMemberId;
                        tauMemberLevel = userData.tauMemberLevel || 1;
                        tauMemberName = userData.tauMemberName || 'Member';
                        lastDeclarationDate = userData.lastDeclarationDate || 0;
                        
                        const levelRates = {1: 0.005, 2: 0.01, 3: 0.1, 4: 0.2};
                        miningRate = levelRates[tauMemberLevel] || 0.005;
                        
                        console.log('‚úÖ Member ID already linked:', tauMemberId);
                        updateMemberStatus();
                    }
                }
            } catch (error) {
                console.error('Error checking member link:', error);
            }
        }

        // ============================================
        // VALUE DECLARATION SYSTEM
        // ============================================
        function openValueDeclarationModal() {
            openModal('valueDeclarationModal');
            document.getElementById('valueCategory').value = '';
            document.getElementById('valueDescription').value = '';
        }

        async function submitValueDeclaration() {
            const category = document.getElementById('valueCategory').value;
            
            if (!category) {
                showNotification('‚ùå Please select a value category');
                return;
            }

            if (!tauMemberId) {
                showNotification('‚ùå Please link your TAU Member ID first');
                closeModal('valueDeclarationModal');
                openModal('memberIDModal');
                return;
            }

            try {
                const description = document.getElementById('valueDescription').value.trim();
                const declarationDate = Date.now();
                
                // Save declaration
                lastDeclarationDate = declarationDate;
                
                await db.collection('users').doc(currentUser.uid).update({
                    lastDeclarationDate: declarationDate,
                    lastValueCategory: category,
                    lastValueDescription: description,
                    declarationHistory: firebase.firestore.FieldValue.arrayUnion({
                        category: category,
                        description: description,
                        date: declarationDate,
                        timestamp: new Date().toISOString()
                    })
                });

                await saveUserData();
                
                showNotification(`‚úÖ Value Declaration Submitted!\n\nCategory: ${category}\n\nValid for 30 days - You can now mine!`);
                
                closeModal('valueDeclarationModal');
                updateMiningUI();
                
            } catch (error) {
                console.error('‚ùå Declaration error:', error);
                showNotification('‚ùå Failed to submit declaration. Please try again.');
            }
        }

        function checkDeclarationExpiry() {
            if (!lastDeclarationDate) return false;
            
            const now = Date.now();
            const thirtyDaysInMs = 30 * 24 * 60 * 60 * 1000;
            
            return (now - lastDeclarationDate) <= thirtyDaysInMs;
        }

        // ============================================
        // MINING SESSION SYSTEM
        // ============================================
        async function startMiningSession(tierId) {
            const tier = MINING_TIERS[tierId];
            
            // Check if TAU Member ID is linked
            if (!tauMemberId) {
                showNotification('‚ö†Ô∏è Please link your TAU Africa Member ID to start mining!');
                openModal('memberIDModal');
                return;
            }

            // Check declaration expiry (30 days)
            if (!checkDeclarationExpiry()) {
                showNotification('‚ö†Ô∏è Declaration expired! Declare your values to activate mining for 30 days.');
                openValueDeclarationModal();
                return;
            }

            // Check member level requirement
            if (tauMemberLevel < tier.reqLevel) {
                showNotification(`üîí ${tier.name} mining requires Level ${tier.reqLevel}!\n\nYour level: ${tauMemberLevel}\n\nUpgrade your TAU membership to unlock.`);
                return;
            }

            // Check if already mining
            if (miningSession.active) {
                showNotification('‚õèÔ∏è Mining session already in progress!\n\nWait for current session to complete.');
                return;
            }

            // Initialize 24-hour mining session
            const now = Date.now();
            miningSession = {
                active: true,
                startTime: now,
                endTime: now + (24 * 60 * 60 * 1000), // 24 hours from now
                ratePerHour: tier.hrRate,
                type: tierId,
                tierName: tier.name
            };

            // Save mining state
            saveMiningState();
            
            // Start real-time mining
            runRealTimeMining();
            
            // Update UI
            updateMiningUI();
            
            showNotification(`üöÄ ${tier.name} Mining Started!\n\nRate: ${tier.rate} iKb/day\nDuration: 24 hours`);
        }

        function runRealTimeMining() {
            // Clear any existing interval
            if (miningSession.intervalId) {
                clearInterval(miningSession.intervalId);
            }

            // Update every second
            miningSession.intervalId = setInterval(() => {
                const now = Date.now();
                
                // Check if session ended
                if (now >= miningSession.endTime) {
                    endMiningSession();
                    return;
                }

                // Calculate progress
                const elapsedMs = now - miningSession.startTime;
                const totalDurationMs = miningSession.endTime - miningSession.startTime;
                const progress = (elapsedMs / totalDurationMs) * 100;

                // Calculate current mined amount
                const elapsedHours = elapsedMs / (1000 * 60 * 60);
                const currentMined = elapsedHours * miningSession.ratePerHour;

                // Update UI
                updateMiningProgress(progress, currentMined);
                updateMiningTimer(miningSession.endTime - now);

            }, 1000);
        }

        function updateMiningProgress(progress, currentMined) {
            const progressBar = document.getElementById('miningProgressBar');
            const progressText = document.getElementById('miningProgressText');
            const statusText = document.getElementById('statusText');

            if (progressBar) {
                progressBar.style.width = progress.toFixed(2) + '%';
            }
            if (progressText) {
                progressText.textContent = progress.toFixed(1) + '%';
            }
            if (statusText) {
                statusText.textContent = `Mining ${miningSession.tierName}`;
            }

            // Show live balance increment (visual only, actual credit at end)
            const projectedBalance = userBalance + currentMined;
            document.getElementById('userBalance').textContent = projectedBalance.toFixed(6) + ' iKb';
        }

        function updateMiningTimer(remainingMs) {
            const hours = Math.floor(remainingMs / (1000 * 60 * 60));
            const minutes = Math.floor((remainingMs % (1000 * 60 * 60)) / (1000 * 60));
            const seconds = Math.floor((remainingMs % (1000 * 60)) / 1000);

            const timerText = `${hours.toString().padStart(2, '0')}:${minutes.toString().padStart(2, '0')}:${seconds.toString().padStart(2, '0')}`;
            document.getElementById('miningTimer').textContent = timerText;
        }

        async function endMiningSession() {
            if (!miningSession.active) return;

            // Stop the interval
            clearInterval(miningSession.intervalId);

            // Calculate final earnings
            const totalHours = 24;
            const totalEarned = totalHours * miningSession.ratePerHour;

            // Credit the balance
            minedBalance += totalEarned;
            userBalance = minedBalance + receivedBalance;
            totalTasksCompleted++;

            // Add transaction
            const transaction = {
                id: generateTransactionId(),
                type: 'mining',
                subtype: miningSession.type,
                tierName: miningSession.tierName,
                amount: totalEarned,
                duration: '24 hours',
                timestamp: new Date().toISOString(),
                status: 'completed'
            };
            transactionHistory.unshift(transaction);

            if (transactionHistory.length > 50) {
                transactionHistory = transactionHistory.slice(0, 50);
            }

            // Award referral bonus (10% to referrer)
            await awardReferralBonus(totalEarned);

            // Save data
            await saveUserData();

            // Reset mining session
            miningSession.active = false;
            saveMiningState();

            // Update UI
            updateUserDisplay();
            updateMiningUI();

            // Notification
            showNotification(`‚úÖ Mining Session Complete!\n\n+${totalEarned.toFixed(6)} iKb earned\n\nüîÑ Click to start a new session`);

            // Browser notification if permitted
            if (Notification.permission === "granted") {
                new Notification("KABIRU Mining", { 
                    body: `Your 24hr mining session has ended. You earned ${totalEarned.toFixed(6)} iKb!`,
                    icon: 'data:image/svg+xml,<svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 100 100"><circle cx="50" cy="50" r="45" fill="%23FFD700"/></svg>'
                });
            }
        }

        function saveMiningState() {
            localStorage.setItem('kabiruMiningSession', JSON.stringify(miningSession));
        }

        function loadMiningState() {
            const saved = localStorage.getItem('kabiruMiningSession');
            if (saved) {
                const state = JSON.parse(saved);
                
                // Check if session is still valid
                if (state.active && state.endTime > Date.now()) {
                    miningSession = state;
                    runRealTimeMining();
                    updateMiningUI();
                } else if (state.active && state.endTime <= Date.now()) {
                    // Session ended while app was closed - complete it
                    miningSession = state;
                    endMiningSession();
                }
            }
        }

        function updateMiningUI() {
            const declarationWarning = document.getElementById('declarationWarning');
            const progressContainer = document.getElementById('miningProgressContainer');
            const statusText = document.getElementById('statusText');

            // Check declaration status
            if (!checkDeclarationExpiry()) {
                declarationWarning.style.display = 'block';
            } else {
                declarationWarning.style.display = 'none';
            }

            // Update tier cards
            const basicTier = document.getElementById('basicTier');
            const communityTier = document.getElementById('communityTier');
            const sovereignTier = document.getElementById('sovereignTier');

            // Reset all tiers
            [basicTier, communityTier, sovereignTier].forEach(card => {
                card.classList.remove('active-mining', 'locked');
            });

            // Lock tiers based on member level
            if (tauMemberLevel < 2) communityTier.classList.add('locked');
            if (tauMemberLevel < 3) sovereignTier.classList.add('locked');

            // Show active mining tier
            if (miningSession.active) {
                progressContainer.style.display = 'block';
                
                if (miningSession.type === 'basic') basicTier.classList.add('active-mining');
                if (miningSession.type === 'community') communityTier.classList.add('active-mining');
                if (miningSession.type === 'sovereign') sovereignTier.classList.add('active-mining');
                
                statusText.textContent = `Mining ${miningSession.tierName}`;
            } else {
                progressContainer.style.display = 'none';
                statusText.textContent = 'Ready to Mine';
                document.getElementById('miningTimer').textContent = '--:--:--';
            }
        }

        // ============================================
        // REFERRAL SYSTEM
        // ============================================
        function generateReferralLink() {
            const baseUrl = window.location.origin + window.location.pathname;
            return `${baseUrl}?ref=${referralCode}`;
        }

        function copyReferralLink() {
            const link = generateReferralLink();
            
            if (navigator.clipboard) {
                navigator.clipboard.writeText(link).then(() => {
                    showNotification('üìã Referral link copied to clipboard!');
                }).catch(() => {
                    fallbackCopyToClipboard(link);
                });
            } else {
                fallbackCopyToClipboard(link);
            }
        }

        function fallbackCopyToClipboard(text) {
            const textArea = document.createElement('textarea');
            textArea.value = text;
            textArea.style.position = 'fixed';
            textArea.style.left = '-999999px';
            document.body.appendChild(textArea);
            textArea.focus();
            textArea.select();
            
            try {
                document.execCommand('copy');
                showNotification('üìã Link copied to clipboard!');
            } catch (err) {
                showNotification('‚ùå Could not copy link. Please copy manually.');
            }
            
            document.body.removeChild(textArea);
        }

        function shareReferralLink() {
            const link = generateReferralLink();
            const shareText = `Join me on KABIRU and start mining iKb tokens! Use my referral link: ${link}`;
            
            if (navigator.share) {
                navigator.share({
                    title: 'Join KABIRU Mining App',
                    text: shareText,
                    url: link
                }).then(() => {
                    showNotification('üì± Share dialog opened!');
                }).catch((err) => {
                    if (err.name !== 'AbortError') {
                        showSocialShareOptions(link, shareText);
                    }
                });
            } else {
                showSocialShareOptions(link, shareText);
            }
        }

        function showSocialShareOptions(link, text) {
            const encodedLink = encodeURIComponent(link);
            const encodedText = encodeURIComponent(text);
            
            const whatsappUrl = `https://wa.me/?text=${encodedText}`;
            const telegramUrl = `https://t.me/share/url?url=${encodedLink}&text=${encodedText}`;
            const twitterUrl = `https://twitter.com/intent/tweet?text=${encodedText}`;
            const facebookUrl = `https://www.facebook.com/sharer/sharer.php?u=${encodedLink}`;
            
            const shareModal = `
                <div style="position: fixed; top: 0; left: 0; right: 0; bottom: 0; background: rgba(0,0,0,0.8); z-index: 9999; display: flex; align-items: center; justify-content: center;" id="socialShareModal" onclick="if(event.target.id==='socialShareModal') this.remove()">
                    <div style="background: linear-gradient(135deg, #1a1a2e 0%, #16213e 100%); padding: 30px; border-radius: 20px; max-width: 350px; width: 90%;" onclick="event.stopPropagation()">
                        <h3 style="color: #FFD700; margin-bottom: 20px; text-align: center;">Share Referral Link</h3>
                        <div style="display: grid; gap: 10px;">
                            <a href="${whatsappUrl}" target="_blank" style="background: #25D366; color: white; padding: 12px; border-radius: 8px; text-decoration: none; text-align: center; font-weight: bold;">
                                üì± Share on WhatsApp
                            </a>
                            <a href="${telegramUrl}" target="_blank" style="background: #0088cc; color: white; padding: 12px; border-radius: 8px; text-decoration: none; text-align: center; font-weight: bold;">
                                ‚úàÔ∏è Share on Telegram
                            </a>
                            <a href="${twitterUrl}" target="_blank" style="background: #1DA1F2; color: white; padding: 12px; border-radius: 8px; text-decoration: none; text-align: center; font-weight: bold;">
                                üê¶ Share on Twitter
                            </a>
                            <a href="${facebookUrl}" target="_blank" style="background: #4267B2; color: white; padding: 12px; border-radius: 8px; text-decoration: none; text-align: center; font-weight: bold;">
                                üìò Share on Facebook
                            </a>
                            <button onclick="navigator.clipboard.writeText('${link}').then(() => {showNotification('Link copied!'); document.getElementById('socialShareModal').remove();})" style="background: linear-gradient(45deg, #667eea, #764ba2); color: white; padding: 12px; border-radius: 8px; border: none; font-weight: bold; cursor: pointer;">
                                üìã Copy Link
                            </button>
                            <button onclick="document.getElementById('socialShareModal').remove()" style="background: rgba(255,255,255,0.1); color: white; padding: 12px; border-radius: 8px; border: none; cursor: pointer;">
                                Cancel
                            </button>
                        </div>
                    </div>
                </div>
            `;
            
            const existing = document.getElementById('socialShareModal');
            if (existing) existing.remove();
            
            document.body.insertAdjacentHTML('beforeend', shareModal);
        }

        async function awardReferralBonus(miningAmount) {
            if (!currentUser || !referredBy || !db) {
                console.log('‚ö†Ô∏è No referral bonus: No referrer or offline mode');
                return;
            }
            
            const bonusAmount = miningAmount * 0.10; // 10% of mining reward
            
            try {
                console.log(`üí∞ Awarding ${bonusAmount.toFixed(6)} iKb to ${referredBy}`);
                
                await db.runTransaction(async (transaction) => {
                    const referrerRef = db.collection('users').doc(referredBy);
                    const referrerSnapshot = await transaction.get(referrerRef);
                    
                    if (!referrerSnapshot.exists) {
                        throw new Error('Referrer account not found');
                    }
                    
                    const referrerData = referrerSnapshot.data();
                    
                    const newReceivedBalance = (referrerData.receivedBalance || 0) + bonusAmount;
                    const newTotalEarnings = (referrerData.totalReferralEarnings || 0) + bonusAmount;
                    
                    const currentTxHistory = referrerData.transactionHistory || [];
                    const newTransaction = {
                        id: generateTransactionId(),
                        type: 'referral_mining_bonus',
                        amount: bonusAmount,
                        from: currentUser.uid,
                        fromEmail: currentUser.email,
                        fromName: currentUser.displayName || 'User',
                        miningType: miningSession.type,
                        timestamp: new Date().toISOString(),
                        status: 'completed'
                    };
                    
                    currentTxHistory.unshift(newTransaction);
                    const trimmedHistory = currentTxHistory.slice(0, 50);
                    
                    transaction.update(referrerRef, {
                        receivedBalance: newReceivedBalance,
                        totalReferralEarnings: newTotalEarnings,
                        transactionHistory: trimmedHistory,
                        lastMiningBonus: firebase.firestore.FieldValue.serverTimestamp()
                    });
                    
                    console.log('‚úÖ Mining bonus awarded:', bonusAmount);
                });
                
            } catch (error) {
                console.error('‚ùå Referral bonus error:', error);
            }
        }

        async function viewReferralEarnings() {
            if (!currentUser || !db) {
                showNotification('Please login to view referral earnings');
                return;
            }
            
            try {
                console.log('üìä Fetching referral data...');
                
                const userDoc = await db.collection('users').doc(currentUser.uid).get();
                
                if (!userDoc.exists) {
                    showNotification('‚ùå User data not found');
                    return;
                }
                
                const userData = userDoc.data();
                const allTransactions = userData.transactionHistory || [];
                
                const referralTransactions = allTransactions.filter(tx => 
                    tx.type === 'referral_mining_bonus' || 
                    tx.type === 'referral_signup_bonus'
                );
                
                const signupBonuses = referralTransactions.filter(tx => tx.type === 'referral_signup_bonus');
                const miningBonuses = referralTransactions.filter(tx => tx.type === 'referral_mining_bonus');
                
                const totalMiningBonus = miningBonuses.reduce((sum, tx) => sum + (tx.amount || 0), 0);
                
                let html = `
                    <div style="background: rgba(255, 215, 0, 0.1); padding: 20px; border-radius: 12px; margin-bottom: 20px;">
                        <div style="font-size: 16px; font-weight: bold; color: #FFD700; margin-bottom: 15px; text-align: center;">
                            üìä REFERRAL EARNINGS SUMMARY
                        </div>
                        
                        <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 10px; margin: 15px 0;">
                            <div style="background: rgba(255,255,255,0.05); padding: 12px; border-radius: 8px; text-align: center;">
                                <div style="font-size: 11px; opacity: 0.8;">Total Referrals</div>
                                <div style="font-size: 20px; font-weight: bold; color: #FFD700;">${totalReferrals}</div>
                            </div>
                            <div style="background: rgba(255,255,255,0.05); padding: 12px; border-radius: 8px; text-align: center;">
                                <div style="font-size: 11px; opacity: 0.8;">Total Earned</div>
                                <div style="font-size: 20px; font-weight: bold; color: #00ff87;">${totalReferralEarnings.toFixed(6)} iKb</div>
                            </div>
                        </div>
                        
                        <div style="margin: 15px 0; padding: 12px; background: rgba(0,0,0,0.2); border-radius: 8px;">
                            <div style="font-size: 12px; margin-bottom: 8px;">üìä Breakdown:</div>
                            <div style="font-size: 11px; line-height: 1.8;">
                                ‚Ä¢ Signup Bonuses: ${signupBonuses.length} √ó 0.005 = ${(signupBonuses.length * 0.005).toFixed(6)} iKb<br>
                                ‚Ä¢ Mining Bonuses: ${miningBonuses.length} transactions = ${totalMiningBonus.toFixed(6)} iKb
                            </div>
                        </div>
                    </div>
                `;
                
                if (referralTransactions.length > 0) {
                    html += `
                        <div style="font-size: 14px; font-weight: bold; color: #667eea; margin-bottom: 10px;">
                            üìú Recent Earnings (Last 10)
                        </div>
                        <div style="max-height: 300px; overflow-y: auto;">
                    `;
                    
                    referralTransactions.slice(0, 10).forEach((tx, index) => {
                        const date = new Date(tx.timestamp).toLocaleDateString();
                        const time = new Date(tx.timestamp).toLocaleTimeString('en-US', { 
                            hour: '2-digit', 
                            minute: '2-digit' 
                        });
                        const type = tx.type === 'referral_signup_bonus' ? 'üîπ Signup' : '‚õèÔ∏è Mining';
                        const fromName = tx.fromName || tx.fromEmail || 'User';
                        
                        html += `
                            <div style="background: rgba(255,255,255,0.05); padding: 12px; border-radius: 8px; margin-bottom: 8px;">
                                <div style="display: flex; justify-content: space-between; align-items: center;">
                                    <div>
                                        <div style="font-size: 12px; font-weight: bold;">${type}</div>
                                        <div style="font-size: 10px; opacity: 0.7;">From: ${fromName}</div>
                                        <div style="font-size: 10px; opacity: 0.6;">${date} ${time}</div>
                                    </div>
                                    <div style="font-size: 14px; font-weight: bold; color: #00ff87;">
                                        +${tx.amount.toFixed(6)} iKb
                                    </div>
                                </div>
                            </div>
                        `;
                    });
                    
                    html += `</div>`;
                } else {
                    html += `
                        <div style="text-align: center; padding: 30px; background: rgba(255,255,255,0.05); border-radius: 12px;">
                            <div style="font-size: 40px; margin-bottom: 10px;">üî≠</div>
                            <div style="font-size: 14px; opacity: 0.8; margin-bottom: 15px;">
                                No referral earnings yet
                            </div>
                            <div style="font-size: 12px; opacity: 0.7; line-height: 1.6;">
                                Share your referral link to start earning!<br><br>
                                <strong>Your Link:</strong><br>
                                <div style="background: rgba(0,0,0,0.3); padding: 8px; border-radius: 6px; font-size: 10px; word-break: break-all; margin-top: 8px;">
                                    ${generateReferralLink()}
                                </div>
                            </div>
                        </div>
                    `;
                }
                
                html += `
                    <div style="margin-top: 20px; padding: 15px; background: rgba(102, 126, 234, 0.1); border-radius: 10px; text-align: center;">
                        <div style="font-size: 12px; line-height: 1.6;">
                            üéØ Earn 10% of your referrals' mining forever!<br>
                            üí° Plus bonuses for each new signup
                        </div>
                    </div>
                `;
                
                document.getElementById('referralEarningsContent').innerHTML = html;
                openModal('referralEarningsModal');
                
            } catch (error) {
                console.error('‚ùå Error viewing referral earnings:', error);
                showNotification('‚ùå Could not load referral earnings: ' + error.message);
            }
        }

        // ============================================
        // SEND/RECEIVE SYSTEM
        // ============================================
        function openSendModal() {
            openModal('sendModal');
            const availableBalance = minedBalance + receivedBalance;
            document.getElementById('sendAvailableBalance').textContent = availableBalance.toFixed(4) + ' iKb';
            document.getElementById('sendRecipient').value = '';
            document.getElementById('sendAmount').value = '';
            document.getElementById('sendTotal').textContent = '0.0001 iKb';
            
            // Add event listener to update total
            document.getElementById('sendAmount').addEventListener('input', updateSendTotal);
        }

        function updateSendTotal() {
            const amount = parseFloat(document.getElementById('sendAmount').value) || 0;
            const fee = 0.0001;
            const total = amount + fee;
            document.getElementById('sendTotal').textContent = total.toFixed(4) + ' iKb';
        }

        async function sendKabiru() {
            const recipient = document.getElementById('sendRecipient').value.trim();
            const amount = parseFloat(document.getElementById('sendAmount').value);
            const fee = 0.0001;
            const totalAmount = amount + fee;
            const availableBalance = minedBalance + receivedBalance;
            
            if (!recipient) {
                showNotification('‚ùå Please enter recipient email address');
                return;
            }
            
            if (!amount || amount <= 0) {
                showNotification('‚ùå Please enter a valid amount');
                return;
            }
            
            if (totalAmount > availableBalance) {
                showNotification(`‚ùå Insufficient balance\n\nAvailable: ${availableBalance.toFixed(4)} iKb\nRequired: ${totalAmount.toFixed(4)} iKb (including fee)`);
                return;
            }
            
            if (recipient.toLowerCase() === currentUser.email.toLowerCase()) {
                showNotification('‚ùå Cannot send to yourself');
                return;
            }
            
            try {
                showNotification('‚è≥ Processing transfer...');
                
                // Deduct from sender's balance
                if (minedBalance >= totalAmount) {
                    minedBalance -= totalAmount;
                } else {
                    const remainingAmount = totalAmount - minedBalance;
                    minedBalance = 0;
                    receivedBalance -= remainingAmount;
                }
                
                userBalance = minedBalance + receivedBalance;
                
                // Try to find recipient and credit them
                let recipientFound = false;
                
                if (db) {
                    try {
                        const recipientQuery = await db.collection('users')
                            .where('email', '==', recipient)
                            .limit(1)
                            .get();
                        
                        if (!recipientQuery.empty) {
                            const recipientDoc = recipientQuery.docs[0];
                            const recipientId = recipientDoc.id;
                            const recipientData = recipientDoc.data();
                            
                            // Credit recipient
                            await db.collection('users').doc(recipientId).update({
                                receivedBalance: firebase.firestore.FieldValue.increment(amount)
                            });
                            
                            // Add transaction to recipient's history
                            const recipientTxHistory = recipientData.transactionHistory || [];
                            recipientTxHistory.unshift({
                                id: generateTransactionId(),
                                type: 'receive',
                                amount: amount,
                                from: currentUser.email,
                                fromName: currentUser.displayName,
                                timestamp: new Date().toISOString(),
                                status: 'completed'
                            });
                            
                            await db.collection('users').doc(recipientId).update({
                                transactionHistory: recipientTxHistory.slice(0, 50)
                            });
                            
                            recipientFound = true;
                            console.log('‚úÖ Recipient found and credited:', recipient);
                        }
                    } catch (error) {
                        console.error('Error finding recipient:', error);
                    }
                }
                
                // Add transaction to sender's history
                const transaction = {
                    id: generateTransactionId(),
                    type: 'send',
                    recipient: recipient,
                    amount: amount,
                    fee: fee,
                    timestamp: new Date().toISOString(),
                    status: recipientFound ? 'completed' : 'pending'
                };
                transactionHistory.unshift(transaction);
                
                if (transactionHistory.length > 50) {
                    transactionHistory = transactionHistory.slice(0, 50);
                }
                
                await saveUserData();
                updateUserDisplay();
                
                if (recipientFound) {
                    showNotification(`‚úÖ Successfully sent ${amount.toFixed(4)} iKb to ${recipient}!`);
                } else {
                    showNotification(`‚ö†Ô∏è Transfer recorded but recipient not found.\n\nAmount: ${amount.toFixed(4)} iKb\nTo: ${recipient}\n\nThey will receive it when they create an account.`);
                }
                
                closeModal('sendModal');
                
            } catch (error) {
                console.error('‚ùå Send error:', error);
                showNotification('‚ùå Failed to send KABIRU. Please try again.');
            }
        }

        function openReceiveModal() {
            openModal('receiveModal');
            document.getElementById('receiveEmail').textContent = currentUser.email;
            document.getElementById('receiveWalletAddress').textContent = userWalletAddress;
        }

        function copyReceiveInfo() {
            const info = `Send KABIRU to: ${currentUser.email}`;
            
            if (navigator.clipboard) {
                navigator.clipboard.writeText(info).then(() => {
                    showNotification('üìã Email copied to clipboard!');
                }).catch(() => {
                    fallbackCopyToClipboard(info);
                });
            } else {
                fallbackCopyToClipboard(info);
            }
        }

        function shareReceiveInfo() {
            const info = `Send KABIRU tokens to my email: ${currentUser.email}`;
            
            if (navigator.share) {
                navigator.share({
                    title: 'Receive KABIRU',
                    text: info
                }).then(() => {
                    showNotification('üì± Share dialog opened!');
                }).catch((err) => {
                    if (err.name !== 'AbortError') {
                        fallbackCopyToClipboard(info);
                    }
                });
            } else {
                fallbackCopyToClipboard(info);
            }
        }

        function viewTransactionHistory() {
            if (!currentUser) {
                showNotification('Please login to view transaction history');
                return;
            }
            
            let html = '';
            
            if (transactionHistory.length === 0) {
                html = `
                    <div style="text-align: center; padding: 40px; background: rgba(255,255,255,0.05); border-radius: 12px;">
                        <div style="font-size: 40px; margin-bottom: 10px;">üì≠</div>
                        <div style="font-size: 14px; opacity: 0.8;">
                            No transactions yet
                        </div>
                    </div>
                `;
            } else {
                html = '<div class="transaction-list">';
                
                transactionHistory.slice(0, 30).forEach(tx => {
                    const date = new Date(tx.timestamp).toLocaleDateString();
                    const time = new Date(tx.timestamp).toLocaleTimeString('en-US', { 
                        hour: '2-digit', 
                        minute: '2-digit' 
                    });
                    
                    let icon = '‚ö°';
                    let amountText = '';
                    let amountClass = 'positive';
                    let description = '';
                    
                    switch (tx.type) {
                        case 'mining':
                            icon = '‚õèÔ∏è';
                            amountText = `+${tx.amount.toFixed(4)} iKb`;
                            description = `${tx.tierName || tx.subtype} mining`;
                            break;
                        case 'send':
                            icon = 'üì§';
                            amountText = `-${tx.amount.toFixed(4)} iKb`;
                            amountClass = 'negative';
                            description = `Sent to ${tx.recipient}`;
                            break;
                        case 'receive':
                            icon = 'üì•';
                            amountText = `+${tx.amount.toFixed(4)} iKb`;
                            description = `Received from ${tx.from || 'Unknown'}`;
                            break;
                        case 'referral_signup_bonus':
                            icon = 'üéÅ';
                            amountText = `+${tx.amount.toFixed(4)} iKb`;
                            description = `Signup bonus from ${tx.fromName || 'referral'}`;
                            break;
                        case 'referral_mining_bonus':
                            icon = '‚õèÔ∏è';
                            amountText = `+${tx.amount.toFixed(4)} iKb`;
                            description = `Mining bonus from ${tx.fromName || 'referral'}`;
                            break;
                        case 'referral_welcome_bonus':
                            icon = 'üéâ';
                            amountText = `+${tx.amount.toFixed(4)} iKb`;
                            description = `Welcome bonus`;
                            break;
                        default:
                            description = tx.type;
                    }
                    
                    html += `
                        <div class="transaction-item">
                            <div style="display: flex; align-items: center; flex: 1;">
                                <div class="transaction-icon">${icon}</div>
                                <div class="transaction-details">
                                    <div style="font-size: 12px; font-weight: bold;">${description}</div>
                                    <div style="font-size: 10px; opacity: 0.7;">${date} ${time}</div>
                                </div>
                            </div>
                            <div class="transaction-amount ${amountClass}">
                                ${amountText}
                            </div>
                        </div>
                    `;
                });
                
                html += '</div>';
                
                if (transactionHistory.length > 30) {
                    html += `
                        <div style="text-align: center; font-size: 11px; opacity: 0.7; margin-top: 15px;">
                            Showing last 30 transactions
                        </div>
                    `;
                }
            }
            
            document.getElementById('transactionHistoryContent').innerHTML = html;
            openModal('transactionHistoryModal');
        }

        // ============================================
        // RESERVE SYSTEM
        // ============================================
        function openAddToReserveModal() {
            openModal('addToReserveModal');
            const availableBalance = minedBalance + receivedBalance;
            document.getElementById('addReserveAvailable').textContent = availableBalance.toFixed(4) + ' iKb';
            document.getElementById('reserveAmount').value = '';
        }

        async function addToReserve() {
            const amount = parseFloat(document.getElementById('reserveAmount').value);
            const availableBalance = minedBalance + receivedBalance;
            
            if (!amount || amount <= 0) {
                showNotification('‚ùå Please enter a valid amount');
                return;
            }
            
            if (amount > availableBalance) {
                showNotification(`‚ùå Insufficient balance\n\nAvailable: ${availableBalance.toFixed(4)} iKb`);
                return;
            }
            
            try {
                // Deduct from available balance
                if (minedBalance >= amount) {
                    minedBalance -= amount;
                } else {
                    const remainingAmount = amount - minedBalance;
                    minedBalance = 0;
                    receivedBalance -= remainingAmount;
                }
                
                // Add to reserve
                reserveBalance += amount;
                userBalance = minedBalance + receivedBalance;
                
                // Add transaction
                const transaction = {
                    id: generateTransactionId(),
                    type: 'reserve_add',
                    amount: amount,
                    timestamp: new Date().toISOString(),
                    status: 'completed'
                };
                transactionHistory.unshift(transaction);
                
                await saveUserData();
                updateUserDisplay();
                
                showNotification(`‚úÖ Successfully added ${amount.toFixed(4)} iKb to reserves!\n\nüí∞ Earning 2% annual interest`);
                closeModal('addToReserveModal');
                
            } catch (error) {
                console.error('‚ùå Reserve error:', error);
                showNotification('‚ùå Failed to add to reserve. Please try again.');
            }
        }

        function openWithdrawReserveModal() {
            openModal('withdrawReserveModal');
            document.getElementById('withdrawReserveAvailable').textContent = reserveBalance.toFixed(4) + ' iKb';
            document.getElementById('withdrawReserveAmount').value = '';
        }

        async function withdrawFromReserve() {
            const amount = parseFloat(document.getElementById('withdrawReserveAmount').value);
            
            if (!amount || amount <= 0) {
                showNotification('‚ùå Please enter a valid amount');
                return;
            }
            
            if (amount > reserveBalance) {
                showNotification(`‚ùå Insufficient reserve balance\n\nReserve: ${reserveBalance.toFixed(4)} iKb`);
                return;
            }
            
            try {
                // Withdraw from reserve
                reserveBalance -= amount;
                receivedBalance += amount;
                userBalance = minedBalance + receivedBalance;
                
                // Add transaction
                const transaction = {
                    id: generateTransactionId(),
                    type: 'reserve_withdraw',
                    amount: amount,
                    timestamp: new Date().toISOString(),
                    status: 'completed'
                };
                transactionHistory.unshift(transaction);
                
                await saveUserData();
                updateUserDisplay();
                
                showNotification(`‚úÖ Successfully withdrew ${amount.toFixed(4)} iKb from reserves!`);
                closeModal('withdrawReserveModal');
                
            } catch (error) {
                console.error('‚ùå Withdraw error:', error);
                showNotification('‚ùå Failed to withdraw from reserve. Please try again.');
            }
        }

        // ============================================
        // LOCKUP SYSTEM
        // ============================================
        function openLockupModal(months, bonusPercentage) {
            currentLockupMonths = months;
            currentLockupBonus = bonusPercentage;
            
            openModal('lockupModal');
            
            const availableBalance = minedBalance + receivedBalance;
            document.getElementById('lockupAvailable').textContent = availableBalance.toFixed(4) + ' iKb';
            document.getElementById('lockupDurationText').textContent = `${months} Month${months > 1 ? 's' : ''}`;
            document.getElementById('lockupBonusText').textContent = `+${(bonusPercentage * 100)}% Instant Bonus`;
            document.getElementById('lockupAmount').value = '';
            
            calculateLockupBonus();
        }

        function calculateLockupBonus() {
            const amount = parseFloat(document.getElementById('lockupAmount').value) || 0;
            const bonus = amount * currentLockupBonus;
            const total = amount + bonus;
            
            document.getElementById('lockupAmountDisplay').textContent = amount.toFixed(4) + ' iKb';
            document.getElementById('lockupBonusDisplay').textContent = bonus.toFixed(4) + ' iKb';
            document.getElementById('lockupTotalDisplay').textContent = total.toFixed(4) + ' iKb';
            
            // Calculate unlock date
            const unlockDate = new Date();
            unlockDate.setMonth(unlockDate.getMonth() + currentLockupMonths);
            document.getElementById('lockupUnlockDate').textContent = unlockDate.toLocaleDateString();
        }

        async function executeLockup() {
            const amount = parseFloat(document.getElementById('lockupAmount').value);
            const availableBalance = minedBalance + receivedBalance;
            
            if (!amount || amount <= 0) {
                showNotification('‚ùå Please enter a valid amount');
                return;
            }
            
            if (amount > availableBalance) {
                showNotification(`‚ùå Insufficient balance\n\nAvailable: ${availableBalance.toFixed(4)} iKb`);
                return;
            }
            
            if (amount < 0.01) {
                showNotification('‚ùå Minimum lockup amount: 0.01 iKb');
                return;
            }
            
            try {
                const bonus = amount * currentLockupBonus;
                const unlockDate = new Date();
                unlockDate.setMonth(unlockDate.getMonth() + currentLockupMonths);
                
                // Deduct from available balance
                if (minedBalance >= amount) {
                    minedBalance -= amount;
                } else {
                    const remainingAmount = amount - minedBalance;
                    minedBalance = 0;
                    receivedBalance -= remainingAmount;
                }
                
                // Add to locked balance (amount + bonus)
                lockedBalance += amount + bonus;
                userBalance = minedBalance + receivedBalance;
                
                // Record lockup period
                const lockupInfo = {
                    id: generateTransactionId(),
                    amount: amount,
                    bonus: bonus,
                    total: amount + bonus,
                    months: currentLockupMonths,
                    bonusPercentage: currentLockupBonus,
                    lockDate: new Date().toISOString(),
                    unlockDate: unlockDate.toISOString(),
                    status: 'locked'
                };
                
                lockupPeriods.push(lockupInfo);
                
                // Add transaction
                const transaction = {
                    id: generateTransactionId(),
                    type: 'lockup',
                    amount: amount,
                    bonus: bonus,
                    months: currentLockupMonths,
                    unlockDate: unlockDate.toISOString(),
                    timestamp: new Date().toISOString(),
                    status: 'completed'
                };
                transactionHistory.unshift(transaction);
                
                await saveUserData();
                updateUserDisplay();
                
                showNotification(
                    `‚úÖ Successfully locked ${amount.toFixed(4)} iKb!\n\n` +
                    `üíé Instant Bonus: +${bonus.toFixed(4)} iKb\n` +
                    `üîì Unlock Date: ${unlockDate.toLocaleDateString()}\n` +
                    `üìä Total Locked: ${(amount + bonus).toFixed(4)} iKb`
                );
                
                closeModal('lockupModal');
                
            } catch (error) {
                console.error('‚ùå Lockup error:', error);
                showNotification('‚ùå Failed to lock tokens. Please try again.');
            }
        }

        function viewLockupPeriods() {
            if (!currentUser) {
                showNotification('Please login to view lockups');
                return;
            }
            
            let html = '';
            
            if (lockupPeriods.length === 0) {
                html = `
                    <div style="text-align: center; padding: 40px; background: rgba(255,255,255,0.05); border-radius: 12px;">
                        <div style="font-size: 40px; margin-bottom: 10px;">üîì</div>
                        <div style="font-size: 14px; opacity: 0.8;">
                            No active lockups
                        </div>
                        <div style="font-size: 12px; opacity: 0.6; margin-top: 10px;">
                            Lock tokens to earn instant bonuses!
                        </div>
                    </div>
                `;
            } else {
                html = `
                    <div style="background: rgba(255, 215, 0, 0.1); padding: 15px; border-radius: 12px; margin-bottom: 15px;">
                        <div style="font-size: 14px; font-weight: bold; color: #FFD700; margin-bottom: 10px; text-align: center;">
                            Total Locked Balance
                        </div>
                        <div style="font-size: 24px; font-weight: bold; color: #ff6b6b; text-align: center;">
                            ${lockedBalance.toFixed(4)} iKb
                        </div>
                    </div>
                `;
                
                html += '<div style="max-height: 400px; overflow-y: auto;">';
                
                lockupPeriods.forEach((lockup, index) => {
                    const lockDate = new Date(lockup.lockDate);
                    const unlockDate = new Date(lockup.unlockDate);
                    const now = new Date();
                    const isUnlocked = now >= unlockDate;
                    
                    const daysRemaining = Math.ceil((unlockDate - now) / (1000 * 60 * 60 * 24));
                    
                    html += `
                        <div style="background: rgba(255,255,255,0.05); padding: 15px; border-radius: 10px; margin-bottom: 10px; border: 2px solid ${isUnlocked ? '#00ff87' : '#ff6b6b'};">
                            <div style="display: flex; justify-content: space-between; margin-bottom: 10px;">
                                <div>
                                    <div style="font-size: 14px; font-weight: bold; color: #FFD700;">
                                        ${lockup.months} Month${lockup.months > 1 ? 's' : ''} Lockup
                                    </div>
                                    <div style="font-size: 11px; opacity: 0.7;">
                                        Locked: ${lockDate.toLocaleDateString()}
                                    </div>
                                </div>
                                <div style="text-align: right;">
                                    <div style="font-size: 16px; font-weight: bold; color: ${isUnlocked ? '#00ff87' : '#ff6b6b'};">
                                        ${lockup.total.toFixed(4)} iKb
                                    </div>
                                    <div style="font-size: 10px; color: #00ff87;">
                                        +${lockup.bonus.toFixed(4)} bonus
                                    </div>
                                </div>
                            </div>
                            
                            <div style="background: rgba(0,0,0,0.2); padding: 8px; border-radius: 6px; font-size: 11px;">
                                <div style="display: flex; justify-content: space-between; margin-bottom: 3px;">
                                    <span>Unlock Date:</span>
                                    <span style="color: #FFD700; font-weight: bold;">${unlockDate.toLocaleDateString()}</span>
                                </div>
                                <div style="display: flex; justify-content: space-between;">
                                    <span>Status:</span>
                                    <span style="color: ${isUnlocked ? '#00ff87' : '#FFA500'}; font-weight: bold;">
                                        ${isUnlocked ? '‚úÖ Unlocked' : `üîí ${daysRemaining} days remaining`}
                                    </span>
                                </div>
                            </div>
                        </div>
                    `;
                });
                
                html += '</div>';
            }
            
            document.getElementById('lockupsContent').innerHTML = html;
            openModal('lockupsModal');
        }

        // DOM Elements
        const loginPage = document.getElementById('loginPage');
        const miningApp = document.getElementById('miningApp');
        const loginContainer = document.getElementById('loginContainer');
        const signupContainer = document.getElementById('signupContainer');
        const errorMessage = document.getElementById('errorMessage');
        const successMessage = document.getElementById('successMessage');

        // Show/Hide Functions
        function showError(message) {
            document.getElementById('errorText').textContent = message;
            errorMessage.style.display = 'block';
            successMessage.style.display = 'none';
            setTimeout(() => {
                errorMessage.style.display = 'none';
            }, 5000);
        }

        function showSuccess(message) {
            document.getElementById('successText').textContent = message;
            successMessage.style.display = 'block';
            errorMessage.style.display = 'none';
            setTimeout(() => {
                successMessage.style.display = 'none';
            }, 3000);
        }

        function showLoginForm() {
            loginContainer.style.display = 'block';
            signupContainer.style.display = 'none';
            errorMessage.style.display = 'none';
            successMessage.style.display = 'none';
        }

        function showSignupForm() {
            loginContainer.style.display = 'none';
            signupContainer.style.display = 'block';
            errorMessage.style.display = 'none';
            successMessage.style.display = 'none';
        }

        function showMiningApp(user) {
            loginPage.style.display = 'none';
            miningApp.style.display = 'block';
            document.getElementById('userName').textContent = user.displayName || user.email;
        }

        function showLoginPage() {
            loginPage.style.display = 'flex';
            miningApp.style.display = 'none';
            showLoginForm();
        }

        // Event Listeners
        document.getElementById('showSignupLink').addEventListener('click', showSignupForm);
        document.getElementById('showLoginLink').addEventListener('click', showLoginForm);

        // Login Handler
        document.getElementById('loginBtn').addEventListener('click', async () => {
            const email = document.getElementById('loginEmail').value.trim();
            const password = document.getElementById('loginPassword').value;

            if (!email || !password) {
                showError('Please fill in all fields');
                return;
            }

            const btn = document.getElementById('loginBtn');
            btn.disabled = true;
            btn.textContent = 'Signing in...';

            try {
                const userCredential = await auth.signInWithEmailAndPassword(email, password);
                showSuccess('Login successful!');
                setTimeout(() => {
                    showMiningApp(userCredential.user);
                }, 1000);
            } catch (error) {
                console.error('Login error:', error);
                let errorMsg = 'Login failed';
                
                switch (error.code) {
                    case 'auth/user-not-found':
                        errorMsg = 'No account found with this email';
                        break;
                    case 'auth/wrong-password':
                        errorMsg = 'Incorrect password';
                        break;
                    case 'auth/invalid-email':
                        errorMsg = 'Invalid email address';
                        break;
                    case 'auth/too-many-requests':
                        errorMsg = 'Too many attempts. Try again later';
                        break;
                    default:
                        errorMsg = error.message;
                }
                
                showError(errorMsg);
            } finally {
                btn.disabled = false;
                btn.textContent = 'Sign In';
            }
        });

        // Signup Handler
        document.getElementById('signupBtn').addEventListener('click', async () => {
            const name = document.getElementById('signupName').value.trim();
            const email = document.getElementById('signupEmail').value.trim();
            const password = document.getElementById('signupPassword').value;
            const confirmPassword = document.getElementById('confirmPassword').value;

            if (!name || !email || !password || !confirmPassword) {
                showError('Please fill in all fields');
                return;
            }

            if (password.length < 6) {
                showError('Password must be at least 6 characters');
                return;
            }

            if (password !== confirmPassword) {
                showError('Passwords do not match');
                return;
            }

            const btn = document.getElementById('signupBtn');
            btn.disabled = true;
            btn.textContent = 'Creating Account...';

            try {
                const userCredential = await auth.createUserWithEmailAndPassword(email, password);
                
                await userCredential.user.updateProfile({
                    displayName: name
                });

                await db.collection('users').doc(userCredential.user.uid).set({
                    displayName: name,
                    email: email,
                    balance: 0,
                    createdAt: firebase.firestore.FieldValue.serverTimestamp()
                });

                showSuccess('Account created successfully!');
                setTimeout(() => {
                    showMiningApp(userCredential.user);
                }, 1000);
            } catch (error) {
                console.error('Signup error:', error);
                let errorMsg = 'Signup failed';
                
                switch (error.code) {
                    case 'auth/email-already-in-use':
                        errorMsg = 'Email already registered';
                        break;
                    case 'auth/invalid-email':
                        errorMsg = 'Invalid email address';
                        break;
                    case 'auth/weak-password':
                        errorMsg = 'Password is too weak';
                        break;
                    default:
                        errorMsg = error.message;
                }
                
                showError(errorMsg);
            } finally {
                btn.disabled = false;
                btn.textContent = 'Create Account';
            }
        });

        // Logout Handler
        document.getElementById('logoutBtn').addEventListener('click', async () => {
            try {
                await auth.signOut();
                showLoginPage();
                showSuccess('Logged out successfully');
            } catch (error) {
                console.error('Logout error:', error);
            }
        });

        // Link Member ID Button
        document.getElementById('linkMemberIdBtn').addEventListener('click', () => {
            openModal('memberIDModal');
        });

        // Request notification permission on load
        if ('Notification' in window && Notification.permission === 'default') {
            Notification.requestPermission().then(permission => {
                console.log('Notification permission:', permission);
            });
        }

        // Auth State Listener
        auth.onAuthStateChanged(async (user) => {
            if (user) {
                console.log('User logged in:', user.email);
                await loadUserData(user);
                loadMiningState(); // Load any active mining session
                showMiningApp(user);
            } else {
                console.log('No user logged in');
                showLoginPage();
            }
        });

        // Enter key support
        document.addEventListener('keypress', (e) => {
            if (e.key === 'Enter') {
                if (loginContainer.style.display !== 'none') {
                    document.getElementById('loginBtn').click();
                } else if (signupContainer.style.display !== 'none') {
                    document.getElementById('signupBtn').click();
                }
            }
        });

        console.log('‚úÖ KABIRU Mining App Loaded');
    </script>
</body>
                    </html>
