<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>KABIRU Mining App</title>
    
    <!-- Firebase SDK v9 -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/firebase/9.23.0/firebase-app-compat.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/firebase/9.23.0/firebase-auth-compat.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/firebase/9.23.0/firebase-firestore-compat.min.js"></script>
    
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: 'Arial', sans-serif;
            background: linear-gradient(135deg, #1a1a2e 0%, #16213e 50%, #0f3460 100%);
            background-attachment: fixed;
            min-height: 100vh;
            color: white;
            overflow-x: hidden;
        }

        /* LOGIN STYLES */
        .login-page {
            display: flex;
            align-items: center;
            justify-content: center;
            padding: 20px;
            min-height: 100vh;
        }

        .auth-container {
            background: rgba(255, 255, 255, 0.1);
            backdrop-filter: blur(10px);
            border-radius: 20px;
            padding: 40px 30px;
            border: 1px solid rgba(255, 255, 255, 0.2);
            box-shadow: 0 15px 50px rgba(0, 0, 0, 0.3);
            width: 100%;
            max-width: 400px;
            animation: fadeInUp 0.8s ease-out;
            margin: 20px auto;
        }

        .auth-logo {
            text-align: center;
            margin-bottom: 30px;
        }

        .auth-logo-img {
            width: 80px;
            height: 80px;
            background: linear-gradient(45deg, #FFD700, #FFA500);
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 16px;
            font-weight: bold;
            color: #333;
            box-shadow: 0 8px 25px rgba(255, 215, 0, 0.3);
            animation: pulse 2s infinite;
            border: 2px solid #FFD700;
            margin: 0 auto 15px;
        }

        .auth-title {
            font-size: 28px;
            font-weight: bold;
            color: #FFD700;
            text-shadow: 2px 2px 4px rgba(0, 0, 0, 0.3);
            margin-bottom: 8px;
        }

        .auth-subtitle {
            font-size: 14px;
            opacity: 0.8;
            margin-bottom: 20px;
        }

        .form-group {
            margin-bottom: 20px;
            position: relative;
        }

        .form-label {
            display: block;
            margin-bottom: 8px;
            font-size: 14px;
            color: #FFD700;
            font-weight: 500;
        }

        .form-input {
            width: 100%;
            padding: 15px;
            border: 1px solid rgba(255, 255, 255, 0.3);
            border-radius: 12px;
            background: rgba(255, 255, 255, 0.1);
            color: white;
            font-size: 16px;
            outline: none;
            transition: all 0.3s ease;
        }

        .form-input:focus {
            border-color: #FFD700;
            background: rgba(255, 255, 255, 0.15);
            box-shadow: 0 0 15px rgba(255, 215, 0, 0.2);
        }

        .form-input::placeholder {
            color: rgba(255, 255, 255, 0.6);
        }

        .password-input-container {
            position: relative;
        }

        .password-toggle {
            position: absolute;
            right: 15px;
            top: 50%;
            transform: translateY(-50%);
            background: none;
            border: none;
            color: #FFD700;
            cursor: pointer;
            font-size: 18px;
            padding: 0;
            width: 20px;
            height: 20px;
            display: flex;
            align-items: center;
            justify-content: center;
            transition: all 0.3s ease;
        }

        .password-toggle:hover {
            opacity: 0.7;
        }

        .auth-button {
            width: 100%;
            padding: 15px;
            background: linear-gradient(45deg, #FFD700, #FFA500);
            border: none;
            border-radius: 12px;
            color: #333;
            font-size: 16px;
            font-weight: bold;
            cursor: pointer;
            transition: all 0.3s ease;
            margin-bottom: 15px;
            text-transform: uppercase;
            letter-spacing: 0.5px;
        }

        .auth-button:hover {
            transform: translateY(-2px);
            box-shadow: 0 8px 25px rgba(255, 215, 0, 0.4);
        }

        .auth-button:disabled {
            opacity: 0.6;
            cursor: not-allowed;
            transform: none;
        }

        .auth-toggle {
            text-align: center;
            margin-top: 20px;
            font-size: 14px;
        }

        .auth-toggle-link {
            color: #FFD700;
            cursor: pointer;
            text-decoration: underline;
            transition: all 0.3s ease;
        }

        .auth-toggle-link:hover {
            opacity: 0.8;
        }

        .forgot-password-link {
            display: block;
            text-align: right;
            color: #FFD700;
            font-size: 12px;
            cursor: pointer;
            text-decoration: underline;
            margin-top: 8px;
            transition: all 0.3s ease;
        }

        .forgot-password-link:hover {
            opacity: 0.8;
        }

        /* Error and Success Messages */
        .success-message, .error-message {
            padding: 15px;
            border-radius: 10px;
            margin-bottom: 20px;
            text-align: center;
            display: none;
        }

        .success-message {
            background: rgba(0, 255, 135, 0.1);
            border: 1px solid rgba(0, 255, 135, 0.3);
            color: #00ff87;
        }

        .error-message {
            background: rgba(255, 107, 107, 0.1);
            border: 1px solid rgba(255, 107, 107, 0.3);
            color: #ff6b6b;
        }

        /* MINING APP STYLES */
        .mining-app {
            display: none;
            min-height: 100vh;
        }

        .page {
            display: none;
            min-height: 100vh;
        }

        .page.active {
            display: block;
        }

        .container {
            max-width: 400px;
            margin: 0 auto;
            padding: 15px;
            position: relative;
        }

        .top-bar {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 20px;
            font-size: 12px;
            opacity: 0.8;
        }

        .top-bar div {
            padding: 5px 10px;
            background: rgba(255, 255, 255, 0.1);
            border-radius: 15px;
            cursor: pointer;
            transition: all 0.3s ease;
        }

        .top-bar div:hover {
            background: rgba(255, 255, 255, 0.2);
        }

        .top-bar div.active {
            background: rgba(255, 215, 0, 0.3);
            color: #FFD700;
        }

        .header {
            text-align: center;
            margin-bottom: 25px;
            animation: fadeInDown 1s ease-out;
        }

        .page-header {
            display: flex;
            align-items: center;
            margin-bottom: 20px;
            padding: 15px 0;
        }

        .back-button {
            background: rgba(255, 255, 255, 0.1);
            border: none;
            color: #FFD700;
            font-size: 20px;
            padding: 10px 15px;
            border-radius: 10px;
            cursor: pointer;
            margin-right: 15px;
            transition: all 0.3s ease;
        }

        .back-button:hover {
            background: rgba(255, 255, 255, 0.2);
        }

        .page-title {
            font-size: 24px;
            color: #FFD700;
            font-weight: bold;
        }

        .logo-section {
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            gap: 15px;
            margin-bottom: 15px;
        }

        .logo-img {
            width: 80px;
            height: 80px;
            background: linear-gradient(45deg, #FFD700, #FFA500);
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 16px;
            font-weight: bold;
            color: #333;
            box-shadow: 0 8px 25px rgba(255, 215, 0, 0.3);
            animation: pulse 2s infinite;
            border: 2px solid #FFD700;
        }

        .app-title {
            font-size: 24px;
            font-weight: bold;
            color: #FFD700;
            text-shadow: 2px 2px 4px rgba(0, 0, 0, 0.3);
        }

        .subtitle {
            font-size: 14px;
            opacity: 0.8;
            margin-top: 5px;
        }

        .balance-section {
            background: rgba(255, 255, 255, 0.1);
            backdrop-filter: blur(10px);
            border-radius: 20px;
            padding: 20px;
            text-align: center;
            margin-bottom: 25px;
            border: 1px solid rgba(255, 255, 255, 0.2);
            animation: fadeInUp 1s ease-out 0.2s both;
        }

        .balance-title {
            font-size: 14px;
            opacity: 0.8;
            margin-bottom: 10px;
            text-transform: uppercase;
            letter-spacing: 1px;
        }

        .balance-amount {
            font-size: 32px;
            font-weight: bold;
            color: #FFD700;
            text-shadow: 2px 2px 4px rgba(0, 0, 0, 0.3);
            margin-bottom: 8px;
        }

        .mining-rate {
            font-size: 12px;
            opacity: 0.7;
            color: #00ff87;
        }

        .main-buttons {
            display: grid;
            grid-template-columns: 1fr 1fr 1fr;
            gap: 15px;
            margin-bottom: 25px;
        }

        .main-button {
            background: linear-gradient(45deg, #667eea, #764ba2);
            border: none;
            padding: 20px 10px;
            border-radius: 15px;
            font-size: 14px;
            font-weight: bold;
            color: white;
            cursor: pointer;
            transition: all 0.3s ease;
            box-shadow: 0 8px 25px rgba(102, 126, 234, 0.3);
            position: relative;
            overflow: hidden;
            animation: fadeInUp 1s ease-out 0.4s both;
            text-align: center;
        }

        .main-button:hover {
            transform: translateY(-2px);
            box-shadow: 0 12px 35px rgba(102, 126, 234, 0.4);
        }

        .sovereign-btn {
            background: linear-gradient(45deg, #FFD700, #FFA500);
            color: #333;
        }

        .value-btn {
            background: linear-gradient(45deg, #00ff87, #60efff);
            color: #333;
        }

        .reserve-btn {
            background: linear-gradient(45deg, #ff6b6b, #ffa726);
            color: white;
        }

        .personal-ledger {
            background: rgba(255, 255, 255, 0.1);
            backdrop-filter: blur(10px);
            border-radius: 15px;
            padding: 15px;
            margin-bottom: 20px;
            border: 1px solid rgba(255, 255, 255, 0.2);
        }

        .ledger-grid {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 10px;
        }

        .ledger-item {
            background: rgba(255, 255, 255, 0.1);
            padding: 10px;
            border-radius: 8px;
            text-align: center;
            font-size: 11px;
        }

        .ledger-title {
            font-weight: bold;
            margin-bottom: 3px;
            color: #FFD700;
        }

        .stats-section {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 15px;
            margin-bottom: 25px;
        }

        .stat-card {
            background: rgba(255, 255, 255, 0.1);
            backdrop-filter: blur(10px);
            padding: 15px;
            border-radius: 12px;
            text-align: center;
            border: 1px solid rgba(255, 255, 255, 0.2);
            animation: fadeInUp 1s ease-out 0.6s both;
        }

        .stat-value {
            font-size: 18px;
            font-weight: bold;
            color: #FFD700;
            margin-bottom: 5px;
        }

        .stat-label {
            font-size: 11px;
            opacity: 0.7;
            text-transform: uppercase;
            letter-spacing: 0.5px;
        }

        .tasks-section {
            background: rgba(255, 255, 255, 0.1);
            backdrop-filter: blur(10px);
            border-radius: 15px;
            padding: 20px;
            margin-bottom: 20px;
            border: 1px solid rgba(255, 255, 255, 0.2);
        }

        .tasks-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 15px;
        }

        .tasks-title {
            font-size: 16px;
            font-weight: bold;
            color: #FFD700;
        }

        .reward-info {
            font-size: 12px;
            opacity: 0.8;
        }

        .task-categories {
            display: grid;
            grid-template-columns: 1fr 1fr 1fr;
            gap: 10px;
            margin-bottom: 15px;
        }

        .task-category {
            background: rgba(255, 255, 255, 0.1);
            padding: 12px 8px;
            border-radius: 10px;
            text-align: center;
            cursor: pointer;
            transition: all 0.3s ease;
            border: 2px solid transparent;
        }

        .task-category:hover {
            background: rgba(255, 255, 255, 0.2);
            border-color: #FFD700;
        }

        .task-category.active {
            background: rgba(255, 215, 0, 0.2);
            border-color: #FFD700;
        }

        .category-title {
            font-size: 11px;
            font-weight: bold;
            margin-bottom: 3px;
        }

        .category-subtitle {
            font-size: 9px;
            opacity: 0.7;
        }

        .value-categories {
            display: grid;
            grid-template-columns: 1fr 1fr 1fr;
            gap: 8px;
        }

        .value-item {
            background: rgba(0, 255, 135, 0.1);
            padding: 8px;
            border-radius: 8px;
            text-align: center;
            font-size: 10px;
            cursor: pointer;
            transition: all 0.3s ease;
        }

        .value-item:hover {
            background: rgba(0, 255, 135, 0.2);
        }

        /* User Account Section */
        .user-account-section {
            background: rgba(255, 255, 255, 0.1);
            backdrop-filter: blur(10px);
            border-radius: 15px;
            padding: 15px;
            margin-bottom: 20px;
            border: 1px solid rgba(255, 255, 255, 0.2);
            cursor: pointer;
            transition: all 0.3s ease;
        }

        .user-account-section:hover {
            background: rgba(255, 255, 255, 0.15);
            transform: translateY(-2px);
        }

        .user-account-content {
            display: flex;
            align-items: center;
            gap: 15px;
        }

        .user-avatar {
            width: 50px;
            height: 50px;
            background: linear-gradient(45deg, #FFD700, #FFA500);
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 18px;
            font-weight: bold;
            color: #333;
            border: 2px solid #FFD700;
        }

        .user-info {
            flex: 1;
        }

        .user-name {
            font-size: 16px;
            font-weight: bold;
            color: #FFD700;
            margin-bottom: 2px;
        }

        .user-email {
            font-size: 12px;
            opacity: 0.7;
            margin-bottom: 2px;
        }

        .user-balance {
            font-size: 14px;
            color: #00ff87;
            font-weight: bold;
        }

        /* Notification */
        .notification {
            position: fixed;
            top: 20px;
            left: 50%;
            transform: translateX(-50%);
            background: rgba(0, 0, 0, 0.8);
            color: white;
            padding: 12px 20px;
            border-radius: 25px;
            font-size: 14px;
            opacity: 0;
            transition: opacity 0.3s ease;
            z-index: 1001;
        }

        .notification.show {
            opacity: 1;
        }

        /* Modal styles */
        .modal {
            display: none;
            position: fixed;
            z-index: 1000;
            left: 0;
            top: 0;
            width: 100%;
            height: 100%;
            background-color: rgba(0, 0, 0, 0.8);
        }

        .modal-content {
            background: rgba(255, 255, 255, 0.1);
            backdrop-filter: blur(10px);
            margin: 10% auto;
            padding: 30px;
            border-radius: 20px;
            width: 90%;
            max-width: 400px;
            border: 1px solid rgba(255, 255, 255, 0.2);
            animation: fadeInUp 0.3s ease-out;
            max-height: 80vh;
            overflow-y: auto;
        }

        .modal-title {
            color: #FFD700;
            font-size: 20px;
            font-weight: bold;
            margin-bottom: 20px;
            text-align: center;
        }

        .close {
            color: #aaa;
            float: right;
            font-size: 28px;
            font-weight: bold;
            cursor: pointer;
            line-height: 1;
        }

        .close:hover {
            color: #FFD700;
        }

        /* Utility Service Button Styles */
        .service-button {
            background: linear-gradient(45deg, #667eea, #764ba2);
            border: none;
            padding: 15px 20px;
            border-radius: 12px;
            color: white;
            font-size: 14px;
            font-weight: bold;
            cursor: pointer;
            transition: all 0.3s ease;
            margin: 10px 0;
            width: 100%;
            text-align: center;
            text-decoration: none;
            display: inline-block;
            box-shadow: 0 4px 15px rgba(102, 126, 234, 0.3);
        }

        .service-button:hover {
            transform: translateY(-2px);
            box-shadow: 0 8px 25px rgba(102, 126, 234, 0.4);
        }

        .service-button.education {
            background: linear-gradient(45deg, #4CAF50, #45a049);
        }

        .service-button.transport {
            background: linear-gradient(45deg, #2196F3, #1976D2);
        }

        .service-button.health {
            background: linear-gradient(45deg, #FF5722, #E64A19);
        }

        /* Conversion styles */
        .conversion-grid {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 10px;
            margin: 15px 0;
        }

        .conversion-item {
            background: rgba(255, 255, 255, 0.1);
            padding: 12px;
            border-radius: 8px;
            text-align: center;
            cursor: pointer;
            transition: all 0.3s ease;
            border: 1px solid rgba(255, 255, 255, 0.2);
        }

        .conversion-item:hover {
            background: rgba(255, 255, 255, 0.2);
            border-color: #FFD700;
        }

        .conversion-title {
            font-size: 12px;
            font-weight: bold;
            color: #FFD700;
            margin-bottom: 5px;
        }

        .conversion-rate {
            font-size: 10px;
            opacity: 0.8;
        }

        .tooltip {
            position: relative;
            display: inline-block;
        }

        .tooltip .tooltiptext {
            visibility: hidden;
            width: 200px;
            background-color: rgba(0, 0, 0, 0.9);
            color: #fff;
            text-align: center;
            border-radius: 6px;
            padding: 8px;
            position: absolute;
            z-index: 1;
            bottom: 125%;
            left: 50%;
            margin-left: -100px;
            opacity: 0;
            transition: opacity 0.3s;
            font-size: 11px;
        }

        .tooltip .tooltiptext::after {
            content: "";
            position: absolute;
            top: 100%;
            left: 50%;
            margin-left: -5px;
            border-width: 5px;
            border-style: solid;
            border-color: rgba(0, 0, 0, 0.9) transparent transparent transparent;
        }

        .tooltip:hover .tooltiptext {
            visibility: visible;
            opacity: 1;
        }

        /* Animations */
        @keyframes fadeInDown {
            from { opacity: 0; transform: translateY(-30px); }
            to { opacity: 1; transform: translateY(0); }
        }

        @keyframes fadeInUp {
            from { opacity: 0; transform: translateY(30px); }
            to { opacity: 1; transform: translateY(0); }
        }

        @keyframes pulse {
            0% { transform: scale(1); }
            50% { transform: scale(1.05); }
            100% { transform: scale(1); }
        }

        /* Responsive Design */
        @media (max-width: 480px) {
            .auth-container {
                margin: 20px;
                padding: 30px 20px;
            }
            
            .modal-content {
                margin: 5% auto;
                width: 95%;
            }
        }
        /* Value Pool & Sovereignty Grid Styles */
.menu-grid {
    display: grid;
    grid-template-columns: 1fr 1fr;
    gap: 15px;
    margin-top: 15px;
}

.menu-item {
    background: rgba(255, 255, 255, 0.08);
    border: 1px solid rgba(255, 215, 0, 0.3);
    border-radius: 12px;
    padding: 20px 10px;
    text-align: center;
    cursor: pointer;
    transition: all 0.3s ease;
}

.menu-item:hover {
    background: rgba(255, 215, 0, 0.15);
    transform: translateY(-3px);
}

.menu-item i { font-size: 24px; margin-bottom: 8px; display: block; }
.menu-item span { font-size: 13px; font-weight: bold; color: #FFD700; }
.menu-item small { font-size: 10px; display: block; opacity: 0.7; }

/* Liquid Wallet Styles */
.liquid-card {
    background: linear-gradient(135deg, #11998e 0%, #38ef7d 100%);
    border-radius: 15px;
    padding: 20px;
    margin-bottom: 20px;
    box-shadow: 0 10px 20px rgba(0,0,0,0.2);
}

.currency-badge {
    background: rgba(255, 255, 255, 0.2);
    padding: 4px 8px;
    border-radius: 5px;
    font-size: 12px;
    font-weight: bold;
}

.form-guided {
    background: rgba(255, 255, 255, 0.05);
    padding: 15px;
    border-radius: 10px;
    margin-top: 10px;
}

.mining-progress-container {
    height: 10px;
    background: rgba(255,255,255,0.1);
    border-radius: 5px;
    margin: 10px 0;
    overflow: hidden;
}

.mining-progress-bar {
    height: 100%;
    background: linear-gradient(90deg, #FFD700, #FFA500);
    width: 0%;
    transition: width 0.5s linear;
}
        const MINING_TIERS = {
    'basic': { rate: 0.005, hrRate: 0.0002083333, reqLevel: 1 },
    'community': { rate: 0.01, hrRate: 0.0004166667, reqLevel: 2 },
    'sovereign': { rate: 0.1, hrRate: 0.0041666667, reqLevel: 3 }
};
    </style>
</head>
<body>
    <!-- Login Page -->
    <div id="loginPage" class="login-page" style="display: flex;">
        <div class="auth-container">
            <!-- Logo Section -->
            <div class="auth-logo">
                <div class="auth-logo-img">iKb</div>
                <div class="auth-title">KABIRU</div>
                <div class="auth-subtitle">Secure Login Portal</div>
            </div>

            <!-- Error/Success Messages -->
            <div id="errorMessage" class="error-message">
                <div><strong>Warning Error</strong></div>
                <div id="errorText">Something went wrong. Please try again.</div>
            </div>

            <div id="successMessage" class="success-message">
                <div><strong>Success</strong></div>
                <div id="successText">Operation completed successfully!</div>
            </div>

            <!-- Login Form -->
            <div id="loginContainer">
                <div class="form-group">
                    <label class="form-label">Email</label>
                    <input type="email" class="form-input" id="loginEmail" placeholder="Enter your email" required>
                </div>
                <div class="form-group">
                    <label class="form-label">Password</label>
                    <div class="password-input-container">
                        <input type="password" class="form-input" id="loginPassword" placeholder="Enter your password" required>
                        <button type="button" class="password-toggle" onclick="togglePassword('loginPassword')">üëÅ</button>
                    </div>
                    <span class="forgot-password-link" onclick="showPasswordReset()">Forgot Password?</span>
                </div>
                <button type="button" class="auth-button" onclick="handleLogin()">Sign In</button>
                
                <div class="auth-toggle">
                    Don't have an account? <span class="auth-toggle-link" onclick="showSignup()">Sign Up</span>
                </div>
            </div>

            <!-- Signup Form -->
            <div id="signupContainer" style="display: none;">
                <div class="form-group">
                    <label class="form-label">Full Name</label>
                    <input type="text" class="form-input" id="signupName" placeholder="Enter your full name" required>
                </div>
                <div class="form-group">
                    <label class="form-label">Email</label>
                    <input type="email" class="form-input" id="signupEmail" placeholder="Enter your email" required>
                </div>
                <div class="form-group">
                    <label class="form-label">Password</label>
                    <div class="password-input-container">
                        <input type="password" class="form-input" id="signupPassword" placeholder="Create a password (min 6 chars)" required>
                        <button type="button" class="password-toggle" onclick="togglePassword('signupPassword')">üëÅ</button>
                    </div>
                </div>
                <div class="form-group">
                    <label class="form-label">Confirm Password</label>
                    <div class="password-input-container">
                        <input type="password" class="form-input" id="confirmPassword" placeholder="Confirm your password" required>
                        <button type="button" class="password-toggle" onclick="togglePassword('confirmPassword')">üëÅ</button>
                    </div>
                </div>
                <button type="button" class="auth-button" onclick="handleSignup()">Create Account</button>
                
                <div class="auth-toggle">
                    Already have an account? <span class="auth-toggle-link" onclick="showLogin()">Sign In</span>
                </div>
            </div>
            
            <!-- Password Reset Form -->
            <div id="passwordResetContainer" style="display: none;">
                <div class="form-group">
                    <label class="form-label">Email Address</label>
                    <input type="email" class="form-input" id="resetEmail" placeholder="Enter your email address" required>
                </div>
                <button type="button" class="auth-button" onclick="handlePasswordReset()">Send Reset Link</button>
                
                <div class="auth-toggle">
                    Remember your password? <span class="auth-toggle-link" onclick="showLogin()">Sign In</span>
                </div>
            </div>

            <!-- Email Verification Notice -->
            <div id="emailVerificationContainer" style="display: none;">
                <div style="text-align: center; margin: 20px 0;">
                    <div style="font-size: 48px; margin-bottom: 15px;">üìß</div>
                    <div style="font-size: 16px; margin-bottom: 10px; color: #FFD700;">Check your email!</div>
                    <div style="font-size: 14px; opacity: 0.8; line-height: 1.4;">
                        We've sent a verification link to your email address. Please check your inbox and click the verification link to activate your account.
                    </div>
                </div>
                
                <button class="auth-button" onclick="checkEmailVerification()">I've Verified My Email</button>
                
                <div style="text-align: center; font-size: 12px; opacity: 0.8;">
                    Didn't receive the email? 
                    <span style="color: #FFD700; cursor: pointer; text-decoration: underline;" onclick="resendEmailVerification()">Resend verification email</span>
                </div>
            </div>
        </div>
    </div>

    <!-- Mining App -->
    <div id="miningApp" class="mining-app">
        <!-- Main Mining Page -->
        <div id="mainPage" class="page active">
            <div class="container">
                <!-- Top Navigation Bar -->
                <div class="top-bar">
                    <div onclick="openUtilitiesModal()" id="utilitiesTab">UTILITIES</div>
                    <div onclick="openWalletModal()" id="walletTab">WALLET</div>
                    <div onclick="openReadModal()" id="readTab">READ</div>
                    <div onclick="openLanguageModal()">LANGUAGE</div>
                    <div onclick="openUserAccountModal()">PROFILE</div>
                </div>

                <!-- Header -->
                <div class="header">
                    <div class="logo-section">
                        <div class="logo-img">iKb</div>
                        <div>
                            <div class="app-title">KABIRU[iKb]</div>
                            <div class="subtitle">Mine Kabiru Token</div>
                        </div>
                    </div>
                </div>

                <!-- User Account Section -->
                <div class="user-account-section" onclick="openUserAccountModal()">
                    <div class="user-account-content">
                        <div class="user-avatar" id="userAvatar">üë§</div>
                        <div class="user-info">
                            <div class="user-name" id="userName">User Name</div>
                            <div class="user-email" id="userEmail">user@example.com</div>
                            <div class="user-balance" id="userAccountBalance">0.0000 iKb</div>
                        </div>
                    </div>
                </div>

                <!-- Balance Section -->
                <div class="balance-section">
                    <div class="balance-title">Your KABIRU BALANCE</div>
                    <div class="balance-amount" id="balance">0.0000 iKb</div>
                    <div class="mining-rate">mining rate <span id="miningRate">0.005</span>iKb/day</div>
                    <div style="font-size: 12px; margin-top: 5px; color: #00ff87;" id="miningTimer">Ready to mine!</div>
                </div>

                <!-- Main Action Buttons -->
                <div class="main-buttons">
                    <button class="main-button sovereign-btn" onclick="openSovereignModal()">
                        SOVEREIGN
                    </button>
                    <button class="main-button value-btn" onclick="openValueModal()">
                        VALUE
                    </button>
                    <button class="main-button reserve-btn" onclick="mineTokens('reserve', 0.002)">
                        RESERVE
                    </button>
                </div>

                <!-- Stats Section -->
                <div class="stats-section">
                    <div class="stat-card">
                        <div class="stat-value" id="totalBalance">0.0000 iKb</div>
                        <div class="stat-label">TOTAL</div>
                    </div>
                    <div class="stat-card">
                        <div class="stat-value" id="miningStatus">Ready</div>
                        <div class="stat-label">STATUS</div>
                    </div>
                    <div class="stat-card">
                        <div class="stat-value" id="networkSize">144,000</div>
                        <div class="stat-label">NETWORK</div>
                    </div>
                    <div class="stat-card">
                        <div class="stat-value" id="tasksCompleted">0</div>
                        <div class="stat-label">TASKS</div>
                    </div>
                </div>

                <!-- Tasks & Rewards Section -->
                <div class="tasks-section">
                    <div class="tasks-header">
                        <div class="tasks-title">Value Declaration</div>
                        <div class="reward-info">mining</div>
                    </div>
                    
                    <div class="task-categories">
                        <div class="task-category" onclick="selectTask('mining')">
                            <div class="category-title">LEVEL III</div>
                            <div class="category-subtitle">Sovereign 0.100000iKb/day</div>
                        </div>
                        <div class="task-category" onclick="selectTask('partnership')">
                            <div class="category-title">LEVEL II</div>
                            <div class="category-subtitle">Community 0.01000iKb/day</div>
                        </div>
                        <div class="task-category" onclick="selectTask('genledger')">
                            <div class="category-title">LEVEL I</div>
                            <div class="category-subtitle">Basic 0.00500iKb/day</div>
                        </div>
                    </div>

                    <div class="value-categories">
    <div class="value-item" onclick="startMiningSession('sovereign')" style="cursor: pointer;">
        Sovereign values<br><small>mine</small>
    </div>
    <div class="value-item" onclick="startMiningSession('community')" style="cursor: pointer;">
        Community values<br><small>mine</small>
    </div>
    <div class="value-item" onclick="startMiningSession('basic')" style="cursor: pointer;">
        Basic values<br><small>mine</small>
    </div>
</div>
                </div>

                <div class="personal-ledger">
    <div class="ledger-grid">
        <div class="ledger-item" onclick="openValueModal()" style="cursor: pointer;">
            <div class="ledger-title">My Trust</div>
            <div>value-pool</div>
        </div>
        <div class="ledger-item" onclick="showValueSection('family')" style="cursor: pointer;">
            <div class="ledger-title">My Foundation</div>
            <div>family-ledger</div>
        </div>
        <div class="ledger-item" onclick="showValueSection('business')" style="cursor: pointer;">
            <div class="ledger-title">My Holdings</div>
            <div>business-ledger</div>
        </div>
        <div class="ledger-item" onclick="openLiquidModal()" style="cursor: pointer;">
            <div class="ledger-title">My Corporate</div>
            <div>liquid-pool</div>
        </div>
    </div>
</div>

                <!-- Footer with Logout -->
                <div style="text-align: center; font-size: 12px; opacity: 0.6; margin-top: 20px;">
                    <button onclick="logout()" style="background: none; border: none; color: #FFD700; font-size: 12px; cursor: pointer; text-decoration: underline; opacity: 0.8; transition: opacity 0.3s ease;">
                        Logout
                    </button>
                </div>
            </div>
        </div>
    </div>

    <!-- Utilities Modal -->
    <div id="utilitiesModal" class="modal">
        <div class="modal-content">
            <span class="close" onclick="closeModal('utilitiesModal')">&times;</span>
            <h2 class="modal-title">KABIRU Utility Services</h2>
            <div style="margin-bottom: 20px;">
                <p style="font-size: 14px; margin-bottom: 20px; opacity: 0.8; text-align: center;">
                    Access our integrated services within the TAU-KABIRU ECOSYSTEM 
                </p>
                
                <a href="https://grouptauafrica-spec.github.io/Tacep-education-App-/" class="service-button education" target="_blank">
                    üìö Education Services
                    <div style="font-size: 12px; margin-top: 5px; opacity: 0.8;">Learning & Development Platform</div>
                </a>
                
                <a href="https://grouptauafrica-spec.github.io/valenta-Transport-Solutions-/" class="service-button transport" target="_blank">
                    üöó Transport Services
                    <div style="font-size: 12px; margin-top: 5px; opacity: 0.8;">Mobility & Transportation Solutions</div>
                </a>
                
                <a href="https://grouptauafrica-spec.github.io/Ayuka-Yamo-Healthcare-/" class="service-button health" target="_blank">
                    üè• Homeopathic Health Services
                    <div style="font-size: 12px; margin-top: 5px; opacity: 0.8;">Healthcare & Wellness Platform</div>
                </a>
                <a href="https://magero1985.github.io/Tau-Africa/tau-tube.html" class="service-button education" target="_blank">
                    üìö Social Media services
                    <div style="font-size: 12px; margin-top: 5px; opacity: 0.8;">Media sharing & Live Platform</div>
                </a>
                
                <a href="https://magero1985.github.io/Tau-Africa/knowledge-App.html" class="service-button transport" target="_blank">
                    üöó Knowledge Gaming Services
                    <div style="font-size: 12px; margin-top: 5px; opacity: 0.8;">Knowledge & Gaming Solutions</div>
                </a>
                
                <a href="https://grouptauafrica-spec.github.io/Diagnosis-App/" class="service-button health" target="_blank">
                    üè• Health Diagnosis Services
                    <div style="font-size: 12px; margin-top: 5px; opacity: 0.8;">Advanced AI+human selfcare diagnosis & Treatment Platform</div>
                </a>
                <a href="https://magero1985.github.io/Reach-out-Ema/" class="service-button education" target="_blank">
                    üìö Merchandise supply Services
                    <div style="font-size: 12px; margin-top: 5px; opacity: 0.8;">Work uniforms & General supplies Platform</div>
                </a>
            </div>
        </div>
    </div>

    <!-- Wallet Modal -->
    <div id="walletModal" class="modal">
        <div class="modal-content">
            <span class="close" onclick="closeModal('walletModal')">&times;</span>
            <h2 class="modal-title">KABIRU Wallet</h2>
            <div style="margin-bottom: 20px;">
                <div style="background: rgba(255, 255, 255, 0.1); padding: 20px; border-radius: 12px; margin: 15px 0;">
                    <div style="font-size: 14px; opacity: 0.8; margin-bottom: 10px;">Wallet Address:</div>
                    <div style="font-size: 12px; word-break: break-all; color: #FFD700;" id="walletAddress">Loading...</div>
                </div>
                
                <!-- Wallet Balance Breakdown -->
                <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 10px; margin: 20px 0;">
                    <div style="background: rgba(0, 255, 135, 0.1); padding: 12px; border-radius: 8px; text-align: center;">
                        <div style="font-size: 14px; font-weight: bold; color: #00ff87;" id="walletMinedBalance">0.0000 iKb</div>
                        <div style="font-size: 10px; opacity: 0.8;">Mined iKb</div>
                    </div>
                    <div style="background: rgba(102, 126, 234, 0.1); padding: 12px; border-radius: 8px; text-align: center;">
                        <div style="font-size: 14px; font-weight: bold; color: #667eea;" id="walletReceivedBalance">0.0000 iKb</div>
                        <div style="font-size: 10px; opacity: 0.8;">Received iKb</div>
                    </div>
                    <div style="background: rgba(255, 107, 107, 0.1); padding: 12px; border-radius: 8px; text-align: center;">
                        <div style="font-size: 14px; font-weight: bold; color: #ff6b6b;" id="walletLockedBalance">0.0000 iKb</div>
                        <div style="font-size: 10px; opacity: 0.8;">Locked iKb</div>
                    </div>
                    <div style="background: rgba(255, 165, 0, 0.1); padding: 12px; border-radius: 8px; text-align: center;">
                        <div style="font-size: 14px; font-weight: bold; color: #FFA500;" id="walletReserveBalance">0.0000 iKb</div>
                        <div style="font-size: 10px; opacity: 0.8;">Reserve iKb</div>
                    </div>
                </div>
                
                <!-- Total Balance -->
                <div style="background: rgba(255, 215, 0, 0.1); padding: 15px; border-radius: 10px; text-align: center; margin: 15px 0; border: 1px solid rgba(255, 215, 0, 0.3);">
                    <div style="font-size: 18px; font-weight: bold; color: #FFD700;" id="walletTotalBalance">0.0000 iKb</div>
                    <div style="font-size: 12px; opacity: 0.7;">Total KABIRU</div>
                </div>
                
                <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 10px; margin-top: 20px;">
                    <button class="auth-button" onclick="openSendReceiveModal()" style="font-size: 12px; padding: 10px;">
                        üí∏ Send / Receive
                    </button>
                    <button class="auth-button" onclick="openTransactionHistoryModal()" style="font-size: 12px; padding: 10px;">
                        üìä History
                    </button>
                </div>
                
                <!-- Cash Withdrawal Section -->
                <div style="margin-top: 15px; padding: 15px; background: rgba(255, 165, 0, 0.1); border-radius: 10px; border: 1px solid rgba(255, 165, 0, 0.3);">
                    <div style="font-size: 14px; font-weight: bold; color: #FFA500; margin-bottom: 10px;">üí∞ Cash Withdrawal</div>
                    <div style="font-size: 12px; opacity: 0.8; margin-bottom: 10px;">
                        Convert iKb to cash at TAU Africa Centers
                    </div>
                    <button class="auth-button" onclick="openCashWithdrawalModal()" style="font-size: 12px; padding: 10px; background: linear-gradient(45deg, #FFA500, #FF8C00); width: 100%;">
                        üíµ Request Cash Withdrawal
                    </button>
                </div>
            </div>
        </div>
    </div>

    <!-- Cash Withdrawal Modal -->
    <div id="cashWithdrawalModal" class="modal">
        <div class="modal-content">
            <span class="close" onclick="closeModal('cashWithdrawalModal')">&times;</span>
            <h2 class="modal-title">üí∞ Cash Withdrawal Request</h2>
            <div style="margin-bottom: 20px;">
                <div style="background: rgba(255, 165, 0, 0.1); padding: 15px; border-radius: 10px; margin: 15px 0; border: 1px solid rgba(255, 165, 0, 0.3);">
                    
                    <div style="font-size: 14px; margin-bottom: 15px; text-align: center;">
                        Available Balance: <span style="color: #FFD700; font-weight: bold;" id="withdrawableBalance">0.0000 iKb</span>
                    </div>
                    
                    <div style="margin: 15px 0;">
                        <label style="font-size: 12px; color: #FFA500; margin-bottom: 5px; display: block;">Amount to Withdraw (iKb):</label>
                        <input type="number" id="cashWithdrawAmount" placeholder="0.0000" step="0.0001" min="0.0001" 
                               style="width: 100%; padding: 12px; border: 1px solid rgba(255, 165, 0, 0.3); border-radius: 8px; background: rgba(255, 255, 255, 0.1); color: white; font-size: 16px;"
                               oninput="calculateCashEquivalent()">
                    </div>
                    
                    <div style="background: rgba(0, 255, 135, 0.1); padding: 15px; border-radius: 8px; margin: 15px 0; text-align: center; border: 1px solid rgba(0, 255, 135, 0.3);">
                        <div style="font-size: 12px; opacity: 0.8; margin-bottom: 5px;">You will receive:</div>
                        <div style="font-size: 24px; font-weight: bold; color: #00ff87;" id="cashEquivalent">0.00 KSH</div>
                        <div style="font-size: 10px; opacity: 0.7; margin-top: 5px;">Exchange Rate: 1 iKb = 100,000 KSH</div>
                    </div>
                    
                    <div style="margin: 15px 0;">
                        <label style="font-size: 12px; color: #FFA500; margin-bottom: 5px; display: block;">Pickup Location *</label>
                        <select id="pickupLocation" style="width: 100%; padding: 12px; border: 1px solid rgba(255, 165, 0, 0.3); border-radius: 8px; background: rgba(255, 255, 255, 0.1); color: white; font-size: 14px;">
                            <option value="">-- Select TAU Center or Agent --</option>
                            <option value="Nairobi HQ">Nairobi - TAU Africa HQ</option>
                            <option value="Mombasa Center">Mombasa Center</option>
                            <option value="Kisumu Center">Kisumu Center</option>
                            <option value="Nakuru Center">Nakuru Center</option>
                            <option value="Local Agent">Local Agent (specify below)</option>
                        </select>
                    </div>
                    
                    <div style="margin: 15px 0;">
                        <label style="font-size: 12px; color: #FFA500; margin-bottom: 5px; display: block;">Phone Number for Contact *</label>
                        <input type="tel" id="withdrawalPhone" placeholder="254XXXXXXXXX" 
                               style="width: 100%; padding: 12px; border: 1px solid rgba(255, 165, 0, 0.3); border-radius: 8px; background: rgba(255, 255, 255, 0.1); color: white; font-size: 14px;">
                    </div>
                    
                    <div style="margin: 15px 0;">
                        <label style="font-size: 12px; color: #FFA500; margin-bottom: 5px; display: block;">Additional Notes (Optional):</label>
                        <textarea id="withdrawalNotes" placeholder="Preferred time, local agent name, special instructions..." rows="3"
                                  style="width: 100%; padding: 12px; border: 1px solid rgba(255, 165, 0, 0.3); border-radius: 8px; background: rgba(255, 255, 255, 0.1); color: white; font-size: 12px;"></textarea>
                    </div>
                    
                    <button class="auth-button" onclick="submitCashWithdrawal()" style="font-size: 14px; padding: 15px; background: linear-gradient(45deg, #FFA500, #FF8C00); width: 100%;">
                        üíµ Submit Withdrawal Request
                    </button>
                </div>
                
                <div style="font-size: 11px; opacity: 0.8; text-align: center; color: #FFD700; padding: 10px; background: rgba(255, 215, 0, 0.1); border-radius: 8px;">
                    ‚è± Requests processed within 24-48 hours<br>
                    üìû You will be contacted to arrange pickup
                </div>
            </div>
        </div>
    </div>

    <!-- Send/Receive Modal -->
    <div id="sendReceiveModal" class="modal">
        <div class="modal-content">
            <span class="close" onclick="closeModal('sendReceiveModal')">&times;</span>
            <h2 class="modal-title">Send / Receive KABIRU</h2>
            <div style="margin-bottom: 20px;">
                
                <!-- Send Section -->
                <div style="background: rgba(255, 107, 107, 0.1); padding: 15px; border-radius: 10px; margin: 15px 0; border: 1px solid rgba(255, 107, 107, 0.3);">
                    <div style="font-size: 16px; font-weight: bold; color: #ff6b6b; margin-bottom: 15px;">üì§ Send KABIRU</div>
                    
                    <div style="margin: 10px 0;">
                        <label style="font-size: 12px; color: #ff6b6b; margin-bottom: 5px; display: block;">Recipient Email/Address:</label>
                        <input type="text" id="sendRecipient" placeholder="Enter email or wallet address" 
                               style="width: 100%; padding: 10px; border: 1px solid rgba(255, 107, 107, 0.3); border-radius: 8px; background: rgba(255, 255, 255, 0.1); color: white; font-size: 14px;">
                    </div>
                    
                    <div style="margin: 10px 0;">
                        <label style="font-size: 12px; color: #ff6b6b; margin-bottom: 5px; display: block;">Amount (iKb):</label>
                        <input type="number" id="sendAmount" placeholder="0.0000" step="0.0001" min="0.0001" 
                               style="width: 100%; padding: 10px; border: 1px solid rgba(255, 107, 107, 0.3); border-radius: 8px; background: rgba(255, 255, 255, 0.1); color: white; font-size: 14px;">
                    </div>
                    
                    <div style="font-size: 11px; opacity: 0.8; margin: 10px 0; text-align: center;">
                        Available: <span id="availableToSend">0.0000 iKb</span> | Fee: 0.0001 iKb
                    </div>
                    
                    <button class="auth-button" onclick="sendKabiru()" style="font-size: 12px; padding: 10px; background: linear-gradient(45deg, #ff6b6b, #ffa726);">
                        üí∏ Send KABIRU
                    </button>
                </div>

                <!-- Receive Section -->
                <div style="background: rgba(0, 255, 135, 0.1); padding: 15px; border-radius: 10px; margin: 15px 0; border: 1px solid rgba(0, 255, 135, 0.3);">
                    <div style="font-size: 16px; font-weight: bold; color: #00ff87; margin-bottom: 15px;">üì• Receive KABIRU</div>
                    
                    <div style="background: rgba(255, 255, 255, 0.1); padding: 10px; border-radius: 8px; margin-bottom: 15px;">
                        <div style="font-size: 12px; opacity: 0.8; margin-bottom: 5px;">Your Wallet Address:</div>
                        <div style="font-size: 11px; word-break: break-all; color: #00ff87;" id="receiveAddress">Loading...</div>
                    </div>
                    
                    <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 10px;">
                        <button class="auth-button" onclick="copyReceiveAddress()" style="font-size: 12px; padding: 8px; background: linear-gradient(45deg, #00ff87, #60efff);">
                            üìã Copy Address
                        </button>
                        <button class="auth-button" onclick="shareReceiveAddress()" style="font-size: 12px; padding: 8px; background: linear-gradient(45deg, #00ff87, #60efff);">
                            üì± Share Address
                        </button>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Transaction History Modal -->
    <div id="transactionHistoryModal" class="modal">
        <div class="modal-content">
            <span class="close" onclick="closeModal('transactionHistoryModal')">&times;</span>
            <h2 class="modal-title">Transaction History</h2>
            <div style="margin-bottom: 20px;">
                <div style="background: rgba(255, 255, 255, 0.1); padding: 15px; border-radius: 10px; margin: 15px 0;">
                    <div style="font-size: 14px; font-weight: bold; color: #FFD700; margin-bottom: 10px;">Recent Transactions</div>
                    <div id="transactionList" style="max-height: 300px; overflow-y: auto;">
                        <div style="text-align: center; opacity: 0.7; font-size: 14px; padding: 20px;">
                            No transactions yet
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Member ID Link Modal -->
    <div id="memberIDModal" class="modal">
        <div class="modal-content">
            <span class="close" onclick="closeModal('memberIDModal')">&times;</span>
            <h2 class="modal-title">Link TAU Africa Member ID</h2>
            <div style="margin-bottom: 20px;">
                <div style="background: rgba(255, 215, 0, 0.1); padding: 15px; border-radius: 10px; margin-bottom: 15px; border: 1px solid rgba(255, 215, 0, 0.3);">
                    <p style="font-size: 14px; margin-bottom: 10px;">Enter your TAU Africa Member ID to activate mining:</p>
                    
                    <input type="text" id="linkMemberID" placeholder="TSK-XXXXXX-XXX or TLK-XXXXXX-XXX" 
                           style="width: 100%; padding: 12px; border: 1px solid rgba(255, 215, 0, 0.3); border-radius: 8px; background: rgba(255, 255, 255, 0.1); color: white; font-size: 14px; margin-bottom: 10px;">
                    
                    <button class="auth-button" onclick="verifyAndLinkMemberID()">
                        üîó Verify & Link Member ID
                    </button>
                </div>
                
                <div style="font-size: 12px; opacity: 0.8; text-align: center;">
                    Don't have a Member ID? <a href="https://magero1985.github.io/Tau-Africa/" target="_blank" style="color: #FFD700;">Register at TAU Africa</a>
                </div>
            </div>
        </div>
    </div>

<div id="valuePoolModal" class="modal">
    <div class="modal-content">
        <span class="close" onclick="closeModal('valuePoolModal')">&times;</span>
        <h2 class="modal-title">VALUE POOL</h2>
        
        <div class="menu-grid">
            <div class="menu-item" onclick="showValueSection('hotpoint')">
                <span>Value Bank</span>
                <small>Codes ‚Ä¢ Items ‚Ä¢ Declarations</small>
            </div>
            <div class="menu-item" onclick="showValueSection('family')">
                <span>Family Ledgers</span>
                <small>Members ‚Ä¢ Personal Decl.</small>
            </div>
            <div class="menu-item" onclick="showValueSection('business')">
                <span>Business Ledgers</span>
                <small>Holdings ‚Ä¢ Empires</small>
            </div>
        </div>

        <div id="valueFormContainer" class="form-guided" style="display:none;">
            <h4 id="formTitle" style="color:#FFD700; margin-bottom:10px;"></h4>
            <div id="formFields"></div>
            <button class="auth-button" onclick="submitDeclaration()">Submit Declaration</button>
        </div>
    </div>
</div>

<div id="liquidPoolModal" class="modal">
    <div class="modal-content">
        <span class="close" onclick="closeModal('liquidPoolModal')">&times;</span>
        <h2 class="modal-title">LIQUID POOL</h2>
        
        <div class="liquid-card">
            <div style="display:flex; justify-content:space-between; align-items:center;">
                <span style="font-size:12px; opacity:0.9;">Liquid Balance</span>
                <span class="currency-badge" id="localCurrencyLabel">KSH</span>
            </div>
            <div style="font-size:28px; font-weight:bold; margin:10px 0;" id="liquidBalance">0.00</div>
            <div style="font-size:11px; opacity:0.8;">Rate: 1 iKb = 100,000 <span class="localCurrency">KSH</span></div>
        </div>

        <div class="menu-grid">
            <div class="menu-item" onclick="initiateDeposit()">
                <span>Add Money</span>
                <small>Mpesa ‚Ä¢ Card ‚Ä¢ Crypto</small>
            </div>
            <div class="menu-item" onclick="convertToIKb()">
                <span>Convert to iKb</span>
                <small>Instant Conversion</small>
            </div>
        </div>
        
        <div class="form-guided">
            <label style="font-size:12px;">Country/Region (for Currency)</label>
            <select id="userCountry" class="form-input" onchange="updateLocalCurrency()">
                <option value="Kenya">Kenya (KSH)</option>
                <option value="Uganda">Uganda (UGX)</option>
                <option value="Tanzania">Tanzania (TZS)</option>
                <option value="Burundi">Burundi (BIF)</option>
            </select>
        </div>
    </div>
</div>

    <!-- Language Modal -->
    <div id="languageModal" class="modal">
        <div class="modal-content">
            <span class="close" onclick="closeModal('languageModal')">&times;</span>
            <h2 class="modal-title">Select Language</h2>
            <div style="margin-bottom: 20px;">
                <div style="padding: 15px; background: rgba(255, 255, 255, 0.1); border-radius: 10px; margin: 10px 0; cursor: pointer;" onclick="selectLanguage('ar')">
                    <strong>Kikuyu</strong>
                </div>
            </div>
        </div>
    </div>

    <!-- User Account Modal -->
    <div id="userAccountModal" class="modal">
        <div class="modal-content">
            <span class="close" onclick="closeModal('userAccountModal')">&times;</span>
            <h2 class="modal-title">User Profile</h2>
            <div style="margin-bottom: 20px;">
                <div style="text-align: center; margin-bottom: 20px;">
                    <div class="user-avatar" style="width: 80px; height: 80px; font-size: 32px; margin: 0 auto 15px;" id="modalUserAvatar">üë§</div>
                    <div style="font-size: 18px; font-weight: bold; color: #FFD700;" id="modalUserName">User Name</div>
                    <div style="font-size: 14px; opacity: 0.7;" id="modalUserEmail">user@example.com</div>
                </div>
                
                <div style="background: rgba(255, 255, 255, 0.1); padding: 20px; border-radius: 12px; margin: 15px 0;">
                    <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 15px;">
                        <div style="text-align: center;">
                            <div style="font-size: 18px; font-weight: bold; color: #FFD700;" id="modalUserBalance">0.0000 iKb</div>
                            <div style="font-size: 12px; opacity: 0.7;">Balance</div>
                        </div>
                        <div style="text-align: center;">
                            <div style="font-size: 18px; font-weight: bold; color: #00ff87;" id="modalUserTasks">0</div>
                            <div style="font-size: 12px; opacity: 0.7;">Tasks Completed</div>
                        </div>
                    </div>
                </div>

                <!-- KABIRU Conversion Section -->
                <div class="tooltip" style="background: rgba(102, 126, 234, 0.1); padding: 15px; border-radius: 10px; margin: 15px 0; border: 1px solid rgba(102, 126, 234, 0.3);">
                    <div style="font-size: 14px; font-weight: bold; color: #667eea; margin-bottom: 10px;">üîÑ KABIRU Conversion</div>
                    <div class="tooltiptext">The KABIRU Points are acquired through tasks in the ecosystem while KABIRU digital currency is mined from genuine values</div>
                    
                    <div class="conversion-grid">
                        <div class="conversion-item" onclick="convertCurrency('ikb_to_ikbp')">
                            <div class="conversion-title">iKb ‚Üí iKbp</div>
                            <div class="conversion-rate">1 iKb = 100,000 iKbp</div>
                            <div style="font-size: 10px; color: #667eea; margin-top: 5px;">Convert to Points</div>
                        </div>
                        <div class="conversion-item" onclick="convertCurrency('ikb_to_ksh')">
                            <div class="conversion-title">iKb ‚Üí KSH</div>
                            <div class="conversion-rate">1 iKb = 100,000 KSH</div>
                            <div style="font-size: 10px; color: #667eea; margin-top: 5px;">Convert to Shillings</div>
                        </div>
                    </div>
                    
                    <div style="font-size: 11px; opacity: 0.8; margin-top: 10px; text-align: center;">
                        Current Exchange: 1 iKbp = 1 KSH
                    </div>
                </div>
                
                <!-- Referral Section -->
                <div style="background: rgba(102, 126, 234, 0.1); padding: 15px; border-radius: 10px; margin: 15px 0; border: 1px solid rgba(102, 126, 234, 0.3);">
                    <div style="font-size: 14px; font-weight: bold; color: #667eea; margin-bottom: 10px;">üîó Referral Link</div>
                    <div style="background: rgba(255, 255, 255, 0.1); padding: 10px; border-radius: 8px; font-size: 12px; word-break: break-all; margin-bottom: 10px;" id="referralLink">
                        Loading referral link...
                    </div>
                    <button class="auth-button" onclick="copyReferralLink()" style="font-size: 12px; padding: 8px 15px; margin: 5px 0;">
                        üìã Copy Link
                    </button>
                    <button class="auth-button" onclick="shareReferralLink()" style="font-size: 12px; padding: 8px 15px; margin: 5px 0;">
                        üì± Share Link
                    </button>
                    <div style="font-size: 11px; opacity: 0.8; margin-top: 5px; text-align: center;">
                        Refer friends and earn 10% of their mining rewards!
                    </div>
                    <button class="auth-button" onclick="viewReferralEarnings()" style="font-size: 12px; padding: 8px 15px; margin: 5px 0; background: linear-gradient(45deg, #00ff87, #60efff);">
                 üìä View Referral Earnings
                </button>
                </div>
                
                <!-- Lockup Options -->
                <div style="background: rgba(255, 107, 107, 0.1); padding: 15px; border-radius: 10px; margin: 15px 0; border: 1px solid rgba(255, 107, 107, 0.3);">
                    <div style="font-size: 14px; font-weight: bold; color: #ff6b6b; margin-bottom: 15px;">üîí Lockup Options</div>
                    <div style="display: grid; grid-template-columns: 1fr 1fr 1fr; gap: 8px;">
                        <button class="service-button" onclick="lockupTokens(3)" style="font-size: 11px; padding: 10px 5px; margin: 0; background: linear-gradient(45deg, #ff6b6b, #ffa726);">
                            üîí 3 Months<br><small>+5% Bonus</small>
                        </button>
                        <button class="service-button" onclick="lockupTokens(6)" style="font-size: 11px; padding: 10px 5px; margin: 0; background: linear-gradient(45deg, #ff6b6b, #ffa726);">
                            üîí 6 Months<br><small>+12% Bonus</small>
                        </button>
                        <button class="service-button" onclick="lockupTokens(12)" style="font-size: 11px; padding: 10px 5px; margin: 0; background: linear-gradient(45deg, #ff6b6b, #ffa726);">
                            üîí 12 Months<br><small>+25% Bonus</small>
                        </button>
                    </div>
                    <div style="font-size: 11px; opacity: 0.8; margin-top: 10px; text-align: center;">
                        Current Locked: <span id="currentLockedAmount">0.0000 iKb</span>
                    </div>
                </div>
                
                <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 10px; margin-top: 20px;">
                    <button class="auth-button" onclick="showNotification('Profile settings coming soon!')" style="font-size: 12px; padding: 10px;">
                        ‚öôÔ∏è Edit Profile
                    </button>
                    <button class="auth-button" onclick="showReserveModal()" style="font-size: 12px; padding: 10px;">
                        üíé Reserve Tokens
                    </button>
                </div>
            </div>
        </div>
    </div>

    <!-- Currency Conversion Modal -->
    <div id="conversionModal" class="modal">
        <div class="modal-content">
            <span class="close" onclick="closeModal('conversionModal')">&times;</span>
            <h2 class="modal-title" id="conversionTitle">Convert KABIRU</h2>
            <div style="margin-bottom: 20px;">
                <div style="background: rgba(102, 126, 234, 0.1); padding: 15px; border-radius: 10px; margin: 15px 0; border: 1px solid rgba(102, 126, 234, 0.3);">
                    
                    <div style="margin: 15px 0;">
                        <label style="font-size: 12px; color: #667eea; margin-bottom: 5px; display: block;" id="conversionFromLabel">Amount to Convert:</label>
                        <input type="number" id="conversionAmount" placeholder="0.0000" step="0.0001" min="0.0001" 
                               style="width: 100%; padding: 10px; border: 1px solid rgba(102, 126, 234, 0.3); border-radius: 8px; background: rgba(255, 255, 255, 0.1); color: white; font-size: 14px;">
                    </div>
                    
                    <div style="background: rgba(255, 255, 255, 0.1); padding: 10px; border-radius: 8px; margin: 10px 0;">
                        <div style="font-size: 12px; opacity: 0.8; margin-bottom: 5px;">You will receive:</div>
                        <div style="font-size: 16px; font-weight: bold; color: #FFD700;" id="conversionResult">0.0000</div>
                    </div>
                    
                    <div style="font-size: 11px; opacity: 0.8; margin: 10px 0; text-align: center;" id="conversionRate"></div>
                    
                    <button class="auth-button" onclick="executeConversion()" id="conversionButton" style="font-size: 12px; padding: 10px; background: linear-gradient(45deg, #667eea, #764ba2);">
                        üîÑ Convert
                    </button>
                </div>
            </div>
        </div>
    </div>

    <!-- Sovereign Values Modal -->
    <div id="sovereignModal" class="modal">
        <div class="modal-content">
            <span class="close" onclick="closeModal('sovereignModal')">&times;</span>
            <h2 class="modal-title">Select Your Sovereignty Value</h2>
            <div style="margin-bottom: 20px;">
                <div style="padding: 15px; background: rgba(255, 255, 255, 0.1); border-radius: 10px; margin: 10px 0; cursor: pointer; transition: all 0.3s ease;" onclick="selectSovereignValue('personal', this)">
                    <strong>Personal Sovereignty</strong>
                    <p style="font-size: 12px; margin-top: 5px; opacity: 0.8;">Individual autonomy and self-governance - 0.003 iKb</p>
                </div>
                <div style="padding: 15px; background: rgba(255, 255, 255, 0.1); border-radius: 10px; margin: 10px 0; cursor: pointer; transition: all 0.3s ease;" onclick="selectSovereignValue('economic', this)">
                    <strong>Economic Sovereignty</strong>
                    <p style="font-size: 12px; margin-top: 5px; opacity: 0.8;">Financial independence and control - 0.003 iKb</p>
                </div>
                <div style="padding: 15px; background: rgba(255, 255, 255, 0.1); border-radius: 10px; margin: 10px 0; cursor: pointer; transition: all 0.3s ease;" onclick="selectSovereignValue('digital', this)">
                    <strong>Digital Sovereignty</strong>
                    <p style="font-size: 12px; margin-top: 5px; opacity: 0.8;">Control over digital identity and data - 0.003 iKb</p>
                </div>
            </div>
            <button class="auth-button" onclick="startSovereignMining()" disabled id="sovereignStartBtn">
                Start Mining
            </button>
        </div>
    </div>

    <!-- Value Selection Modal -->
    <div id="valueModal" class="modal">
        <div class="modal-content">
            <span class="close" onclick="closeModal('valueModal')">&times;</span>
            <h2 class="modal-title">Select Your Value Type</h2>
            <div style="margin-bottom: 20px;">
                <div style="padding: 15px; background: rgba(255, 255, 255, 0.1); border-radius: 10px; margin: 10px 0; cursor: pointer; transition: all 0.3s ease;" onclick="selectValue('service', 0.0015, this)">
                    <strong>Service Value</strong>
                    <p style="font-size: 12px; margin-top: 5px; opacity: 0.8;">Community service and assistance - 0.0015 iKb</p>
                </div>
                <div style="padding: 15px; background: rgba(255, 255, 255, 0.1); border-radius: 10px; margin: 10px 0; cursor: pointer; transition: all 0.3s ease;" onclick="selectValue('skill', 0.0025, this)">
                    <strong>Skill Value</strong>
                    <p style="font-size: 12px; margin-top: 5px; opacity: 0.8;">Professional skills and expertise - 0.0025 iKb</p>
                </div>
                <div style="padding: 15px; background: rgba(255, 255, 255, 0.1); border-radius: 10px; margin: 10px 0; cursor: pointer; transition: all 0.3s ease;" onclick="selectValue('knowledge', 0.0035, this)">
                    <strong>Knowledge Value</strong>
                    <p style="font-size: 12px; margin-top: 5px; opacity: 0.8;">Information and wisdom sharing - 0.0035 iKb</p>
                </div>
                <div style="padding: 15px; background: rgba(255, 255, 255, 0.1); border-radius: 10px; margin: 10px 0; cursor: pointer; transition: all 0.3s ease;" onclick="selectValue('innovation', 0.0045, this)">
                    <strong>Innovation Value</strong>
                    <p style="font-size: 12px; margin-top: 5px; opacity: 0.8;">Creative solutions and inventions - 0.0045 iKb</p>
                </div>
                <div style="padding: 15px; background: rgba(255, 255, 255, 0.1); border-radius: 10px; margin: 10px 0; cursor: pointer; transition: all 0.3s ease;" onclick="selectValue('leadership', 0.0055, this)">
                    <strong>Leadership Value</strong>
                    <p style="font-size: 12px; margin-top: 5px; opacity: 0.8;">Guidance and mentorship - 0.0055 iKb</p>
                </div>
            </div>
            <button class="auth-button" onclick="startValueMining()" disabled id="valueStartBtn">
                Start Mining
            </button>
        </div>
    </div>

    <!-- Reserve Tokens Modal -->
    <div id="reserveModal" class="modal">
        <div class="modal-content">
            <span class="close" onclick="closeModal('reserveModal')">&times;</span>
            <h2 class="modal-title">Reserve Tokens</h2>
            <div style="margin-bottom: 20px;">
                <div style="background: rgba(255, 165, 0, 0.1); padding: 15px; border-radius: 10px; margin: 15px 0; border: 1px solid rgba(255, 165, 0, 0.3);">
                    <div style="font-size: 14px; margin-bottom: 10px;">Available Balance: <span style="color: #FFD700; font-weight: bold;" id="availableForReserve">0.0000 iKb</span></div>
                    <div style="font-size: 14px; margin-bottom: 15px;">Current Reserve: <span style="color: #FFA500; font-weight: bold;" id="currentReserveAmount">0.0000 iKb</span></div>
                    
                    <div style="margin: 15px 0;">
                        <label style="font-size: 12px; color: #FFA500; margin-bottom: 5px; display: block;">Amount to Reserve:</label>
                        <input type="number" id="reserveAmount" placeholder="0.0000" step="0.0001" min="0.0001" 
                               style="width: 100%; padding: 10px; border: 1px solid rgba(255, 165, 0, 0.3); border-radius: 8px; background: rgba(255, 255, 255, 0.1); color: white; font-size: 14px;">
                    </div>
                    
                    <div style="font-size: 11px; opacity: 0.8; margin: 10px 0; text-align: center;">
                        Reserved tokens earn 2% annual interest and can be withdrawn anytime
                    </div>
                    
                    <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 10px;">
                        <button class="auth-button" onclick="addToReserve()" style="font-size: 12px; padding: 10px; background: linear-gradient(45deg, #FFA500, #FF8C00);">
                            üíé Add to Reserve
                        </button>
                        <button class="auth-button" onclick="withdrawFromReserve()" style="font-size: 12px; padding: 10px; background: linear-gradient(45deg, #667eea, #764ba2);">
                            üí∞ Withdraw
                        </button>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Notification -->
    <div id="notification" class="notification"></div>

    <script>
        // Global Variables
        let currentUser = null;
        let userBalance = 0.0000;
        let minedBalance = 0.0000;
        let receivedBalance = 0.0000;
        let reserveBalance = 0.0000;
        let lockedBalance = 0.0000;
        let kabiruPoints = 0.0000;
        let totalTasksCompleted = 0;
        let miningRate = 0.001;
        let isMining = false;
        let selectedSovereignType = null;
        let selectedValueType = null;
        let selectedValueAmount = null;
        let userWalletAddress = '';
        let transactionHistory = [];
        let referralCode = '';
        let lockupPeriods = [];
        let currentConversionType = null;
        let transferListener = null;

        // Firebase Configuration
         const firebaseConfig = {
            apiKey: "AIzaSyCZhPjrl18PuyBh01Ou2KQMs-Ph3x2GP7o",
            authDomain: "kabiru-mining-app.firebaseapp.com",
            projectId: "kabiru-mining-app",
            storageBucket: "kabiru-mining-app.appspot.com",
            messagingSenderId: "217095254990",
            appId: "1:217095254990:web:9eb44eff825666995fb19f",
            measurementId: "G-W6070RT4PB"
        };
    

        // Initialize Firebase
        let app, db, auth;

        try {
            app = firebase.initializeApp(firebaseConfig);
            db = firebase.firestore();
            auth = firebase.auth();
            console.log('‚úÖ Firebase initialized successfully');
        } catch (error) {
            console.error('‚ùå Firebase initialization error:', error);
            showError('Firebase connection failed. Using offline mode.');
            initOfflineMode();
        }

        // Initialize offline mode if Firebase fails
        function initOfflineMode() {
            console.log('üî¥ Initializing offline mode...');
            const savedData = localStorage.getItem('kabiruMiningData');
            if (savedData) {
                const data = JSON.parse(savedData);
                userBalance = data.userBalance || 0.0000;
                minedBalance = data.minedBalance || 0.0000;
                receivedBalance = data.receivedBalance || 0.0000;
                reserveBalance = data.reserveBalance || 0.0000;
                lockedBalance = data.lockedBalance || 0.0000;
                kabiruPoints = data.kabiruPoints || 0.0000;
                totalTasksCompleted = data.totalTasksCompleted || 0;
                transactionHistory = data.transactionHistory || [];
                referralCode = data.referralCode || '';
                lockupPeriods = data.lockupPeriods || [];
            }
            
            if (!referralCode) {
                referralCode = 'KABIRU_' + Math.random().toString(36).substr(2, 6).toUpperCase();
            }
            
            currentUser = {
                uid: 'offline-user',
                email: 'demo@kabiru.app',
                displayName: 'Demo User',
                balance: userBalance,
                tasksCompleted: totalTasksCompleted,
                miningRate: miningRate,
                walletAddress: generateWalletAddress()
            };
            
            userWalletAddress = currentUser.walletAddress;
            showMiningApp();
        }

        // Save user data function
        async function saveUserData() {
            const userData = {
                balance: userBalance,
                minedBalance: minedBalance,
                receivedBalance: receivedBalance,
                reserveBalance: reserveBalance,
                lockedBalance: lockedBalance,
                kabiruPoints: kabiruPoints,
                tasksCompleted: totalTasksCompleted,
                miningRate: miningRate,
                walletAddress: userWalletAddress,
                transactionHistory: transactionHistory,
                referralCode: referralCode,
                lockupPeriods: lockupPeriods,
                lastActive: new Date().toISOString()
            };

            localStorage.setItem('kabiruMiningData', JSON.stringify(userData));

            if (currentUser && currentUser.uid && db && currentUser.uid !== 'offline-user') {
                try {
                    await db.collection('users').doc(currentUser.uid).update({
                        ...userData,
                        lastActive: firebase.firestore.FieldValue.serverTimestamp()
                    });
                    console.log('üíæ User data saved to Firestore');
                } catch (error) {
                    console.error('‚ùå Error saving user data to Firestore:', error);
                }
            }
        }

        // ============================================
// FIX 4: UPDATE mineTokens() to Include Referral Bonus
// ============================================
// REPLACE your existing mineTokens() function with this:

async function mineTokens(type, reward) {
    // Check if TAU Member ID is linked
    if (!currentUser || !currentUser.tauMemberId) {
        showNotification('‚ö†Ô∏è Please link your TAU Africa Member ID to start mining!');
        openMemberIDLinkModal();
        return;
    }
    
    console.log('‚õèÔ∏è Mining started:', type, 'Reward:', reward);
    
    if (isMining) {
        showNotification('Already mining! Please wait for current session to complete.');
        return;
    }

    isMining = true;
    document.getElementById('miningStatus').textContent = 'Mining...';
    
    disableMiningButtons();
    showNotification(`üî• ${type.toUpperCase()} mining started! Please wait...`);
    startMiningCountdown();
    
    setTimeout(async () => {
        const oldBalance = userBalance;
        minedBalance += reward;
        userBalance = minedBalance + receivedBalance;
        totalTasksCompleted++;
        
        // Add mining transaction
        const transaction = {
            id: generateTransactionId(),
            type: 'mining',
            subtype: type,
            amount: reward,
            timestamp: new Date().toISOString(),
            status: 'completed'
        };
        transactionHistory.unshift(transaction);
        
        if (transactionHistory.length > 50) {
            transactionHistory = transactionHistory.slice(0, 50);
        }
        
        console.log('üí∞ Balance updated:', oldBalance.toFixed(4), '->', userBalance.toFixed(4));
        
        // Award referral bonus (10% to referrer)
        await awardReferralBonus(reward);
        
        updateBalanceDisplay();
        updateUserDisplay();
        await saveUserData();
        
        document.getElementById('miningStatus').textContent = 'Completed';
        showNotification(`‚úÖ ${type.toUpperCase()} mining complete! +${reward.toFixed(4)} iKb earned`);
        
        enableMiningButtons();
        isMining = false;
        
        setTimeout(() => {
            document.getElementById('miningStatus').textContent = 'Ready';
        }, 3000);
        
    }, Math.random() * 2000 + 3000);
}


        // Replace your verifyAndLinkMemberID() function with this enhanced version:

async function verifyAndLinkMemberID() {
    const memberId = document.getElementById('linkMemberID').value.trim();
    
    // Validate format
    if (!memberId || !memberId.match(/^(TSK|TLK)-\d{6}-\d{3}$/)) {
        showNotification('‚ùå Invalid Member ID format. Use: TSK-XXXXXX-XXX or TLK-XXXXXX-XXX');
        return;
    }
    
    try {
        showNotification('üîç Verifying Member ID...');
        console.log('üîç Searching for Member ID:', memberId);
        console.log('üìß Current user email:', currentUser.email);
        
        // STRATEGY 1: Try to find by member ID first
        console.log('üìç Strategy 1: Searching by member ID...');
        let memberQuery = await db.collection('members')
            .where('id', '==', memberId)
            .limit(1)
            .get();
        
        console.log('üìä Query 1 results:', memberQuery.size, 'documents found');
        
        // STRATEGY 2: If not found, try searching by email only
        if (memberQuery.empty) {
            console.log('üìç Strategy 2: Searching by email only...');
            memberQuery = await db.collection('members')
                .where('email', '==', currentUser.email)
                .limit(1)
                .get();
            
            console.log('üìä Query 2 results:', memberQuery.size, 'documents found');
            
            // Check if the found member has the correct ID
            if (!memberQuery.empty) {
                const foundMember = memberQuery.docs[0].data();
                console.log('üë§ Found member:', foundMember);
                
                if (foundMember.id !== memberId) {
                    showNotification(`‚ùå Your email is registered with ID: ${foundMember.id}\nPlease use that ID instead.`);
                    document.getElementById('linkMemberID').value = foundMember.id;
                    return;
                }
            }
        }
        
        // STRATEGY 3: Check if member exists at all (regardless of email)
        if (memberQuery.empty) {
            console.log('üìç Strategy 3: Checking if member ID exists anywhere...');
            const idOnlyQuery = await db.collection('members')
                .where('id', '==', memberId)
                .limit(1)
                .get();
            
            if (!idOnlyQuery.empty) {
                const existingMember = idOnlyQuery.docs[0].data();
                console.log('‚ö†Ô∏è Member ID exists but email mismatch');
                console.log('   Registered email:', existingMember.email);
                console.log('   Your email:', currentUser.email);
                
                showNotification(
                    `‚ùå Member ID exists but email mismatch.\n\n` +
                    `This ID is registered with: ${existingMember.email}\n` +
                    `Your account: ${currentUser.email}\n\n` +
                    `Please use the correct Member ID for your email.`
                );
                return;
            }
            
            // Member doesn't exist at all
            console.log('‚ùå Member ID not found in database');
            showNotification(
                `‚ùå Member ID not found.\n\n` +
                `Please check:\n` +
                `1. ID format is correct (TSK-XXXXXX-XXX)\n` +
                `2. You are registered in TAU Africa\n` +
                `3. Your email matches: ${currentUser.email}\n\n` +
                `If you don't have a TAU Member ID, register at TAU Africa first.`
            );
            return;
        }
        
        // SUCCESS: Member found and email matches
        const memberDoc = memberQuery.docs[0];
        const memberData = memberDoc.data();
        console.log('‚úÖ Member verified:', memberData);
        
        // Extract member details
        const memberLevel = memberData.level || 1;
        const memberTeam = memberData.team || 'General';
        const memberName = memberData.fullName || memberData.name || 'Member';
        
        // Link Member ID to Kabiru user account
        console.log('üîó Linking to Kabiru account...');
        await db.collection('users').doc(currentUser.uid).update({
            tauMemberId: memberId,
            tauMemberName: memberName,
            tauMemberTeam: memberTeam,
            tauMemberLevel: memberLevel,
            tauMemberEmail: memberData.email,
            memberVerified: true,
            linkedAt: firebase.firestore.FieldValue.serverTimestamp()
        });
        
        // Update current user object
        currentUser.tauMemberId = memberId;
        currentUser.tauMemberLevel = memberLevel;
        currentUser.tauMemberName = memberName;
        currentUser.lastDeclarationDate = 0; // Will need to declare values
        
        // Set mining rate based on level
        const levelRates = {
            1: 0.005,   // Basic: 0.005 iKb/day
            2: 0.01,    // Community: 0.01 iKb/day
            3: 0.1,     // Sovereign: 0.1 iKb/day
            4: 0.2      // Elite: 0.2 iKb/day (if exists)
        };
        miningRate = levelRates[memberLevel] || 0.005;
        
        // Save to local storage
        await saveUserData();
        updateBalanceDisplay();
        
        // Success notification
        showNotification(
            `‚úÖ Member ID Verified Successfully!\n\n` +
            `Name: ${memberName}\n` +
            `Level: ${memberLevel}\n` +
            `Team: ${memberTeam}\n` +
            `Mining Rate: ${miningRate} iKb/day\n\n` +
            `‚ö†Ô∏è Next Step: Declare your values to activate mining!`
        );
        
        closeModal('memberIDModal');
        
        // Prompt to declare values
        setTimeout(() => {
            if (confirm('Would you like to declare your values now to start mining?')) {
                openValueModal();
            }
        }, 2000);
        
    } catch (error) {
        console.error('‚ùå Verification error:', error);
        console.error('Error code:', error.code);
        console.error('Error message:', error.message);
        
        let errorMsg = '‚ùå Verification failed.\n\n';
        
        if (error.code === 'permission-denied') {
            errorMsg += 'Database access denied. Please check Firebase security rules.';
        } else if (error.code === 'unavailable') {
            errorMsg += 'Cannot connect to database. Please check your internet connection.';
        } else {
            errorMsg += `Error: ${error.message}\n\nPlease try again or contact support.`;
        }
        
        showNotification(errorMsg);
    }
}

// HELPER: Check if Member ID is already linked (call this on app load)
async function checkExistingMemberLink() {
    if (!currentUser || !currentUser.uid || !db) return;
    
    try {
        const userDoc = await db.collection('users').doc(currentUser.uid).get();
        
        if (userDoc.exists) {
            const userData = userDoc.data();
            
            if (userData.tauMemberId && userData.memberVerified) {
                // Already linked
                currentUser.tauMemberId = userData.tauMemberId;
                currentUser.tauMemberLevel = userData.tauMemberLevel || 1;
                currentUser.tauMemberName = userData.tauMemberName || 'Member';
                currentUser.lastDeclarationDate = userData.lastDeclarationDate || 0;
                
                console.log('‚úÖ Member ID already linked:', currentUser.tauMemberId);
                console.log('üìÖ Last declaration:', new Date(currentUser.lastDeclarationDate));
                
                // Update mining rate
                const levelRates = {1: 0.005, 2: 0.01, 3: 0.1, 4: 0.2};
                miningRate = levelRates[currentUser.tauMemberLevel] || 0.005;
            }
        }
    } catch (error) {
        console.error('Error checking member link:', error);
    }
        }

        // Cash withdrawal functions
        function openCashWithdrawalModal() {
            document.getElementById('cashWithdrawalModal').style.display = 'block';
            const availableBalance = minedBalance + receivedBalance;
            document.getElementById('withdrawableBalance').textContent = availableBalance.toFixed(4) + ' iKb';
            document.getElementById('cashWithdrawAmount').value = '';
            document.getElementById('cashEquivalent').textContent = '0.00 KSH';
            document.getElementById('withdrawalPhone').value = currentUser ? currentUser.email : '';
            closeModal('walletModal');
        }

        function calculateCashEquivalent() {
            const ikbAmount = parseFloat(document.getElementById('cashWithdrawAmount').value) || 0;
            const kshAmount = ikbAmount * 100000;
            document.getElementById('cashEquivalent').textContent = kshAmount.toLocaleString('en-KE', {minimumFractionDigits: 2, maximumFractionDigits: 2}) + ' KSH';
        }

        async function submitCashWithdrawal() {
            const amount = parseFloat(document.getElementById('cashWithdrawAmount').value);
            const location = document.getElementById('pickupLocation').value;
            const phone = document.getElementById('withdrawalPhone').value.trim();
            const notes = document.getElementById('withdrawalNotes').value.trim();
            const availableBalance = minedBalance + receivedBalance;
            
            if (!amount || amount <= 0) {
                showNotification('‚ùå Please enter a valid amount');
                return;
            }
            
            if (amount > availableBalance) {
                showNotification(`‚ùå Insufficient balance. Available: ${availableBalance.toFixed(4)} iKb`);
                return;
            }
            
            if (!location) {
                showNotification('‚ùå Please select a pickup location');
                return;
            }
            
            if (!phone) {
                showNotification('‚ùå Please enter your phone number');
                return;
            }
            
            if (!phone.match(/^254[0-9]{9}$/)) {
                showNotification('‚ùå Invalid phone format. Use: 254XXXXXXXXX');
                return;
            }
            
            try {
                showNotification('‚è≥ Processing withdrawal request...');
                
                if (minedBalance >= amount) {
                    minedBalance -= amount;
                } else {
                    const remaining = amount - minedBalance;
                    minedBalance = 0;
                    receivedBalance -= remaining;
                }
                
                userBalance = minedBalance + receivedBalance;
                
                const withdrawalRequest = {
                    userId: currentUser.uid,
                    userEmail: currentUser.email,
                    userName: currentUser.displayName,
                    tauMemberId: currentUser.tauMemberId || 'Not linked',
                    tauMemberLevel: currentUser.tauMemberLevel || 1,
                    ikbAmount: amount,
                    kshAmount: amount * 100000,
                    pickupLocation: location,
                    contactPhone: phone,
                    notes: notes || 'None',
                    status: 'pending',
                    requestedAt: firebase.firestore.FieldValue.serverTimestamp(),
                    processedAt: null,
                    processedBy: null
                };
                
                const docRef = await db.collection('cashWithdrawals').add(withdrawalRequest);
                
                const transaction = {
                    id: generateTransactionId(),
                    type: 'cash_withdrawal',
                    amount: amount,
                    kshAmount: amount * 100000,
                    pickupLocation: location,
                    contactPhone: phone,
                    withdrawalId: docRef.id,
                    timestamp: new Date().toISOString(),
                    status: 'pending'
                };
                transactionHistory.unshift(transaction);
                
                if (transactionHistory.length > 50) {
                    transactionHistory = transactionHistory.slice(0, 50);
                }
                
                await saveUserData();
                updateBalanceDisplay();
                
                showNotification(`‚úÖ Withdrawal Request Submitted!\n\n${amount.toFixed(4)} iKb = ${(amount * 100000).toLocaleString()} KSH\n\nPickup: ${location}\nPhone: ${phone}\n\nüìû You will be contacted within 24-48 hours.`);
                
                document.getElementById('cashWithdrawAmount').value = '';
                document.getElementById('withdrawalNotes').value = '';
                document.getElementById('pickupLocation').value = '';
                
                closeModal('cashWithdrawalModal');
                
            } catch (error) {
                console.error('‚ùå Withdrawal error:', error);
                showNotification('‚ùå Withdrawal request failed. Please try again.');
            }
        }

        // Send KABIRU function
        async function sendKabiru() {
            const recipient = document.getElementById('sendRecipient').value.trim();
            const amount = parseFloat(document.getElementById('sendAmount').value);
            const fee = 0.0001;
            const totalAmount = amount + fee;
            const availableBalance = minedBalance + receivedBalance;
            
            if (!recipient) {
                showNotification('Please enter recipient email or address.');
                return;
            }
            
            if (!amount || amount <= 0) {
                showNotification('Please enter a valid amount.');
                return;
            }
            
            if (totalAmount > availableBalance) {
                showNotification('Insufficient balance. Available: ' + availableBalance.toFixed(4) + ' iKb');
                return;
            }
            
            try {
                if (minedBalance >= totalAmount) {
                    minedBalance -= totalAmount;
                } else {
                    const remainingAmount = totalAmount - minedBalance;
                    minedBalance = 0;
                    receivedBalance -= remainingAmount;
                }
                
                if (db && currentUser.uid !== 'offline-user') {
                    try {
                        const recipientQuery = await db.collection('users').where('email', '==', recipient).limit(1).get();
                        
                        if (!recipientQuery.empty) {
                            const recipientDoc = recipientQuery.docs[0];
                            const recipientId = recipientDoc.id;
                            
                            await db.collection('users').doc(recipientId).update({
                                receivedBalance: firebase.firestore.FieldValue.increment(amount)
                            });
                        } else {
                            showNotification('Recipient not found. Transaction recorded as pending.');
                        }
                    } catch (error) {
                        console.error('Error finding recipient:', error);
                    }
                }
                
                const transaction = {
                    id: generateTransactionId(),
                    type: 'send',
                    recipient: recipient,
                    amount: amount,
                    fee: fee,
                    timestamp: new Date().toISOString(),
                    status: 'completed'
                };
                transactionHistory.unshift(transaction);
                
                await saveUserData();
                updateBalanceDisplay();
                
                showNotification(`‚úÖ Successfully sent ${amount.toFixed(4)} iKb to ${recipient}!`);
                document.getElementById('sendRecipient').value = '';
                document.getElementById('sendAmount').value = '';
                closeModal('sendReceiveModal');
                
            } catch (error) {
                console.error('Send error:', error);
                showNotification('‚ùå Failed to send KABIRU. Please try again.');
            }
        }

        // Currency conversion functions
        function convertCurrency(type) {
            currentConversionType = type;
            document.getElementById('conversionModal').style.display = 'block';
            
            if (type === 'ikb_to_ikbp') {
                document.getElementById('conversionTitle').textContent = 'Convert iKb to iKbp';
                document.getElementById('conversionFromLabel').textContent = 'Amount in iKb:';
                document.getElementById('conversionRate').textContent = 'Exchange Rate: 1 iKb = 100,000 iKbp';
            } else if (type === 'ikb_to_ksh') {
                document.getElementById('conversionTitle').textContent = 'Convert iKb to KSH';
                document.getElementById('conversionFromLabel').textContent = 'Amount in iKb:';
                document.getElementById('conversionRate').textContent = 'Exchange Rate: 1 iKb = 100,000 KSH';
            }
            
            document.getElementById('conversionAmount').oninput = updateConversionResult;
        }

        function updateConversionResult() {
            const amount = parseFloat(document.getElementById('conversionAmount').value) || 0;
            let result = 0;
            
            if (currentConversionType === 'ikb_to_ikbp') {
                result = amount * 100000;
                document.getElementById('conversionResult').textContent = result.toLocaleString() + ' iKbp';
            } else if (currentConversionType === 'ikb_to_ksh') {
                result = amount * 100000;
                document.getElementById('conversionResult').textContent = result.toLocaleString() + ' KSH';
            }
        }

        async function executeConversion() {
            const amount = parseFloat(document.getElementById('conversionAmount').value);
            const availableBalance = minedBalance + receivedBalance;
            
            if (!amount || amount <= 0) {
                showNotification('Please enter a valid amount.');
                return;
            }
            
            if (amount > availableBalance) {
                showNotification('Insufficient iKb balance for conversion.');
                return;
            }
            
            try {
                if (minedBalance >= amount) {
                    minedBalance -= amount;
                } else {
                    const remainingAmount = amount - minedBalance;
                    minedBalance = 0;
                    receivedBalance -= remainingAmount;
                }
                
                let convertedAmount = 0;
                let transactionType = '';
                
                if (currentConversionType === 'ikb_to_ikbp') {
                    convertedAmount = amount * 100000;
                    kabiruPoints += convertedAmount;
                    transactionType = 'conversion_to_ikbp';
                    showNotification(`‚úÖ Converted ${amount.toFixed(4)} iKb to ${convertedAmount.toLocaleString()} iKbp!`);
                } else if (currentConversionType === 'ikb_to_ksh') {
                    convertedAmount = amount * 100000;
                    transactionType = 'conversion_to_ksh';
                    showNotification(`‚úÖ Converted ${amount.toFixed(4)} iKb to ${convertedAmount.toLocaleString()} KSH!`);
                }
                
                const transaction = {
                    id: generateTransactionId(),
                    type: transactionType,
                    amount: amount,
                    convertedAmount: convertedAmount,
                    timestamp: new Date().toISOString(),
                    status: 'completed'
                };
                transactionHistory.unshift(transaction);
                
                await saveUserData();
                updateBalanceDisplay();
                
                document.getElementById('conversionAmount').value = '';
                closeModal('conversionModal');
                
            } catch (error) {
                console.error('Conversion error:', error);
                showNotification('‚ùå Conversion failed. Please try again.');
            }
        }

        // Copy and share functions
        function copyReceiveAddress() {
            const address = userWalletAddress;
            if (navigator.clipboard) {
                navigator.clipboard.writeText(address).then(() => {
                    showNotification('üìã Wallet address copied to clipboard!');
                }).catch(err => {
                    fallbackCopyToClipboard(address);
                });
            } else {
                fallbackCopyToClipboard(address);
            }
        }

        function shareReceiveAddress() {
            const address = userWalletAddress;
            const shareText = `Send KABIRU tokens to my wallet address: ${address}`;
            
            if (navigator.share) {
                navigator.share({
                    title: 'My KABIRU Wallet Address',
                    text: shareText
                }).then(() => {
                    showNotification('üì± Wallet address shared successfully!');
                }).catch(() => {
                    fallbackShare(shareText);
                });
            } else {
                fallbackShare(shareText);
            }
        }

        function openSendReceiveModal() {
            document.getElementById('sendReceiveModal').style.display = 'block';
            document.getElementById('availableToSend').textContent = (minedBalance + receivedBalance).toFixed(4) + ' iKb';
            document.getElementById('receiveAddress').textContent = userWalletAddress || 'Loading...';
            closeModal('walletModal');
        }

        function openTransactionHistoryModal() {
            document.getElementById('transactionHistoryModal').style.display = 'block';
            displayTransactionHistory();
            closeModal('walletModal');
        }

        function displayTransactionHistory() {
            const transactionList = document.getElementById('transactionList');
            
            if (transactionHistory.length === 0) {
                transactionList.innerHTML = '<div style="text-align: center; opacity: 0.7; font-size: 14px; padding: 20px;">No transactions yet</div>';
                return;
            }
            
            let html = '';
            transactionHistory.slice(0, 20).forEach(tx => {
                const date = new Date(tx.timestamp).toLocaleDateString();
                const time = new Date(tx.timestamp).toLocaleTimeString();
                let icon = '‚ö°';
                let amountText = `+${tx.amount.toFixed(4)} iKb`;
                let description = '';
                
                switch (tx.type) {
                    case 'mining':
                        icon = '‚õèÔ∏è';
                        description = `${tx.subtype} mining`;
                        break;
                    case 'send':
                        icon = 'üì§';
                        amountText = `-${tx.amount.toFixed(4)} iKb`;
                        description = `Sent to ${tx.recipient}`;
                        break;
                    case 'receive':
                        icon = 'üì•';
                        description = `Received from ${tx.sender || 'Unknown'}`;
                        break;
                    case 'tau_transfer':
                        icon = 'üíé';
                        description = `Transfer from TAU Africa`;
                        break;
                    case 'cash_withdrawal':
                        icon = 'üíµ';
                        amountText = `-${tx.amount.toFixed(4)} iKb`;
                        description = `Cash withdrawal request`;
                        break;
                    case 'referral_bonus':
                        icon = 'üéÅ';
                        description = 'Referral bonus';
                        break;
                    case 'lockup':
                        icon = 'üîí';
                        amountText = `-${tx.amount.toFixed(4)} iKb`;
                        description = `Locked for ${tx.months} months`;
                        break;
                    case 'conversion_to_ikbp':
                        icon = 'üîÑ';
                        amountText = `-${tx.amount.toFixed(4)} iKb`;
                        description = `Converted to ${tx.convertedAmount.toLocaleString()} iKbp`;
                        break;
                    case 'conversion_to_ksh':
                        icon = 'üí±';
                        amountText = `-${tx.amount.toFixed(4)} iKb`;
                        description = `Converted to ${tx.convertedAmount.toLocaleString()} KSH`;
                        break;
                }
                
                html += `
                    <div style="background: rgba(255, 255, 255, 0.1); padding: 10px; border-radius: 8px; margin: 5px 0; display: flex; align-items: center; gap: 10px;">
                        <div style="font-size: 16px;">${icon}</div>
                        <div style="flex: 1;">
                            <div style="font-size: 12px; font-weight: bold;">${description}</div>
                            <div style="font-size: 10px; opacity: 0.7;">${date} ${time}</div>
                        </div>
                        <div style="font-size: 12px; font-weight: bold; color: ${tx.type === 'send' || tx.type === 'lockup' || tx.type.includes('conversion') || tx.type === 'cash_withdrawal' ? '#ff6b6b' : '#00ff87'};">${amountText}</div>
                    </div>
                `;
            });
            
            transactionList.innerHTML = html;
        }

        function startMiningCountdown() {
            const timerElement = document.getElementById('miningTimer');
            let seconds = 3;
            
            const countdown = setInterval(() => {
                timerElement.textContent = `Mining in progress... ${seconds}s`;
                seconds--;
                
                if (seconds < 0) {
                    clearInterval(countdown);
                    timerElement.textContent = 'Mining complete!';
                    setTimeout(() => {
                        timerElement.textContent = 'Ready to mine!';
                    }, 2000);
                }
            }, 1000);
        }

        function disableMiningButtons() {
            const buttons = document.querySelectorAll('.main-button, .value-item');
            buttons.forEach(btn => {
                btn.style.opacity = '0.5';
                btn.style.pointerEvents = 'none';
            });
        }

        function enableMiningButtons() {
            const buttons = document.querySelectorAll('.main-button, .value-item');
            buttons.forEach(btn => {
                btn.style.opacity = '1';
                btn.style.pointerEvents = 'auto';
            });
        }

        // Modal functions
        function openUtilitiesModal() {
            document.getElementById('utilitiesModal').style.display = 'block';
        }

        function openWalletModal() {
            document.getElementById('walletModal').style.display = 'block';
            document.getElementById('walletAddress').textContent = userWalletAddress || 'Not available';
            document.getElementById('walletMinedBalance').textContent = minedBalance.toFixed(4) + ' iKb';
            document.getElementById('walletReceivedBalance').textContent = receivedBalance.toFixed(4) + ' iKb';
            document.getElementById('walletLockedBalance').textContent = lockedBalance.toFixed(4) + ' iKb';
            document.getElementById('walletReserveBalance').textContent = reserveBalance.toFixed(4) + ' iKb';
            document.getElementById('walletTotalBalance').textContent = (minedBalance + receivedBalance + lockedBalance + reserveBalance).toFixed(4) + ' iKb';
        }
function openMemberIDLinkModal() {
        document.getElementById('memberIDModal').style.display = 'block';
        document.getElementById('linkMemberID').value = '';
}
        function openReadModal() {
            document.getElementById('readModal').style.display = 'block';
        }

        function openLanguageModal() {
            document.getElementById('languageModal').style.display = 'block';
        }

        function openUserAccountModal() {
            document.getElementById('userAccountModal').style.display = 'block';
            if (currentUser) {
                document.getElementById('modalUserAvatar').textContent = (currentUser.displayName || 'U').charAt(0).toUpperCase();
                document.getElementById('modalUserName').textContent = currentUser.displayName || 'Anonymous User';
                document.getElementById('modalUserEmail').textContent = currentUser.email || 'No email';
                document.getElementById('modalUserBalance').textContent = userBalance.toFixed(4) + ' iKb';
                document.getElementById('modalUserTasks').textContent = totalTasksCompleted;
                document.getElementById('currentLockedAmount').textContent = lockedBalance.toFixed(4) + ' iKb';
                
                const referralLink = generateReferralLink();
                document.getElementById('referralLink').textContent = referralLink;
            }
        }

        function openSovereignModal() {
            document.getElementById('sovereignModal').style.display = 'block';
            selectedSovereignType = null;
            document.getElementById('sovereignStartBtn').disabled = true;
        }

        function openValueModal() {
            document.getElementById('valueModal').style.display = 'block';
            selectedValueType = null;
            selectedValueAmount = null;
            document.getElementById('valueStartBtn').disabled = true;
        }

        function showReserveModal() {
            document.getElementById('reserveModal').style.display = 'block';
            document.getElementById('availableForReserve').textContent = (minedBalance + receivedBalance).toFixed(4) + ' iKb';
            document.getElementById('currentReserveAmount').textContent = reserveBalance.toFixed(4) + ' iKb';
            closeModal('userAccountModal');
        }

        function closeModal(modalId) {
            document.getElementById(modalId).style.display = 'none';
        }

        function selectLanguage(langCode) {
            showNotification(`Language changed to ${langCode === 'en' ? 'English' : langCode === 'sw' ? 'Kiswahili' : langCode === 'fr' ? 'Dho Luo' : 'Kikuyu'}`);
            closeModal('languageModal');
        }

        function selectSovereignValue(type, element) {
            document.querySelectorAll('#sovereignModal div[onclick]').forEach(div => {
                div.style.background = 'rgba(255, 255, 255, 0.1)';
            });
            
            element.style.background = 'rgba(255, 215, 0, 0.2)';
            selectedSovereignType = type;
            document.getElementById('sovereignStartBtn').disabled = false;
        }

        function selectValue(type, amount, element) {
            document.querySelectorAll('#valueModal div[onclick]').forEach(div => {
                div.style.background = 'rgba(255, 255, 255, 0.1)';
            });
            
            element.style.background = 'rgba(255, 215, 0, 0.2)';
            selectedValueType = type;
            selectedValueAmount = amount;
            document.getElementById('valueStartBtn').disabled = false;
        }

        function startSovereignMining() {
            if (selectedSovereignType) {
                closeModal('sovereignModal');
                mineTokens(selectedSovereignType, 0.003);
            }
        }

        function startValueMining() {
            if (selectedValueType && selectedValueAmount) {
                closeModal('valueModal');
                mineTokens(selectedValueType, selectedValueAmount);
            }
        }

        function generateReferralLink() {
            if (!referralCode) {
                referralCode = 'KABIRU_' + (currentUser?.uid?.substr(-6) || Math.random().toString(36).substr(2, 6)).toUpperCase();
            }
            const baseUrl = window.location.origin + window.location.pathname;
            return `${baseUrl}?ref=${referralCode}`;
        }

        function copyReferralLink() {
            const referralLink = generateReferralLink();
            if (navigator.clipboard) {
                navigator.clipboard.writeText(referralLink).then(() => {
                    showNotification('Referral link copied to clipboard!');
                }).catch(err => {
                    fallbackCopyToClipboard(referralLink);
                });
            } else {
                fallbackCopyToClipboard(referralLink);
            }
        }

        function fallbackCopyToClipboard(text) {
            const textArea = document.createElement('textarea');
            textArea.value = text;
            document.body.appendChild(textArea);
            textArea.focus();
            textArea.select();
            try {
                document.execCommand('copy');
                showNotification('Link copied to clipboard!');
            } catch (err) {
                showNotification('Could not copy link. Please copy manually.');
            }
            document.body.removeChild(textArea);
        }

        function shareReferralLink() {
    const referralLink = generateReferralLink();
    const shareText = `Join me on KABIRU and start mining iKb tokens! Use my referral link: ${referralLink}`;
    
    if (navigator.share) {
        // Native mobile/desktop share
        navigator.share({
            title: 'Join KABIRU Mining App',
            text: shareText,
            url: referralLink
        }).then(() => {
            showNotification('üì± Share dialog opened!');
        }).catch((err) => {
            console.log('Share cancelled or failed:', err);
            // User cancelled or error - show manual options
            showSocialShareOptions(referralLink, shareText);
        });
    } else {
        // Desktop fallback - show social media options
        showSocialShareOptions(referralLink, shareText);
    }
}

function showSocialShareOptions(link, text) {
    const encodedLink = encodeURIComponent(link);
    const encodedText = encodeURIComponent(text);
    
    // Create social share URLs
    const whatsappUrl = `https://wa.me/?text=${encodedText}`;
    const telegramUrl = `https://t.me/share/url?url=${encodedLink}&text=${encodedText}`;
    const twitterUrl = `https://twitter.com/intent/tweet?text=${encodedText}`;
    const facebookUrl = `https://www.facebook.com/sharer/sharer.php?u=${encodedLink}`;
    const emailUrl = `mailto:?subject=Join KABIRU Mining&body=${encodedText}`;
    
    // Show options modal
    const shareModal = `
        <div style="position: fixed; top: 0; left: 0; right: 0; bottom: 0; background: rgba(0,0,0,0.8); z-index: 9999; display: flex; align-items: center; justify-content: center;" id="socialShareModal" onclick="if(event.target.id==='socialShareModal') this.remove()">
            <div style="background: linear-gradient(135deg, #1a1a2e 0%, #16213e 100%); padding: 30px; border-radius: 20px; max-width: 350px; width: 90%;" onclick="event.stopPropagation()">
                <h3 style="color: #FFD700; margin-bottom: 20px; text-align: center;">Share Referral Link</h3>
                <div style="display: grid; gap: 10px;">
                    <a href="${whatsappUrl}" target="_blank" style="background: #25D366; color: white; padding: 12px; border-radius: 8px; text-decoration: none; text-align: center; font-weight: bold;">
                        üì± Share on WhatsApp
                    </a>
                    <a href="${telegramUrl}" target="_blank" style="background: #0088cc; color: white; padding: 12px; border-radius: 8px; text-decoration: none; text-align: center; font-weight: bold;">
                        ‚úàÔ∏è Share on Telegram
                    </a>
                    <a href="${twitterUrl}" target="_blank" style="background: #1DA1F2; color: white; padding: 12px; border-radius: 8px; text-decoration: none; text-align: center; font-weight: bold;">
                        üê¶ Share on Twitter
                    </a>
                    <a href="${facebookUrl}" target="_blank" style="background: #4267B2; color: white; padding: 12px; border-radius: 8px; text-decoration: none; text-align: center; font-weight: bold;">
                        üìò Share on Facebook
                    </a>
                    <a href="${emailUrl}" style="background: #EA4335; color: white; padding: 12px; border-radius: 8px; text-decoration: none; text-align: center; font-weight: bold;">
                        üìß Share via Email
                    </a>
                    <button onclick="navigator.clipboard.writeText('${link}').then(() => {showNotification('Link copied!'); document.getElementById('socialShareModal').remove();})" style="background: linear-gradient(45deg, #667eea, #764ba2); color: white; padding: 12px; border-radius: 8px; border: none; font-weight: bold; cursor: pointer;">
                        üìã Copy Link
                    </button>
                    <button onclick="document.getElementById('socialShareModal').remove()" style="background: rgba(255,255,255,0.1); color: white; padding: 12px; border-radius: 8px; border: none; cursor: pointer;">
                        Cancel
                    </button>
                </div>
            </div>
        </div>
    `;
    
    // Remove existing modal if any
    const existing = document.getElementById('socialShareModal');
    if (existing) existing.remove();
    
    // Add new modal
    document.body.insertAdjacentHTML('beforeend', shareModal);
}

function fallbackShare(text) {
    // This is now only used if absolutely necessary
    const textarea = document.createElement('textarea');
    textarea.value = text;
    document.body.appendChild(textarea);
    textarea.select();
    try {
        document.execCommand('copy');
        showNotification('Referral message copied! Paste it to share with friends.');
    } catch (err) {
        showNotification('Could not copy. Please copy the link manually.');
    }
    document.body.removeChild(textarea);
}

        async function lockupTokens(months) {
            const availableBalance = minedBalance + receivedBalance;
            
            if (availableBalance < 0.01) {
                showNotification('Insufficient balance for lockup. Minimum 0.01 iKb required.');
                return;
            }

            const lockupAmount = prompt(`Enter amount to lock for ${months} months (Available: ${availableBalance.toFixed(4)} iKb):`);
            
            if (!lockupAmount || isNaN(lockupAmount) || parseFloat(lockupAmount) <= 0) {
                showNotification('Invalid amount entered.');
                return;
            }

            const amount = parseFloat(lockupAmount);
            
            if (amount > availableBalance) {
                showNotification('Insufficient balance for this lockup amount.');
                return;
            }

            const bonusPercentage = months === 3 ? 0.05 : months === 6 ? 0.12 : 0.25;
            const bonus = amount * bonusPercentage;
            const unlockDate = new Date();
            unlockDate.setMonth(unlockDate.getMonth() + months);

            if (minedBalance >= amount) {
                minedBalance -= amount;
            } else {
                const remainingAmount = amount - minedBalance;
                minedBalance = 0;
                receivedBalance -= remainingAmount;
            }
            
            lockedBalance += amount + bonus;
            
            const lockupInfo = {
                amount: amount,
                bonus: bonus,
                months: months,
                lockDate: new Date().toISOString(),
                unlockDate: unlockDate.toISOString(),
                status: 'locked'
            };
            
            lockupPeriods.push(lockupInfo);
            
            const transaction = {
                id: generateTransactionId(),
                type: 'lockup',
                amount: amount,
                bonus: bonus,
                months: months,
                timestamp: new Date().toISOString(),
                status: 'completed'
            };
            transactionHistory.unshift(transaction);
            
            await saveUserData();
            updateBalanceDisplay();
            updateUserDisplay();
            
            showNotification(`Successfully locked ${amount.toFixed(4)} iKb for ${months} months with ${bonus.toFixed(4)} iKb bonus!`);
            closeModal('userAccountModal');
        }

        async function addToReserve() {
            const amount = parseFloat(document.getElementById('reserveAmount').value);
            const availableBalance = minedBalance + receivedBalance;
            
            if (!amount || amount <= 0) {
                showNotification('Please enter a valid amount.');
                return;
            }
            
            if (amount > availableBalance) {
                showNotification('Insufficient balance for this reserve amount.');
                return;
            }
            
            if (minedBalance >= amount) {
                minedBalance -= amount;
            } else {
                const remainingAmount = amount - minedBalance;
                minedBalance = 0;
                receivedBalance -= remainingAmount;
            }
            
            reserveBalance += amount;
            
            const transaction = {
                id: generateTransactionId(),
                type: 'reserve_add',
                amount: amount,
                timestamp: new Date().toISOString(),
                status: 'completed'
            };
            transactionHistory.unshift(transaction);
            
            await saveUserData();
            updateBalanceDisplay();
            
            showNotification(`Successfully added ${amount.toFixed(4)} iKb to reserves!`);
            document.getElementById('reserveAmount').value = '';
            showReserveModal();
        }

        async function withdrawFromReserve() {
            const amount = parseFloat(document.getElementById('reserveAmount').value);
            
            if (!amount || amount <= 0) {
                showNotification('Please enter a valid amount.');
                return;
            }
            
            if (amount > reserveBalance) {
                showNotification('Insufficient reserve balance for this withdrawal.');
                return;
            }
            
            reserveBalance -= amount;
            receivedBalance += amount;
            
            const transaction = {
                id: generateTransactionId(),
                type: 'reserve_withdraw',
                amount: amount,
                timestamp: new Date().toISOString(),
                status: 'completed'
            };
            transactionHistory.unshift(transaction);
            
            await saveUserData();
            updateBalanceDisplay();
            
            showNotification(`Successfully withdrew ${amount.toFixed(4)} iKb from reserves!`);
            document.getElementById('reserveAmount').value = '';
            showReserveModal();
        }

        // TAU-Kabiru Transfer Listener
        function listenForKabiruTransfers(memberEmail) {
            if (!memberEmail || !db) {
                console.log('‚ö†Ô∏è No email or database for transfer listener');
                return null;
            }
            
            console.log('üëÇ Listening for iKb transfers to:', memberEmail);
            
            return db.collection('members')
                .where('email', '==', memberEmail)
                .onSnapshot(snapshot => {
                    snapshot.forEach(doc => {
                        const data = doc.data();
                        
                        if (data.pendingKabiruTransfer && data.pendingKabiruTransfer.status === 'pending') {
                            const transfer = data.pendingKabiruTransfer;
                            
                            console.log('üíé Transfer detected:', transfer);
                            
                            const transferredIkb = transfer.iKb || 0;
                            const transferredIkbp = transfer.iKbp || 0;
                            
                            receivedBalance += transferredIkb;
                            kabiruPoints += transferredIkbp;
                            userBalance = minedBalance + receivedBalance;
                            
                            const transaction = {
                                id: generateTransactionId(),
                                type: 'tau_transfer',
                                iKb: transferredIkb,
                                iKbp: transferredIkbp,
                                timestamp: new Date().toISOString(),
                                status: 'completed'
                            };
                            transactionHistory.unshift(transaction);
                            
                            db.collection('members').doc(doc.id).update({
                                'pendingKabiruTransfer.status': 'completed',
                                'pendingKabiruTransfer.completedAt': firebase.firestore.FieldValue.serverTimestamp()
                            }).then(() => {
                                console.log('‚úÖ Transfer marked as completed');
                            });
                            
                            updateBalanceDisplay();
                            saveUserData();
                            
                            showNotification(`‚úÖ Received from TAU Africa!\n\n${transferredIkb.toFixed(4)} iKb${transferredIkbp > 0 ? '\n' + transferredIkbp.toLocaleString() + ' iKbp' : ''}\n\n‚õèÔ∏è Start mining to grow your balance!`);
                            
                            console.log('‚úÖ Transfer completed - Balances updated');
                        }
                    });
                }, error => {
                    console.error('‚ö†Ô∏è Transfer listener error:', error);
                });
        }

        document.addEventListener('DOMContentLoaded', function() {
            console.log('KABIRU Mining App starting...');
            setupAuthStateListener();
        });

        // UPDATED: Better auth state listener
function setupAuthStateListener() {
    if (!auth) {
        showOfflineLogin();
        return;
    }

    auth.onAuthStateChanged(async (user) => {
        console.log('üîÑ Auth state changed:', user ? user.uid : 'No user');
        
        if (user) {
            // Force reload to get latest verification status
            await user.reload();
            
            if (user.emailVerified) {
                console.log('‚úÖ User authenticated and verified');
                await loadUserData(user);
                showMiningApp();
            } else {
                console.log('‚ö†Ô∏è User not verified, showing verification screen');
                showEmailVerification();
            }
        } else {
            console.log('üë§ No authenticated user, showing login');
            showLoginPage();
        }
    });
    }

        function showOfflineLogin() {
            showNotification('Running in offline mode - you can still mine tokens!');
            initOfflineMode();
        }

//============================================
// STEP 1: Enhanced User Registration with Referral Tracking
// ============================================
// REPLACE your existing loadUserData function with this:

   async function loadUserData(firebaseUser) {
    try {
        console.log('üìä Loading user data for:', firebaseUser.uid);
        
        const userDoc = await db.collection('users').doc(firebaseUser.uid).get();
        
        // DECLARE userData HERE so it's accessible throughout the function
        let userData = null;
        
        if (userDoc.exists) {
            // EXISTING USER - Load their data
            userData = userDoc.data();
            
            // Load TAU Member verification
            if (userData.tauMemberId) {
                try {
                    const memberQuery = await db.collection('members')
                        .where('id', '==', userData.tauMemberId)
                        .limit(1)
                        .get();
                    
                    if (!memberQuery.empty) {
                        const memberData = memberQuery.docs[0].data();
                        const memberLevel = memberData.level || 1;
                        
                        const levelRates = {
                            1: 0.005,  // Basic
                            2: 0.01,   // Community
                            3: 0.1,    // Sovereign
                            4: 0.2     // Elite
                        };
                        
                        miningRate = levelRates[memberLevel] || 0.005;
                        
                        console.log(`‚ö° Mining rate: ${miningRate} iKb/day (Level ${memberLevel})`);
                    }
                } catch (error) {
                    console.error('Error loading member level:', error);
                }
            }
            
            // Load user balances
            minedBalance = userData.minedBalance || 0.0000;
            receivedBalance = userData.receivedBalance || 0.0000;
            userBalance = minedBalance + receivedBalance;
            reserveBalance = userData.reserveBalance || 0.0000;
            lockedBalance = userData.lockedBalance || 0.0000;
            kabiruPoints = userData.kabiruPoints || 0.0000;
            totalTasksCompleted = userData.tasksCompleted || 0;
            miningRate = userData.miningRate || 0.005;
            userWalletAddress = userData.walletAddress || generateWalletAddress();
            transactionHistory = userData.transactionHistory || [];
            referralCode = userData.referralCode || '';
            lockupPeriods = userData.lockupPeriods || [];
            
            console.log('‚úÖ User data loaded - Balance:', userBalance.toFixed(4));
            
        } else {
            // NEW USER - Check for referral code and process signup
            console.log('üÜï New user registration');
            
            userWalletAddress = generateWalletAddress();
            referralCode = 'KABIRU_' + firebaseUser.uid.substr(-6).toUpperCase();
            
            const urlParams = new URLSearchParams(window.location.search);
            const referralCodeParam = urlParams.get('ref');
            
            let referrerId = null;
            let welcomeBonus = 0;
            
            if (referralCodeParam) {
                try {
                    console.log('üîç Processing referral code:', referralCodeParam);
                    
                    const referrerQuery = await db.collection('users')
                        .where('referralCode', '==', referralCodeParam)
                        .limit(1)
                        .get();
                    
                    if (!referrerQuery.empty) {
    const referrerDoc = referrerQuery.docs[0];
    referrerId = referrerDoc.id;
    const referrerData = referrerDoc.data();
    
    console.log('‚úÖ Valid referrer found');
    
    // Give new user their welcome bonus
    welcomeBonus = 0.01;
    receivedBalance = welcomeBonus;
    userBalance = welcomeBonus;
    
    // Try to give referrer their signup bonus
    const signupBonus = 0.005;

    try {
        await db.runTransaction(async (transaction) => {
            const referrerRef = db.collection('users').doc(referrerId);
            const referrerSnapshot = await transaction.get(referrerRef);
            
            // ‚úÖ SAFETY CHECK: Only proceed if referrer still exists
            if (!referrerSnapshot.exists) {
                console.warn('‚ö†Ô∏è Referrer was deleted - new user still gets bonus');
                return;  // ‚úÖ NEW: Exit gracefully instead of throwing error
                }
                                
                                const referrerCurrentData = referrerSnapshot.data();
                                
                                const newReceivedBalance = (referrerCurrentData.receivedBalance || 0) + signupBonus;
                                const newTotalReferrals = (referrerCurrentData.totalReferrals || 0) + 1;
                                const newTotalEarnings = (referrerCurrentData.totalReferralEarnings || 0) + signupBonus;
                                
                                console.log('üìä Referrer update:', {
                                    oldBalance: referrerCurrentData.receivedBalance || 0,
                                    newBalance: newReceivedBalance,
                                    bonus: signupBonus,
                                    totalReferrals: newTotalReferrals
                                });
                                
                                const currentTxHistory = referrerCurrentData.transactionHistory || [];
                                const newTransaction = {
                                    id: generateTransactionId(),
                                    type: 'referral_signup_bonus',
                                    amount: signupBonus,
                                    from: firebaseUser.uid,
                                    fromEmail: firebaseUser.email,
                                    fromName: firebaseUser.displayName || 'New User',
                                    timestamp: new Date().toISOString(),
                                    status: 'completed'
                                };
                                
                                currentTxHistory.unshift(newTransaction);
                                const trimmedHistory = currentTxHistory.slice(0, 50);
                                
                                transaction.update(referrerRef, {
                                    receivedBalance: newReceivedBalance,
                                    totalReferrals: newTotalReferrals,
                                    totalReferralEarnings: newTotalEarnings,
                                    transactionHistory: trimmedHistory,
                                    lastReferralBonus: firebase.firestore.FieldValue.serverTimestamp()
                                });
                            });
                            
                            console.log('‚úÖ Signup bonus credited to referrer:', signupBonus);
                            
                        } catch (txError) {
                            console.error('‚ùå Referral transaction failed:', txError);
                            console.error('   Error details:', txError.message);
                            // Even if referrer bonus fails, new user still gets welcome bonus
                        }
                        
                        // Add transaction to NEW USER's history
                        transactionHistory.push({
                            id: generateTransactionId(),
                            type: 'referral_welcome_bonus',
                            amount: welcomeBonus,
                            from: 'system',
                            referrer: referrerData.email,
                            referrerId: referrerId,
                            timestamp: new Date().toISOString(),
                            status: 'completed'
                        });
                        
                        showNotification(`üéâ Welcome! +${welcomeBonus.toFixed(4)} iKb bonus for joining through referral!`);
                        
                    } else {
                        console.log('‚ö†Ô∏è Referral code not found:', referralCodeParam);
                        showNotification('‚ö†Ô∏è Invalid referral code. Signing up without referral bonus.');
                    }
                } catch (error) {
                    console.error('‚ùå Error processing referral:', error);
                    console.error('   Referral code:', referralCodeParam);
                    // Continue with signup even if referral processing fails
                }
            }
            
            // Create new user document
            const newUserData = {
                uid: firebaseUser.uid,
                email: firebaseUser.email,
                displayName: firebaseUser.displayName || 'Anonymous User',
                balance: userBalance,
                minedBalance: 0.0000,
                receivedBalance: receivedBalance,
                reserveBalance: 0.0000,
                lockedBalance: 0.0000,
                kabiruPoints: 0.0000,
                tasksCompleted: 0,
                miningRate: 0.005,
                walletAddress: userWalletAddress,
                transactionHistory: transactionHistory,
                referralCode: referralCode,
                referredBy: referrerId,
                totalReferrals: 0,
                totalReferralEarnings: 0,
                lockupPeriods: [],
                createdAt: firebase.firestore.FieldValue.serverTimestamp(),
                lastActive: firebase.firestore.FieldValue.serverTimestamp()
            };
            
            await db.collection('users').doc(firebaseUser.uid).set(newUserData);
            console.log('‚úÖ New user created with referral tracking');
            
            // Set userData for new user
            userData = newUserData;
            
            if (referralCodeParam) {
                window.history.replaceState({}, document.title, window.location.pathname);
            }
        }
        
        // Create currentUser object - NOW userData is ALWAYS defined
        currentUser = {
            uid: firebaseUser.uid,
            email: firebaseUser.email,
            displayName: firebaseUser.displayName || userData?.displayName || 'Anonymous User',
            balance: userBalance,
            tasksCompleted: totalTasksCompleted,
            miningRate: miningRate,
            walletAddress: userWalletAddress,
            tauMemberId: userData?.tauMemberId || null,
            tauMemberLevel: userData?.tauMemberLevel || null,
            referredBy: userData?.referredBy || null,
            totalReferrals: userData?.totalReferrals || 0,
            totalReferralEarnings: userData?.totalReferralEarnings || 0
        };

        // CRITICAL: Update UI immediately after creating currentUser
        console.log('‚úÖ Current user created:', {
            displayName: currentUser.displayName,
            email: currentUser.email,
            balance: currentUser.balance
        });
        
        // UPDATE THE UI
        updateUserDisplay();
        
        // Start transfer listener
        if (firebaseUser && firebaseUser.email) {
            console.log('üîó Starting transfer listener');
            transferListener = listenForKabiruTransfers(firebaseUser.email);
        }
        
    } catch (error) {
        console.error('‚ùå Error loading user data:', error);
        // Initialize defaults
        userBalance = 0.0000;
        minedBalance = 0.0000;
        receivedBalance = 0.0000;
        reserveBalance = 0.0000;
        lockedBalance = 0.0000;
        kabiruPoints = 0.0000;
        totalTasksCompleted = 0;
        miningRate = 0.005;
        userWalletAddress = generateWalletAddress();
        transactionHistory = [];
        referralCode = '';
        lockupPeriods = [];
    }
    }
        async function checkReferralBonus() {
            const urlParams = new URLSearchParams(window.location.search);
            const referralCodeParam = urlParams.get('ref');
            
            if (referralCodeParam && referralCodeParam !== referralCode) {
                try {
                    const referrerQuery = await db.collection('users').where('referralCode', '==', referralCodeParam).limit(1).get();
                    
                    if (!referrerQuery.empty) {
                        const referrerDoc = referrerQuery.docs[0];
                        const referrerId = referrerDoc.id;
                        
                        receivedBalance += 0.01;
                        userBalance = minedBalance + receivedBalance;
                        
                        await db.collection('users').doc(referrerId).update({
                            receivedBalance: firebase.firestore.FieldValue.increment(0.005)
                        });
                        
                        const transaction = {
                            id: generateTransactionId(),
                            type: 'referral_bonus',
                            amount: 0.01,
                            referrer: referralCodeParam,
                            timestamp: new Date().toISOString(),
                            status: 'completed'
                        };
                        transactionHistory.unshift(transaction);
                        
                        showNotification('Welcome bonus: +0.01 iKb for joining through referral!');
                        console.log('Referral bonus awarded');
                        
                        window.history.replaceState({}, document.title, window.location.pathname);
                    }
                } catch (error) {
                    console.error('Error processing referral:', error);
                }
            }
        }

        function generateWalletAddress() {
            const chars = '0123456789abcdef';
            let address = '0x';
            for (let i = 0; i < 40; i++) {
                address += chars[Math.floor(Math.random() * chars.length)];
            }
            return address;
        }

        function updateUserDisplay() {
            if (!currentUser) return;
            
            document.getElementById('userName').textContent = currentUser.displayName || 'Anonymous User';
            document.getElementById('userEmail').textContent = currentUser.email || 'No email';
            document.getElementById('userAvatar').textContent = (currentUser.displayName || 'U').charAt(0).toUpperCase();
            
            updateBalanceDisplay();
            document.getElementById('tasksCompleted').textContent = totalTasksCompleted;
            document.getElementById('miningRate').textContent = miningRate.toFixed(3);
        }

        function updateBalanceDisplay() {
            userBalance = minedBalance + receivedBalance;
            
            const balanceText = userBalance.toFixed(4) + ' iKb';
            document.getElementById('balance').textContent = balanceText;
            document.getElementById('totalBalance').textContent = balanceText;
            document.getElementById('userAccountBalance').textContent = balanceText;
        }

        function generateTransactionId() {
            return 'tx_' + Date.now() + '_' + Math.random().toString(36).substr(2, 9);
        }

        async function handleLogin() {
            const email = document.getElementById('loginEmail').value.trim();
            const password = document.getElementById('loginPassword').value;
            
            if (!email || !password) {
                showError('Please fill in all fields');
                return;
            }
            
            if (!isValidEmail(email)) {
                showError('Please enter a valid email address');
                return;
            }
            
            if (!auth) {
                currentUser = {
                    uid: 'offline-user',
                    email: email,
                    displayName: email.split('@')[0],
                    balance: userBalance,
                    tasksCompleted: totalTasksCompleted,
                    miningRate: miningRate,
                    walletAddress: generateWalletAddress()
                };
                userWalletAddress = currentUser.walletAddress;
                showSuccess('Logged in offline mode! You can start mining.');
                setTimeout(() => {
                    showMiningApp();
                }, 1500);
                return;
            }
            
            try {
                hideMessages();
                document.querySelector('#loginContainer .auth-button').textContent = 'Signing in...';
                document.querySelector('#loginContainer .auth-button').disabled = true;
                
                const userCredential = await auth.signInWithEmailAndPassword(email, password);
                const user = userCredential.user;
                
                if (!user.emailVerified) {
                    showError('Please verify your email address first. Check your inbox for the verification link.');
                    document.querySelector('#loginContainer .auth-button').textContent = 'Sign In';
                    document.querySelector('#loginContainer .auth-button').disabled = false;
                    return;
                }
                
                console.log('Login successful');
                showSuccess('Login successful! Loading your mining dashboard...');
                
            } catch (error) {
                console.error('Login error:', error);
                document.querySelector('#loginContainer .auth-button').textContent = 'Sign In';
                document.querySelector('#loginContainer .auth-button').disabled = false;
                
                let errorMessage = 'Login failed. ';
                switch (error.code) {
                    case 'auth/user-not-found':
                        errorMessage = 'No account found with this email. Please sign up first.';
                        break;
                    case 'auth/wrong-password':
                        errorMessage = 'Incorrect password. Please try again.';
                        break;
                    case 'auth/invalid-email':
                        errorMessage = 'Please enter a valid email address.';
                        break;
                    case 'auth/too-many-requests':
                        errorMessage = 'Too many failed attempts. Please try again later.';
                        break;
                    default:
                        errorMessage += error.message;
                }
                showError(errorMessage);
            }
        }

        async function handleSignup() {
            const name = document.getElementById('signupName').value.trim();
            const email = document.getElementById('signupEmail').value.trim();
            const password = document.getElementById('signupPassword').value;
            const confirmPassword = document.getElementById('confirmPassword').value;
            
            if (!name) {
                showError('Please enter your full name');
                return;
            }
            
            if (!email) {
                showError('Please enter your email address');
                return;
            }
            
            if (!isValidEmail(email)) {
                showError('Please enter a valid email address');
                return;
            }
            
            if (!password) {
                showError('Please create a password');
                return;
            }
            
            if (password.length < 6) {
                showError('Password must be at least 6 characters long');
                return;
            }
            
            if (password !== confirmPassword) {
                showError('Passwords do not match');
                return;
            }
            
            if (!auth) {
                showError('Signup requires internet connection. Please try again later.');
                return;
            }
            
            try {
                hideMessages();
                document.querySelector('#signupContainer .auth-button').textContent = 'Creating Account...';
                document.querySelector('#signupContainer .auth-button').disabled = true;
                
                const userCredential = await auth.createUserWithEmailAndPassword(email, password);
                const user = userCredential.user;
                
                await user.updateProfile({
                    displayName: name
                });
                // IMMEDIATE email verification with retry logic
let emailSent = false;
let retryCount = 0;
const maxRetries = 3;

while (!emailSent && retryCount < maxRetries) {
    try {
        console.log(`üìß Sending verification email (attempt ${retryCount + 1})...`);
        
        await user.sendEmailVerification({
            url: window.location.href, // Use current URL
            handleCodeInApp: false
        });
        
        emailSent = true;
        console.log('‚úÖ Verification email sent successfully!');
        
    } catch (emailError) {
        retryCount++;
        console.warn(`‚ö†Ô∏è Email send attempt ${retryCount} failed:`, emailError.message);
        
        if (retryCount < maxRetries) {
            // Wait 2 seconds before retry
            await new Promise(resolve => setTimeout(resolve, 2000));
        } else {
            console.error('‚ùå All email send attempts failed');
            throw new Error('Failed to send verification email after 3 attempts');
        }
    }
}

console.log('‚úÖ Account created, verification email sent');
showSuccess(`‚úÖ Account Created!\n\nüìß Verification email sent to:\n${email}\n\nCheck your inbox (and spam folder) now!`);

// Auto-open email verification screen
setTimeout(() => {
    showEmailVerification();
}, 1500);

        function showLoginPage() {
            document.getElementById('loginPage').style.display = 'flex';
            document.getElementById('miningApp').style.display = 'none';
            showLogin();
        }

        function showMiningApp() {
            document.getElementById('loginPage').style.display = 'none';
            document.getElementById('miningApp').style.display = 'block';
            showMain();
            updateUserDisplay();
        }

        function showMain() {
            document.getElementById('mainPage').classList.add('active');
        }

        function showLogin() {
            hideAllContainers();
            document.getElementById('loginContainer').style.display = 'block';
            hideMessages();
        }

        function showSignup() {
            hideAllContainers();
            document.getElementById('signupContainer').style.display = 'block';
            hideMessages();
        }

        function showPasswordReset() {
            hideAllContainers();
            document.getElementById('passwordResetContainer').style.display = 'block';
            hideMessages();
        }

        function showEmailVerification() {
            hideAllContainers();
            document.getElementById('emailVerificationContainer').style.display = 'block';
            hideMessages();
        }

        function hideAllContainers() {
            const containers = [
                'loginContainer',
                'signupContainer', 
                'passwordResetContainer',
                'emailVerificationContainer'
            ];
            
            containers.forEach(id => {
                document.getElementById(id).style.display = 'none';
            });
        }

        function selectTask(taskType) {
            document.querySelectorAll('.task-category').forEach(cat => {
                cat.classList.remove('active');
            });
            event.target.classList.add('active');
            showNotification(`Selected ${taskType} task category`);
        }

        function isValidEmail(email) {
            const emailRegex = /^[^\s@]+@[^\s@]+\.[^\s@]+$/;
            return emailRegex.test(email);
        }

        function togglePassword(inputId) {
            const passwordInput = document.getElementById(inputId);
            const toggleButton = passwordInput.nextElementSibling;
            
            if (passwordInput.type === 'password') {
                passwordInput.type = 'text';
                toggleButton.textContent = 'üôà';
            } else {
                passwordInput.type = 'password';
                toggleButton.textContent = 'üëÅ';
            }
        }

        function showError(message) {
            hideMessages();
            document.getElementById('errorText').textContent = message;
            document.getElementById('errorMessage').style.display = 'block';
            setTimeout(() => {
                document.getElementById('errorMessage').style.display = 'none';
            }, 5000);
        }

        function showSuccess(message) {
            hideMessages();
            document.getElementById('successText').textContent = message;
            document.getElementById('successMessage').style.display = 'block';
            setTimeout(() => {
                document.getElementById('successMessage').style.display = 'none';
            }, 3000);
        }

        function hideMessages() {
            document.getElementById('errorMessage').style.display = 'none';
            document.getElementById('successMessage').style.display = 'none';
        }

        function showNotification(message) {
            const notification = document.getElementById('notification');
            notification.textContent = message;
            notification.classList.add('show');
            
            setTimeout(() => {
                notification.classList.remove('show');
            }, 3000);
        }

        async function logout() {
            try {
                await saveUserData();
                
                if (transferListener) {
                    transferListener();
                    transferListener = null;
                }
                
                if (auth) {
                    await auth.signOut();
                }
                
                currentUser = null;
                userBalance = 0.0000;
                minedBalance = 0.0000;
                receivedBalance = 0.0000;
                reserveBalance = 0.0000;
                lockedBalance = 0.0000;
                kabiruPoints = 0.0000;
                totalTasksCompleted = 0;
                miningRate = 0.001;
                isMining = false;
                userWalletAddress = '';
                transactionHistory = [];
                referralCode = '';
                lockupPeriods = [];
                
                localStorage.removeItem('kabiruMiningData');
                
                showNotification('Logged out successfully');
                console.log('User logged out');
                showLoginPage();
                
            } catch (error) {
                console.error('Logout error:', error);
                showNotification('Logout completed');
                showLoginPage();
            }
        }

        // Replace your checkEmailVerification() function with this:

async function checkEmailVerification() {
    if (!auth || !auth.currentUser) {
        showError('No user session found. Please try logging in again.');
        setTimeout(() => {
            showLogin();
        }, 2000);
        return;
    }
    
    try {
        // Show loading state
        const verifyButton = document.querySelector('#emailVerificationContainer .auth-button');
        const originalText = verifyButton.textContent;
        verifyButton.textContent = 'Checking verification...';
        verifyButton.disabled = true;
        
        // IMPORTANT: Force refresh user data from Firebase
        console.log('üîµ Reloading user data from Firebase...');
        await auth.currentUser.reload();
        
        // Small delay to ensure Firebase has updated
        await new Promise(resolve => setTimeout(resolve, 1000));
        
        // Check verification status
        const isVerified = auth.currentUser.emailVerified;
        console.log('üìß Email verified status:', isVerified);
        
        if (isVerified) {
            console.log('‚úÖ Email verification confirmed!');
            showSuccess('Email verified successfully! Loading your account...');
            
            // Wait a moment then proceed to app
            setTimeout(async () => {
                await loadUserData(auth.currentUser);
                showMiningApp();
            }, 1500);
        } else {
            console.log('‚ö†Ô∏è Email not yet verified');
            // Reset button
            verifyButton.textContent = originalText;
            verifyButton.disabled = false;
            
            showError('Email not yet verified. Please click the verification link in your email, then click this button again.');
        }
        
    } catch (error) {
        console.error('‚ùå Verification check error:', error);
        showError('Error checking verification status: ' + error.message);
        
        // Reset button
        const verifyButton = document.querySelector('#emailVerificationContainer .auth-button');
        verifyButton.textContent = "I've Verified My Email";
        verifyButton.disabled = false;
    }
}

// ALSO ADD THIS: Auto-check on page load if coming from email link
document.addEventListener('DOMContentLoaded', function() {
    console.log('KABIRU Mining App starting...');
    
    // Check if user is coming from email verification link
    const urlParams = new URLSearchParams(window.location.search);
    const mode = urlParams.get('mode');
    const oobCode = urlParams.get('oobCode');
    
    if (mode === 'verifyEmail' && oobCode) {
        console.log('üîó Email verification link detected!');
        // Show a loading message while we process the verification
        showNotification('Processing email verification...');
        
        // Wait for Firebase to initialize, then handle verification
        setTimeout(() => {
            handleEmailVerificationFromLink(oobCode);
        }, 2000);
    } else {
        // Normal app startup
        setupAuthStateListener();
    }
});

// NEW FUNCTION: Handle verification when coming from email link
async function handleEmailVerificationFromLink(oobCode) {
    try {
        // Apply the email verification code
        console.log('üîµ Applying verification code...');
        await auth.applyActionCode(oobCode);
        console.log('‚úÖ Email verification applied!');
        
        // Clean up URL (remove verification parameters)
        const cleanUrl = window.location.origin + window.location.pathname;
        window.history.replaceState({}, document.title, cleanUrl);
        
        // Check if user is already signed in
        if (auth.currentUser) {
            // Reload to get updated verification status
            await auth.currentUser.reload();
            
            showSuccess('Email verified successfully! Loading your account...');
            setTimeout(async () => {
                await loadUserData(auth.currentUser);
                showMiningApp();
            }, 1500);
        } else {
            // User not signed in, show success and ask them to login
            showSuccess('Email verified successfully! Please sign in to continue.');
            setTimeout(() => {
                showLogin();
            }, 2000);
        }
        
    } catch (error) {
        console.error('‚ùå Verification error:', error);
        
        let errorMessage = 'Email verification failed. ';
        switch (error.code) {
            case 'auth/expired-action-code':
                errorMessage = 'This verification link has expired. Please request a new one.';
                break;
            case 'auth/invalid-action-code':
                errorMessage = 'This verification link is invalid or has already been used.';
                break;
            case 'auth/user-disabled':
                errorMessage = 'This account has been disabled.';
                break;
            case 'auth/user-not-found':
                errorMessage = 'No account found for this verification link.';
                break;
            default:
                errorMessage += error.message;
        }
        
        showError(errorMessage);
        setTimeout(() => {
            showLogin();
        }, 3000);
    }
}


        function resendEmailVerification() {
            if (auth && auth.currentUser) {
                auth.currentUser.sendEmailVerification().then(() => {
                    showNotification('Verification email resent!');
                }).catch(error => {
                    showError('Failed to resend verification email: ' + error.message);
                });
            }
        }

        async function handlePasswordReset() {
            const email = document.getElementById('resetEmail').value.trim();
            if (!email) {
                showError('Please enter your email address');
                return;
            }
            
            if (!auth) {
                showError('Password reset requires internet connection.');
                return;
            }

            try {
                await auth.sendPasswordResetEmail(email);
                showSuccess('Password reset email sent! Check your inbox.');
                setTimeout(() => showLogin(), 2000);
            } catch (error) {
                showError('Failed to send reset email: ' + error.message);
            }
        }

        document.addEventListener('keydown', function(e) {
            if (e.key === 'Enter') {
                const activeContainer = document.querySelector('#loginPage [style*="display: block"]');
                if (activeContainer) {
                    if (activeContainer.id === 'loginContainer') {
                        handleLogin();
                    } else if (activeContainer.id === 'signupContainer') {
                        handleSignup();
                    } else if (activeContainer.id === 'passwordResetContainer') {
                        handlePasswordReset();
                    }
                }
            }
        });

        window.onclick = function(event) {
            const modals = document.querySelectorAll('.modal');
            modals.forEach(modal => {
                if (event.target == modal) {
                    modal.style.display = 'none';
                }
            });
        }

        console.log('‚úÖ KABIRU Mining App - Fully Loaded & Ready!');
    </script>
    <script>
    (function() {
    'use strict';
    
    console.log('üåâ TAU-Kabiru Bridge - Initializing...');
    
    // ============================================
    // FIREBASE CONFIG (Same for both apps)
    // ============================================
    
         // Firebase Configuration
        const firebaseConfig = {
            apiKey: "AIzaSyCZhPjrl18PuyBh01Ou2KQMs-Ph3x2GP7o",
            authDomain: "kabiru-mining-app.firebaseapp.com",
            projectId: "kabiru-mining-app",
            storageBucket: "kabiru-mining-app.appspot.com",
            messagingSenderId: "217095254990",
            appId: "1:217095254990:web:9eb44eff825666995fb19f",
            measurementId: "G-W6070RT4PB"
        };

    
    let db, isKabiruApp = false;
    
    // Detect which app this is
    if (window.location.href.includes('kabiru-mining-app')) {
        isKabiruApp = true;
        console.log('üìç Detected: kabiru mining app');
    } else {
        console.log('üìç Detected: TAU Main App');
    }
    
    // Initialize Firebase
    try {
        if (!firebase.apps.length) {
            firebase.initializeApp(firebaseConfig);
        }
        db = firebase.firestore();
        console.log('‚úÖ Firebase connected');
    } catch (error) {
        console.error('‚ùå Firebase init failed:', error);
        db = null;
    }
    
    // ============================================
    // MAIN APP SIDE: Enhanced Withdrawal
    // ============================================
    if (!isKabiruApp && db) {
        
        window.initiateKabiruWithdrawal = async function() {
            const currentMember = window.TauDB?.getCurrentMember();
            
            if (!currentMember) {
                if (typeof showNotification === 'function') {
                    showNotification('Please login first', 'error');
                }
                return;
            }
            
            const availableIkbp = currentMember.iKbpBalance || 0;
            const availableIkb = currentMember.iKbBalance || 0;
            
            // Minimum check
            if (availableIkbp < 10000 && availableIkb < 0.0001) {
                if (typeof showNotification === 'function') {
                    showNotification('‚ùå Minimum: 10,000 iKbp or 0.0001 iKb', 'error');
                }
                return;
            }
            
            const confirmMsg = `Transfer to Kabiru Mining App?\n\n` +
                              `${availableIkbp.toLocaleString()} iKbp\n` +
                              `${availableIkb.toFixed(6)} iKb\n\n` +
                              `This will zero your TAU balance and credit Kabiru.`;
            
            if (!confirm(confirmMsg)) return;
            
            try {
                // Create transfer record
                const transferId = 'XFER-' + Date.now();
                
                await db.collection('kabiru_transfers').add({
                    transferId: transferId,
                    memberId: currentMember.id,
                    memberName: currentMember.fullName,
                    memberEmail: currentMember.email,
                    iKbp: availableIkbp,
                    iKb: availableIkb,
                    timestamp: firebase.firestore.FieldValue.serverTimestamp(),
                    status: 'pending',
                    direction: 'tau_to_kabiru'
                });
                
                // Update member document
                await db.collection('members').doc(currentMember.id).update({
                    pendingKabiruTransfer: {
                        transferId: transferId,
                        iKbp: availableIkbp,
                        iKb: availableIkb,
                        timestamp: new Date().toISOString(),
                        status: 'pending'
                    },
                    lastTransferToKabiru: new Date().toISOString()
                });
                
                // Zero out TAU balances locally
                const members = JSON.parse(localStorage.getItem('tauAfricaDB') || '[]');
                const memberIndex = members.findIndex(m => m.id === currentMember.id);
                if (memberIndex !== -1) {
                    members[memberIndex].iKbpBalance = 0;
                    members[memberIndex].iKbBalance = 0;
                    members[memberIndex].pendingKabiruTransfer = {
                        transferId: transferId,
                        iKbp: availableIkbp,
                        iKb: availableIkb,
                        status: 'pending'
                    };
                    localStorage.setItem('tauAfricaDB', JSON.stringify(members));
                    
                    // Update session
                    sessionStorage.setItem('tauCurrentUser', JSON.stringify(members[memberIndex]));
                }
                
                if (typeof showNotification === 'function') {
                    showNotification('‚úÖ Transfer initiated! Open Kabiru Mining App to receive.', 'success');
                }
                
                // Show transfer ID
                alert(`Transfer ID: ${transferId}\n\nOpen Kabiru Mining App and login to receive your tokens.`);
                
                console.log('‚úÖ Transfer created:', transferId);
                
            } catch (error) {
                console.error('‚ùå Transfer failed:', error);
                if (typeof showNotification === 'function') {
                    showNotification('‚ùå Transfer failed: ' + error.message, 'error');
                }
            }
        };
        
        console.log('‚úÖ Main App: Withdrawal function enhanced');
    }
    
    // ============================================
    // KABIRU APP SIDE: Listen for Incoming Transfers
    // ============================================
    if (isKabiruApp && db) {
        
        console.log('üëÇ Kabiru App: Listening for transfers...');
        
        // Function to get current Kabiru user
        function getCurrentKabiruMember() {
            // Adjust this based on your Kabiru app's storage
            const kabiruUser = sessionStorage.getItem('kabiruCurrentUser') || 
                               sessionStorage.getItem('tauCurrentUser');
            
            if (kabiruUser) {
                return JSON.parse(kabiruUser);
            }
            
            // Try localStorage as fallback
            const allMembers = JSON.parse(localStorage.getItem('tauAfricaDB') || '[]');
            if (allMembers.length > 0) {
                // Return last logged in member (you may need to adjust this)
                return allMembers[0];
            }
            
            return null;
        }
        
        // Listen for transfers in real-time
        function startTransferListener() {
            const currentMember = getCurrentKabiruMember();
            
            if (!currentMember) {
                console.log('‚ö†Ô∏è No member logged in, waiting...');
                // Retry after 5 seconds
                setTimeout(startTransferListener, 5000);
                return;
            }
            
            console.log('üë§ Listening for transfers to:', currentMember.id);
            
            // Listen to kabiru_transfers collection
            db.collection('kabiru_transfers')
                .where('memberId', '==', currentMember.id)
                .where('status', '==', 'pending')
                .onSnapshot(snapshot => {
                    snapshot.docChanges().forEach(change => {
                        if (change.type === 'added') {
                            const transfer = change.doc.data();
                            processIncomingTransfer(transfer, change.doc.id);
                        }
                    });
                });
        }
        
        // Process incoming transfer
        async function processIncomingTransfer(transfer, docId) {
            console.log('üì• Incoming transfer detected:', transfer);
            
            try {
                // Get current Kabiru balances (adjust storage keys as needed)
                const kabiruData = JSON.parse(localStorage.getItem('kabiruMiningData') || 
                                             localStorage.getItem('tauAfricaDB') || '[]');
                
                const memberIndex = kabiruData.findIndex(m => m.id === transfer.memberId);
                
                if (memberIndex !== -1) {
                    // Credit the balances
                    kabiruData[memberIndex].iKbpBalance = 
                        (kabiruData[memberIndex].iKbpBalance || 0) + (transfer.iKbp || 0);
                    kabiruData[memberIndex].iKbBalance = 
                        (kabiruData[memberIndex].iKbBalance || 0) + (transfer.iKb || 0);
                    
                    // Save to localStorage
                    localStorage.setItem('kabiruMiningData', JSON.stringify(kabiruData));
                    
                    console.log('‚úÖ Balances credited:', {
                        iKbp: transfer.iKbp,
                        iKb: transfer.iKb
                    });
                } else {
                    // Create new member record in Kabiru
                    kabiruData.push({
                        id: transfer.memberId,
                        fullName: transfer.memberName,
                        email: transfer.memberEmail,
                        iKbpBalance: transfer.iKbp || 0,
                        iKbBalance: transfer.iKb || 0,
                        importedFromTAU: true,
                        importDate: new Date().toISOString()
                    });
                    
                    localStorage.setItem('kabiruMiningData', JSON.stringify(kabiruData));
                    console.log('‚úÖ New member created with balances');
                }
                
                // Mark transfer as completed
                await db.collection('kabiru_transfers').doc(docId).update({
                    status: 'completed',
                    completedAt: firebase.firestore.FieldValue.serverTimestamp()
                });
                
                // Update member document
                await db.collection('members').doc(transfer.memberId).update({
                    'pendingKabiruTransfer.status': 'completed',
                    lastKabiruSync: firebase.firestore.FieldValue.serverTimestamp()
                });
                
                // Show success notification
                if (typeof showNotification === 'function') {
                    showNotification(
                        `‚úÖ Received from TAU!\n${transfer.iKbp} iKbp + ${transfer.iKb} iKb`, 
                        'success'
                    );
                } else {
                    alert(`‚úÖ Transfer Complete!\n\nReceived:\n${transfer.iKbp} iKbp\n${transfer.iKb} iKb`);
                }
                
                // Trigger UI refresh if functions exist
                if (typeof updateMiningStats === 'function') updateMiningStats();
                if (typeof refreshBalance === 'function') refreshBalance();
                
            } catch (error) {
                console.error('‚ùå Transfer processing error:', error);
                
                // Mark transfer as failed
                await db.collection('kabiru_transfers').doc(docId).update({
                    status: 'failed',
                    error: error.message,
                    failedAt: firebase.firestore.FieldValue.serverTimestamp()
                });
            }
        }
        
        // Start listening after 2 seconds
        setTimeout(startTransferListener, 2000);
        
        console.log('‚úÖ Kabiru App: Transfer listener installed');
    }
    
    // ============================================
    // REVERSE SYNC: Kabiru ‚Üí TAU (Activities/Tasks)
    // ============================================
    if (isKabiruApp && db) {
        
        // When user completes activities/tasks in Kabiru and wants to send back to TAU
        window.sendToTAU = async function(iKbp, iKb, reason) {
            const currentMember = getCurrentKabiruMember();
            
            if (!currentMember) {
                alert('Please login first');
                return;
            }
            
            try {
                // Create reverse transfer
                const transferId = 'KXFER-' + Date.now();
                
                await db.collection('kabiru_transfers').add({
                    transferId: transferId,
                    memberId: currentMember.id,
                    memberName: currentMember.fullName,
                    iKbp: iKbp || 0,
                    iKb: iKb || 0,
                    reason: reason || 'Mining earnings',
                    timestamp: firebase.firestore.FieldValue.serverTimestamp(),
                    status: 'pending',
                    direction: 'kabiru_to_tau'
                });
                
                console.log('‚úÖ Reverse transfer created:', transferId);
                alert('‚úÖ Transfer to TAU initiated!');
                
            } catch (error) {
                console.error('‚ùå Reverse transfer failed:', error);
                alert('‚ùå Transfer failed: ' + error.message);
            }
        };
        
        console.log('‚úÖ Kabiru App: Reverse transfer function ready');
    }
    
    // ============================================
    // MAIN APP: Listen for Reverse Transfers
    // ============================================
    if (!isKabiruApp && db) {
        
        function listenForReverseTransfers() {
            const currentMember = window.TauDB?.getCurrentMember();
            
            if (!currentMember) {
                setTimeout(listenForReverseTransfers, 5000);
                return;
            }
            
            db.collection('kabiru_transfers')
                .where('memberId', '==', currentMember.id)
                .where('direction', '==', 'kabiru_to_tau')
                .where('status', '==', 'pending')
                .onSnapshot(snapshot => {
                    snapshot.docChanges().forEach(async change => {
                        if (change.type === 'added') {
                            const transfer = change.doc.data();
                            
                            // Credit TAU balance
                            if (window.TauDB?.updateBalance) {
                                window.TauDB.updateBalance(currentMember.id, transfer.iKbp || 0);
                            }
                            
                            // Mark as completed
                            await db.collection('kabiru_transfers').doc(change.doc.id).update({
                                status: 'completed',
                                completedAt: firebase.firestore.FieldValue.serverTimestamp()
                            });
                            
                            if (typeof showNotification === 'function') {
                                showNotification(`‚úÖ Received from Kabiru: ${transfer.iKbp} iKbp`, 'success');
                            }
                        }
                    });
                });
        }
        
        setTimeout(listenForReverseTransfers, 3000);
        console.log('‚úÖ Main App: Reverse transfer listener ready');
    }
    
    // ============================================
    // EXPOSE GLOBAL API
    // ============================================
    window.TauKabiruBridge = {
        isKabiruApp: isKabiruApp,
        transferToKabiru: !isKabiruApp ? window.initiateKabiruWithdrawal : null,
        transferToTAU: isKabiruApp ? window.sendToTAU : null,
        checkPendingTransfers: async function(memberId) {
            if (!db) return [];
            const snapshot = await db.collection('kabiru_transfers')
                .where('memberId', '==', memberId)
                .where('status', '==', 'pending')
                .get();
            return snapshot.docs.map(doc => ({id: doc.id, ...doc.data()}));
        }
    };
    
    console.log('‚úÖ TAU-Kabiru Bridge loaded successfully');
    console.log(`üìç App Mode: ${isKabiruApp ? 'Kabiru Mining' : 'TAU Main'}`);
    
})();
            </script>
    <script>
        // services/realtimeService.js - KABIRU MINING VERSION
export const realtimeService = {
  
  // Listen for INCOMING transfers from TAU
  subscribeToIncomingTransfers(memberId, callback) {
    return db.collection('kabiru_transfers')
      .where('memberId', '==', memberId)
      .where('direction', '==', 'tau_to_kabiru')
      .where('status', '==', 'pending')
      .onSnapshot(callback);
  },
  
  // Listen to member profile (for balance sync)
  subscribeToMemberProfile(memberId, callback) {
    return db.collection('members').doc(memberId)
      .onSnapshot(callback);
  },
  
  // Listen to mining-specific events
  subscribeToMiningEvents(callback) {
    return db.collection('sync_events')
      .where('type', '==', 'mining_update')
      .orderBy('timestamp', 'desc')
      .limit(20)
      .onSnapshot(callback);
  }
};
    </script>
                <script>
                    // State for Mining Sessions
let miningSession = {
    active: false,
    startTime: null,
    endTime: null,
    ratePerHour: 0,
    intervalId: null,
    type: null
};

// Mining Configs
const MINING_TIERS = {
    basic: { rate: 0.005, hrRate: 0.0002083333, reqLevel: 1 },
    community: { rate: 0.01, hrRate: 0.0004166667, reqLevel: 2 },
    sovereign: { rate: 0.1, hrRate: 0.0041666667, reqLevel: 3 }
};

async function startMiningSession(tierId) {
    const tier = MINING_TIERS[tierId];
    
    // 1. Check Declaration Code Expiry (30 Days)
    const lastDeclaration = currentUser.lastDeclarationDate || 0;
    const now = Date.now();
    const thirtyDaysInMs = 30 * 24 * 60 * 60 * 1000;
    
    if (now - lastDeclaration > thirtyDaysInMs) {
        showNotification("‚ö†Ô∏è Declaration expired! Require declaration code to activate for 30 days.");
        openValueModal(); // Direct to renewal
        return;
    }

    if (currentUser.memberLevel < tier.reqLevel) {
        showNotification(`üîí Level ${tier.reqLevel} Declaration Required!`);
        return;
    }

    if (miningSession.active) {
        showNotification("Mining session already in progress!");
        return;
    }

    // Initialize 24hr Session
    miningSession = {
        active: true,
        startTime: now,
        endTime: now + (24 * 60 * 60 * 1000),
        ratePerHour: tier.hrRate,
        type: tierId
    };

    saveMiningState();
    runRealTimeMining();
    showNotification(`üöÄ ${tierId.toUpperCase()} Mining started for 24 hours!`);
}

function runRealTimeMining() {
    miningSession.intervalId = setInterval(() => {
        const now = Date.now();
        if (now >= miningSession.endTime) {
            endMiningSession();
            return;
        }

        // Calculate progress and real-time increment
        const elapsedHrs = (now - miningSession.startTime) / (1000 * 60 * 60);
        const currentMined = elapsedHrs * miningSession.ratePerHour;
        
        // Update UI Progress Bar & Timer
        const progress = ((now - miningSession.startTime) / (24 * 60 * 60 * 1000)) * 100;
        document.getElementById('miningProgressBar').style.width = `${progress}%`;
        
        const remaining = miningSession.endTime - now;
        updateMiningTimer(remaining);
        
        // Animation: Update balance display with small increments
        animateBalanceIncrement(currentMined);
        
    }, 1000);
}

function endMiningSession() {
    clearInterval(miningSession.intervalId);
    miningSession.active = false;
    
    // Finalize balance
    const totalEarned = (miningSession.endTime - miningSession.startTime) / (1000 * 60 * 60) * miningSession.ratePerHour;
    minedBalance += totalEarned;
    
    saveUserData();
    updateBalanceDisplay();
    
    // Notification every end of season
    showNotification("üèÅ Mining session ended! Click MINE again to continue earning iKb.");
    
    // Trigger System Notification if possible
    if (Notification.permission === "granted") {
        new Notification("KABIRU Mining", { body: "Your 24hr session has ended. Restart to keep earning!" });
    }
                    }
                </script>
    <script>
        const CURRENCY_MAP = {
    'Kenya': { code: 'KSH', symbol: 'Ksh' },
    'Uganda': { code: 'UGX', symbol: 'Ugsh' },
    'Burundi': { code: 'BIF', symbol: 'BFr' },
    'Tanzania': { code: 'TZS', symbol: 'Tsh' }
};

function updateLocalCurrency() {
    const country = document.getElementById('userCountry').value;
    const currency = CURRENCY_MAP[country];
    
    // Update UI Labels
    document.getElementById('localCurrencyLabel').textContent = currency.code;
    const labels = document.querySelectorAll('.localCurrency');
    labels.forEach(el => el.textContent = currency.symbol);
    
    showNotification(`Currency set to ${currency.code} based on ${country} ID`);
}

async function convertToIKb() {
    const liquidAmount = parseFloat(prompt("Enter amount to convert to iKb:"));
    if (isNaN(liquidAmount) || liquidAmount <= 0) return;

    // 1 iKb = 100,000 of chosen currency
    const ikbValue = liquidAmount / 100000;
    
    if (confirm(`Convert ${liquidAmount} to ${ikbValue.toFixed(6)} iKb?`)) {
        showNotification("üîÑ Processing conversion via Valenta Company...");
        
        setTimeout(async () => {
            receivedBalance += ikbValue;
            userBalance = minedBalance + receivedBalance;
            
            await saveUserData();
            updateBalanceDisplay();
            showNotification(`‚úÖ Successfully added ${ikbValue.toFixed(6)} iKb to main wallet!`);
            closeModal('liquidPoolModal');
        }, 2000);
    }
                    }
                </script>
    <script>
        // --- Modal Control Functions ---

function openValueModal() {
    document.getElementById('valuePoolModal').style.display = 'block';
}

function openLiquidModal() {
    document.getElementById('liquidPoolModal').style.display = 'block';
    // Initialize currency display based on current user settings
    updateLocalCurrency();
}

function openSovereignModal() {
    // Lead to Sovereign forms
    openValueModal();
    showValueSection('sovereignty'); 
}

function closeModal(modalId) {
    document.getElementById(modalId).style.display = 'none';
}
// ============================================
// FIX 1: ADD MISSING MODAL FUNCTION
// ============================================
// Add this function anywhere in your <script> section

function openMemberIDLinkModal() {
    document.getElementById('memberIDModal').style.display = 'block';
    document.getElementById('linkMemberID').value = '';
}

// Function to handle sub-sections inside the Value Pool
function showValueSection(section) {
    const container = document.getElementById('valueFormContainer');
    const fields = document.getElementById('formFields');
    const title = document.getElementById('formTitle');
    
    container.style.display = 'block';
    fields.innerHTML = ''; // Clear previous fields

    if (section === 'hotpoint') {
        title.innerText = "Value Hotpoint";
        fields.innerHTML = `
            <input type="text" class="form-input" placeholder="Enter Value Code">
            <input type="text" class="form-input" placeholder="Value Items">
            <textarea class="form-input" placeholder="Declaration Details"></textarea>
        `;
    } else if (section === 'sovereignty') {
        title.innerText = "Sovereignty Path";
        fields.innerHTML = `
            <p style="font-size:11px; margin-bottom:10px;">Guided form for Personal & Community Sovereignty.</p>
            <input type="text" class="form-input" placeholder="Empire Details">
            <select class="form-input">
                <option>Self Sovereignty</option>
                <option>Family Sovereignty</option>
                <option>Community Sovereignty</option>
            </select>
        `;
    }
    // Add other sections (family, business) as needed...
}
    </script> 
    <script>

// ============================================
// FIXED: Mining Referral Bonus - COMPLETE VERSION
// ============================================
// Find your awardReferralBonus() function and REPLACE it with this:

async function awardReferralBonus(miningAmount) {
    if (!currentUser || !currentUser.referredBy || !db) {
        console.log('‚ö†Ô∏è No referral bonus: No referrer or offline mode');
        return;
    }
    
    const bonusAmount = miningAmount * 0.10; // 10% of mining reward
    
    try {
        console.log(`üí∞ Awarding ${bonusAmount.toFixed(6)} iKb to ${currentUser.referredBy}`);
        
        await db.runTransaction(async (transaction) => {
            const referrerRef = db.collection('users').doc(currentUser.referredBy);
            const referrerSnapshot = await transaction.get(referrerRef);
            
            if (!referrerSnapshot.exists) {
                throw new Error('Referrer account not found');
            }
            
            const referrerData = referrerSnapshot.data();
            
            // Calculate new values
            const newReceivedBalance = (referrerData.receivedBalance || 0) + bonusAmount;
            const newTotalEarnings = (referrerData.totalReferralEarnings || 0) + bonusAmount;
            
            // Prepare transaction history
            const currentTxHistory = referrerData.transactionHistory || [];
            const newTransaction = {
                id: generateTransactionId(),
                type: 'referral_mining_bonus',
                amount: bonusAmount,
                from: currentUser.uid,
                fromEmail: currentUser.email,
                fromName: currentUser.displayName || 'User',
                miningType: 'mining',
                timestamp: new Date().toISOString(),
                status: 'completed'
            };
            
            currentTxHistory.unshift(newTransaction);
            const trimmedHistory = currentTxHistory.slice(0, 50);
            
            // Update in ONE atomic operation
            transaction.update(referrerRef, {
                receivedBalance: newReceivedBalance,
                totalReferralEarnings: newTotalEarnings,
                transactionHistory: trimmedHistory,
                lastMiningBonus: firebase.firestore.FieldValue.serverTimestamp()
            });
            
            console.log('‚úÖ Mining bonus awarded:', {
                bonus: bonusAmount,
                newBalance: newReceivedBalance,
                totalEarnings: newTotalEarnings
            });
        });
        
        console.log('‚úÖ Referral bonus transaction completed successfully');
        
    } catch (error) {
        console.error('‚ùå Referral bonus error:', error);
        console.error('   Referrer ID:', currentUser.referredBy);
        console.error('   Bonus Amount:', bonusAmount);
        console.error('   Error details:', error.message);
    }
}


// ============================================
// FIXED: View Referral Earnings with Better Tracking
// ============================================
// Find your viewReferralEarnings() function and REPLACE it with this:

async function viewReferralEarnings() {
    if (!currentUser || !db) {
        showNotification('Please login to view referral earnings');
        return;
    }
    
    try {
        console.log('üìä Fetching referral data for:', currentUser.uid);
        
        const userDoc = await db.collection('users').doc(currentUser.uid).get();
        
        if (!userDoc.exists) {
            showNotification('‚ùå User data not found');
            return;
        }
        
        const userData = userDoc.data();
        
        // Get referral statistics
        const totalReferrals = userData.totalReferrals || 0;
        const totalEarnings = userData.totalReferralEarnings || 0;
        
        console.log('Referral stats:', { totalReferrals, totalEarnings });
        
        // Filter referral transactions
        const allTransactions = userData.transactionHistory || [];
        const referralTransactions = allTransactions.filter(tx => 
            tx.type === 'referral_mining_bonus' || 
            tx.type === 'referral_signup_bonus'
        );
        
        const signupBonuses = referralTransactions.filter(tx => tx.type === 'referral_signup_bonus');
        const miningBonuses = referralTransactions.filter(tx => tx.type === 'referral_mining_bonus');
        
        console.log('Transaction breakdown:', {
            total: referralTransactions.length,
            signup: signupBonuses.length,
            mining: miningBonuses.length
        });
        
        let message = `üí∞ REFERRAL EARNINGS DASHBOARD\n`;
        message += `${'='.repeat(40)}\n\n`;
        message += `üë• Total Referrals: ${totalReferrals}\n`;
        message += `üíé Total Earned: ${totalEarnings.toFixed(6)} iKb\n\n`;
        message += `üìä Breakdown:\n`;
        message += `   üîπ Signup Bonuses: ${signupBonuses.length} √ó 0.005 = ${(signupBonuses.length * 0.005).toFixed(6)} iKb\n`;
        
        // Calculate total mining bonuses
        const totalMiningBonus = miningBonuses.reduce((sum, tx) => sum + (tx.amount || 0), 0);
        message += `   ‚õèÔ∏è Mining Bonuses: ${miningBonuses.length} √ó = ${totalMiningBonus.toFixed(6)} iKb\n\n`;
        
        if (referralTransactions.length > 0) {
            message += `üìú Recent Earnings (Last 10):\n`;
            message += `${'‚îÄ'.repeat(40)}\n`;
            
            referralTransactions.slice(0, 10).forEach((tx, index) => {
                const date = new Date(tx.timestamp).toLocaleDateString();
                const time = new Date(tx.timestamp).toLocaleTimeString('en-US', { 
                    hour: '2-digit', 
                    minute: '2-digit' 
                });
                const type = tx.type === 'referral_signup_bonus' ? 'üîπ Signup' : '‚õèÔ∏è Mining';
                const fromName = tx.fromName || tx.fromEmail || 'User';
                
                message += `${index + 1}. ${date} ${time}\n`;
                message += `   ${type}: +${tx.amount.toFixed(6)} iKb\n`;
                message += `   From: ${fromName}\n`;
                if (index < referralTransactions.length - 1) {
                    message += `\n`;
                }
            });
        } else {
            message += `üî≠ No referral earnings yet.\n`;
            message += `\nüí° Share your referral link to start earning!\n`;
            message += `\nüìã Your referral link:\n`;
            message += `${generateReferralLink()}`;
        }
        
        message += `\n\n${'='.repeat(40)}\n`;
        message += `üéØ Earn 10% of your referrals' mining!`;
        
        alert(message);
        
    } catch (error) {
        console.error('‚ùå Error viewing referral earnings:', error);
        showNotification('‚ùå Could not load referral earnings: ' + error.message);
    }
        }
        // Debug function to check user state
window.checkUserState = function() {
    console.log('üîç USER STATE CHECK');
    console.log('='.repeat(50));
    console.log('Current User Object:', currentUser);
    console.log('Firebase Auth User:', auth?.currentUser);
    console.log('Display Name:', currentUser?.displayName);
    console.log('Email:', currentUser?.email);
    console.log('Balance:', userBalance);
    console.log('Referred By:', currentUser?.referredBy);
    console.log('='.repeat(50));
};

console.log('üí° Type checkUserState() in console to debug');
        // ============================================
// DEBUG: Test Referral System
// ============================================
window.testReferralSystem = async function() {
    if (!currentUser || !db) {
        console.error('‚ùå Not logged in or no database');
        return;
    }
    
    console.log('üîç REFERRAL SYSTEM DEBUG');
    console.log('='.repeat(50));
    
    // Check current user's referral status
    const userDoc = await db.collection('users').doc(currentUser.uid).get();
    const userData = userDoc.data();
    
    console.log('üìå Current User:');
    console.log('   UID:', currentUser.uid);
    console.log('   Email:', currentUser.email);
    console.log('   Referral Code:', userData?.referralCode || 'Not set');
    console.log('   Referred By:', userData?.referredBy || 'None (not referred)');
    console.log('   Total Referrals:', userData?.totalReferrals || 0);
    console.log('   Total Earnings:', (userData?.totalReferralEarnings || 0).toFixed(6), 'iKb');
    
    // Check if user was referred
    if (userData?.referredBy) {
        console.log('\n‚úÖ This user WAS referred');
        console.log('   Referrer ID:', userData.referredBy);
        
        // Try to get referrer info
        const referrerDoc = await db.collection('users').doc(userData.referredBy).get();
        if (referrerDoc.exists) {
            const referrerData = referrerDoc.data();
            console.log('   Referrer Email:', referrerData.email);
            console.log('   Referrer Earnings:', (referrerData.totalReferralEarnings || 0).toFixed(6), 'iKb');
        }
    } else {
        console.log('\n‚ö†Ô∏è This user was NOT referred');
        console.log('   To test referral: Share this link with someone:');
        console.log('   ' + generateReferralLink());
    }
    
    // Check referral transactions
    const refTxs = (userData?.transactionHistory || []).filter(tx => 
        tx.type === 'referral_mining_bonus' || 
        tx.type === 'referral_signup_bonus' ||
        tx.type === 'referral_welcome_bonus'
    );
    
    console.log('\nüìä Referral Transactions:', refTxs.length);
    refTxs.forEach((tx, i) => {
        console.log(`   ${i+1}. ${tx.type}: ${tx.amount.toFixed(6)} iKb from ${tx.fromEmail || tx.referrer || 'system'}`);
    });
    
    console.log('\n' + '='.repeat(50));
};

console.log('üí° Run testReferralSystem() in console to debug referrals');

    </script>
</body>
    </html>
