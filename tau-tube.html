<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>TAU TUBE - Media Platform</title>
    
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://www.gstatic.com/firebasejs/10.7.1/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/10.7.1/firebase-auth-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/10.7.1/firebase-firestore-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/10.7.1/firebase-storage-compat.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/@emailjs/browser@3/dist/email.min.js"></script>
    <script src="https://unpkg.com/lucide@latest"></script>
    
    <style>
        @keyframes marquee {
            0% { transform: translateX(100%); }
            100% { transform: translateX(-100%); }
        }
        .animate-marquee {
            animation: marquee 25s linear infinite;
        }
        .video-thumbnail {
            transition: transform 0.2s;
        }
        .video-thumbnail:hover {
            transform: scale(1.05);
        }
        .smooth-loader {
            position: absolute;
            inset: 0;
            background: linear-gradient(90deg, transparent, rgba(255,255,255,0.1), transparent);
            animation: shimmer 1.5s infinite;
        }
        @keyframes shimmer {
            0% { transform: translateX(-100%); }
            100% { transform: translateX(100%); }
        }
        .notification-banner {
            position: fixed;
            bottom: 0;
            left: 0;
            right: 0;
            background: linear-gradient(90deg, #9333ea, #06b6d4);
            color: white;
            padding: 12px;
            z-index: 100;
            overflow: hidden;
            box-shadow: 0 -4px 15px rgba(0,0,0,0.3);
        }
        .notification-text {
            white-space: nowrap;
            display: inline-block;
            animation: scroll-text 25s linear;
        }
        @keyframes scroll-text {
            0% { transform: translateX(100%); }
            100% { transform: translateX(-100%); }
        }
    </style>
</head>
<body class="bg-gray-900 min-h-screen">

    <!-- Notification Toast -->
    <div id="notification-toast" class="fixed top-4 right-4 bg-gradient-to-r from-purple-600 to-teal-400 text-white p-4 rounded-lg shadow-lg z-50 hidden max-w-sm">
        <div class="flex items-start gap-3">
            <i data-lucide="bell" style="width: 24px; height: 24px;"></i>
            <div>
                <p id="notification-text" class="font-semibold"></p>
            </div>
            <button onclick="closeNotification()" class="ml-auto">
                <i data-lucide="x" style="width: 20px; height: 20px;"></i>
            </button>
        </div>
    </div>

    <!-- Scrolling Notification Banner -->
    <div id="notification-banner" class="notification-banner" style="display: none;">
        <div class="notification-text" id="banner-text"></div>
    </div>

    <!-- Header -->
    <div class="bg-gradient-to-r from-purple-600 via-cyan-500 to-teal-400 p-4">
        <div class="max-w-7xl mx-auto flex flex-wrap items-center justify-between gap-4">
            <div class="flex items-center gap-3">
                <div class="bg-white p-2 rounded-lg">
                    <i data-lucide="film" class="text-purple-600" style="width: 32px; height: 32px;"></i>
                </div>
                <div>
                    <h1 class="text-white text-2xl font-bold">TAU TUBE</h1>
                    <p class="text-purple-200 text-sm">Powered by TAU Africa Ecosystem</p>
                </div>
            </div>
            
            <div class="flex items-center gap-2 flex-wrap">
                <button onclick="togglePointsDropdown()" class="bg-white bg-opacity-20 backdrop-blur-sm px-4 py-2 rounded-lg flex items-center gap-2">
                    <i data-lucide="award" class="text-yellow-300" style="width: 20px; height: 20px;"></i>
                    <div>
                        <p class="text-white font-bold"><span id="user-points">0</span> iKbp</p>
                        <p class="text-purple-200 text-xs">Kabiru Points</p>
                    </div>
                </button>
                
                <button onclick="shareReferral()" class="bg-white text-purple-600 px-4 py-2 rounded-lg hover:bg-purple-50 flex items-center gap-2 font-semibold text-sm">
                    <i data-lucide="share-2" style="width: 18px; height: 18px;"></i> Refer
                </button>
                
                <button onclick="showUploadModal()" class="bg-yellow-400 text-gray-900 px-4 py-2 rounded-lg hover:bg-yellow-300 flex items-center gap-2 font-semibold text-sm">
                    <i data-lucide="upload" style="width: 18px; height: 18px;"></i> Upload
                </button>
            </div>
        </div>
    </div>

    <!-- Breaking News Ticker -->
    <div class="bg-red-600 text-white py-2 px-4 flex items-center gap-4 overflow-hidden">
        <div class="flex items-center gap-2 font-bold whitespace-nowrap">
            <i data-lucide="bell" style="width: 18px; height: 18px;"></i> BREAKING:
        </div>
        <div class="overflow-hidden flex-1">
            <div class="animate-marquee whitespace-nowrap" id="news-ticker">
                News update : Welcome to TAU Africa Ecosystem and Kabiru Digital Value Currency. Our Grand Launch is confirmed for 28th February 2026 at Paris Hotel, Nairobi Kenya. There will be online live coverage via our TAU Tube and other social media or TV. please register at the TAU Africa Main App and get your Member ID, to be used for mining and all network benefits.
            </div>
        </div>
    </div>

    <!-- Navigation Tabs -->
    <div class="bg-gray-800 border-b border-gray-700">
        <div class="max-w-7xl mx-auto px-4">
            <div class="flex items-center justify-between border-b border-gray-700 pb-3 mb-3">
                <div class="flex gap-1 flex-wrap">
                    <button onclick="switchTab('videos')" id="tab-videos" class="px-4 py-3 text-sm bg-purple-600 text-white rounded-t">
                        <i data-lucide="film" class="inline" style="width: 18px; height: 18px;"></i> Videos
                    </button>
                    <button onclick="switchTab('images')" id="tab-images" class="px-4 py-3 text-sm text-gray-400 hover:text-white rounded-t">
                        <i data-lucide="image" class="inline" style="width: 18px; height: 18px;"></i> Images
                    </button>
                    <button onclick="switchTab('audio')" id="tab-audio" class="px-4 py-3 text-sm text-gray-400 hover:text-white rounded-t">
                        <i data-lucide="mic" class="inline" style="width: 18px; height: 18px;"></i> Audio
                    </button>
                    <button onclick="switchTab('live')" id="tab-live" class="px-4 py-3 text-sm text-gray-400 hover:text-white flex items-center gap-2 rounded-t">
                        <i data-lucide="radio" class="text-red-500" style="width: 18px; height: 18px;"></i> Live
                    </button>
                    <button onclick="switchTab('competitions')" id="tab-competitions" class="px-4 py-3 text-sm text-gray-400 hover:text-white flex items-center gap-2 rounded-t">
                        <i data-lucide="trophy" class="text-yellow-400" style="width: 18px; height: 18px;"></i> Competitions
                    </button>
                </div>
                
                <div class="flex gap-2">
                    <button onclick="setViewMode('grid')" id="view-grid" class="p-2 text-purple-400 hover:text-white">
                        <i data-lucide="grid" style="width: 20px; height: 20px;"></i>
                    </button>
                    <button onclick="setViewMode('list')" id="view-list" class="p-2 text-gray-400 hover:text-white">
                        <i data-lucide="list" style="width: 20px; height: 20px;"></i>
                    </button>
                </div>
            </div>
            
            <!-- Account Section -->
            <div class="flex items-center justify-between py-3">
                <div class="flex items-center gap-3">
                    <div class="w-12 h-12 bg-gradient-to-r from-purple-600 to-teal-400 rounded-full flex items-center justify-center">
                        <i data-lucide="user" class="text-white" style="width: 24px; height: 24px;"></i>
                    </div>
                    <div>
                        <p id="account-name" class="text-white font-semibold">Guest User</p>
                        <p id="account-id" class="text-gray-400 text-sm">Not logged in</p>
                    </div>
                </div>
                <button onclick="showAccountModal()" class="bg-gradient-to-r from-purple-600 to-teal-400 text-white px-6 py-2 rounded-lg hover:opacity-90 flex items-center gap-2 font-semibold">
                    <i data-lucide="user-plus" style="width: 18px; height: 18px;"></i> Login / Register
                </button>
            </div>
        </div>
    </div>

    <!-- Main Content -->
    <div class="max-w-7xl mx-auto p-4" style="padding-bottom: 80px;">
        <div id="content-grid" class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-4">
            <!-- Content will be loaded here dynamically -->
        </div>
    </div>

    <!-- Competition Registration Modal -->
    <div id="competition-modal" class="fixed inset-0 bg-black bg-opacity-75 z-50 hidden items-center justify-center p-4">
        <div class="bg-gray-800 rounded-lg p-6 w-full max-w-2xl max-h-[90vh] overflow-y-auto">
            <h2 class="text-white text-2xl font-bold mb-4">Join Competition</h2>
            
            <div class="bg-yellow-400 bg-opacity-20 border border-yellow-400 rounded-lg p-4 mb-4">
                <p class="text-yellow-300 text-sm">
                    <i data-lucide="info" class="inline" style="width: 16px; height: 16px;"></i>
                    <strong>Important:</strong> You need a TAU Africa Member ID to participate. 
                    <a href="https://magero1985.github.io/Tau-Africa/" target="_blank" class="underline hover:text-yellow-100">
                        Register here if you don't have one.
                    </a>
                </p>
            </div>
            
            <form id="competition-form" class="space-y-4">
                <div>
                    <label class="text-gray-300 block mb-2">TAU Member ID *</label>
                    <input type="text" id="comp-member-id" required class="w-full bg-gray-700 text-white p-3 rounded-lg" placeholder="TSK-XXXXXX-XXX or TLK-XXXXXX-XXX">
                    <p class="text-gray-400 text-xs mt-1">Don't have one? <a href="https://magero1985.github.io/Tau-Africa/" target="_blank" class="text-purple-400 underline">Register at TAU Africa</a></p>
                </div>

                <div>
                    <label class="text-gray-300 block mb-2">Full Name *</label>
                    <input type="text" id="comp-name" required class="w-full bg-gray-700 text-white p-3 rounded-lg" placeholder="Your full name">
                </div>

                <div>
                    <label class="text-gray-300 block mb-2">Email *</label>
                    <input type="email" id="comp-email" required class="w-full bg-gray-700 text-white p-3 rounded-lg" placeholder="your@email.com">
                </div>

                <div>
                    <label class="text-gray-300 block mb-2">Phone Number *</label>
                    <input type="tel" id="comp-phone" required class="w-full bg-gray-700 text-white p-3 rounded-lg" placeholder="+254...">
                </div>

                <div>
                    <label class="text-gray-300 block mb-2">Competition Type *</label>
                    <select id="comp-type" required class="w-full bg-gray-700 text-white p-3 rounded-lg">
                        <option value="">Select competition</option>
                        <option value="Best Video Creator">Best Video Creator of the Month</option>
                        <option value="Audio Challenge">Audio Content Challenge</option>
                        <option value="Photography">Photography Competition</option>
                    </select>
                </div>

                <div class="flex gap-2">
                    <button type="submit" class="flex-1 bg-purple-600 text-white py-3 rounded-lg hover:bg-purple-700 font-semibold">
                        Submit Registration
                    </button>
                    <button type="button" onclick="closeCompetitionModal()" class="flex-1 bg-gray-700 text-white py-3 rounded-lg hover:bg-gray-600">
                        Cancel
                    </button>
                </div>
            </form>
        </div>
    </div>

    <!-- Account/Login Modal -->
    <div id="account-modal" class="fixed inset-0 bg-black bg-opacity-75 z-50 hidden items-center justify-center p-4">
        <div class="bg-gray-800 rounded-lg p-6 w-full max-w-md max-h-[90vh] overflow-y-auto">
            <h2 class="text-white text-2xl font-bold mb-4" id="account-modal-title">Login / Register</h2>
            
            <!-- Login/Register Tabs -->
            <div class="flex gap-2 mb-4">
                <button onclick="switchAccountTab('login')" id="account-tab-login" class="flex-1 py-2 bg-purple-600 text-white rounded">Login</button>
                <button onclick="switchAccountTab('register')" id="account-tab-register" class="flex-1 py-2 bg-gray-700 text-white rounded">Register</button>
            </div>

            <!-- Login Form -->
            <div id="login-form-container">
                <form id="login-form" class="space-y-4">
                    <div>
                        <label class="text-gray-300 block mb-2">Login Method</label>
                        <select id="login-method" class="w-full bg-gray-700 text-white p-3 rounded-lg">
                            <option value="email">Email</option>
                            <option value="member-id">TAU Member ID</option>
                        </select>
                    </div>
                    <div>
                        <label class="text-gray-300 block mb-2" id="login-identifier-label">Email</label>
                        <input type="text" id="login-identifier" required class="w-full bg-gray-700 text-white p-3 rounded-lg" placeholder="Enter email or Member ID">
                    </div>
                    <div>
                        <label class="text-gray-300 block mb-2">Password</label>
                        <input type="password" id="login-password" required class="w-full bg-gray-700 text-white p-3 rounded-lg">
                    </div>
                    <button type="submit" class="w-full bg-purple-600 text-white py-3 rounded-lg hover:bg-purple-700 font-semibold">
                        Login
                    </button>
                </form>
            </div>

            <!-- Register Form -->
            <div id="register-form-container" style="display: none;">
                <form id="register-form" class="space-y-4">
                    <div>
                        <label class="text-gray-300 block mb-2">Full Name</label>
                        <input type="text" id="reg-name" required class="w-full bg-gray-700 text-white p-3 rounded-lg">
                    </div>
                    <div>
                        <label class="text-gray-300 block mb-2">Email</label>
                        <input type="email" id="reg-email" required class="w-full bg-gray-700 text-white p-3 rounded-lg">
                    </div>
                    <div>
                        <label class="text-gray-300 block mb-2">TAU Member ID (Optional)</label>
                        <input type="text" id="reg-member-id" class="w-full bg-gray-700 text-white p-3 rounded-lg" placeholder="TSK-XXXXXX-XXX">
                        <p class="text-gray-400 text-xs mt-1">Have a TAU ID? Link it for bonuses!</p>
                    </div>
                    <div>
                        <label class="text-gray-300 block mb-2">Password</label>
                        <input type="password" id="reg-password" required class="w-full bg-gray-700 text-white p-3 rounded-lg">
                    </div>
                    <button type="submit" class="w-full bg-purple-600 text-white py-3 rounded-lg hover:bg-purple-700 font-semibold">
                        Create Account
                    </button>
                </form>
            </div>

            <button onclick="closeAccountModal()" class="w-full bg-gray-700 text-white py-2 rounded-lg hover:bg-gray-600 mt-4">
                Close
            </button>
        </div>
    </div>

    <!-- User Dashboard Modal -->
    <div id="dashboard-modal" class="fixed inset-0 bg-black bg-opacity-75 z-50 hidden items-center justify-center p-4">
        <div class="bg-gray-800 rounded-lg p-6 w-full max-w-2xl max-h-[90vh] overflow-y-auto">
            <h2 class="text-white text-2xl font-bold mb-4">My Account</h2>
            
            <!-- Balance Section -->
            <div class="grid grid-cols-2 gap-4 mb-4">
                <div class="bg-gradient-to-r from-purple-600 to-cyan-500 p-4 rounded-lg">
                    <p class="text-white text-sm opacity-80">iKbp Balance</p>
                    <p class="text-white text-2xl font-bold" id="dash-ikbp">0</p>
                    <p class="text-white text-xs">10 iKbp = 1 KSH</p>
                </div>
                <div class="bg-gradient-to-r from-yellow-500 to-orange-500 p-4 rounded-lg">
                    <p class="text-white text-sm opacity-80">Equivalent</p>
                    <p class="text-white text-2xl font-bold" id="dash-ksh">0 KSH</p>
                    <p class="text-white text-xs">10,000 iKbp = 1 iKb</p>
                </div>
            </div>

            <!-- Conversion Section -->
            <div class="bg-gray-700 p-4 rounded-lg mb-4">
                <h3 class="text-white font-bold mb-3 flex items-center gap-2">
                    <i data-lucide="repeat" style="width: 20px; height: 20px;"></i>
                    Convert iKbp to iKb
                </h3>
                <p class="text-gray-300 text-sm mb-3">Convert 10,000 iKbp = 1 iKb for use in Kabiru Mining App</p>
                <div class="flex gap-2">
                    <input type="number" id="convert-amount" placeholder="10000" class="flex-1 bg-gray-600 text-white p-2 rounded" min="10000" step="10000">
                    <button onclick="convertToIKb()" class="bg-purple-600 text-white px-4 py-2 rounded hover:bg-purple-700">
                        Convert
                    </button>
                </div>
                <p class="text-gray-400 text-xs mt-2">Minimum: 10,000 iKbp</p>
            </div>

            <!-- Transfer to Kabiru -->
            <div class="bg-gray-700 p-4 rounded-lg mb-4">
                <h3 class="text-white font-bold mb-3 flex items-center gap-2">
                    <i data-lucide="send" style="width: 20px; height: 20px;"></i>
                    Transfer to Kabiru Wallet
                </h3>
                <p class="text-gray-300 text-sm mb-3">Transfer iKbp to Kabiru Mining App for withdrawals and more features</p>
                <div class="space-y-2">
                    <input type="number" id="transfer-amount" placeholder="Amount in iKbp" class="w-full bg-gray-600 text-white p-2 rounded">
                    <input type="text" id="kabiru-wallet-id" placeholder="Your Kabiru Wallet ID or Email" class="w-full bg-gray-600 text-white p-2 rounded">
                    <button onclick="transferToKabiru()" class="w-full bg-teal-500 text-white px-4 py-2 rounded hover:bg-teal-600 font-semibold">
                        Transfer to Kabiru
                    </button>
                </div>
                <p class="text-yellow-300 text-xs mt-2">
                    <i data-lucide="info" class="inline" style="width: 12px; height: 12px;"></i>
                    Don't have Kabiru account? <a href="https://magero1985.github.io/Tau-Africa/Kabiru-Mining-Portal/" target="_blank" class="underline">Sign up here</a>
                </p>
            </div>

            <!-- Referral Section -->
            <div class="bg-gray-700 p-4 rounded-lg mb-4">
                <h3 class="text-white font-bold mb-3 flex items-center gap-2">
                    <i data-lucide="users" style="width: 20px; height: 20px;"></i>
                    Referral Link
                </h3>
                <div class="flex gap-2">
                    <input type="text" id="referral-link" readonly class="flex-1 bg-gray-600 text-white p-2 rounded text-sm" value="https://magero1985.github.io/Tau-Africa/tau-tube.html">
                    <button onclick="copyReferralLink()" class="bg-purple-600 text-white px-4 py-2 rounded hover:bg-purple-700">
                        <i data-lucide="copy" style="width: 16px; height: 16px;"></i>
                    </button>
                </div>
                <p class="text-gray-400 text-xs mt-2">Share and earn 50 iKbp per active referral!</p>
            </div>

            <button onclick="closeDashboard()" class="w-full bg-gray-700 text-white py-2 rounded-lg hover:bg-gray-600">
                Close
            </button>
        </div>
    </div>

    <!-- Video Player Modal (keeping existing) -->
    <div id="video-modal" class="fixed inset-0 bg-black bg-opacity-95 z-50 hidden items-center justify-center p-4" style="padding-bottom: 80px;">
        <!-- Same as original -->
    </div>

    <!-- JavaScript -->
    <script>
        const FIREBASE_CONFIG = {
            apiKey: "AIzaSyBcTzvl5lwpojRQM5lwyWe3hwp4upogUWw",
            authDomain: "tau-main-app.firebaseapp.com",
            projectId: "tau-main-app",
            storageBucket: "tau-main-app.firebasestorage.app",
            messagingSenderId: "69734421488",
            appId: "1:69734421488:web:d13ae38f1c7d79cc854335"
        };

        const EMAIL_CONFIG = {
            serviceId: 'service_xfira7g',
            templateId: 'template_bqxztig',
            publicKey: 'GhjI14eQVGgOli0j1',
            adminEmail: 'grouptauafrica@gmail.com'
        };

        firebase.initializeApp(FIREBASE_CONFIG);
        const auth = firebase.auth();
        const db = firebase.firestore();
        const storage = firebase.storage();

        emailjs.init(EMAIL_CONFIG.publicKey);

        let currentUser = null;
        let currentTab = 'videos';
        let viewMode = 'grid';
        let userPoints = 0;
        let referralCode = '';

        const notificationMessages = [
            "Welcome to TAU TUBE! Earn iKbp rewards by watching and uploading content. Start building your balance today!",
            "New competition starting soon! Register now with your TAU Member ID for a chance to win amazing prizes.",
            "Transfer your iKbp to Kabiru Wallet for withdrawals. Conversion: 10,000 iKbp = 1 iKb = 100,000 KSH",
            "Refer friends and earn bonuses! Share your referral link and get 50 iKbp for each active user who joins.",
            "Convert your iKbp to iKb in your account. Rate: 10 iKbp = 1 KSH | 10,000 iKbp = 1 iKb",
            "Watch videos daily to maximize your iKbp earnings! Every view counts towards your rewards.",
            "Complete your TAU Africa registration to unlock all features and boost your mining rate.",
            "New videos uploaded! Check out the latest content from our creators and start earning rewards."
        ];

        document.addEventListener('DOMContentLoaded', () => {
            lucide.createIcons();
            loadInitialData();
            startNotificationCycle();
            setupLoginMethodChange();
        });

        // Enhanced Notification System - 50 second display, 60 second cycle
        function startNotificationCycle() {
            let messageIndex = 0;
            const banner = document.getElementById('notification-banner');
            const bannerText = document.getElementById('banner-text');

            function showNextMessage() {
                bannerText.textContent = notificationMessages[messageIndex];
                banner.style.display = 'block';
                
                // Hide after 50 seconds
                setTimeout(() => {
                    banner.style.display = 'none';
             text-y 50,000);

                messageIndex = (messageIndex + 1) % notificationMessages.length;
            }

            // Show first message immediately
            showNextMessage();
            
            // Show next message every 60 seconds
            setInterval(showNextMessage, 60000);
        }

        async function loadInitialData() {
            referralCode = `TAU-${Math.random().toString(36).substr(2, 8).toUpperCase()}`;

            userPoints = parseInt(localStorage.getItem('ikbp_points') || '0');
            document.getElementById('user-points').textContent = userPoints;

            await loadBreakingNews();
            await loadContent();

            // Check for logged in user
            auth.onAuthStateChanged(user => {
                if (user) {
                    currentUser = user;
                    updateUserDisplay();
                }
            });
        }

        async function loadBreakingNews() {
            const ticker = document.getElementById('news-ticker');
            ticker.textContent = 'TAU Africa announces new partnership ‚Ä¢ Kabiru Ecosystem reaches 10,000 users ‚Ä¢ New features coming to TAU Main App ‚Ä¢ Join our content competitions and win amazing prizes!';
        }

        function setupLoginMethodChange() {
            const loginMethod = document.getElementById('login-method');
            if (loginMethod) {
                loginMethod.addEventListener('change', (e) => {
                    const label = document.getElementById('login-identifier-label');
                    const input = document.getElementById('login-identifier');
                    if (e.target.value === 'member-id') {
                        label.textContent = 'TAU Member ID';
                        input.placeholder = 'TSK-XXXXXX-XXX or TLK-XXXXXX-XXX';
                    } else {
                        label.textContent = 'Email';
                        input.placeholder = 'your@email.com';
                    }
                });
            }
        }

        function switchAccountTab(tab) {
            const loginContainer = document.getElementById('login-form-container');
            const registerContainer = document.getElementById('register-form-container');
            const loginTab = document.getElementById('account-tab-login');
            const registerTab = document.getElementById('account-tab-register');

            if (tab === 'login') {
                loginContainer.style.display = 'block';
                registerContainer.style.display = 'none';
                loginTab.className = 'flex-1 py-2 bg-purple-600 text-white rounded';
                registerTab.className = 'flex-1 py-2 bg-gray-700 text-white rounded';
            } else {
                loginContainer.style.display = 'none';
                registerContainer.style.display = 'block';
                loginTab.className = 'flex-1 py-2 bg-purple-600 text-white rounded';
            }
        }

        // Login Form Handler
        document.getElementById('login-form')?.addEventListener('submit', async (e) => {
            e.preventDefault();
            const method = document.getElementById('login-method').value;
            const identifier = document.getElementById('login-identifier').value;
            const password = document.getElementById('login-password').value;

            try {
                let email = identifier;
                
                // If using Member ID, look up email from Firestore
                if (method === 'member-id') {
                    const memberQuery = await db.collection('members')
                        .where('id', '==', identifier)
                        .limit(1)
                        .get();
                    
                    if (memberQuery.empty) {
                        showNotification('Member ID not found. Please check and try again.');
                        return;
                    }
                    
                    email = memberQuery.docs[0].data().email;
                }

                const userCredential = await auth.signInWithEmailAndPassword(email, password);
                currentUser = userCredential.user;
                
                // Load user data
                await loadUserData();
                
                showNotification('Login successful! Welcome back.');
                closeAccountModal();
                updateUserDisplay();
                
            } catch (error) {
                console.error('Login error:', error);
                showNotification('Login failed: ' + error.message);
            }
        });

        // Register Form Handler
        document.getElementById('register-form')?.addEventListener('submit', async (e) => {
            e.preventDefault();
            const name = document.getElementById('reg-name').value;
            const email = document.getElementById('reg-email').value;
            const memberId = document.getElementById('reg-member-id').value;
            const password = document.getElementById('reg-password').value;

            try {
                // Create Firebase auth account
                const userCredential = await auth.createUserWithEmailAndPassword(email, password);
                currentUser = userCredential.user;

                // Update profile
                await currentUser.updateProfile({ displayName: name });

                // Create user document
                await db.collection('users').doc(currentUser.uid).set({
                    name: name,
                    email: email,
                    tauMemberId: memberId || null,
                    ikbpBalance: memberId ? 100 : 0, // Bonus for linking Member ID
                    createdAt: firebase.firestore.FieldValue.serverTimestamp(),
                    referralCode: `TAU-${Math.random().toString(36).substr(2, 8).toUpperCase()}`
                });

                userPoints = memberId ? 100 : 0;
                localStorage.setItem('ikbp_points', userPoints);
                document.getElementById('user-points').textContent = userPoints;

                showNotification(memberId ? 
                    'Account created! You earned 100 iKbp for linking your TAU Member ID!' : 
                    'Account created successfully!');
                
                closeAccountModal();
                updateUserDisplay();

            } catch (error) {
                console.error('Registration error:', error);
                showNotification('Registration failed: ' + error.message);
            }
        });

        // Competition Form Handler
        document.getElementById('competition-form')?.addEventListener('submit', async (e) => {
            e.preventDefault();
            
            const memberId = document.getElementById('comp-member-id').value;
            const name = document.getElementById('comp-name').value;
            const email = document.getElementById('comp-email').value;
            const phone = document.getElementById('comp-phone').value;
            const competitionType = document.getElementById('comp-type').value;

            // Validate Member ID format
            if (!memberId.match(/^(TSK|TLK)-\d{6}-\d{3}$/)) {
                showNotification('Invalid Member ID format. Use: TSK-XXXXXX-XXX or TLK-XXXXXX-XXX');
                return;
            }

            try {
                // Send email via EmailJS
                await emailjs.send(EMAIL_CONFIG.serviceId, EMAIL_CONFIG.templateId, {
                    to_email: EMAIL_CONFIG.adminEmail,
                    subject: 'TAU TUBE Competition Registration',
                    message: `
                        New Competition Registration:
                        
                        TAU Member ID: ${memberId}
                        Name: ${name}
                        Email: ${email}
                        Phone: ${phone}
                        Competition: ${competitionType}
                        Date: ${new Date().toLocaleString()}
                    `
                }, EMAIL_CONFIG.publicKey);

                // Also send confirmation to participant
                await emailjs.send(EMAIL_CONFIG.serviceId, EMAIL_CONFIG.templateId, {
                    to_email: email,
                    subject: 'Welcome to TAU TUBE Competition!',
                    message: `
                        Dear ${name},
                        
                        Welcome to participation in ${competitionType}!
                        
                        Your registration has been received. We will contact you with further details soon.
                        
                        Competition Details:
                        - Member ID: ${memberId}
                        - Competition: ${competitionType}
                        
                        Good luck!
                        
                        TAU TUBE Team
                    `
                }, EMAIL_CONFIG.publicKey);

                showNotification('Welcome to participation! Registration submitted successfully.');
                closeCompetitionModal();
                document.getElementById('competition-form').reset();

            } catch (error) {
                console.error('Competition registration error:', error);
                showNotification('Registration failed. Please try again.');
            }
        });

        async function loadUserData() {
            if (!currentUser) return;

            try {
                const userDoc = await db.collection('users').doc(currentUser.uid).get();
                if (userDoc.exists) {
                    const userData = userDoc.data();
                    userPoints = userData.ikbpBalance || 0;
                    referralCode = userData.referralCode || '';
                    
                    localStorage.setItem('ikbp_points', userPoints);
                    document.getElementById('user-points').textContent = userPoints;
                }
            } catch (error) {
                console.error('Error loading user data:', error);
            }
        }

        function updateUserDisplay() {
            if (currentUser) {
                document.getElementById('account-name').textContent = currentUser.displayName || currentUser.email;
                document.getElementById('account-id').textContent = currentUser.email;
                
                const accountBtn = document.querySelector('button[onclick="showAccountModal()"]');
                accountBtn.innerHTML = '<i data-lucide="user" style="width: 18px; height: 18px;"></i> My Account';
                accountBtn.onclick = showDashboard;
                
                lucide.createIcons();
            }
        }

        function showDashboard() {
            document.getElementById('dashboard-modal').classList.remove('hidden');
            document.getElementById('dashboard-modal').classList.add('flex');
            
            // Update dashboard values
            document.getElementById('dash-ikbp').textContent = userPoints.toLocaleString();
            document.getElementById('dash-ksh').textContent = (userPoints / 10).toLocaleString();
            
            const referralLink = `https://magero1985.github.io/Tau-Africa/tau-tube.html?ref=${referralCode || 'SHARE'}`;
            document.getElementById('referral-link').value = referralLink;
            
            lucide.createIcons();
        }

        function closeDashboard() {
            document.getElementById('dashboard-modal').classList.add('hidden');
            document.getElementById('dashboard-modal').classList.remove('flex');
        }

        async function convertToIKb() {
            const amount = parseInt(document.getElementById('convert-amount').value);
            
            if (!amount || amount < 10000) {
                showNotification('Minimum conversion: 10,000 iKbp');
                return;
            }

            if (amount > userPoints) {
                showNotification('Insufficient iKbp balance');
                return;
            }

            if (amount % 10000 !== 0) {
                showNotification('Amount must be multiple of 10,000 iKbp');
                return;
            }

            const ikb = amount / 10000;
            
            if (!confirm(`Convert ${amount.toLocaleString()} iKbp to ${ikb} iKb?`)) {
                return;
            }

            try {
                userPoints -= amount;
                
                // Update Firestore
                await db.collection('users').doc(currentUser.uid).update({
                    ikbpBalance: userPoints,
                    ikbBalance: firebase.firestore.FieldValue.increment(ikb)
                });

                localStorage.setItem('ikbp_points', userPoints);
                document.getElementById('user-points').textContent = userPoints;
                
                showNotification(`Successfully converted to ${ikb} iKb!`);
                showDashboard(); // Refresh dashboard
                
            } catch (error) {
                console.error('Conversion error:', error);
                showNotification('Conversion failed. Please try again.');
            }
        }

        async function transferToKabiru() {
            const amount = parseInt(document.getElementById('transfer-amount').value);
            const walletId = document.getElementById('kabiru-wallet-id').value.trim();

            if (!amount || amount <= 0) {
                showNotification('Please enter a valid amount');
                return;
            }

            if (!walletId) {
                showNotification('Please enter Kabiru Wallet ID');
                return;
            }

            if (amount > userPoints) {
                showNotification('Insufficient iKbp balance');
                return;
            }

            if (!confirm(`Transfer ${amount.toLocaleString()} iKbp to Kabiru wallet: ${walletId}?`)) {
                return;
            }

            try {
                // Create transfer record
                await db.collection('kabiru_transfers').add({
                    fromUser: currentUser.uid,
                    fromEmail: currentUser.email,
                    toWallet: walletId,
                    amount: amount,
                    timestamp: firebase.firestore.FieldValue.serverTimestamp(),
                    status: 'pending'
                });

                userPoints -= amount;
                
                // Update user balance
                await db.collection('users').doc(currentUser.uid).update({
                    ikbpBalance: userPoints
                });

                localStorage.setItem('ikbp_points', userPoints);
                document.getElementById('user-points').textContent = userPoints;
                
                showNotification(`Transfer initiated! ${amount.toLocaleString()} iKbp will be credited to Kabiru wallet.`);
                document.getElementById('transfer-amount').value = '';
                document.getElementById('kabiru-wallet-id').value = '';
                showDashboard(); // Refresh dashboard
                
            } catch (error) {
                console.error('Transfer error:', error);
                showNotification('Transfer failed. Please try again.');
            }
        }

        function copyReferralLink() {
            const input = document.getElementById('referral-link');
            input.select();
            document.execCommand('copy');
            showNotification('Referral link copied to clipboard!');
        }

        function shareReferral() {
            const link = `https://magero1985.github.io/Tau-Africa/tau-tube.html?ref=${referralCode || 'SHARE'}`;
            
            if (navigator.share) {
                navigator.share({
                    title: 'Join TAU TUBE',
                    text: 'Join me on TAU TUBE and earn iKbp rewards!',
                    url: link
                });
            } else {
                const tempInput = document.createElement('input');
                tempInput.value = link;
                document.body.appendChild(tempInput);
                tempInput.select();
                document.execCommand('copy');
                document.body.removeChild(tempInput);
                showNotification('Referral link copied! Share it with friends.');
            }
        }

        function showAccountModal() {
            document.getElementById('account-modal').classList.remove('hidden');
            document.getElementById('account-modal').classList.add('flex');
            switchAccountTab('login');
            lucide.createIcons();
        }

        function closeAccountModal() {
            document.getElementById('account-modal').classList.add('hidden');
            document.getElementById('account-modal').classList.remove('flex');
        }

        function joinCompetition(compId) {
            document.getElementById('competition-modal').classList.remove('hidden');
            document.getElementById('competition-modal').classList.add('flex');
            lucide.createIcons();
        }

        function closeCompetitionModal() {
            document.getElementById('competition-modal').classList.add('hidden');
            document.getElementById('competition-modal').classList.remove('flex');
        }

        function showUploadModal() {
            showNotification('Upload feature coming soon!');
        }

        function togglePointsDropdown() {
            showNotification(`Your balance: ${userPoints.toLocaleString()} iKbp = ${(userPoints/10).toLocaleString()} KSH`);
        }

        function switchTab(tab) {
            currentTab = tab;
            
            ['videos', 'images', 'audio', 'live', 'competitions'].forEach(t => {
                const btn = document.getElementById(`tab-${t}`);
                if (t === tab) {
                    btn.className = 'px-4 py-3 text-sm bg-purple-600 text-white rounded-t';
                } else {
                    btn.className = 'px-4 py-3 text-sm text-gray-400 hover:text-white rounded-t';
                }
            });

            loadContent();
        }

        function setViewMode(mode) {
            viewMode = mode;
            
            document.getElementById('view-grid').className = mode === 'grid' ? 'p-2 text-purple-400 hover:text-white' : 'p-2 text-gray-400 hover:text-white';
            document.getElementById('view-list').className = mode === 'list' ? 'p-2 text-purple-400 hover:text-white' : 'p-2 text-gray-400 hover:text-white';
            
            loadContent();
        }

        async function loadContent() {
            const container = document.getElementById('content-grid');
            container.innerHTML = '<div class="col-span-full flex justify-center p-8"><div class="smooth-loader w-full h-32 relative overflow-hidden bg-gray-800 rounded-lg"></div></div>';

            setTimeout(() => {
                if (currentTab === 'competitions') {
                    loadCompetitions();
                } else {
                    loadMediaContent();
                }
            }, 500);
        }

        function loadCompetitions() {
            const container = document.getElementById('content-grid');
            container.className = 'grid grid-cols-1 md:grid-cols-2 gap-4';
            
            const competitions = [
                { id: 1, title: 'Best Video Creator of the Month', prize: '5000 iKbp + Featured Spot', deadline: '10 days left', participants: 234 },
                { id: 2, title: 'Audio Content Challenge', prize: '3000 iKbp', deadline: '15 days left', participants: 156 },
                { id: 3, title: 'Photography Competition', prize: '2000 iKbp + Equipment', deadline: '20 days left', participants: 389 }
            ];

            container.innerHTML = competitions.map(comp => `
                <div class="bg-gradient-to-r from-purple-600 to-teal-400 rounded-lg p-6">
                    <div class="bg-gray-900 rounded-lg p-4">
                        <div class="flex items-start justify-between mb-4">
                            <i data-lucide="trophy" class="text-yellow-400" style="width: 32px; height: 32px;"></i>
                            <span class="bg-red-600 text-white px-3 py-1 rounded-full text-sm">${comp.deadline}</span>
                        </div>
                        <h3 class="text-white text-xl font-bold mb-2">${comp.title}</h3>
                        <p class="text-yellow-400 font-semibold mb-3">üèÜ Prize: ${comp.prize}</p>
                        <p class="text-gray-400 text-sm mb-4">üë• ${comp.participants} participants</p>
                        <button onclick="joinCompetition(${comp.id})" class="w-full bg-gradient-to-r from-purple-600 to-teal-400 text-white py-3 rounded-lg hover:opacity-90 font-semibold">
                            Join Competition
                        </button>
                    </div>
                </div>
            `).join('');
            
            lucide.createIcons();
        }

        function loadMediaContent() {
            const container = document.getElementById('content-grid');
            container.className = viewMode === 'grid' ? 'grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-4' : 'grid grid-cols-1 gap-4';
            
            container.innerHTML = '<div class="col-span-full text-center text-gray-400 py-8">Content coming soon...</div>';
        }

        function showNotification(message) {
            const toast = document.getElementById('notification-toast');
            const text = document.getElementById('notification-text');
            text.textContent = message;
            toast.classList.remove('hidden');
            
            setTimeout(() => {
                toast.classList.add('hidden');
            }, 5000);
        }

        function closeNotification() {
            document.getElementById('notification-toast').classList.add('hidden');
        }
    </script>
</body>
                            </html>
