<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <title>TAU Africa Global</title>
    <meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=5.0, user-scalable=yes">
<meta name="apple-mobile-web-app-capable" content="yes">
<meta name="apple-mobile-web-app-status-bar-style" content="default">
<meta name="format-detection" content="telephone=no">
    <link rel="manifest" href="manifest.json">
<meta name="theme-color" content="#4169e1">
<meta name="apple-mobile-web-app-capable" content="yes">
<meta name="apple-mobile-web-app-status-bar-style" content="default">
<meta name="apple-mobile-web-app-title" content="TAU Africa">
<link rel="apple-touch-icon" href="icon-192.png">
    <title>TAU AFRICA INTERNATIONAL</title>
    
    <!-- EmailJS SDK -->
    <script type="text/javascript" src="https://cdn.jsdelivr.net/npm/@emailjs/browser@4/dist/email.min.js"></script>
    
    <style>
        /* Safari/iOS Compatibility Fixes */
* {
    -webkit-tap-highlight-color: transparent;
    -webkit-touch-callout: none;
}

body {
    -webkit-overflow-scrolling: touch;
    overflow-scrolling: touch;
}

/* Fix buttons on iOS */
button, input[type="submit"], input[type="button"] {
    -webkit-appearance: none;
    -moz-appearance: none;
    appearance: none;
    cursor: pointer;
}

/* Fix inputs on iOS */
input, select, textarea {
    -webkit-appearance: none;
    -moz-appearance: none;
    appearance: none;
    border-radius: 10px;
}

/* Fix modal scrolling on iOS */
.modal {
    -webkit-overflow-scrolling: touch;
    overflow-scrolling: touch;
}

.modal-content {
    -webkit-overflow-scrolling: touch;
    overflow-scrolling: touch;
}

/* Fix for Safari date input */
input[type="date"] {
    -webkit-appearance: none;
    appearance: none;
    min-height: 44px;
}

/* Fix button clicks on iOS */
.btn, .level-btn, .house-btn, .corporate-btn {
    cursor: pointer;
    -webkit-user-select: none;
    user-select: none;
    touch-action: manipulation;
}
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: 'Arial', sans-serif;
            background: linear-gradient(135deg, #1e3c72, #2a5298, #87ceeb);
            min-height: 100vh;
            color: #333;
        }

        .container {
            max-width: 1200px;
            margin: 0 auto;
            padding: 20px;
        }

        .header {
            text-align: center;
            margin-bottom: 30px;
            background: linear-gradient(45deg, #000080, #4169e1, #87ceeb);
            color: white;
            padding: 30px;
            border-radius: 20px;
            box-shadow: 0 10px 30px rgba(0,0,0,0.3);
            position: relative;
            overflow: hidden;
        }

        .emancipation-scroll {
            position: absolute;
            bottom: 5px;
            left: 0;
            width: 100%;
            height: 20px;
            overflow: hidden;
            background: rgba(255, 215, 0, 0.2);
            border-radius: 10px;
        }

        .emancipation-text {
            display: inline-block;
            white-space: nowrap;
            font-size: 12px;
            font-weight: bold;
            color: #ffd700;
            animation: scrollText 15s linear infinite;
            line-height: 20px;
            text-shadow: 1px 1px 2px rgba(0,0,0,0.5);
        }

        @keyframes scrollText {
            0% { transform: translateX(100%); }
            100% { transform: translateX(-100%); }
        }

        .logo {
            width: 120px;
            height: 120px;
            background: radial-gradient(circle, #87ceeb, #4169e1);
            border-radius: 50%;
            margin: 0 auto 20px;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 24px;
            font-weight: bold;
            border: 4px solid #ffd700;
        }

        .main-title {
            font-size: 2.8rem;
            font-weight: bold;
            margin-bottom: 10px;
            text-shadow: 2px 2px 4px rgba(0,0,0,0.5);
            letter-spacing: 2px;
        }

        .vision {
            font-size: 1.2rem;
            font-style: italic;
            opacity: 0.9;
        }

        .social-links {
            display: flex;
            justify-content: center;
            gap: 20px;
            margin-top: 20px;
            flex-wrap: wrap;
        }

        .social-link {
            display: inline-flex;
            align-items: center;
            padding: 8px 16px;
            background: rgba(255,255,255,0.2);
            border-radius: 20px;
            color: white;
            text-decoration: none;
            transition: all 0.3s ease;
            font-size: 14px;
        }

        .social-link:hover {
            background: rgba(255,255,255,0.3);
            transform: scale(1.05);
        }

        .wings-container {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 30px;
            margin-bottom: 40px;
        }

        .wing {
            background: rgba(255,255,255,0.95);
            border-radius: 20px;
            padding: 30px;
            box-shadow: 0 15px 35px rgba(0,0,0,0.2);
            transition: all 0.3s ease;
        }

        .wing:hover {
            transform: translateY(-5px);
            box-shadow: 0 20px 40px rgba(0,0,0,0.3);
        }

        .auffi {
            background: linear-gradient(135deg, #ff6b6b, #4ecdc4);
            color: white;
        }

        .valenta {
            background: linear-gradient(135deg, #667eea, #764ba2);
            color: white;
        }

        .wing-title {
            font-size: 2rem;
            font-weight: bold;
            margin-bottom: 15px;
            text-align: center;
        }

        .wing-description {
            margin-bottom: 20px;
            line-height: 1.6;
        }

        .houses-grid {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 15px;
            margin-bottom: 20px;
        }

        .house-btn, .corporate-btn {
            background: rgba(255,255,255,0.2);
            border: 2px solid rgba(255,255,255,0.3);
            color: white;
            padding: 15px;
            border-radius: 15px;
            cursor: pointer;
            transition: all 0.3s ease;
            text-align: center;
            font-weight: bold;
        }

        .house-btn:hover, .corporate-btn:hover {
            background: rgba(255,255,255,0.3);
            transform: scale(1.05);
        }

        .galaxy-banner {
            background: linear-gradient(45deg, #ffd700, #ffed4e);
            color: #333;
            padding: 10px;
            border-radius: 10px;
            text-align: center;
            font-weight: bold;
            margin-top: 15px;
        }

        .main-sections {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(300px, 1fr));
            gap: 25px;
            margin-bottom: 40px;
        }

        .section {
            background: rgba(255,255,255,0.95);
            border-radius: 15px;
            padding: 25px;
            box-shadow: 0 10px 25px rgba(0,0,0,0.15);
            transition: all 0.3s ease;
        }

        .section:hover {
            transform: translateY(-3px);
            box-shadow: 0 15px 35px rgba(0,0,0,0.2);
        }

        .section-title {
            font-size: 1.5rem;
            font-weight: bold;
            color: #2a5298;
            margin-bottom: 15px;
            text-align: center;
        }

        .btn {
            background: linear-gradient(45deg, #4169e1, #87ceeb);
            color: white;
            border: none;
            padding: 12px 24px;
            border-radius: 25px;
            cursor: pointer;
            font-weight: bold;
            transition: all 0.3s ease;
            margin: 5px;
            display: inline-block;
            text-decoration: none;
        }

        .btn:hover {
            background: linear-gradient(45deg, #2a5298, #4169e1);
            transform: scale(1.05);
        }

        .btn-register {
            background: linear-gradient(45deg, #ff6b6b, #ee5a24);
            font-size: 1.1rem;
            padding: 15px 30px;
        }

        .btn-kabiru {
            background: linear-gradient(45deg, #ffd700, #ffed4e);
            color: #333;
            font-weight: bold;
            width: 100%;
            padding: 15px;
            margin-top: 20px;
        }

        .modal {
            display: none;
            position: fixed;
            z-index: 1000;
            left: 0;
            top: 0;
            width: 100%;
            height: 100%;
            background-color: rgba(0,0,0,0.7);
            overflow-y: auto;
        }

        .modal-content {
            background-color: white;
            margin: 2% auto;
            padding: 30px;
            border-radius: 20px;
            width: 90%;
            max-width: 600px;
            max-height: 95vh;
            overflow-y: auto;
            position: relative;
        }

        .close {
            color: #aaa;
            float: right;
            font-size: 28px;
            font-weight: bold;
            cursor: pointer;
            position: absolute;
            right: 20px;
            top: 15px;
        }

        .close:hover {
            color: #000;
        }

        .form-group {
            margin-bottom: 20px;
        }

        .form-group label {
            display: block;
            margin-bottom: 5px;
            font-weight: bold;
            color: #2a5298;
        }

        .form-group input, .form-group select, .form-group textarea {
            width: 100%;
            padding: 12px;
            border: 2px solid #ddd;
            border-radius: 10px;
            font-size: 16px;
        }

        .form-group input:focus, .form-group select:focus, .form-group textarea:focus {
            border-color: #4169e1;
            outline: none;
        }

        .payment-info {
            background: linear-gradient(45deg, #ffd700, #ffed4e);
            padding: 20px;
            border-radius: 15px;
            margin: 20px 0;
            text-align: center;
        }

        .level-selection {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 10px;
            margin-top: 10px;
        }

        .level-btn {
            padding: 10px;
            border:form solid #4169e1;
            background: rgba(65, 105, 225, 0.1);
            border-radius: 10px;
            cursor: pointer;
            transition: all 0.3s ease;
            text-align: center;
        }

        .level-btn.selected {
            background: #4169e1;
            color: white;
        }

        .kabiru-section {
            background: linear-gradient(135deg, #ffd700, #ffed4e);
            color: #333;
            text-align: center;
            padding: 30px;
            border-radius: 20px;
            margin-top: 30px;
        }

        .payment-modal {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0,0,0,0.8);
            display: flex;
            justify-content: center;
            align-items: center;
            z-index: 2000;
        }

        .payment-widget {
            background: white;
            padding: 30px;
            border-radius: 20px;
            text-align: center;
            max-width: 400px;
            width: 90%;
        }

        .payment-input {
            width: 100%;
            padding: 12px;
            border: 2px solid #ddd;
            border-radius: 10px;
            margin: 10px 0;
            font-size: 16px;
            text-align: center;
        }

        .spinner {
            border: 4px solid #f3f3f3;
            border-top: 4px solid #4169e1;
            border-radius: 50%;
            width: 40px;
            height: 40px;
            animation: spin 1s linear infinite;
            margin: 20px auto;
        }

        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }

        .notification {
    position: fixed;
    top: 20px;
    right: 20px;
    padding: 20px;
    border-radius: 10px;
    color: white;
    font-weight: bold;
    z-index: 20000; /* Highest priority */
    display: none;
    max-width: 350px;
    box-shadow: 0 5px 15px rgba(0,0,0,0.3);
}

        .success { background: #2ecc71; }
        .error { background: #e74c3c; }

        .floating-btn {
            position: fixed;
            bottom: 30px;
            right: 30px;
            width: 60px;
            height: 60px;
            background: linear-gradient(45deg, #4169e1, #87ceeb);
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            color: white;
            font-size: 24px;
            cursor: pointer;
            box-shadow: 0 4px 12px rgba(0,0,0,0.3);
            transition: all 0.3s ease;
            z-index: 100;
        }

        .floating-btn:hover {
            transform: scale(1.1);
            box-shadow: 0 6px 20px rgba(0,0,0,0.4);
        }

        .ai-assistant {
            position: fixed;
            bottom: 100px;
            right: 30px;
            width: 60px;
            height: 60px;
            background: linear-gradient(45deg, #ff6b6b, #4ecdc4);
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            color: white;
            font-size: 24px;
            cursor: pointer;
            box-shadow: 0 4px 12px rgba(0,0,0,0.3);
            transition: all 0.3s ease;
            z-index: 100;
            animation: pulse 2s infinite;
        }

        @keyframes pulse {
            0% { box-shadow: 0 0 0 0 rgba(255, 107, 107, 0.7); }
            70% { box-shadow: 0 0 0 10px rgba(255, 107, 107, 0); }
            100% { box-shadow: 0 0 0 0 rgba(255, 107, 107, 0); }
        }

        .ai-chat-window {
            position: fixed;
            bottom: 170px;
            right: 30px;
            width: 350px;
            height: 450px;
            background: white;
            border-radius: 20px;
            box-shadow: 0 10px 30px rgba(0,0,0,0.3);
            display: none;
            flex-direction: column;
            z-index: 200;
        }

        .ai-chat-header {
            background: linear-gradient(45deg, #ff6b6b, #4ecdc4);
            color: white;
            padding: 15px 20px;
            border-radius: 20px 20px 0 0;
            font-weight: bold;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .ai-chat-messages {
            flex: 1;
            padding: 20px;
            overflow-y: auto;
            max-height: 300px;
        }

        .ai-message {
            background: #f0f0f0;
            padding: 10px 15px;
            border-radius: 15px;
            margin: 10px 0;
            max-width: 80%;
        }

        .user-message {
            background: linear-gradient(45deg, #4169e1, #87ceeb);
            color: white;
            margin-left: auto;
        }

        .ai-chat-input {
            display: flex;
            padding: 15px;
            border-top: 1px solid #eee;
        }

        .ai-chat-input input {
            flex: 1;
            padding: 10px;
            border: 1px solid #ddd;
            border-radius: 20px;
            outline: none;
        }

        .ai-chat-input button {
            background: linear-gradient(45deg, #ff6b6b, #4ecdc4);
            color: white;
            border: none;
            padding: 10px 15px;
            border-radius: 50%;
            margin-left: 10px;
            cursor: pointer;
        }

        @media (max-width: 768px) {
            .wings-container {
                grid-template-columns: 1fr;
            }
            
            .main-title {
                font-size: 2rem;
            }
            
            .houses-grid {
                grid-template-columns: 1fr;
            }
            
            .ai-chat-window {
                width: 90%;
                right: 5%;
                left: 5%;
            }
            
            .social-links {
                gap: 10px;
            }
            
            .social-link {
                font-size: 12px;
                padding: 6px 12px;
            }
        }
        
        .btn-small {
            padding: 10px 15px;
            font-size: 14px;
            min-width: 120px;
        }
    </style>
</head>
<body>
    <div class="container">
        <!-- Header -->
        <div class="header">
            <div class="logo">üåç TAU</div>
            <h1 class="main-title">TAU AFRICA ECOSYSTEM</h1>
            <p class="vision">Community ‚Ä¢ Value ‚Ä¢ Corporate ‚Ä¢ Sovereignty</p>
            
            <!-- Social Media Links -->
            <div class="social-links">
                <a href="https://x.com/grouptauafrica?t=pFlJ-gky_A7Dp3e0lbZ5Sg&s=09" target="_blank" class="social-link">
                    üê¶ Twitter/X
                </a>
                <a href="https://www.tiktok.com/@tau.africa.nairob?_t=ZM-8zwbvmFtmt2&_r=1" target="_blank" class="social-link">
                    üéµ TikTok
                </a>
                <a href="https://youtube.com/@tauafrica8922?si=wwgxc2AvYHYwsHTh" target="_blank" class="social-link">
                    üì∫ YouTube
                </a>
                <span class="social-link" style="opacity: 0.7;">
                    üìò Facebook (Coming Soon)
                </span>
            </div>
            
            <div class="emancipation-scroll">
                <div class="emancipation-text">KABIRU DIGITAL VALUE CURRENCY ‚Ä¢ ECONOMIC FREEDOM FOR ALL AFRICANS ‚Ä¢ KABIRU TECH CENTERS‚Ä¢ KABIRU SYS AGENTS ‚Ä¢ KABIRU SYS VALIDATORS‚Ä¢ KABIRU SYS CARE</div>
            </div>
        </div>

        <!-- Two Wings -->
        <div class="wings-container">
            <!-- AUFFI Wing -->
            <div class="wing auffi">
                <h2 class="wing-title">üåç KABIRU DIGITAL VALUE CURRENCY!</h2>
                <p class="wing-description">We are building TAU AFRICA ECOSYSTEM and KABIRU DIGITAL VALUE CURRENCY for Africa Awakening and Empowerment. Our Digital Value product and Ecosystem are dedicated to harnessing Africa's human and potential values to create the continent's own Sovereign Wealth. Join us in the Initiative for Community ‚Ä¢ Value ‚Ä¢ Corporate ‚Ä¢ Sovereignty ‚Ä¢ 

You can participate in the Initiative and earn iKbp by proofing & validating values:

System Cares, 

System Validators,

System Agents, & 

System Membership TASK & TALK. 
To join in these categories, please use KABIRU SERVICE CENTER portal</p>
                
                <div class="houses-grid">
                    <div class="house-btn" onclick="showNotification('become human validator,  validate real humans and Earn iKbp!')">System-Care [1st Validation]</div>
                    <div class="house-btn" onclick="showNotification('become value validator, validate real values and Earn iKbp!')">System-Validator [2nd Validation]</div>
                    <div class="house-btn" onclick="showNotification('become Chain validator,  validate value change and Earn iKbp!')">System-Agents [3rd Validation]</div>
                    <div class="house-btn" onclick="showNotification('become ecosystem miner and member, Earn iKbp on all values')">Kabiru-Ecosystem [Kabiru & Utility Apps]</div>
                </div>
                
                <div class="galaxy-banner">
                    AUFFI - The Pan African Trust Graph System<br> [COMMUNITY - VALUE - CORPORATE - SOVEREIGNTY]  Our digital Ecosystem uses human & environmental values to create Africa's Sovereign Wealth, and subsequently bring back Sovereignty to black people and humanity. join the Kabiru Mining App to mine your values in building The African digital currency (Kabiru)
                </div>
                
                <button class="btn" onclick="openModal('parSirai')">KABIRU SERVICE CENTERS</button>
            </div>

            <!-- Valenta Wing -->
            <div class="wing valenta">
                <h2 class="wing-title">üè¢ VALENTA PLC</h2>
                <p class="wing-description">Value Enter Africa - TAU HOLDINGS VEHICLE, the company building Kabiru Digital currency for Africa value harnessing, erecting a sustainable Kabiru digital ecosystem, & Empowering African communities through Education - Economic and Social Literacy. Come let us build our sovereignty together, and make Africa great again</p>

                <div class="houses-grid">
                    <div class="corporate-btn" onclick="openModal('corporate')">TAU AUFFI TRUST GRAPH</div>
                    <div class="corporate-btn" onclick="openModal('trustGraph')">TAU AFRICA FOUNDATION</div>
                    <div class="corporate-btn" onclick="openModal('foundation')">TAU VALENTA HOLDINGS LTD</div>
                    <div class="corporate-btn" onclick="openModal('holdings')">TAU CORPORATE VENTURES</div>
                </div>
            </div>
        </div>

        <!-- Main Sections -->
        <div class="main-sections">
            <!-- Membership Registration -->
            <div class="section">
                <h3 class="section-title">üë• MEMBERSHIP</h3>
                <p>Join our Ecosystem through TASK & TALK teams</p>
                <button class="btn btn-register" onclick="openModal('taskRegistration')">Join TASK Team</button>
                <button class="btn btn-register" onclick="openModal('talkRegistration')">Join TALK Team</button>
                <p style="margin-top: 15px; font-weight: bold; color: #e74c3c;">TASK Fee: KSH 1000 | TALK Fee: KSH 5,000. Renewable annually for continued earnings. Begin Earning real benefits and expand with the system. See Tau Africa Blueprint on comprehensive member benefits</p>
            </div>
            <!-- Add this button to your main sections area -->
<div class="section">
    <h3 class="section-title">üíé PROVIDE VALUE</h3>
    <p>Provide products, services, skills, labour, innovation, profession, knowledge or time</p>
    <button class="btn" onclick="openValueSubmissionModal()">Submit Your Value</button>
    <p style="margin-top: 15px; font-size: 0.9rem; color: #666;">
        Earn iKbp when your value is validated!
    </p>
</div>
            
            <!-- PUBLIC OPPORTUNITIES SECTION-->
<div class="main-sections" style="margin-top: 40px;">
    <div class="section" style="grid-column: 1 / -1;">
        <h3 class="section-title">üéØ COMPLETE AND EARN </h3>
        <p style="text-align: center; margin-bottom: 20px;">Engage with values, tasks, activities to earn iKbp and iKb from the comfort of your smartphone!</p>
        
        <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 10px; margin-bottom: 20px; max-width: 400px; margin-left: auto; margin-right: auto;">
    <button class="btn btn-small" onclick="filterOpportunities('all')" id="filter-all">All</button>
    <button class="btn btn-small" onclick="filterOpportunities('activities')" id="filter-activities">Activities</button>
    <button class="btn btn-small" onclick="filterOpportunities('tasks')" id="filter-tasks">Tasks</button>
    <button class="btn btn-small" onclick="filterOpportunities('values')" id="filter-values">Values</button>
</div>
        
        <div id="publicOpportunitiesContainer"></div>
    </div>
</div>
            <!-- Activity Area -->
            <div class="section">
                <h3 class="section-title">üìö ACTIVITIES</h3>
                <p>Training workshops, job creation & research services</p>
                <button class="btn" onclick="openModal('training')">Member Trainings</button>
                <button class="btn" onclick="openModal('workshop')">Hosting Workshops</button>
                <button class="btn" onclick="openModal('research')">Research Services</button>
                <button class="btn" onclick="openModal('jobCreation')">Job Creation hubs</button>
            </div>

            <!-- Jobs Area -->
<div class="section">
    <h3 class="section-title">üíº JOBS GALLERY</h3>
    <p>Connect jobs and job seekers with verified opportunities</p>
    <button class="btn" onclick="openJobsGallery('post')">Job Opening</button>
    <button class="btn" onclick="openJobsGallery('search')">Job Search</button>
    <button class="btn" onclick="openJobsGallery('browse')">Jobs Portal</button>
    <button class="btn" onclick="openJobsGallery('apply')">Apply for Job</button>
</div>

            <!-- Community -->
            <div class="section">
                <h3 class="section-title">ü§ù COMMUNITY PROGRAMS</h3>
                <p>Community upgrade support programs</p>
                <button class="btn" onclick="openModal('community')">Join Programs</button>
                <div style="margin-top: 10px; font-size: 0.9rem;">
                    Agriculture ‚Ä¢ Climate ‚Ä¢ Environment<br>
                    Water & Sanitation ‚Ä¢ Education ‚Ä¢ Child Care ‚Ä¢ business 
                </div>
            </div>

            <!-- Interactive Forum -->
            <div class="section">
                <h3 class="section-title">üí¨ MEMBER FORUM</h3>
                <p>Connect, share ideas, and collaborate with fellow ecosystem members</p>
                <button class="btn" onclick="openModal('forum')">Access Forum</button>
                <div style="margin-top: 10px; font-size: 0.9rem;">
                    Discussions ‚Ä¢ Job Sharing ‚Ä¢ Training Materials<br>
                    Voice Calls ‚Ä¢ Messaging ‚Ä¢ Networking
                </div>
            </div>
        </div>

        <!-- Kabiru Mining Section -->
        <div class="kabiru-section">
            <h2>‚ö° KABIRU MINING</h2>
            <p>Mine Kabiru tokens by proving and validating real values</p>
            <button class="btn-kabiru" onclick="window.open('https://magero1985.github.io/Kabiru-Mining-Portal-/', '_blank')">Access Kabiru Mining App</button>
        </div>
    </div>

<!-- Notification -->
    <div id="notification" class="notification"></div>
<!-- Notification Bell Icon - Add to your header -->
<div id="tauNotificationBell" style="position: fixed; top: 20px; right: 80px; z-index: 1000;">
    <button onclick="openTauNotifications()" style="background: #667eea; color: white; border: none; padding: 12px; border-radius: 50%; cursor: pointer; box-shadow: 0 4px 12px rgba(0,0,0,0.2); position: relative;">
        üîî
        <span id="tauNotifBadge" style="display: none; position: absolute; top: -5px; right: -5px; background: red; color: white; border-radius: 50%; width: 20px; height: 20px; font-size: 10px; line-height: 20px; text-align: center;">0</span>
    </button>
</div>

<!-- Notification Panel -->
<div id="tauNotificationPanel" style="display: none; position: fixed; top: 70px; right: 20px; width: 350px; max-height: 500px; background: white; border-radius: 15px; box-shadow: 0 10px 30px rgba(0,0,0,0.3); z-index: 1000; overflow-y: auto;">
    <div style="padding: 20px; border-bottom: 2px solid #eee;">
        <h3 style="margin: 0;">üîî Notifications</h3>
    </div>
    <div id="tauNotificationList" style="padding: 10px;"></div>
</div>

    <!-- Floating Member Access Button -->
    <div class="floating-btn" onclick="showRealMemberLogin()" title="Member Access">üë§</div>
    <!-- Add this with your other floating buttons -->
<div class="floating-btn" onclick="showValidatorInterface()" title="Validator Access" style="bottom: 170px; right: 30px; background: linear-gradient(45deg, #9b59b6, #8e44ad);">
    üîê
</div>

<!-- Add this for admin validation dashboard access -->
<div class="floating-btn" onclick="openAdminBridge()" title="Admin Database" style="bottom: 240px; right: 30px; background: linear-gradient(45deg, #e74c3c, #c0392b);">
    üìä
</div>
    <!-- AI Chat Window -->
    <div class="ai-chat-window" id="aiChatWindow">
        <div class="ai-chat-header">
            <span>TAU AI Assistant</span>
            <span onclick="toggleAIChat()" style="cursor: pointer;">‚úñ</span>
        </div>
        <div class="ai-chat-messages" id="aiChatMessages">
            <div class="ai-message">
                Hello! I'm your TAU Africa AI assistant. I can help you with:
                <br>‚Ä¢ Navigating the app
                <br>‚Ä¢ Understanding registration process
                <br>‚Ä¢ Payment procedures
                <br>‚Ä¢ Technical support
                <br>‚Ä¢ General questions about TAU Africa
                <br><br>How can I assist you today?
            </div>
        </div>
        <div class="ai-chat-input">
            <input type="text" id="aiChatInput" placeholder="Ask me anything..." onkeypress="handleAIChatKeyPress(event)">
            <button onclick="sendAIMessage()">‚û§</button>
        </div>
        <button onclick="‚úÖ Validate()">‚û§</button>
    </div>
</div>
        <!-- Public Access Button (NEW) -->
    <div class="floating-btn" onclick="showPublicRegistration()" title="Public Access" style="bottom: 100px; right: 30px; background: linear-gradient(45deg, #27ae60, #2ecc71);">
        üåç
    </div>
    </div>

<!-- Firebase SDK -->
<script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-app-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-auth-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-firestore-compat.js"></script>
</script>
<!-- EmailJS SDK -->
<script src="https://cdn.jsdelivr.net/npm/@emailjs/browser@4/dist/email.min.js"></script>
<script>
// ============================================
// TAU AFRICA - UNIFIED EMAIL SYSTEM (FIXED)
// ============================================
(function() {
    'use strict';
    
    console.log('üìß Loading Email System...');
    
    // ============================================
    // 1. SINGLE EMAIL CONFIGURATION
    // ============================================
    const EMAIL_CONFIG = {
        serviceId: 'service_xfira7g',
        templateId: 'template_bqxztig',  // Use this ONE template for all emails
        publicKey: 'GhjI14eQVGgOli0j1',
        adminEmail: 'grouptauafrica@gmail.com'
    };
    
    // ============================================
    // 2. INITIALIZE EMAILJS (ONCE)
    // ============================================
    let emailInitialized = false;
    
    function initEmailJS() {
        if (emailInitialized) return true;
        
        if (typeof emailjs === 'undefined') {
            console.error('‚ùå EmailJS library not loaded');
            return false;
        }
        
        try {
            emailjs.init({ publicKey: EMAIL_CONFIG.publicKey });
            emailInitialized = true;
            console.log('‚úÖ EmailJS initialized');
            return true;
        } catch (error) {
            console.error('‚ùå EmailJS init failed:', error);
            return false;
        }
    }
    
    // Initialize immediately
    setTimeout(initEmailJS, 500);
    
    // ============================================
    // 3. CORE EMAIL FUNCTION (Used by all)
    // ============================================
    async function sendEmail(toEmail, toName, subject, message, additionalParams = {}) {
        if (!initEmailJS()) {
            console.error('‚ùå Cannot send email - EmailJS not ready');
            return { success: false, error: 'EmailJS not initialized' };
        }
        
        const templateParams = {
            to_email: toEmail,
            to_name: toName,
            from_name: 'TAU Africa',
            from_email: EMAIL_CONFIG.adminEmail,
            subject: subject,
            message: message,
            ...additionalParams  // Allows passing phone, location, etc.
        };
        
        console.log('üìß Sending email...', { to: toEmail, subject });
        
        try {
            const response = await emailjs.send(
                EMAIL_CONFIG.serviceId,
                EMAIL_CONFIG.templateId,
                templateParams
            );
            
            console.log('‚úÖ Email sent:', response.status);
            return { success: true, status: response.status };
            
        } catch (error) {
            console.error('‚ùå Email failed:', error);
            return { success: false, error: error.text || error.message };
        }
    }
    
    // ============================================
    // 4. SEND WELCOME EMAIL TO MEMBER
    // ============================================
    window.sendWelcomeEmail = async function(member) {
        const message = `
Dear ${member.fullName},

üéâ WELCOME TO TAU AFRICA INTERNATIONAL! üéâ

‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ
YOUR MEMBERSHIP DETAILS
‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ

üë§ Member ID: ${member.id}
üìß Email: ${member.email}
üì± Phone: ${member.phone}
üìç Location: ${member.location}
üë• Team: ${member.team}
üí∞ Registration Fee: KSH ${member.fee} ‚úÖ PAID

‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ
YOUR BENEFITS
‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ

üéÅ Welcome Bonus: 500 iKbp (KSH 50) - CREDITED!
üîë Referral Code: ${member.referralCode}
   Share to earn 500 iKbp per referral!

üíé Start earning:
   ‚Ä¢ Complete activities: 100-500 iKbp each
   ‚Ä¢ Complete tasks: 200-5000 iKbp each
   ‚Ä¢ Submit values: Earn iKb
   ‚Ä¢ Refer friends: 500 iKbp each

‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ
NEXT STEPS
‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ

1. Login with your Member ID or Email
2. Complete your first activity (earn 100 iKbp!)
3. Share your referral code
4. Explore the Kabiru Mining App

üåê Access your dashboard:
   ${window.location.origin}

üìß Need help? Contact:
   grouptauafrica@gmail.com

Welcome to the TAU Africa family!

Best regards,
TAU Africa Team
üåç Building Africa's Digital Future
        `.trim();
        
        return await sendEmail(
            member.email,
            member.fullName,
            'üéâ Welcome to TAU Africa International!',
            message,
            {
                phone: member.phone,
                location: member.location,
                member_id: member.id,
                referral_code: member.referralCode
            }
        );
    };
    
    // ============================================
    // 5. SEND NOTIFICATION TO ADMIN
    // ============================================
    window.sendEmailToAdmin = async function(formData, subject) {
        const memberName = formData.fullName || formData.name || 'New Member';
        const team = formData.team || 'TASK';
        const fee = formData.fee || (team === 'TASK' ? 500 : team === 'TALK' ? 2000 : 1500);
        
        const message = `
NEW REGISTRATION RECEIVED
‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ

üë§ Name: ${memberName}
üìß Email: ${formData.email}
üì± Phone: ${formData.phone}
üìç Location: ${formData.location}
üë• Team: ${team}
üí∞ Fee: KSH ${fee} ‚úÖ PAID
üìÖ Date: ${new Date().toLocaleString()}

${formData.id ? 'üÜî Member ID: ' + formData.id : ''}
${formData.referralCode ? 'üîë Referral Code: ' + formData.referralCode : ''}

‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ
Additional Information:
${JSON.stringify(formData, null, 2)}

‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ
TAU Africa Registration System
        `.trim();
        
        return await sendEmail(
            EMAIL_CONFIG.adminEmail,
            'TAU Africa Admin',
            subject,
            message,
            {
                phone: formData.phone,
                location: formData.location,
                team: team
            }
        );
    };
    
    // ============================================
    // 6. SEND REFERRAL NOTIFICATION
    // ============================================
    window.sendReferralNotification = async function(referrer, earnings) {
        const message = `
Congratulations ${referrer.fullName}!

üéâ REFERRAL BONUS EARNED! üéâ

You've earned ${earnings} iKbp (KSH ${earnings/10}) from your referral.

üí∞ Current Balance: ${referrer.iKbpBalance || 0} iKbp
üîë Your Referral Code: ${referrer.referralCode}

Keep sharing to earn more!

Best regards,
TAU Africa Team
        `.trim();
        
        return await sendEmail(
            referrer.email,
            referrer.fullName,
            'üéÅ Referral Bonus Earned!',
            message
        );
    };
    
    // ============================================
    // 7. OVERRIDE SUCCESS HANDLERS WITH PROPER EMAIL
    // ============================================
    
    // TASK Registration Success
    window.processTaskSuccess = async function(formData) {
        console.log('üéØ Processing TASK registration...');
        
        try {
            // 1. Save to database
            const referralCode = window.TauDB?.checkReferralCode();
            const syncResult = window.TauDB?.sync(formData, 'TASK', referralCode);
            
            if (!syncResult || !syncResult.success) {
                throw new Error('Database sync failed');
            }
            
            const member = syncResult.member;
            console.log('‚úÖ Member saved:', member.id);
            
            // 2. Award welcome bonus
            if (window.TauDB?.updateBalance) {
                window.TauDB.updateBalance(member.id, 500);
                console.log('üéÅ Welcome bonus: 500 iKbp');
            }
            
            // 3. Create notification
            if (typeof createNotification === 'function') {
                createNotification(
                    member.id,
                    'üéâ Welcome to TAU Africa!',
                    `Member ID: ${member.id}\nWelcome Bonus: 500 iKbp`,
                    'success'
                );
            }
            
            // 4. Send emails (parallel)
            showNotification('üìß Sending confirmation emails...', 'info');
            
            const [welcomeResult, adminResult] = await Promise.allSettled([
                sendWelcomeEmail(member),
                sendEmailToAdmin(member, 'NEW TASK REGISTRATION - PAYMENT CONFIRMED')
            ]);
            
            // 5. Check email results
            const welcomeSent = welcomeResult.status === 'fulfilled' && welcomeResult.value.success;
            const adminSent = adminResult.status === 'fulfilled' && adminResult.value.success;
            
            console.log('üìß Email results:', { welcomeSent, adminSent });
            
            // 6. Show appropriate notification
            let message = '‚úÖ Registration complete!';
            if (welcomeSent && adminSent) {
                message += ' Confirmation emails sent to you and admin.';
            } else if (welcomeSent) {
                message += ' Welcome email sent to you.';
            } else if (adminSent) {
                message += ' Admin notified.';
            } else {
                message += ' Emails may be delayed - check inbox in a few minutes.';
            }
            
            showNotification(message, 'success');
            
            // 7. Close modal and show success screen
            setTimeout(() => {
                closeAllModals();
                if (typeof showSuccessModal === 'function') {
                    showSuccessModal(member);
                }
            }, 2000);
            
        } catch (error) {
            console.error('‚ùå Registration error:', error);
            showNotification('‚ùå Registration failed: ' + error.message, 'error');
        }
    };
    
    // TALK Registration Success
    window.processTalkSuccess = async function(formData) {
        console.log('üéØ Processing TALK registration...');
        
        try {
            const referralCode = window.TauDB?.checkReferralCode();
            const syncResult = window.TauDB?.sync(formData, 'TALK', referralCode);
            
            if (!syncResult || !syncResult.success) {
                throw new Error('Database sync failed');
            }
            
            const member = syncResult.member;
            
            if (window.TauDB?.updateBalance) {
                window.TauDB.updateBalance(member.id, 500);
            }
            
            if (typeof createNotification === 'function') {
                createNotification(member.id, 'üéâ Welcome!', 'Welcome bonus: 500 iKbp', 'success');
            }
            
            showNotification('üìß Sending confirmation emails...', 'info');
            
            const [welcomeResult, adminResult] = await Promise.allSettled([
                sendWelcomeEmail(member),
                sendEmailToAdmin(member, 'NEW TALK REGISTRATION - PAYMENT CONFIRMED')
            ]);
            
            const welcomeSent = welcomeResult.status === 'fulfilled' && welcomeResult.value.success;
            const adminSent = adminResult.status === 'fulfilled' && adminResult.value.success;
            
            let message = '‚úÖ Registration complete!';
            if (welcomeSent && adminSent) {
                message += ' Emails sent successfully.';
            }
            
            showNotification(message, 'success');
            
            setTimeout(() => {
                closeAllModals();
                if (typeof showSuccessModal === 'function') showSuccessModal(member);
            }, 2000);
            
        } catch (error) {
            console.error('‚ùå Registration error:', error);
            showNotification('‚ùå Registration failed: ' + error.message, 'error');
        }
    };
    
    // JOB CREATION Success
    window.processJobCreationSuccess = async function(formData) {
        console.log('üéØ Processing Job Creation enrollment...');
        
        try {
            const referralCode = window.TauDB?.checkReferralCode();
            const syncResult = window.TauDB?.sync(formData, 'JOB_CREATION', referralCode);
            
            if (!syncResult || !syncResult.success) {
                throw new Error('Database sync failed');
            }
            
            const member = syncResult.member;
            
            if (window.TauDB?.updateBalance) {
                window.TauDB.updateBalance(member.id, 500);
            }
            
            showNotification('üìß Sending confirmation emails...', 'info');
            
            await Promise.allSettled([
                sendWelcomeEmail(member),
                sendEmailToAdmin(member, 'JOB CREATION ENROLLMENT - PAYMENT CONFIRMED')
            ]);
            
            showNotification('‚úÖ Enrollment complete! Emails sent.', 'success');
            
            setTimeout(() => {
                closeAllModals();
                if (typeof showSuccessModal === 'function') showSuccessModal(member);
            }, 2000);
            
        } catch (error) {
            console.error('‚ùå Enrollment error:', error);
            showNotification('‚ùå Enrollment failed: ' + error.message, 'error');
        }
    };
    
    // ============================================
    // 8. TEST FUNCTION
    // ============================================
    window.testTauEmails = async function() {
        console.log('üß™ Testing email system...');
        
        const testResult = await sendEmail(
            EMAIL_CONFIG.adminEmail,
            'Test User',
            'TAU Email System Test',
            'This is a test email from TAU Africa.\n\nIf you receive this, the email system is working correctly!\n\nTest Time: ' + new Date().toLocaleString()
        );
        
        if (testResult.success) {
            showNotification('‚úÖ Test email sent! Check ' + EMAIL_CONFIG.adminEmail, 'success');
            console.log('‚úÖ Test passed');
        } else {
            showNotification('‚ùå Test failed: ' + testResult.error, 'error');
            console.error('‚ùå Test failed:', testResult.error);
        }
        
        return testResult;
    };
    
    // ============================================
    // 9. STARTUP REPORT
    // ============================================
    setTimeout(() => {
        console.log('\n' + '='.repeat(60));
        console.log('üìß TAU AFRICA EMAIL SYSTEM STATUS');
        console.log('='.repeat(60));
        console.log('EmailJS:', emailInitialized ? '‚úÖ Ready' : '‚ùå Failed');
        console.log('Service ID:', EMAIL_CONFIG.serviceId);
        console.log('Template ID:', EMAIL_CONFIG.templateId);
        console.log('Admin Email:', EMAIL_CONFIG.adminEmail);
        console.log('='.repeat(60));
        console.log('Functions Available:');
        console.log('  ‚úÖ sendWelcomeEmail(member)');
        console.log('  ‚úÖ sendEmailToAdmin(formData, subject)');
        console.log('  ‚úÖ sendReferralNotification(referrer, earnings)');
        console.log('='.repeat(60));
        console.log('üí° Test: window.testTauEmails()');
        console.log('='.repeat(60) + '\n');
    }, 2000);
    console.log('‚úÖ Unified Email System loaded');
    
})();
</script>    
    <script>
    
    // ============================================
    // 1. FIREBASE CONFIG & INIT
    // ============================================
      const FIREBASE_CONFIG = {
        apiKey: "AIzaSyBcTzvl5lwpojRQM5lwyWe3hwp4upogUWw",
        authDomain: "tau-main-app.firebaseapp.com",
        projectId: "tau-main-app",
        storageBucket: "tau-main-app.firebasestorage.app",
        messagingSenderId: "69734421488",
        appId: "1:69734421488:web:d13ae38f1c7d79cc854335"
    };
    
    let db, isOnline = false;
    
    try {
        if (!firebase.apps.length) {
            firebase.initializeApp(FIREBASE_CONFIG);
        }
        db = firebase.firestore();
        
        // Enable offline persistence (cache for offline use)
        db.enablePersistence({ synchronizeTabs: true })
            .then(() => {
                console.log('‚úÖ Offline cache enabled (fallback only)');
            })
            .catch(err => {
                console.warn('‚ö†Ô∏è Persistence error:', err.code);
            });
        
        isOnline = true;
        console.log('‚úÖ Firestore connected (PRIMARY STORAGE)');
        
    } catch (error) {
        console.error('‚ùå Firebase init failed:', error);
        alert('‚ö†Ô∏è Cloud storage unavailable. Please check your internet connection.');
        isOnline = false;
    }
    
    // ============================================
    // 2. CLOUD-FIRST TauDB.sync() 
    // ============================================
    if (window.TauDB && window.TauDB.sync) {
        const originalSync = window.TauDB.sync;
        
        window.TauDB.sync = async function(formData, team, referralCode) {
            console.log('‚òÅÔ∏è Cloud-first registration starting...');
            
            if (!db || !isOnline) {
                alert('‚ùå Cloud storage unavailable. Please connect to the internet to register.');
                return { success: false, error: 'No internet connection' };
            }
            
            // 1. Generate member ID
            const memberId = generateMemberID(team, referralCode);
            const memberReferralCode = generateReferralCode(memberId);
            
            // 2. Create member object
            const member = {
                id: memberId,
                referralCode: memberReferralCode,
                team: team,
                fullName: formData.fullName || formData.name,
                email: formData.email,
                phone: formData.phone,
                location: formData.location,
                paymentStatus: 'Paid',
                dateJoined: new Date().toISOString().split('T')[0],
                status: 'Active',
                fee: team === 'TASK' ? 500 : team === 'TALK' ? 2000 : 1500,
                accountCreated: new Date().toISOString(),
                lastLogin: null,
                activities: [],
                tasks: [],
                iKbpBalance: 500, // Welcome bonus
                iKbBalance: 0,
                referredBy: referralCode || null,
                ...formData // Include all form data
            };
            
            try {
                // 3. SAVE TO FIRESTORE FIRST (PRIMARY)
                await db.collection('members').doc(memberId).set({
                    ...member,
                    createdAt: firebase.firestore.FieldValue.serverTimestamp(),
                    lastModified: firebase.firestore.FieldValue.serverTimestamp()
                });
                
                console.log('‚úÖ Saved to Firestore (PRIMARY):', memberId);
                
                // Also save to tau_members for Bridge compatibility
                await db.collection('tau_members').doc(memberId).set(member);
                
                // 4. CACHE TO LOCALSTORAGE (SECONDARY - for offline access)
                const localMembers = JSON.parse(localStorage.getItem('tauAfricaDB') || '[]');
                localMembers.push(member);
                localStorage.setItem('tauAfricaDB', JSON.stringify(localMembers));
                console.log('üíæ Cached to localStorage (secondary)');
                
                // 5. Store credentials
                const credentials = JSON.parse(localStorage.getItem('tauCredentials') || '{}');
                credentials[memberId] = {
                    email: member.email,
                    phone: member.phone.slice(-4),
                    fullName: member.fullName
                };
                localStorage.setItem('tauCredentials', JSON.stringify(credentials));
                
                // 6. Track referral
                if (referralCode) {
                    await trackReferralFirestore(referralCode, memberId);
                }
                
                // 7. Create activity log
                await db.collection('activity_log').add({
                    type: 'new_registration',
                    memberId: memberId,
                    memberName: member.fullName,
                    team: team,
                    timestamp: firebase.firestore.FieldValue.serverTimestamp()
                });
                
                return { success: true, memberId, member };
                
            } catch (error) {
                console.error('‚ùå Firestore save failed:', error);
                alert('‚ùå Registration failed. Please check your internet connection and try again.');
                return { success: false, error: error.message };
            }
        };
        
        console.log('‚úÖ TauDB.sync enhanced (CLOUD-FIRST)');
    }
    
    // ============================================
    // 3. CLOUD-FIRST AUTHENTICATE
    // ============================================
    if (window.TauDB && window.TauDB.authenticate) {
        const originalAuth = window.TauDB.authenticate;
        
        window.TauDB.authenticate = async function(identifier, phoneLastFour) {
    console.log('üîê Login attempt:', identifier);
    
    try {
        // 1. Try localStorage FIRST (most reliable)
        const localMembers = JSON.parse(localStorage.getItem('tauAfricaDB') || '[]');
        
        let member = localMembers.find(m => 
            (m.id === identifier || m.email === identifier) && 
            m.phone.slice(-4) === phoneLastFour
        );
        
        if (member) {
            console.log('‚úÖ Found in localStorage:', member.id);
            
            // Update last login
            member.lastLogin = new Date().toISOString();
            const index = localMembers.findIndex(m => m.id === member.id);
            if (index >= 0) {
                localMembers[index] = member;
                localStorage.setItem('tauAfricaDB', JSON.stringify(localMembers));
            }
            
            // Save session
            sessionStorage.setItem('tauCurrentUser', JSON.stringify(member));
            
            // Try to sync with Firestore in background
            if (typeof firebase !== 'undefined' && firebase.apps.length > 0) {
                syncMemberFromFirestore(member.id).catch(err => 
                    console.warn('Background sync warning:', err)
                );
            }
            
            return { success: true, member };
        }
        
        // 2. If not found locally, try Firestore
        if (typeof firebase !== 'undefined' && firebase.apps.length > 0) {
            const db = firebase.firestore();
            
            // Try by ID
            let memberDoc = await db.collection('members').doc(identifier).get();
            
            // Try by email
            if (!memberDoc.exists) {
                const querySnapshot = await db.collection('members')
                    .where('email', '==', identifier)
                    .limit(1)
                    .get();
                
                if (!querySnapshot.empty) {
                    memberDoc = querySnapshot.docs[0];
                }
            }
            
            if (memberDoc.exists) {
                member = { ...memberDoc.data(), firestoreId: memberDoc.id };
                
                // Verify phone
                if (member.phone.slice(-4) === phoneLastFour) {
                    // Save to localStorage
                    localMembers.push(member);
                    localStorage.setItem('tauAfricaDB', JSON.stringify(localMembers));
                    
                    // Save session
                    sessionStorage.setItem('tauCurrentUser', JSON.stringify(member));
                    
                    console.log('‚úÖ Found in Firestore, cached locally:', member.id);
                    return { success: true, member };
                }
            }
        }
        
        console.error('‚ùå Login failed: Invalid credentials');
        return { 
            success: false, 
            error: 'Invalid credentials' 
        };
        
    } catch (error) {
        console.error('‚ùå Authentication error:', error);
        return { 
            success: false, 
            error: error.message 
        };
    }
};

async function syncMemberFromFirestore(memberId) {
    const db = firebase.firestore();
    const doc = await db.collection('members').doc(memberId).get();
    
    if (doc.exists) {
        const member = { ...doc.data(), firestoreId: doc.id };
        const localMembers = JSON.parse(localStorage.getItem('tauAfricaDB') || '[]');
        const index = localMembers.findIndex(m => m.id === memberId);
        
        if (index >= 0) {
            localMembers[index] = member;
        } else {
            localMembers.push(member);
        }
        
        localStorage.setItem('tauAfricaDB', JSON.stringify(localMembers));
        console.log('üîÑ Member synced from Firestore');
    }
}

console.log('‚úÖ Authentication fixed');
    }
    
    // ============================================
    // 4. CLOUD-FIRST BALANCE UPDATES
    // ============================================
    if (window.TauDB && window.TauDB.updateBalance) {
        const originalUpdateBalance = window.TauDB.updateBalance;
        
        window.TauDB.updateBalance = async function(memberId, amount) {
            if (db && isOnline) {
                try {
                    await db.collection('members').doc(memberId).update({
                        iKbpBalance: firebase.firestore.FieldValue.increment(amount),
                        lastModified: firebase.firestore.FieldValue.serverTimestamp()
                    });
                    console.log('‚úÖ Balance updated in Firestore');
                } catch (error) {
                    console.error('‚ö†Ô∏è Firestore balance update failed:', error);
                }
            }
            
            // Also update localStorage (cache)
            return originalUpdateBalance.call(this, memberId, amount);
        };
    }
    
    // ============================================
    // 5. REAL-TIME SYNC (Download changes from cloud)
    // ============================================
    function setupRealtimeSync() {
        if (!db || !isOnline) return;
        
        console.log('üëÇ Setting up real-time sync from cloud...');
        
        db.collection('members').onSnapshot(snapshot => {
            snapshot.docChanges().forEach(change => {
                const memberData = { id: change.doc.id, ...change.doc.data() };
                const localMembers = JSON.parse(localStorage.getItem('tauAfricaDB') || '[]');
                
                if (change.type === 'added' || change.type === 'modified') {
                    const index = localMembers.findIndex(m => m.id === memberData.id);
                    if (index >= 0) {
                        localMembers[index] = memberData;
                    } else {
                        localMembers.push(memberData);
                    }
                    localStorage.setItem('tauAfricaDB', JSON.stringify(localMembers));
                    console.log('üîÑ Synced from cloud:', memberData.id);
                }
            });
            
            // Refresh UI
            if (typeof updateStats === 'function') updateStats();
            if (typeof renderMembers === 'function') renderMembers();
        });
        
        console.log('‚úÖ Real-time sync active');
    }
    
    setTimeout(setupRealtimeSync, 3000);
    
    // ============================================
    // 6. HELPER FUNCTIONS
    // ============================================
    function generateMemberID(team, referralCode) {
        const prefix = team === 'TASK' ? 'TSK' : team === 'TALK' ? 'TLK' : 'JOB';
        const timestamp = Date.now().toString().slice(-6);
        const random = Math.floor(Math.random() * 1000).toString().padStart(3, '0');
        return `${prefix}-${timestamp}-${random}`;
    }
    
    function generateReferralCode(memberId) {
        return btoa(memberId).substring(0, 8).toUpperCase();
    }
    
    async function trackReferralFirestore(referralCode, newMemberId) {
        try {
            const querySnapshot = await db.collection('members')
                .where('referralCode', '==', referralCode)
                .limit(1)
                .get();
            
            if (!querySnapshot.empty) {
                const referrerDoc = querySnapshot.docs[0];
                const referrerId = referrerDoc.id;
                
                // Award referral bonus
                await db.collection('members').doc(referrerId).update({
                    iKbpBalance: firebase.firestore.FieldValue.increment(500),
                    lastModified: firebase.firestore.FieldValue.serverTimestamp()
                });
                
                console.log('‚úÖ Referral bonus awarded:', referrerId);
            }
        } catch (error) {
            console.error('‚ö†Ô∏è Referral tracking error:', error);
        }
    }
    
    // ============================================
    // 7. EXPOSE API
    // ============================================
    window.TauFirestore = {
        db: db,
        isOnline: () => isOnline,
        forceSync: async function(memberId) {
            if (!db || !isOnline) return null;
            const doc = await db.collection('members').doc(memberId).get();
            return doc.exists ? doc.data() : null;
        }
    };
    
    console.log('‚úÖ Cloud-First Storage Active');
    console.log('üìä Storage Priority: Firestore (primary) ‚Üí localStorage (cache)');
    
})();
</script>
  <script>
// ============================================
// TAU AFRICA - COMPLETE EMAIL & NOTIFICATION FIX
// ============================================

    (function() {
    'use strict';
    
    console.log('üìß Loading Email & Notification System...');
    
    // ============================================
    // 1. FORCE EMAILJS INITIALIZATION
    // ============================================
    let emailReady = false;
    
    function initEmailJS() {
        if (typeof emailjs === 'undefined') {
            console.error('‚ùå EmailJS library not loaded!');
            setTimeout(initEmailJS, 1000);
            return;
        }
        
        try {
            emailjs.init({
                publicKey: "GhjI14eQVGgOli0j1"
            });
            emailReady = true;
            console.log('‚úÖ EmailJS initialized');
        } catch (error) {
            console.error('‚ùå EmailJS init error:', error);
            setTimeout(initEmailJS, 1000);
        }
    }
    
    // Initialize immediately
    initEmailJS();
    
    // ============================================
    // 2. SEND EMAIL FUNCTION
    // ============================================
    async function sendEmail(toEmail, toName, subject, message) {
        if (!emailReady) {
            console.error('‚ùå EmailJS not ready');
            return false;
        }
        
        const templateParams = {
            to_email: toEmail,
            to_name: toName,
            from_name: 'TAU Africa',
            from_email: 'grouptauafrica@gmail.com',
            subject: subject,
            message: message
        };
        
        console.log('üìß Sending email to:', toEmail);
        
        try {
            const response = await emailjs.send(
                'service_xfira7g',
                'template_bqxztig',
                templateParams
            );
            
            console.log('‚úÖ Email sent:', response.status);
            return true;
        } catch (error) {
            console.error('‚ùå Email failed:', error);
            return false;
        }
    }
    
    // ============================================
    // 3. CREATE NOTIFICATION FUNCTION
    // ============================================
    function createNotification(memberId, title, message, type = 'info') {
        const NOTIF_KEY = 'tauNotifications';
        const allNotifications = JSON.parse(localStorage.getItem(NOTIF_KEY) || '{}');
        
        if (!allNotifications[memberId]) {
            allNotifications[memberId] = [];
        }
        
        const notification = {
            id: `NOTIF-${Date.now()}`,
            title: title,
            message: message,
            timestamp: new Date().toISOString(),
            read: false,
            type: type
        };
        
        allNotifications[memberId].unshift(notification);
        localStorage.setItem(NOTIF_KEY, JSON.stringify(allNotifications));
        
        console.log(`üì¨ Notification created for ${memberId}:`, title);
        
        // Show popup notification
        if (typeof showNotification === 'function') {
            showNotification(title, type);
        }
    }
    
    // ============================================
    // 4. OVERRIDE TASK SUCCESS HANDLER
    // ============================================
    window.processTaskSuccess = async function(formData) {
        console.log('üéØ TASK Registration - Starting...');
        
        try {
            // 1. Get referral code
            const referralCode = window.TauDB?.checkReferralCode();
            
            // 2. Save to database
            const syncResult = window.TauDB?.sync(formData, 'TASK', referralCode);
            
            if (!syncResult || !syncResult.success) {
                throw new Error('Database sync failed');
            }
            
            const member = syncResult.member;
            console.log('‚úÖ Member saved:', member.id);
            
            // 3. Award welcome bonus
            if (window.TauDB?.updateBalance) {
                window.TauDB.updateBalance(member.id, 500);
                console.log('üéÅ Welcome bonus: 500 iKbp');
            }
            
            // 4. Create notification
            createNotification(
                member.id,
                'üéâ Welcome to TAU Africa!',
                `Member ID: ${member.id}\nReferral Code: ${member.referralCode}\nWelcome Bonus: 500 iKbp`,
                'success'
            );
            
            // 5. Prepare email messages
            const welcomeMsg = `
Dear ${member.fullName},

üéâ WELCOME TO TAU AFRICA INTERNATIONAL! üéâ

‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ
YOUR MEMBERSHIP DETAILS
‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ

üë§ Member ID: ${member.id}
üìß Email: ${member.email}
üì± Phone: ${member.phone}
üìç Location: ${member.location}
üë• Team: TASK
üí∞ Registration Fee: KSH 500 ‚úÖ PAID

‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ
YOUR BENEFITS
‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ

üéÅ Welcome Bonus: 500 iKbp (KSH 50) - CREDITED!
üîë Referral Code: ${member.referralCode}
   Share to earn 500 iKbp per referral!

üíé Start earning:
   ‚Ä¢ Complete activities: 100-500 iKbp each
   ‚Ä¢ Complete tasks: 200-5000 iKbp each
   ‚Ä¢ Submit values: Earn iKb
   ‚Ä¢ Refer friends: 500 iKbp each

‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ
NEXT STEPS
‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ

1. Login with your Member ID or Email
2. Complete your first activity (earn 100 iKbp!)
3. Share your referral code
4. Explore the Kabiru Mining App

üåê Access your dashboard:
   ${window.location.origin}

üìß Need help? Contact:
   grouptauafrica@gmail.com

Welcome to the TAU Africa family!

Best regards,
TAU Africa Team
üåç Building Africa's Digital Future
            `.trim();
            
            const adminMsg = `
NEW TASK REGISTRATION - PAYMENT CONFIRMED

‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ
MEMBER DETAILS
‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ

üë§ Name: ${member.fullName}
üìß Email: ${member.email}
üì± Phone: ${member.phone}
üìç Location: ${member.location}
üë• Team: TASK
üí∞ Fee: KSH 500 ‚úÖ PAID

üÜî Member ID: ${member.id}
üîë Referral Code: ${member.referralCode}
üìÖ Date: ${new Date().toLocaleString()}

‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ

TAU Africa Registration System
            `.trim();
            
            // 6. Send emails
            console.log('üìß Sending emails...');
            showNotification('üìß Sending confirmation emails...', 'info');
            
            const emailPromises = [
                sendEmail(member.email, member.fullName, 'üéâ Welcome to TAU Africa!', welcomeMsg),
                sendEmail('grouptauafrica@gmail.com', 'TAU Admin', 'NEW TASK REGISTRATION', adminMsg)
            ];
            
            const results = await Promise.all(emailPromises);
            const [memberEmailSent, adminEmailSent] = results;
            
            console.log('üìß Email results:', { memberEmailSent, adminEmailSent });
            
            // 7. Show appropriate message
            let msg = '‚úÖ Registration complete!';
            if (memberEmailSent && adminEmailSent) {
                msg += ' Confirmation emails sent to you and admin.';
            } else if (memberEmailSent) {
                msg += ' Welcome email sent to you.';
            } else if (adminEmailSent) {
                msg += ' Admin notified.';
            } else {
                msg += ' Emails may be delayed - check inbox in a few minutes.';
            }
            
            showNotification(msg, 'success');
            
            // 8. Close modal and show success screen
            setTimeout(() => {
                closeAllModals();
                if (typeof showSuccessModal === 'function') {
                    showSuccessModal(member);
                }
            }, 2000);
            
        } catch (error) {
            console.error('‚ùå Registration error:', error);
            showNotification('‚ùå Registration failed: ' + error.message, 'error');
        }
    };
    
    // ============================================
    // 5. OVERRIDE TALK SUCCESS HANDLER
    // ============================================
    window.processTalkSuccess = async function(formData) {
        console.log('üéØ TALK Registration - Starting...');
        
        try {
            const referralCode = window.TauDB?.checkReferralCode();
            const syncResult = window.TauDB?.sync(formData, 'TALK', referralCode);
            
            if (!syncResult || !syncResult.success) {
                throw new Error('Database sync failed');
            }
            
            const member = syncResult.member;
            
            if (window.TauDB?.updateBalance) {
                window.TauDB.updateBalance(member.id, 500);
            }
            
            createNotification(
                member.id,
                'üéâ Welcome to TAU Africa!',
                'TALK Team - Welcome bonus: 500 iKbp',
                'success'
            );
            
            const welcomeMsg = `Welcome ${member.fullName} to TAU Africa - TALK Team!\n\nMember ID: ${member.id}\nReferral Code: ${member.referralCode}\nWelcome Bonus: 500 iKbp`;
            const adminMsg = `NEW TALK REGISTRATION\n\nMember: ${member.fullName}\nEmail: ${member.email}\nID: ${member.id}`;
            
            const results = await Promise.all([
                sendEmail(member.email, member.fullName, 'Welcome - TALK Team', welcomeMsg),
                sendEmail('grouptauafrica@gmail.com', 'TAU Admin', 'NEW TALK REGISTRATION', adminMsg)
            ]);
            
            showNotification('‚úÖ TALK registration complete!', 'success');
            
            setTimeout(() => {
                closeAllModals();
                if (typeof showSuccessModal === 'function') {
                    showSuccessModal(member);
                }
            }, 2000);
            
        } catch (error) {
            console.error('‚ùå Registration error:', error);
            showNotification('‚ùå Registration failed: ' + error.message, 'error');
        }
    };
    
    // ============================================
    // 6. OVERRIDE JOB CREATION SUCCESS HANDLER
    // ============================================
    window.processJobCreationSuccess = async function(formData) {
        console.log('üéØ Job Creation - Starting...');
        
        try {
            const referralCode = window.TauDB?.checkReferralCode();
            const syncResult = window.TauDB?.sync(formData, 'JOB_CREATION', referralCode);
            
            if (!syncResult || !syncResult.success) {
                throw new Error('Database sync failed');
            }
            
            const member = syncResult.member;
            
            if (window.TauDB?.updateBalance) {
                window.TauDB.updateBalance(member.id, 500);
            }
            
            createNotification(
                member.id,
                'üéâ Enrollment Complete!',
                'Job Creation Training - Welcome bonus: 500 iKbp',
                'success'
            );
            
            const welcomeMsg = `Job Creation Training Enrollment Confirmed!\n\nMember: ${member.fullName}\nID: ${member.id}\nBonus: 500 iKbp`;
            const adminMsg = `JOB CREATION ENROLLMENT\n\nMember: ${member.fullName}\nEmail: ${member.email}\nID: ${member.id}`;
            
            await Promise.all([
                sendEmail(member.email, member.fullName, 'Job Creation Enrollment', welcomeMsg),
                sendEmail('grouptauafrica@gmail.com', 'TAU Admin', 'JOB CREATION ENROLLMENT', adminMsg)
            ]);
            
            showNotification('‚úÖ Enrollment complete!', 'success');
            setTimeout(() => {
                closeAllModals();
                if (typeof showSuccessModal === 'function') showSuccessModal(member);
            }, 2000);
            
        } catch (error) {
            console.error('‚ùå Enrollment error:', error);
            showNotification('‚ùå Enrollment failed: ' + error.message, 'error');
        }
    };
    
    // ============================================
    // 7. TEST FUNCTION
    // ============================================
    window.testTauEmails = async function() {
        console.log('üß™ Testing email system...');
        
        const result = await sendEmail(
            'grouptauafrica@gmail.com',
            'Test User',
            'TAU Email Test',
            'This is a test email. If you receive this, the email system is working!'
        );
        
        if (result) {
            showNotification('‚úÖ Test email sent! Check grouptauafrica@gmail.com', 'success');
        } else {
            showNotification('‚ùå Test failed - check console', 'error');
        }
    };
    
    // ============================================
    // 8. EXPOSE GLOBAL API
    // ============================================
    window.TauEmail = {
        send: sendEmail,
        createNotification: createNotification,
        test: window.testTauEmails
    };
    
    console.log('‚úÖ Email & Notification System loaded');
    console.log('üí° Test: window.testTauEmails()');
    
})();
  </script>
<script>
// ===== M-PESA PAYMENT INTEGRATION =====//

    function initiateMpesaPayment(amount, phoneNumber, formData, successCallback) {
    showPaymentModal(amount, phoneNumber, formData, successCallback);
}

function showPaymentModal(amount, phoneNumber, formData, successCallback) {
    const paymentModal = document.createElement('div');
    paymentModal.className = 'payment-modal';
    paymentModal.innerHTML = `
        <div class="payment-widget">
            <h3>üì± M-PESA Payment</h3>
            <div class="payment-step">
                <h4>Amount: KSH ${amount}</h4>
                <p>Phone: ${phoneNumber}</p>
                <p style="color: #666; font-size: 0.9em;">A payment prompt will be sent to your phone</p>
            </div>
            <div id="paymentSteps">
                <div style="margin: 20px 0; padding: 15px; background: #f0f8ff; border-radius: 10px;">
                    <p><strong>Payment Process:</strong></p>
                    <ol style="text-align: left; margin-top: 10px;">
                        <li>Check your phone for M-PESA prompt</li>
                        <li>Enter your M-PESA PIN</li>
                        <li>Confirm the payment</li>
                        <li>Wait for confirmation</li>
                    </ol>
                </div>
                <input type="text" class="payment-input" placeholder="Enter confirmation code (if received)" id="confirmationCode">
                <button class="btn" onclick="simulatePayment(${amount}, '${phoneNumber}')">Confirm Payment</button>
            </div>
            <button class="btn" style="background: #e74c3c; margin-top: 20px;" onclick="cancelPayment()">Cancel Payment</button>
        </div>
    `;
    paymentModal.formData = formData;
    paymentModal.successCallback = successCallback;
    document.body.appendChild(paymentModal);
}

function simulatePayment(amount, phoneNumber) {
    const paymentModal = document.querySelector('.payment-modal');
    const confirmationCode = document.getElementById('confirmationCode').value;
    
    if (confirmationCode.length < 4) {
        showNotification('Please enter a valid confirmation code', 'error');
        return;
    }

    paymentModal.innerHTML = `
        <div class="payment-widget">
            <h3>Processing Payment...</h3>
            <div class="spinner"></div>
            <p>Verifying M-PESA transaction</p>
            <p style="font-size: 0.9em; color: #666;">Transaction ID: MPX${Date.now()}</p>
        </div>
    `;

    setTimeout(() => {
        if (Math.random() > 0.05) {
            const storedFormData = paymentModal.formData;
            const callback = paymentModal.successCallback;
            
            paymentModal.remove();
            
            if (callback === 'processTaskSuccess') {
                processTaskSuccess(storedFormData);
            } else if (callback === 'processTalkSuccess') {
                processTalkSuccess(storedFormData);
            } else if (callback === 'processJobCreationSuccess') {
                processJobCreationSuccess(storedFormData);
            }
            
            showNotification(`M-PESA payment of KSH ${amount} successful! Transaction ID: MPX${Date.now()}`, 'success');
        } else {
            paymentModal.remove();
            showNotification('Payment failed. Please try again or contact support.', 'error');
        }
    }, 3000);
}

function cancelPayment() {
    document.querySelector('.payment-modal')?.remove();
    showNotification('Payment cancelled', 'error');
}

// ===== NOTIFICATION SYSTEM =====
function showNotification(message, type = 'success') {
    const notification = document.getElementById('notification');
    notification.innerHTML = message;
    notification.className = `notification ${type}`;
    notification.style.display = 'block';
    
    setTimeout(() => {
        notification.style.display = 'none';
    }, 6000);
}
</script>
    <script>
// ===== MODAL MANAGEMENT =====//
    function openModal(type) {
    closeAllModals();
    
    const modalContent = getModalContent(type);
    const modal = document.createElement('div');
    modal.className = 'modal';
    modal.style.display = 'block';
    modal.innerHTML = modalContent;
    document.body.appendChild(modal);
    currentModal = modal;
}

function closeAllModals() {
    const modals = document.querySelectorAll('.modal, .payment-modal');
    modals.forEach(modal => modal.remove());
    currentModal = null;
}

// ===== SELECTION FUNCTIONS =====

    function selectLevel(level, element) {
    const buttons = document.querySelectorAll('.level-btn');
    buttons.forEach(btn => btn.classList.remove('selected'));
    const target = element || (window.event && window.event.target);
    if (target) {
        target.classList.add('selected');
    }
    selectedLevel = level;
    const levelInput = document.getElementById('supportLevel');
    if (levelInput) levelInput.value = level;
    
    const enhanced = document.getElementById('enhancedRequirements');
    if (enhanced && (level === 'middle' || level === 'upper' || level === 'high' || level === 'top')) {
        enhanced.style.display = 'block';
    }
}

function selectCategory(category, element) {
    const buttons = document.querySelectorAll('.level-btn');
    buttons.forEach(btn => btn.classList.remove('selected'));
    const target = element || (window.event && window.event.target);
    if (target) {
        target.classList.add('selected');
    }
    selectedCategory = category;
    const categoryInput = document.getElementById('taskCategory');
    if (categoryInput) categoryInput.value = category;
}
    
 //===SUBMISSION HANDLERS =====//
function processTaskRegistration(event) {
    event.preventDefault();
    const form = event.target;
    const formData = new FormData(form);
    const data = Object.fromEntries(formData.entries());
    
    if (!data.phone || !data.fullName || !data.email || !selectedCategory) {
        showNotification('Please fill all required fields and select a category', 'error');
        return;
    }
    
    if (!data.phone.match(/^254[0-9]{9}$/)) {
        showNotification('Please use correct phone format: 254XXXXXXXXX', 'error');
        return;
    }
    
    data.category = selectedCategory;
    initiateMpesaPayment(500, data.phone, data, 'processTaskSuccess');
}

function processTalkRegistration(event) {
    event.preventDefault();
    const form = event.target;
    const formData = new FormData(form);
    const data = Object.fromEntries(formData.entries());
    
    if (!data.phone || !data.fullName || !data.email || !selectedLevel) {
        showNotification('Please fill all required fields and select a support level', 'error');
        return;
    }
    
    if (!data.phone.match(/^254[0-9]{9}$/)) {
        showNotification('Please use correct phone format: 254XXXXXXXXX', 'error');
        return;
    }
    
    data.supportLevel = selectedLevel;
    initiateMpesaPayment(2000, data.phone, data, 'processTalkSuccess');
}

function processJobCreationTraining(event) {
    event.preventDefault();
    const form = event.target;
    const formData = new FormData(form);
    const data = Object.fromEntries(formData.entries());
    
    if (!data.phone || !data.fullName || !data.email) {
        showNotification('Please fill all required fields', 'error');
        return;
    }
    
    if (!data.phone.match(/^254[0-9]{9}$/)) {
        showNotification('Please use correct phone format: 254XXXXXXXXX', 'error');
        return;
    }
    
    initiateMpesaPayment(1500, data.phone, data, 'processJobCreationSuccess');
}
  </script>
 <script>

TAU AFRICA - COMPLETE FIX (ALL-IN-ONE)
 
 (function() {
    'use strict';
    
    console.log('üöÄ TAU Complete Fix - Starting...');
    
    // ========================================
    // PART 1: FIREBASE CONNECTION
    // ========================================
      const FIREBASE_CONFIG = {
        apiKey: "AIzaSyBcTzvl5lwpojRQM5lwyWe3hwp4upogUWw",
        authDomain: "tau-main-app.firebaseapp.com",
        projectId: "tau-main-app",
        storageBucket: "tau-main-app.firebasestorage.app",
        messagingSenderId: "69734421488",
        appId: "1:69734421488:web:d13ae38f1c7d79cc854335"
    };
    
    let db = null;
    let isOnline = false;
    
    function initFirebase() {
        if (typeof firebase === 'undefined') {
            console.error('‚ùå Firebase not loaded yet, retrying...');
            setTimeout(initFirebase, 1000);
            return;
        }
        
        try {
            if (!firebase.apps.length) {
                firebase.initializeApp(FIREBASE_CONFIG);
            }
            
            db = firebase.firestore();
            
            // Test connection
            db.collection('_test_').doc('connection').set({
                test: true,
                timestamp: firebase.firestore.FieldValue.serverTimestamp()
            })
            .then(() => {
                console.log('‚úÖ Firebase CONNECTED');
                isOnline = true;
                
                // Enable persistence
                db.enablePersistence({ synchronizeTabs: true })
                    .catch(err => console.warn('Persistence:', err.code));
                
                // Start sync
                startFirebaseSync();
            })
            .catch(error => {
                console.error('‚ùå Firebase FAILED:', error);
                if (error.code === 'permission-denied') {
                    alert('‚ö†Ô∏è Firebase permission denied. Update rules!');
                }
                isOnline = false;
            });
            
        } catch (error) {
            console.error('‚ùå Firebase init error:', error);
        }
    }
    
    function startFirebaseSync() {
        if (!db) return;
        
        db.collection('members').onSnapshot(snapshot => {
            const localMembers = JSON.parse(localStorage.getItem('tauAfricaDB') || '[]');
            let hasChanges = false;
            
            snapshot.docChanges().forEach(change => {
                const data = change.doc.data();
                const index = localMembers.findIndex(m => m.id === data.id);
                
                if (change.type === 'added' || change.type === 'modified') {
                    if (index >= 0) {
                        localMembers[index] = { ...localMembers[index], ...data };
                    } else {
                        localMembers.push(data);
                    }
                    hasChanges = true;
                }
            });
            
            if (hasChanges) {
                localStorage.setItem('tauAfricaDB', JSON.stringify(localMembers));
                console.log('üîÑ Firebase synced to localStorage');
            }
        });
    }
   </script>
        <script>
    // ========================================
    // PART 2: EMAIL SYSTEM
    // ========================================
    let emailReady = false;
    
    function initEmailJS() {
        if (typeof emailjs === 'undefined') {
            console.error('‚ùå EmailJS not loaded yet, retrying...');
            setTimeout(initEmailJS, 1000);
            return;
        }
        
        try {
            emailjs.init({ publicKey: "GhjI14eQVGgOli0j1" });
            emailReady = true;
            console.log('‚úÖ EmailJS READY');
        } catch (error) {
            console.error('‚ùå EmailJS init failed:', error);
        }
    }
    
    async function sendEmail(toEmail, toName, subject, message) {
        if (!emailReady) {
            console.error('‚ùå EmailJS not ready');
            return false;
        }
        
        try {
            const response = await emailjs.send(
                'service_xfira7g',
                'template_bqxztig',
                {
                    to_email: toEmail,
                    to_name: toName,
                    from_name: 'TAU Africa',
                    from_email: 'grouptauafrica@gmail.com',
                    subject: subject,
                    message: message
                }
            );
            
            console.log('‚úÖ Email sent to:', toEmail);
            return true;
        } catch (error) {
            console.error('‚ùå Email failed:', error);
            return false;
        }
    }
    
    // ========================================
    // PART 3: NOTIFICATION SYSTEM
    // ========================================
    function createNotification(memberId, title, message, type = 'info') {
        const allNotifs = JSON.parse(localStorage.getItem('tauNotifications') || '{}');
        
        if (!allNotifs[memberId]) {
            allNotifs[memberId] = [];
        }
        
        allNotifs[memberId].unshift({
            id: `NOTIF-${Date.now()}`,
            title: title,
            message: message,
            timestamp: new Date().toISOString(),
            read: false,
            type: type
        });
        
        localStorage.setItem('tauNotifications', JSON.stringify(allNotifs));
        console.log('üì¨ Notification created:', title);
        
        if (typeof showNotification === 'function') {
            showNotification(title, type);
        }
    }
    
    // ========================================
    // PART 4: ENHANCE TauDB.sync()
    // ========================================
    function enhanceTauDB() {
        if (!window.TauDB || !window.TauDB.sync) {
            setTimeout(enhanceTauDB, 1000);
            return;
        }
        
        const originalSync = window.TauDB.sync;
        
        window.TauDB = window.TauDB || {};

window.TauDB.sync = async function(formData, team, referralCode) {
    console.log('üéØ Registration starting...', { team, referralCode });
    
    try {
        // 1. Generate IDs
        const memberId = generateMemberID(team, referralCode);
        const memberReferralCode = generateReferralCode(memberId);
        
        // 2. Create member object
        const member = {
            id: memberId,
            referralCode: memberReferralCode,
            team: team,
            fullName: formData.fullName || formData.name,
            email: formData.email,
            phone: formData.phone,
            location: formData.location,
            paymentStatus: 'Paid',
            dateJoined: new Date().toISOString().split('T')[0],
            status: 'Active',
            fee: team === 'TASK' ? 500 : team === 'TALK' ? 2000 : 1500,
            accountCreated: new Date().toISOString(),
            lastLogin: null,
            iKbpBalance: 500, // Welcome bonus
            iKbBalance: 0,
            referredBy: referralCode || null,
            ...formData
        };
        
        // 3. SAVE TO LOCALSTORAGE (GUARANTEED)
        const localMembers = JSON.parse(localStorage.getItem('tauAfricaDB') || '[]');
        
        // Check for duplicates
        const existingIndex = localMembers.findIndex(m => 
            m.email === member.email || m.phone === member.phone
        );
        
        if (existingIndex >= 0) {
            console.warn('‚ö†Ô∏è Member already exists, updating...');
            localMembers[existingIndex] = member;
        } else {
            localMembers.push(member);
        }
        
        localStorage.setItem('tauAfricaDB', JSON.stringify(localMembers));
        console.log('‚úÖ SAVED TO LOCALSTORAGE:', memberId);
        
        // 4. SAVE TO FIRESTORE (if available)
        if (typeof firebase !== 'undefined' && firebase.apps.length > 0) {
            try {
                const db = firebase.firestore();
                await db.collection('members').doc(memberId).set({
                    ...member,
                    createdAt: firebase.firestore.FieldValue.serverTimestamp(),
                    lastSync: firebase.firestore.FieldValue.serverTimestamp()
                });
                console.log('‚òÅÔ∏è SAVED TO FIRESTORE:', memberId);
            } catch (firestoreError) {
                console.warn('‚ö†Ô∏è Firestore save failed (but localStorage worked):', firestoreError);
            }
        }
        
        // 5. Save credentials for login
        const credentials = JSON.parse(localStorage.getItem('tauCredentials') || '{}');
        credentials[memberId] = {
            email: member.email,
            phone: member.phone.slice(-4),
            fullName: member.fullName
        };
        localStorage.setItem('tauCredentials', JSON.stringify(credentials));
        console.log('üîë Credentials saved');
        
        // 6. Track referral
        if (referralCode) {
            trackReferralFirestore(referralCode, memberId);
        }
        
        // 7. Trigger sync event
        window.dispatchEvent(new CustomEvent('tauMemberAdded', { 
            detail: { member, memberId } 
        }));
        
        return { 
            success: true, 
            memberId, 
            member 
        };
        
    } catch (error) {
        console.error('‚ùå Registration error:', error);
        return { 
            success: false, 
            error: error.message 
        };
    }
};

// Helper functions
function generateMemberID(team, referralCode) {
    const prefix = team === 'TASK' ? 'TSK' : team === 'TALK' ? 'TLK' : 'MEM';
    const timestamp = Date.now().toString().slice(-6);
    const random = Math.floor(Math.random() * 1000).toString().padStart(3, '0');
    return `${prefix}-${timestamp}-${random}`;
}

function generateReferralCode(memberId) {
    return btoa(memberId).substring(0, 8).toUpperCase();
}

function trackReferralFirestore(referralCode, newMemberId) {
    const members = JSON.parse(localStorage.getItem('tauAfricaDB') || '[]');
    const referrer = members.find(m => m.referralCode === referralCode);
    
    if (referrer && window.TauDB.updateBalance) {
        window.TauDB.updateBalance(referrer.id, 500);
        console.log('üéÅ Referral bonus awarded:', referrer.id);
    }
}

console.log('‚úÖ TauDB.sync fixed - guaranteed save');
    
    // ========================================
    // PART 5: OVERRIDE SUCCESS HANDLERS
    // ========================================
    
    // TASK Registration
    window.processTaskSuccess = async function(formData) {
        console.log('üéØ TASK Registration...');
        
        try {
            const referralCode = window.TauDB?.checkReferralCode();
            const syncResult = window.TauDB?.sync(formData, 'TASK', referralCode);
            
            if (!syncResult || !syncResult.success) {
                throw new Error('Sync failed');
            }
            
            const member = syncResult.member;
            
            // Award bonus
            if (window.TauDB?.updateBalance) {
                window.TauDB.updateBalance(member.id, 500);
            }
            
            // Create notification
            createNotification(
                member.id,
                'üéâ Welcome to TAU Africa!',
                `Member ID: ${member.id}\nBonus: 500 iKbp`,
                'success'
            );
            
            // Prepare emails
            const welcomeMsg = `
Dear ${member.fullName},

Welcome to TAU Africa International!

Member ID: ${member.id}
Referral Code: ${member.referralCode}
Welcome Bonus: 500 iKbp (KSH 50)

Login at: ${window.location.origin}

Best regards,
TAU Africa Team
            `.trim();
            
            const adminMsg = `
NEW TASK REGISTRATION

Name: ${member.fullName}
Email: ${member.email}
Phone: ${member.phone}
Member ID: ${member.id}
Fee: KSH 500 ‚úÖ PAID
            `.trim();
            
            // Send emails
            showNotification('üìß Sending emails...', 'info');
            
            const [memberSent, adminSent] = await Promise.all([
                sendEmail(member.email, member.fullName, 'üéâ Welcome to TAU Africa', welcomeMsg),
                sendEmail('grouptauafrica@gmail.com', 'TAU Admin', 'NEW TASK REGISTRATION', adminMsg)
            ]);
            
            let msg = '‚úÖ Registration complete!';
            if (memberSent && adminSent) {
                msg += ' Emails sent.';
            } else if (memberSent || adminSent) {
                msg += ' One email sent.';
            }
            
            showNotification(msg, 'success');
            
            setTimeout(() => {
                closeAllModals();
                if (typeof showSuccessModal === 'function') {
                    showSuccessModal(member);
                }
            }, 2000);
            
        } catch (error) {
            console.error('‚ùå Registration error:', error);
            showNotification('‚ùå Registration failed: ' + error.message, 'error');
        }
    };
    
    // TALK Registration
    window.processTalkSuccess = async function(formData) {
        console.log('üéØ TALK Registration...');
        
        try {
            const referralCode = window.TauDB?.checkReferralCode();
            const syncResult = window.TauDB?.sync(formData, 'TALK', referralCode);
            
            if (!syncResult?.success) throw new Error('Sync failed');
            
            const member = syncResult.member;
            
            if (window.TauDB?.updateBalance) {
                window.TauDB.updateBalance(member.id, 500);
            }
            
            createNotification(member.id, 'üéâ Welcome!', 'TALK Team - 500 iKbp bonus', 'success');
            
            const welcomeMsg = `Welcome ${member.fullName} to TAU Africa - TALK Team!\n\nMember ID: ${member.id}\nBonus: 500 iKbp`;
            const adminMsg = `NEW TALK REGISTRATION\n\nName: ${member.fullName}\nEmail: ${member.email}\nID: ${member.id}`;
            
            await Promise.all([
                sendEmail(member.email, member.fullName, 'Welcome - TALK Team', welcomeMsg),
                sendEmail('grouptauafrica@gmail.com', 'TAU Admin', 'NEW TALK REGISTRATION', adminMsg)
            ]);
            
            showNotification('‚úÖ TALK registration complete!', 'success');
            
            setTimeout(() => {
                closeAllModals();
                if (typeof showSuccessModal === 'function') showSuccessModal(member);
            }, 2000);
            
        } catch (error) {
            console.error('‚ùå Error:', error);
            showNotification('‚ùå Failed: ' + error.message, 'error');
        }
    };
    
    // Job Creation
    window.processJobCreationSuccess = async function(formData) {
        console.log('üéØ Job Creation...');
        
        try {
            const referralCode = window.TauDB?.checkReferralCode();
            const syncResult = window.TauDB?.sync(formData, 'JOB_CREATION', referralCode);
            
            if (!syncResult?.success) throw new Error('Sync failed');
            
            const member = syncResult.member;
            
            if (window.TauDB?.updateBalance) {
                window.TauDB.updateBalance(member.id, 500);
            }
            
            createNotification(member.id, 'üéâ Enrolled!', 'Job Creation - 500 iKbp', 'success');
            
            const msg = `Enrollment Confirmed!\n\nName: ${member.fullName}\nID: ${member.id}`;
            
            await Promise.all([
                sendEmail(member.email, member.fullName, 'Job Creation Enrollment', msg),
                sendEmail('grouptauafrica@gmail.com', 'TAU Admin', 'JOB CREATION ENROLLMENT', msg)
            ]);
            
            showNotification('‚úÖ Enrollment complete!', 'success');
            setTimeout(() => {
                closeAllModals();
                if (typeof showSuccessModal === 'function') showSuccessModal(member);
            }, 2000);
            
        } catch (error) {
            console.error('‚ùå Error:', error);
            showNotification('‚ùå Failed: ' + error.message, 'error');
        }
    };
    
    // ========================================
    // PART 6: TEST FUNCTIONS
    // ========================================
    window.testTauEmails = async function() {
        console.log('üß™ Testing emails...');
        
        const result = await sendEmail(
            'grouptauafrica@gmail.com',
            'Test User',
            'TAU Email Test',
            'This is a test. If you receive this, emails work!'
        );
        
        if (result) {
            showNotification('‚úÖ Test email sent!', 'success');
        } else {
            showNotification('‚ùå Test failed', 'error');
        }
    };
    
    window.TauDebug = {
        testEmail: window.testTauEmails,
        testFirebase: async function() {
            if (!db) {
                console.error('‚ùå Firestore not available');
                return;
            }
            
            try {
                await db.collection('_test_').doc('test').set({ test: true });
                console.log('‚úÖ Firebase test passed');
                showNotification('‚úÖ Firebase working!', 'success');
            } catch (error) {
                console.error('‚ùå Firebase test failed:', error);
                showNotification('‚ùå Firebase failed', 'error');
            }
        },
        status: function() {
            console.log('üìä Status:');
            console.log('  Firebase:', isOnline ? '‚úÖ Online' : '‚ùå Offline');
            console.log('  Email:', emailReady ? '‚úÖ Ready' : '‚ùå Not ready');
            console.log('  TauDB:', window.TauDB ? '‚úÖ Loaded' : '‚ùå Not loaded');
        }
    };
    
    // ========================================
    // PART 7: START EVERYTHING
    // ========================================
    function start() {
        console.log('‚è≥ Initializing...');
        
        // Start Firebase
        setTimeout(initFirebase, 500);
        
        // Start Email
        setTimeout(initEmailJS, 500);
        
        // Enhance TauDB
        setTimeout(enhanceTauDB, 2000);
        
        // Status report
        setTimeout(() => {
            console.log('\n' + '='.repeat(60));
            console.log('üöÄ TAU AFRICA - SYSTEM STATUS');
            console.log('='.repeat(60));
            console.log('Firebase:', isOnline ? '‚úÖ ONLINE' : '‚ùå OFFLINE');
            console.log('Email:', emailReady ? '‚úÖ READY' : '‚ùå NOT READY');
            console.log('TauDB:', window.TauDB ? '‚úÖ LOADED' : '‚ö†Ô∏è PENDING');
            console.log('='.repeat(60));
            console.log('\nüí° Test commands:');
            console.log('  window.testTauEmails()');
            console.log('  window.TauDebug.testFirebase()');
            console.log('  window.TauDebug.status()');
            console.log('='.repeat(60) + '\n');
        }, 5000);
    }
    
    // Start when DOM is ready
    if (document.readyState === 'loading') {
        document.addEventListener('DOMContentLoaded', start);
    } else {
        start();
    }
    
    console.log('‚úÖ Complete Fix Loaded');
    
})();
</script>
    <script> 
 //====M-PESA PAYMENT INTEGRATION====//

    function initiateMpesaPayment(amount, phoneNumber, formData, successCallback) {
    showPaymentModal(amount, phoneNumber, formData, successCallback);
}

function showPaymentModal(amount, phoneNumber, formData, successCallback) {
    const paymentModal = document.createElement('div');
    paymentModal.className = 'payment-modal';
    paymentModal.innerHTML = `
        <div class="payment-widget">
            <h3>üì± M-PESA Payment</h3>
            <div class="payment-step">
                <h4>Amount: KSH ${amount}</h4>
                <p>Phone: ${phoneNumber}</p>
                <p style="color: #666; font-size: 0.9em;">A payment prompt will be sent to your phone</p>
            </div>
            <div id="paymentSteps">
                <div style="margin: 20px 0; padding: 15px; background: #f0f8ff; border-radius: 10px;">
                    <p><strong>Payment Process:</strong></p>
                    <ol style="text-align: left; margin-top: 10px;">
                        <li>Check your phone for M-PESA prompt</li>
                        <li>Enter your M-PESA PIN</li>
                        <li>Confirm the payment</li>
                        <li>Wait for confirmation</li>
                    </ol>
                </div>
                <input type="text" class="payment-input" placeholder="Enter confirmation code (if received)" id="confirmationCode">
                <button class="btn" onclick="simulatePayment(${amount}, '${phoneNumber}')">Confirm Payment</button>
            </div>
            <button class="btn" style="background: #e74c3c; margin-top: 20px;" onclick="cancelPayment()">Cancel Payment</button>
        </div>
    `;
    paymentModal.formData = formData;
    paymentModal.successCallback = successCallback;
    document.body.appendChild(paymentModal);
}

function simulatePayment(amount, phoneNumber) {
    const paymentModal = document.querySelector('.payment-modal');
    const confirmationCode = document.getElementById('confirmationCode').value;
    
    if (confirmationCode.length < 4) {
        showNotification('Please enter a valid confirmation code', 'error');
        return;
    }

    paymentModal.innerHTML = `
        <div class="payment-widget">
            <h3>Processing Payment...</h3>
            <div class="spinner"></div>
            <p>Verifying M-PESA transaction</p>
            <p style="font-size: 0.9em; color: #666;">Transaction ID: MPX${Date.now()}</p>
        </div>
    `;

    setTimeout(() => {
        if (Math.random() > 0.05) {
            const storedFormData = paymentModal.formData;
            const callback = paymentModal.successCallback;
            
            paymentModal.remove();
            
            if (callback === 'processTaskSuccess') {
                processTaskSuccess(storedFormData);
            } else if (callback === 'processTalkSuccess') {
                processTalkSuccess(storedFormData);
            } else if (callback === 'processJobCreationSuccess') {
                processJobCreationSuccess(storedFormData);
            }
            
            showNotification(`M-PESA payment of KSH ${amount} successful! Transaction ID: MPX${Date.now()}`, 'success');
        } else {
            paymentModal.remove();
            showNotification('Payment failed. Please try again or contact support.', 'error');
        }
    }, 3000);
}

function cancelPayment() {
    document.querySelector('.payment-modal')?.remove();
    showNotification('Payment cancelled', 'error');
}

// ===== NOTIFICATION SYSTEM =====
function showNotification(message, type = 'success') {
    const notification = document.getElementById('notification');
    notification.innerHTML = message;
    notification.className = `notification ${type}`;
    notification.style.display = 'block';
    </script>
<script>
    // ============================================
// FIXED VALUE SUBMISSION - ALLOWS EVERYONE
// Replace in index after line ~2500
// ============================================

(function() {
    'use strict';
    
    // Override to allow EVERYONE to submit values
    window.openValueSubmissionModal = function() {
        const currentMember = window.TauDB?.getCurrentMember();
        
        // Get submitter info (member or prompt for guest)
        let submitterInfo = {
            id: null,
            name: '',
            email: '',
            phone: ''
        };
        
        if (currentMember) {
            submitterInfo = {
                id: currentMember.id,
                name: currentMember.fullName,
                email: currentMember.email,
                phone: currentMember.phone
            };
        }
        
        const modal = document.createElement('div');
        modal.className = 'modal';
        modal.style.display = 'block';
        modal.innerHTML = `
            <div class="modal-content" style="max-width: 700px;">
                <span class="close" onclick="this.parentElement.parentElement.remove()">&times;</span>
                
                <div style="background: linear-gradient(45deg, #ffd700, #ffed4e); color: #333; padding: 25px; border-radius: 15px; margin-bottom: 25px; text-align: center;">
                    <h2 style="margin: 0;">üíé Submit Your Value</h2>
                    <p style="margin: 10px 0 0 0;">Turn your skills, products, and services into iKb</p>
                </div>
                
                <form onsubmit="submitValueEveryone(event)" id="valueSubmissionForm">
                    ${!currentMember ? `
                        <!-- Guest Info Section -->
                        <div style="background: #e3f2fd; padding: 20px; border-radius: 10px; margin-bottom: 20px;">
                            <h4 style="margin: 0 0 15px 0; color: #1976d2;">Your Contact Information</h4>
                            
                            <div class="form-group">
                                <label>Your Full Name *</label>
                                <input type="text" name="submitterName" required placeholder="John Doe">
                            </div>
                            
                            <div class="form-group">
                                <label>Your Email *</label>
                                <input type="email" name="submitterEmail" required placeholder="you@example.com">
                            </div>
                            
                            <div class="form-group">
                                <label>Your Phone *</label>
                                <input type="tel" name="submitterPhone" required placeholder="254XXXXXXXXX">
                            </div>
                            
                            <p style="margin: 10px 0 0 0; font-size: 12px; color: #666;">
                                üí° <a href="#" onclick="closeAllModals(); setTimeout(() => showPublicRegistration(), 500); return false;" style="color: #1976d2;">Register for free</a> to track your submissions
                            </p>
                        </div>
                    ` : `
                        <div style="background: #e8f5e9; padding: 15px; border-radius: 10px; margin-bottom: 20px;">
                            <strong>Submitting as:</strong> ${currentMember.fullName} (${currentMember.id})
                        </div>
                    `}
                    
                    <div class="form-group">
                        <label>Value Type *</label>
                        <select name="valueType" required>
                            <option value="">Select type</option>
                            <option value="Product">üì¶ Product</option>
                            <option value="Service">üõ†Ô∏è Service</option>
                            <option value="Skill">üéØ Skill</option>
                            <option value="Labour">üí™ Labour</option>
                            <option value="Time">‚è∞ Time</option>
                        </select>
                    </div>
                    
                    <div class="form-group">
                        <label>Value Title *</label>
                        <input type="text" name="valueTitle" required maxlength="100" placeholder="e.g., Professional Web Design Services">
                    </div>
                    
                    <div class="form-group">
                        <label>Detailed Description *</label>
                        <textarea name="valueDescription" rows="6" required maxlength="2000" placeholder="Describe what you're offering, what makes it valuable, delivery time, terms, etc."></textarea>
                        <small><span id="charCount">0</span>/2000 characters</small>
                    </div>
                    
                    <div class="form-group">
                        <label>Estimated Worth (KSH) *</label>
                        <input type="number" name="worthKsh" required min="0" step="0.01" placeholder="Enter value in KSH">
                        <small>This will be converted to iKb (1 iKb = 100,000 KSH)</small>
                    </div>
                    
                    <div class="form-group">
                        <label>Location/Region *</label>
                        <input type="text" name="valueLocation" required placeholder="Where can you provide this value?">
                    </div>
                    
                    <div class="form-group">
                        <label>
                            <input type="checkbox" name="termsAgree" required style="width: auto; margin-right: 10px;">
                            I certify that this value is genuine and I can deliver as described *
                        </label>
                    </div>
                    
                    <button type="submit" class="btn" style="width: 100%; padding: 15px; font-size: 16px;">
                        üíé Submit Value for Validation
                    </button>
                </form>
            </div>
        `;
        
        document.body.appendChild(modal);
        
        // Character counter
        const textarea = modal.querySelector('textarea[name="valueDescription"]');
        textarea.addEventListener('input', function() {
            document.getElementById('charCount').textContent = this.value.length;
        });
    };
    
    // New submission handler that works for everyone
    window.submitValueEveryone = function(event) {
        event.preventDefault();
        
        const formData = new FormData(event.target);
        const currentMember = window.TauDB?.getCurrentMember();
        
        const worthKsh = parseFloat(formData.get('worthKsh'));
        const worthIkb = (worthKsh / 100000).toFixed(6);
        
        // Determine submitter info
        let submitterId, submitterName, submitterEmail, submitterPhone;
        
        if (currentMember) {
            // Logged-in member
            submitterId = currentMember.id;
            submitterName = currentMember.fullName;
            submitterEmail = currentMember.email;
            submitterPhone = currentMember.phone;
        } else {
            // Guest/Public user
            submitterId = 'GUEST-' + Date.now();
            submitterName = formData.get('submitterName');
            submitterEmail = formData.get('submitterEmail');
            submitterPhone = formData.get('submitterPhone');
        }
        
        const value = {
            id: 'VAL-' + Date.now(),
            type: formData.get('valueType'),
            title: formData.get('valueTitle'),
            description: formData.get('valueDescription'),
            worthKsh: worthKsh,
            worthIkb: worthIkb,
            location: formData.get('valueLocation'),
            submittedBy: submitterId,
            submittedByName: submitterName,
            submittedByEmail: submitterEmail,
            submittedByPhone: submitterPhone,
            isGuestSubmission: !currentMember,
            validationCode: generateValueCode(),
            status: 'Pending Review',
            created: new Date().toISOString(),
            validated: false
        };
        
        // Save to localStorage
        const values = JSON.parse(localStorage.getItem('tauValues') || '[]');
        values.push(value);
        localStorage.setItem('tauValues', JSON.stringify(values));
        
        // Save to Firebase if available
        if (typeof firebase !== 'undefined' && firebase.apps.length > 0) {
            const db = firebase.firestore();
            db.collection('values').doc(value.id).set(value)
                .then(() => console.log('‚òÅÔ∏è Value synced to Firestore'))
                .catch(err => console.warn('‚ö†Ô∏è Firestore sync warning:', err));
        }
        
        // Notify admins
        const adminNotifs = JSON.parse(localStorage.getItem('tauAdminNotifications') || '[]');
        adminNotifs.unshift({
            id: 'ADMIN-' + Date.now(),
            type: 'new_value_submission',
            data: {
                valueName: value.title,
                submittedBy: submitterName,
                worth: worthIkb + ' iKb',
                validationCode: value.validationCode,
                isGuest: !currentMember
            },
            timestamp: new Date().toISOString(),
            read: false
        });
        localStorage.setItem('tauAdminNotifications', JSON.stringify(adminNotifs));
        
        // Notify member if logged in
        if (currentMember && typeof createNotification === 'function') {
            createNotification(
                currentMember.id,
                'üíé Value Submitted!',
                `Your value "${value.title}" has been submitted. Code: ${value.validationCode}`,
                'success'
            );
        }
        
        // Show success modal
        closeAllModals();
        showValueSubmissionSuccess(value, !currentMember);
    };
    
    function generateValueCode() {
        const timestamp = Date.now().toString(36).toUpperCase();
        const random = Math.random().toString(36).substring(2, 6).toUpperCase();
        return 'VAL-' + timestamp + '-' + random;
    }
    
    window.showValueSubmissionSuccess = function(value, isGuest) {
        const modal = document.createElement('div');
        modal.className = 'modal';
        modal.style.display = 'block';
        modal.innerHTML = `
            <div class="modal-content">
                <span class="close" onclick="this.parentElement.parentElement.remove()">&times;</span>
                
                <div style="text-align: center;">
                    <div style="font-size: 80px; margin-bottom: 20px;">‚úÖ</div>
                    <h2 style="color: #2ecc71;">Value Submitted Successfully!</h2>
                </div>
                
                <div style="background: linear-gradient(45deg, #ffd700, #ffed4e); padding: 25px; border-radius: 15px; margin: 25px 0; text-align: center;">
                    <h3 style="color: #333; margin: 0 0 15px 0;">Your Validation Code</h3>
                    <div style="background: white; padding: 15px; border-radius: 10px; font-size: 24px; font-weight: bold; letter-spacing: 3px; color: #333;">
                        ${value.validationCode}
                    </div>
                    <button onclick="copyToClipboard('${value.validationCode}')" class="btn" style="margin-top: 15px; background: white; color: #333;">
                        üìã Copy Code
                    </button>
                </div>
                
                ${isGuest ? `
                    <div style="background: #fff3cd; padding: 20px; border-radius: 10px; margin: 20px 0;">
                        <strong>üí° Track Your Submission:</strong>
                        <p style="margin: 10px 0 0 0;">
                            <a href="#" onclick="closeAllModals(); setTimeout(() => showPublicRegistration(), 500); return false;" style="color: #1976d2; text-decoration: none; font-weight: 600;">
                                Register for free ‚Üí
                            </a> to track all your submissions and earn when values are claimed!
                        </p>
                    </div>
                ` : ''}
                
                <div style="background: #e3f2fd; padding: 20px; border-radius: 10px; margin: 20px 0;">
                    <h4 style="margin: 0 0 10px 0; color: #1976d2;">What Happens Next?</h4>
                    <ol style="margin: 0; padding-left: 20px; color: #666;">
                        <li>Admins review your value (24-48 hours)</li>
                        <li>You'll receive email notification when approved</li>
                        <li>Your value becomes visible to all TAU members</li>
                        <li>When someone claims it, you earn ${value.worthIkb} iKb!</li>
                    </ol>
                </div>
                
                <button onclick="this.parentElement.parentElement.remove()" class="btn" style="width: 100%;">
                    Got it!
                </button>
            </div>
        `;
        document.body.appendChild(modal);
    };
    
    console.log('‚úÖ Value submission now open to EVERYONE');
    
})();
    </script>
<script>

// PUBLIC OPPORTUNITIES DISPLAY - Main App
// ============================================
  
    (function() {
    'use strict';
    
    let currentFilter = 'all';
    
    window.filterOpportunities = function(filter) {
        currentFilter = filter;
        
        // Update button styles
        document.querySelectorAll('[id^="filter-"]').forEach(btn => {
            btn.style.background = 'linear-gradient(45deg, #95a5a6, #7f8c8d)';
        });
        document.getElementById('filter-' + filter).style.background = 'linear-gradient(45deg, #4169e1, #87ceeb)';
        
        refreshPublicOpportunities();
    };
    
    window.refreshPublicOpportunities = function() {
        refreshPublicTasks();
        refreshPublicActivities();
        refreshPublicValues();
    };
    
    window.refreshPublicTasks = function() {
        displayOpportunities();
    };
    
    window.refreshPublicActivities = function() {
        displayOpportunities();
    };
    
    window.refreshPublicValues = function() {
        displayOpportunities();
    };
    
    function displayOpportunities() {
        const container = document.getElementById('publicOpportunitiesContainer');
        if (!container) return;
        
        const tasks = JSON.parse(localStorage.getItem('tauTasks') || '[]').filter(t => t.validated);
        const activities = JSON.parse(localStorage.getItem('tauActivities') || '[]').filter(a => a.validated);
        const values = JSON.parse(localStorage.getItem('tauValues') || '[]').filter(v => v.validated && v.status === 'Approved');
        
        let items = [];
        
        if (currentFilter === 'all' || currentFilter === 'activities') {
            items = items.concat(activities.map(a => ({...a, type: 'activity'})));
        }
        if (currentFilter === 'all' || currentFilter === 'tasks') {
            items = items.concat(tasks.map(t => ({...t, type: 'task'})));
        }
        if (currentFilter === 'all' || currentFilter === 'values') {
            items = items.concat(values.map(v => ({...v, type: 'value'})));
        }
        
        if (items.length === 0) {
            container.innerHTML = '<p style="text-align: center; padding: 40px; color: #999;">No opportunities available yet</p>';
            return;
        }
        
        container.innerHTML = `
            <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(300px, 1fr)); gap: 20px;">
                ${items.map(item => `
                    <div style="background: white; border-radius: 15px; padding: 25px; box-shadow: 0 5px 15px rgba(0,0,0,0.1); border-left: 4px solid ${getColorForType(item.type)};">
                        <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 15px;">
                            <h4 style="margin: 0; color: #2a5298;">${item.title}</h4>
                            <span style="background: ${getColorForType(item.type)}; color: white; padding: 5px 12px; border-radius: 12px; font-size: 12px; font-weight: 600;">
                                ${item.type.toUpperCase()}
                            </span>
                        </div>
                        
                        <p style="color: #666; margin-bottom: 15px;">${item.description}</p>
                        
                        <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 15px;">
                            <span style="background: #ffd700; color: #333; padding: 8px 15px; border-radius: 20px; font-weight: bold;">
                                ${item.type === 'value' ? item.worthIkb + ' iKb' : item.reward + ' iKbp'}
                            </span>
                            ${item.category ? `<span style="font-size: 12px; color: #999;">${item.category}</span>` : ''}
                        </div>
                        
                        <button class="btn" onclick="claimOpportunity('${item.type}', '${item.id}')" style="width: 100%; padding: 12px;">
                            ${item.type === 'value' ? 'üíé Claim Value' : '‚úÖ Complete & Earn'}
                        </button>
                    </div>
                `).join('')}
            </div>
        `;
    }
    
    function getColorForType(type) {
        switch(type) {
            case 'activity': return '#ff6b6b';
            case 'task': return '#4169e1';
            case 'value': return '#ffd700';
            default: return '#95a5a6';
        }
    }
    
    window.claimOpportunity = function(type, id) {
        const currentMember = window.TauDB?.getCurrentMember();
        
        if (!currentMember) {
            showNotification('Please login to claim opportunities', 'error');
            showMemberLogin();
            return;
        }
        if (typeof showRealMemberLogin === 'function') {
    showRealMemberLogin();
} else if (typeof showMemberLogin === 'function') {
    showMemberLogin();
        }
        const storageKey = type === 'activity' ? 'tauActivities' : type === 'task' ? 'tauTasks' : 'tauValues';
        const items = JSON.parse(localStorage.getItem(storageKey) || '[]');
        const item = items.find(i => i.id === id);
        
        if (!item) {
            showNotification('Item not found', 'error');
            return;
        }
        
        if (type === 'value') {
            openValueClaimModal(item);
        } else {
            openCompletionModal(type, item);
        }
    };
    
    function openCompletionModal(type, item) {
        const modal = document.createElement('div');
        modal.className = 'modal';
        modal.style.display = 'block';
        modal.innerHTML = `
            <div class="modal-content">
                <span class="close" onclick="this.parentElement.parentElement.remove()">&times;</span>
                <h2>${type === 'activity' ? 'üìö' : 'üìã'} Complete ${type.charAt(0).toUpperCase() + type.slice(1)}</h2>
                
                <div style="background: #f8f9fa; padding: 20px; border-radius: 10px; margin: 20px 0;">
                    <h3>${item.title}</h3>
                    <p>${item.description}</p>
                    <p style="font-weight: bold; color: #ffd700;">Reward: ${item.reward} iKbp</p>
                </div>
                
                <form onsubmit="submitCompletion(event, '${type}', '${item.id}')">
                    <div class="form-group">
                        <label>Proof of Completion *</label>
                        <textarea name="proof" rows="4" placeholder="Describe what you did, attach links, etc." required></textarea>
                    </div>
                    
                    <div class="form-group">
                        <label>Validation Code (if you have one)</label>
                        <input type="text" name="validationCode" placeholder="Optional">
                    </div>
                    
                    <button type="submit" class="btn">Submit for Review</button>
                </form>
            </div>
        `;
        document.body.appendChild(modal);
    }
    
    function openValueClaimModal(item) {
        const modal = document.createElement('div');
        modal.className = 'modal';
        modal.style.display = 'block';
        modal.innerHTML = `
            <div class="modal-content">
                <span class="close" onclick="this.parentElement.parentElement.remove()">&times;</span>
                <h2>üíé Claim Value</h2>
                
                <div style="background: linear-gradient(45deg, #ffd700, #ffed4e); padding: 20px; border-radius: 10px; margin: 20px 0;">
                    <h3 style="color: #333;">${item.title}</h3>
                    <p style="color: #666;">${item.description}</p>
                    <p style="font-weight: bold; color: #333;">Worth: ${item.worthIkb} iKb (${item.worthKsh} KSH)</p>
                </div>
                
                <form onsubmit="submitValueClaim(event, '${item.id}')">
                    <div class="form-group">
                        <label>How will you provide this value? *</label>
                        <textarea name="proposal" rows="4" required></textarea>
                    </div>
                    
                    <button type="submit" class="btn">Submit Claim</button>
                </form>
            </div>
        `;
        document.body.appendChild(modal);
    }
    
    window.submitCompletion = function(event, type, itemId) {
        event.preventDefault();
        const currentMember = window.TauDB?.getCurrentMember();
        if (!currentMember) return;
        
        const formData = new FormData(event.target);
        const proof = formData.get('proof');
        
        // Add to member's record
        if (type === 'activity') {
            window.TauDB.addActivity(currentMember.id, {
                type: 'Completed Activity',
                title: 'Activity Completion',
                description: proof,
                reward: 0 // Pending approval
            });
        } else {
            window.TauDB.addTask(currentMember.id, {
                title: 'Task Completion',
                description: proof,
                category: 'User Submitted',
                reward: 0 // Pending approval
            });
        }
        
        // Create notification for admins
        createAdminNotification('completion', {
            memberId: currentMember.id,
            memberName: currentMember.fullName,
            itemType: type,
            itemId: itemId,
            proof: proof
        });
        
        closeAllModals();
        showNotification('‚úÖ Submitted for review! You will be notified when approved.', 'success');
    };
    
    window.submitValueClaim = function(event, valueId) {
        event.preventDefault();
        const currentMember = window.TauDB?.getCurrentMember();
        if (!currentMember) return;
        
        const formData = new FormData(event.target);
        const proposal = formData.get('proposal');
        
        // Create admin notification
        createAdminNotification('value_claim', {
            memberId: currentMember.id,
            memberName: currentMember.fullName,
            valueId: valueId,
            proposal: proposal
        });
        
        closeAllModals();
        showNotification('‚úÖ Value claim submitted! Admins will review.', 'success');
    };
    
    function createAdminNotification(type, data) {
        const adminNotifs = JSON.parse(localStorage.getItem('tauAdminNotifications') || '[]');
        adminNotifs.unshift({
            id: 'ADMIN-' + Date.now(),
            type: type,
            data: data,
            timestamp: new Date().toISOString(),
            read: false
        });
        localStorage.setItem('tauAdminNotifications', JSON.stringify(adminNotifs));
    }
    
    // Auto-refresh every 10 seconds
    setInterval(refreshPublicOpportunities, 10000);
    
    // Initial load
    setTimeout(refreshPublicOpportunities, 1000);
})();
  </script>
    <script>
  //===== MODAL MANAGEMENT =====//

    function openModal(type) {
    closeAllModals();
    
    const modalContent = getModalContent(type);
    const modal = document.createElement('div');
    modal.className = 'modal';
    modal.style.display = 'block';
    modal.innerHTML = modalContent;
    document.body.appendChild(modal);
    currentModal = modal;
}

function closeAllModals() {
    const modals = document.querySelectorAll('.modal, .payment-modal');
    modals.forEach(modal => modal.remove());
    currentModal = null;
}

// ===== SELECTION FUNCTIONS =====
function selectLevel(level, element) {
    const buttons = document.querySelectorAll('.level-btn');
    buttons.forEach(btn => btn.classList.remove('selected'));
    const target = element || (window.event && window.event.target);
    if (target) {
        target.classList.add('selected');
    }
    selectedLevel = level;
    const levelInput = document.getElementById('supportLevel');
    if (levelInput) levelInput.value = level;
    
    const enhanced = document.getElementById('enhancedRequirements');
    if (enhanced && (level === 'middle' || level === 'upper' || level === 'high' || level === 'top')) {
        enhanced.style.display = 'block';
    }
}

function selectCategory(category, element) {
    const buttons = document.querySelectorAll('.level-btn');
    buttons.forEach(btn => btn.classList.remove('selected'));
    const target = element || (window.event && window.event.target);
    if (target) {
        target.classList.add('selected');
    }
    selectedCategory = category;
    const categoryInput = document.getElementById('taskCategory');
    if (categoryInput) categoryInput.value = category;
}

// ===== FORM SUBMISSION HANDLERS =====
function processTaskRegistration(event) {
    event.preventDefault();
    const form = event.target;
    const formData = new FormData(form);
    const data = Object.fromEntries(formData.entries());
    
    if (!data.phone || !data.fullName || !data.email || !selectedCategory) {
        showNotification('Please fill all required fields and select a category', 'error');
        return;
    }
    
    if (!data.phone.match(/^254[0-9]{9}$/)) {
        showNotification('Please use correct phone format: 254XXXXXXXXX', 'error');
        return;
    }
    
    data.category = selectedCategory;
    initiateMpesaPayment(500, data.phone, data, 'processTaskSuccess');
}

function processTalkRegistration(event) {
    event.preventDefault();
    const form = event.target;
    const formData = new FormData(form);
    const data = Object.fromEntries(formData.entries());
    
    if (!data.phone || !data.fullName || !data.email || !selectedLevel) {
        showNotification('Please fill all required fields and select a support level', 'error');
        return;
    }
    
    if (!data.phone.match(/^254[0-9]{9}$/)) {
        showNotification('Please use correct phone format: 254XXXXXXXXX', 'error');
        return;
    }
    
    data.supportLevel = selectedLevel;
    initiateMpesaPayment(2000, data.phone, data, 'processTalkSuccess');
}

function processJobCreationTraining(event) {
    event.preventDefault();
    const form = event.target;
    const formData = new FormData(form);
    const data = Object.fromEntries(formData.entries());
    
    if (!data.phone || !data.fullName || !data.email) {
        showNotification('Please fill all required fields', 'error');
        return;
    }
    
    if (!data.phone.match(/^254[0-9]{9}$/)) {
        showNotification('Please use correct phone format: 254XXXXXXXXX', 'error');
        return;
    }
    
    initiateMpesaPayment(1500, data.phone, data, 'processJobCreationSuccess');
}

// ===== DUAL EMAIL SUCCESS HANDLERS =====
function processTaskSuccess(formData) {
    formData.team = 'TASK';
    console.log('üìß Processing TASK registration - sending DUAL emails...');
    
    Promise.all([
        sendEmailToAdmin(formData, 'NEW TASK REGISTRATION - PAYMENT CONFIRMED'),
        sendWelcomeEmail(formData)
    ])
    .then(results => {
        const adminSent = results[0];
        const memberSent = results[1];
        
        if (adminSent && memberSent) {
            showNotification('‚úÖ Registration complete! Confirmation emails sent to you and admin.', 'success');
        } else if (adminSent || memberSent) {
            showNotification('‚úÖ Registration complete! One email sent successfully.', 'success');
        } else {
            showNotification('‚ö†Ô∏è Registration saved but emails failed. Contact: grouptauafrica@gmail.com', 'error');
        }
        closeAllModals();
    })
    .catch(error => {
        console.error('Email error:', error);
        showNotification('‚ö†Ô∏è Registration saved but emails failed. Contact: grouptauafrica@gmail.com', 'error');
        closeAllModals();
    });
}

function processTalkSuccess(formData) {
    formData.team = 'TALK';
    console.log('üìß Processing TALK registration - sending DUAL emails...');
    
    Promise.all([
        sendEmailToAdmin(formData, 'NEW TALK REGISTRATION - PAYMENT CONFIRMED'),
        sendWelcomeEmail(formData)
    ])
    .then(results => {
        const adminSent = results[0];
        const memberSent = results[1];
        
        if (adminSent && memberSent) {
            showNotification('‚úÖ Registration complete! Confirmation emails sent to you and admin.', 'success');
        } else if (adminSent || memberSent) {
            showNotification('‚úÖ Registration complete! One email sent successfully.', 'success');
        } else {
            showNotification('‚ö†Ô∏è Registration saved but emails failed. Contact: grouptauafrica@gmail.com', 'error');
        }
        closeAllModals();
    })
    .catch(error => {
        console.error('Email error:', error);
        showNotification('‚ö†Ô∏è Registration saved but emails failed. Contact: grouptauafrica@gmail.com', 'error');
        closeAllModals();
    });
}

function processJobCreationSuccess(formData) {
    formData.team = 'JOB CREATION';
    console.log('üìß Processing Job Creation - sending DUAL emails...');
    
    Promise.all([
        sendEmailToAdmin(formData, 'JOB CREATION ENROLLMENT - PAYMENT CONFIRMED'),
        sendWelcomeEmail(formData)
    ])
    .then(results => {
        const adminSent = results[0];
        const memberSent = results[1];
        
        if (adminSent && memberSent) {
            showNotification('‚úÖ Enrollment complete! Confirmation emails sent to you and admin.', 'success');
        } else if (adminSent || memberSent) {
            showNotification('‚úÖ Enrollment complete! One email sent successfully.', 'success');
        } else {
            showNotification('‚ö†Ô∏è Enrollment saved but emails failed. Contact: grouptauafrica@gmail.com', 'error');
        }
        closeAllModals();
    })
    .catch(error => {
        console.error('Email error:', error);
        showNotification('‚ö†Ô∏è Enrollment saved but emails failed. Contact: grouptauafrica@gmail.com', 'error');
        closeAllModals();
    });
}

// ===== OTHER FORM SUBMISSIONS WITH FIXED EMAIL =====
function processTrainingRegistration(event) {
    event.preventDefault();
    const form = event.target;
    const formData = new FormData(form);
    const data = Object.fromEntries(formData.entries());
    data.team = 'TRAINING';
    
    console.log('üìß Submitting training registration...');
    Promise.all([
        sendEmailToAdmin(data, 'TRAINING PROGRAM REGISTRATION'),
        sendWelcomeEmail(data)
    ])
    .then(() => {
        showNotification('‚úÖ Training registration successful! Check your email.', 'success');
        closeAllModals();
    })
    .catch(() => {
        showNotification('‚ö†Ô∏è Registration saved. Contact: grouptauafrica@gmail.com', 'error');
        closeAllModals();
    });
}

function processWorkshopProposal(event) {
    event.preventDefault();
    const form = event.target;
    const formData = new FormData(form);
    const data = Object.fromEntries(formData.entries());
    data.team = 'WORKSHOP';
    
    console.log('üìß Submitting workshop proposal - sending DUAL emails...');
    
    Promise.all([
        sendEmailToAdmin(data, 'WORKSHOP PROPOSAL SUBMISSION'),
        sendWelcomeEmail(data)
    ])
    .then(results => {
        const adminSent = results[0];
        const memberSent = results[1];
        
        if (adminSent || memberSent) {
            showNotification('‚úÖ Workshop proposal submitted! Confirmation emails sent.', 'success');
        } else {
            showNotification('‚ö†Ô∏è Proposal saved but emails failed. Contact: grouptauafrica@gmail.com', 'error');
        }
        closeAllModals();
    })
    .catch(error => {
        console.error('Email error:', error);
        showNotification('‚ö†Ô∏è Proposal saved. Contact: grouptauafrica@gmail.com', 'error');
        closeAllModals();
    });
    }

function processResearchRequest(event) {
    event.preventDefault();
    const form = event.target;
    const formData = new FormData(form);
    const data = Object.fromEntries(formData.entries());
    data.team = 'RESEARCH';
    
    console.log('üìß Submitting research request - sending DUAL emails...');
    
    Promise.all([
        sendEmailToAdmin(data, 'RESEARCH SERVICES REQUEST'),
        sendWelcomeEmail(data)
    ])
    .then(results => {
        const adminSent = results[0];
        const memberSent = results[1];
        
        if (adminSent || memberSent) {
            showNotification('‚úÖ Research request submitted! Confirmation emails sent.', 'success');
        } else {
            showNotification('‚ö†Ô∏è Request saved but emails failed. Contact: grouptauafrica@gmail.com', 'error');
        }
        closeAllModals();
    })
    .catch(error => {
        console.error('Email error:', error);
        showNotification('‚ö†Ô∏è Request saved. Contact: grouptauafrica@gmail.com', 'error');
        closeAllModals();
    });
}
function processJobPosting(event) {
    event.preventDefault();
    const form = event.target;
    const formData = new FormData(form);
    const data = Object.fromEntries(formData.entries());
    data.team = 'JOB POSTING';
    
    console.log('üìß Submitting job posting - sending DUAL emails...');
    
    Promise.all([
        sendEmailToAdmin(data, 'NEW JOB POSTING'),
        sendWelcomeEmail(data)
    ])
    .then(results => {
        const adminSent = results[0];
        const memberSent = results[1];
        
        if (adminSent || memberSent) {
            showNotification('‚úÖ Job posting submitted! Confirmation emails sent.', 'success');
        } else {
            showNotification('‚ö†Ô∏è Posting saved but emails failed. Contact: grouptauafrica@gmail.com', 'error');
        }
        closeAllModals();
    })
    .catch(error => {
        console.error('Email error:', error);
        showNotification('‚ö†Ô∏è Posting saved. Contact: grouptauafrica@gmail.com', 'error');
        closeAllModals();
    });
}

function processJobSearch(event) {
    event.preventDefault();
    const form = event.target;
    const formData = new FormData(form);
    const data = Object.fromEntries(formData.entries());
    
    console.log('Submitting job search...');
    sendEmailToOrganization(data, 'JOB SEARCH REQUEST')
        .then(success => {
            if (success) {
                showNotification('‚úÖ Job search submitted! Email sent.', 'success');
                closeAllModals();
            } else {
                showNotification('‚ùå Email failed. Please contact grouptauafrica@gmail.com', 'error');
            }
        });
}

function processJobApplication(event) {
    event.preventDefault();
    const form = event.target;
    const formData = new FormData(form);
    const data = Object.fromEntries(formData.entries());
    
    console.log('Submitting job application...');
    sendEmailToOrganization(data, 'JOB APPLICATION')
        .then(success => {
            if (success) {
                showNotification('‚úÖ Application submitted! Email sent.', 'success');
                closeAllModals();
            } else {
                showNotification('‚ùå Email failed. Please contact grouptauafrica@gmail.com', 'error');
            }
        });
}

function processJobApplication(event) {
    event.preventDefault();
    const form = event.target;
    const formData = new FormData(form);
    const data = Object.fromEntries(formData.entries());
    data.team = 'JOB APPLICATION';
    
    console.log('üìß Submitting job application - sending DUAL emails...');
    
    Promise.all([
        sendEmailToAdmin(data, 'NEW JOB APPLICATION'),
        sendWelcomeEmail(data)
    ])
    .then(results => {
        const adminSent = results[0];
        const memberSent = results[1];
        
        if (adminSent || memberSent) {
            showNotification('‚úÖ Application submitted! Confirmation emails sent.', 'success');
        } else {
            showNotification('‚ö†Ô∏è Application saved but emails failed. Contact: grouptauafrica@gmail.com', 'error');
        }
        closeAllModals();
    })
    .catch(error => {
        console.error('Email error:', error);
        showNotification('‚ö†Ô∏è Application saved. Contact: grouptauafrica@gmail.com', 'error');
        closeAllModals();
    });
}
function processCommunityRegistration(event) {
    event.preventDefault();
    const form = event.target;
    const formData = new FormData(form);
    const data = Object.fromEntries(formData.entries());
    data.team = 'COMMUNITY';
    
    console.log('üìß Submitting community registration - sending DUAL emails...');
    
    Promise.all([
        sendEmailToAdmin(data, 'COMMUNITY PROGRAM REGISTRATION'),
        sendWelcomeEmail(data)
    ])
    .then(results => {
        const adminSent = results[0];
        const memberSent = results[1];
        
        if (adminSent || memberSent) {
            showNotification('‚úÖ Community registration successful! Confirmation emails sent.', 'success');
        } else {
            showNotification('‚ö†Ô∏è Registration saved but emails failed. Contact: grouptauafrica@gmail.com', 'error');
        }
        closeAllModals();
    })
    .catch(error => {
        console.error('Email error:', error);
        showNotification('‚ö†Ô∏è Registration saved. Contact: grouptauafrica@gmail.com', 'error');
        closeAllModals();
    });
}

function processCorporateRegistration(event) {
    event.preventDefault();
    const form = event.target;
    const formData = new FormData(form);
    const data = Object.fromEntries(formData.entries());
    data.team = 'CORPORATE';
    
    console.log('üìß Submitting corporate registration - sending DUAL emails...');
    
    Promise.all([
        sendEmailToAdmin(data, 'CORPORATE REGISTRATION'),
        sendWelcomeEmail(data)
    ])
    .then(results => {
        const adminSent = results[0];
        const memberSent = results[1];
        
        if (adminSent || memberSent) {
            showNotification('‚úÖ Corporate registration submitted! Confirmation emails sent.', 'success');
        } else {
            showNotification('‚ö†Ô∏è Registration saved but emails failed. Contact: grouptauafrica@gmail.com', 'error');
        }
        closeAllModals();
    })
    .catch(error => {
        console.error('Email error:', error);
        showNotification('‚ö†Ô∏è Registration saved. Contact: grouptauafrica@gmail.com', 'error');
        closeAllModals();
    });
}

function processParSiraiRegistration(event) {
    event.preventDefault();
    const form = event.target;
    const formData = new FormData(form);
    const data = Object.fromEntries(formData.entries());
    data.team = 'PAR SIRAI';
    
    console.log('üìß Submitting Par Sirai registration - sending DUAL emails...');
    
    Promise.all([
        sendEmailToAdmin(data, 'PAR SIRAI CENTER REGISTRATION'),
        sendWelcomeEmail(data)
    ])
    .then(results => {
        if (results[0] || results[1]) {
            showNotification('‚úÖ Par Sirai registration successful! Confirmation emails sent.', 'success');
        } else {
            showNotification('‚ö†Ô∏è Registration saved but emails failed. Contact: grouptauafrica@gmail.com', 'error');
        }
        closeAllModals();
    })
    .catch(error => {
        console.error('Email error:', error);
        showNotification('‚ö†Ô∏è Registration saved. Contact: grouptauafrica@gmail.com', 'error');
        closeAllModals();
    });
}

function processTrustGraphAccess(event) {
    event.preventDefault();
    const form = event.target;
    const formData = new FormData(form);
    const data = Object.fromEntries(formData.entries());
    data.team = 'TRUST GRAPH';
    
    console.log('üìß Submitting Trust Graph access - sending DUAL emails...');
    
    Promise.all([
        sendEmailToAdmin(data, 'TRUST GRAPH ACCESS REQUEST'),
        sendWelcomeEmail(data)
    ])
    .then(results => {
        if (results[0] || results[1]) {
            showNotification('‚úÖ Trust Graph access requested! Confirmation emails sent.', 'success');
        } else {
            showNotification('‚ö†Ô∏è Request saved but emails failed. Contact: grouptauafrica@gmail.com', 'error');
        }
        closeAllModals();
    })
    .catch(error => {
        console.error('Email error:', error);
        showNotification('‚ö†Ô∏è Request saved. Contact: grouptauafrica@gmail.com', 'error');
        closeAllModals();
    });
}
function processFoundationInquiry(event) {
    event.preventDefault();
    const form = event.target;
    const formData = new FormData(form);
    const data = Object.fromEntries(formData.entries());
    data.team = 'FOUNDATION';
    
    console.log('üìß Submitting Foundation inquiry - sending DUAL emails...');
    
    Promise.all([
        sendEmailToAdmin(data, 'FOUNDATION INQUIRY'),
        sendWelcomeEmail(data)
    ])
    .then(results => {
        if (results[0] || results[1]) {
            showNotification('‚úÖ Foundation inquiry submitted! Confirmation emails sent.', 'success');
        } else {
            showNotification('‚ö†Ô∏è Inquiry saved but emails failed. Contact: grouptauafrica@gmail.com', 'error');
        }
        closeAllModals();
    })
    .catch(error => {
        console.error('Email error:', error);
        showNotification('‚ö†Ô∏è Inquiry saved. Contact: grouptauafrica@gmail.com', 'error');
        closeAllModals();
    });
}

function processHoldingsInquiry(event) {
    event.preventDefault();
    const form = event.target;
    const formData = new FormData(form);
    const data = Object.fromEntries(formData.entries());
    data.team = 'HOLDINGS';
    
    console.log('üìß Submitting Holdings inquiry - sending DUAL emails...');
    
    Promise.all([
        sendEmailToAdmin(data, 'COMPANY HOLDINGS INQUIRY'),
        sendWelcomeEmail(data)
    ])
    .then(results => {
        if (results[0] || results[1]) {
            showNotification('‚úÖ Holdings inquiry submitted! Confirmation emails sent.', 'success');
        } else {
            showNotification('‚ö†Ô∏è Inquiry saved but emails failed. Contact: grouptauafrica@gmail.com', 'error');
        }
        closeAllModals();
    })
    .catch(error => {
        console.error('Email error:', error);
        showNotification('‚ö†Ô∏è Inquiry saved. Contact: grouptauafrica@gmail.com', 'error');
        closeAllModals();
    });
}
    
// ===== AI ASSISTANT FUNCTIONS =====
function toggleAIChat() {
    const chatWindow = document.getElementById('aiChatWindow');
    if (chatWindow.style.display === 'none' || !chatWindow.style.display) {
        chatWindow.style.display = 'flex';
    } else {
        chatWindow.style.display = 'none';
    }
}

function handleAIChatKeyPress(event) {
    if (event.key === 'Enter') {
        sendAIMessage();
    }
}

function sendAIMessage() {
    const input = document.getElementById('aiChatInput');
    const message = input.value.trim();
    
    if (!message) return;
    
    const messagesContainer = document.getElementById('aiChatMessages');
    
    const userMessage = document.createElement('div');
    userMessage.className = 'ai-message user-message';
    userMessage.textContent = message;
    messagesContainer.appendChild(userMessage);
    
    input.value = '';
    
    setTimeout(() => {
        const aiResponse = generateAIResponse(message);
        const aiMessage = document.createElement('div');
        aiMessage.className = 'ai-message';
        aiMessage.innerHTML = aiResponse;
        messagesContainer.appendChild(aiMessage);
        messagesContainer.scrollTop = messagesContainer.scrollHeight;
    }, 1000);
    
    messagesContainer.scrollTop = messagesContainer.scrollHeight;
}

function generateAIResponse(userMessage) {
    const message = userMessage.toLowerCase();
    
    if (message.includes('register') || message.includes('join')) {
        return `To register with TAU Africa, you can choose between:<br>
        ‚Ä¢ <strong>TASK Team (KSH 500)</strong> - For service providers and skilled professionals<br>
        ‚Ä¢ <strong>TALK Team (KSH 2,000)</strong> - For investors and financial supporters<br>
        ‚Ä¢ <strong>Job Creation Training (KSH 1,500)</strong> - For aspiring entrepreneurs<br>
        <br>Click the relevant buttons in the Membership section to get started!`;
    }
    
    if (message.includes('payment') || message.includes('mpesa')) {
        return `Our payment process uses M-PESA:<br>
        1. Enter your M-PESA number (254XXXXXXXXX format)<br>
        2. You'll receive a payment prompt on your phone<br>
        3. Enter your M-PESA PIN to confirm<br>
        4. Wait for confirmation<br>
        <br>All payments are secure and processed instantly!`;
    }
    
    if (message.includes('kabiru') || message.includes('mining')) {
        return `Kabiru is our digital currency! You can:<br>
        ‚Ä¢ Mine Kabiru by validating real values in the community<br>
        ‚Ä¢ Use the mining portal<br>
        ‚Ä¢ Earn through community contributions<br>
        ‚Ä¢ Convert to other currencies through our ecosystem`;
    }
    
    if (message.includes('help') || message.includes('support')) {
        return `I'm here to help! You can ask me about:<br>
        ‚Ä¢ Registration processes and payments<br>
        ‚Ä¢ Kabiru mining and digital currency<br>
        ‚Ä¢ Community programs and training<br>
        ‚Ä¢ Technical issues with the app<br>
        ‚Ä¢ Business registration services<br>
        <br>What specific area would you like help with?`;
    }
    
    return `Thank you for your question! Here are some ways I can help:<br>
    ‚Ä¢ Registration and membership information<br>
    ‚Ä¢ Payment and M-PESA guidance<br>
    ‚Ä¢ Kabiru mining and digital currency<br>
    ‚Ä¢ Community programs and forum access<br>
    ‚Ä¢ Technical support<br>
    <br>Please ask a specific question, or contact <strong>grouptauafrica@gmail.com</strong> for detailed support.`;
}

// ===== MEMBER LOGIN FUNCTIONS =====
function showMemberLogin() {
    const modal = document.createElement('div');
    modal.className = 'modal';
    modal.style.display = 'block';
    modal.innerHTML = `
        <div class="modal-content">
            <span class="close" onclick="this.parentElement.parentElement.remove()">&times;</span>
            <h2>Member Login</h2>
            <p>Access your TAU Africa member dashboard</p>
            
            <form onsubmit="simulateLogin(event)">
                <div class="form-group">
                    <label>Email or Member ID</label>
                    <input type="text" name="loginId" required>
                </div>
                <div class="form-group">
                    <label>Password</label>
                    <input type="password" name="password" required>
                </div>
                <button type="submit" class="btn">Login to Dashboard</button>
                
                <div style="text-align: center; margin-top: 20px;">
                    <p>New member? Complete registration through TASK or TALK teams first!</p>
                </div>
            </form>
            
            <div style="background: #f0f8ff; padding: 15px; border-radius: 10px; margin-top: 20px;">
                <h4>Demo Access:</h4>
                <p>Use any email/password to see dashboard preview</p>
            </div>
        </div>
    `;
    document.body.appendChild(modal);
}

function simulateLogin(event) {
    event.preventDefault();
    showNotification('Login successful! Loading dashboard...', 'success');
    setTimeout(() => {
        closeAllModals();
        showMemberDashboard();
    }, 1500);
}

function showMemberDashboard() {
    const modal = document.createElement('div');
    modal.className = 'modal';
    modal.style.display = 'block';
    modal.innerHTML = `
        <div class="modal-content" style="max-width: 800px;">
            <span class="close" onclick="this.parentElement.parentElement.remove()">&times;</span>
            <h2>TAU Africa Member Dashboard</h2>
            <p>Welcome, <strong>Demo User</strong></p>
            
            <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(200px, 1fr)); gap: 20px; margin: 30px 0;">
                <div style="background: linear-gradient(45deg, #4169e1, #87ceeb); color: white; padding: 20px; border-radius: 15px; text-align: center; cursor: pointer;" onclick="showNotification('Profile management launching soon!', 'success')">
                    <h4>My Profile</h4>
                    <p>Manage account</p>
                </div>
                <div style="background: linear-gradient(45deg, #ff6b6b, #ee5a24); color: white; padding: 20px; border-radius: 15px; text-align: center; cursor: pointer;" onclick="showNotification('Programs dashboard launching soon!', 'success')">
                    <h4>My Programs</h4>
                    <p>Active memberships</p>
                </div>
                <div style="background: linear-gradient(45deg, #2ecc71, #27ae60); color: white; padding: 20px; border-radius: 15px; text-align: center; cursor: pointer;" onclick="window.open('https://magero1985.github.io/Kabiru-Mining-Portal-/', '_blank')">
                    <h4>Kabiru Wallet</h4>
                    <p>0.00 KABIRU<br><small>Click to mine</small></p>
                </div>
                <div style="background: linear-gradient(45deg, #9b59b6, #8e44ad); color: white; padding: 20px; border-radius: 15px; text-align: center; cursor: pointer;" onclick="openModal('forum')">
                    <h4>Community</h4>
                    <p>Forum & networking</p>
                </div>
            </div>
            
            <div style="background: #f8f9fa; padding: 20px; border-radius: 15px; margin: 20px 0;">
                <h3>Recent Activity</h3>
                <ul style="list-style: none; padding: 0;">
                    <li style="padding: 10px 0; border-bottom: 1px solid #eee;">Registration completed - Welcome to TAU Africa!</li>
                    <li style="padding: 10px 0; border-bottom: 1px solid #eee;">Welcome email sent</li>
                    <li style="padding: 10px 0;">Ready to start your journey!</li>
                </ul>
            </div>
            
            <div style="text-align: center; margin-top: 20px;">
                <p><strong>Note:</strong> This is a dashboard preview. Full functionality available after registration.</p>
            </div>
            üë®‚Äçüíº Admin & Validator Access

    

        Authenticate activities, tasks, and manage member data
    


    
        üîê Open Admin Dashboard
        </div>
    `;
    document.body.appendChild(modal);
}

// ===== EVENT LISTENERS =====
document.addEventListener('click', function(event) {
    if (event.target.classList.contains('modal')) {
        closeAllModals();
    }
});

document.addEventListener('keydown', function(e) {
    if (e.key === 'Escape') {
        closeAllModals();
        document.getElementById('aiChatWindow').style.display = 'none';
    }
});

// ===== INITIALIZE APP =====
document.addEventListener('DOMContentLoaded', function() {
    console.log('========================================');
    console.log('TAU AFRICA INTERNATIONAL - INITIALIZED');
    console.log('========================================');
    console.log('‚úÖ EmailJS Status: ACTIVE & CONFIGURED');
    console.log('‚úÖ Service ID: service_xfira7g');
    console.log('‚úÖ Template ID: template_q2lu285');
    console.log('‚úÖ Recipient: grouptauafrica@gmail.com');
    console.log('‚úÖ M-PESA Payment: READY');
    console.log('‚úÖ All Forms: FUNCTIONAL WITH EMAIL');
    console.log('‚úÖ AI Assistant: ACTIVE');
    console.log('========================================');
    showNotification('‚úÖ Welcome to TAU AFRICA Digital Ecosystem! MINE Values to build your wealth - registration of pilot test group begins Jan 1 2026', 'success');
});
        
// ===== GET MODAL CONTENT BASED ON TYPE =====
function getModalContent(type) {
    switch(type) {
        case 'taskRegistration':
            return createTaskRegistrationModal();
        case 'talkRegistration':
            return createTalkRegistrationModal();
        case 'corporate':
            return createCorporateModal();
        case 'training':
            return createTrainingModal();
        case 'workshop':
            return createWorkshopModal();
        case 'research':
            return createResearchModal();
        case 'jobCreation':
            return createJobCreationModal();
        case 'insertJob':
            return createInsertJobModal();
        case 'retrieveJob':
            return createRetrieveJobModal();
        case 'availableJobs':
            return createAvailableJobsModal();
        case 'applyJob':
            return createApplyJobModal();
        case 'community':
            return createCommunityModal();
        case 'parSirai':
            return createParSiraiModal();
        case 'trustGraph':
            return createTrustGraphModal();
        case 'foundation':
            return createFoundationModal();
        case 'holdings':
            return createHoldingsModal();
        case 'forum':
            return createForumModal();
        default:
            return '<div class="modal-content"><span class="close" onclick="closeAllModals()">&times;</span><h2>Feature Coming Soon</h2><p>This feature is under development.</p></div>';
    }
}
// ===== COMPREHENSIVE TASK REGISTRATION MODAL =====
function createTaskRegistrationModal() {
    return `
        <div class="modal-content">
            <span class="close" onclick="closeAllModals()">&times;</span>
            <h2>Join TASK Team</h2>
            <p>Declare the values or services you're offering to the TAU Africa community</p>
            
            <div class="payment-info">
                <h3>Registration Fee: KSH 500</h3>
                <p>Secure M-PESA payment required ‚Ä¢ One-time membership fee</p>
            </div>
            
            <form onsubmit="processTaskRegistration(event)" id="taskForm">
                <div class="form-group">
                    <label>Full Name *</label>
                    <input type="text" name="fullName" required placeholder="Enter your full legal name">
                </div>
                
                <div class="form-group">
                    <label>Email Address *</label>
                    <input type="email" name="email" required placeholder="your.email@example.com">
                </div>
                
                <div class="form-group">
                    <label>Phone Number (M-PESA) *</label>
                    <input type="tel" name="phone" required placeholder="254XXXXXXXXX" pattern="254[0-9]{9}">
                    <small>Format: 254XXXXXXXXX (include country code)</small>
                </div>
                
                <div class="form-group">
                    <label>Country/Location *</label>
                    <input type="text" name="location" required placeholder="City, Country">
                </div>

                <div class="form-group">
                    <label>Date of Birth *</label>
                    <input type="date" name="dateOfBirth" required>
                </div>

                <div class="form-group">
                    <label>Gender *</label>
                    <select name="gender" required>
                        <option value="">Select gender</option>
                        <option value="Male">Male</option>
                        <option value="Female">Female</option>
                        <option value="Other">Other</option>
                        <option value="Prefer not to say">Prefer not to say</option>
                    </select>
                </div>

                <div class="form-group">
                    <label>Nationality *</label>
                    <input type="text" name="nationality" required placeholder="Your nationality">
                </div>
                
                <div class="form-group">
                    <label>Value Category *</label>
                    <div class="level-selection">
                        <div class="level-btn" onclick="selectCategory('skills', this)">Skills & Crafts</div>
                        <div class="level-btn" onclick="selectCategory('knowledge', this)">Knowledge & Expertise</div>
                        <div class="level-btn" onclick="selectCategory('service', this)">Professional Service</div>
                        <div class="level-btn" onclick="selectCategory('profession', this)">Licensed Profession</div>
                        <div class="level-btn" onclick="selectCategory('creativity', this)">Creative Arts</div>
                        <div class="level-btn" onclick="selectCategory('leadership', this)">Leadership & Management</div>
                        <div class="level-btn" onclick="selectCategory('business', this)">Business & Entrepreneurship</div>
                    </div>
                    <input type="hidden" name="category" id="taskCategory" required>
                </div>
                
                <div class="form-group">
                    <label>Describe Your Value/Service *</label>
                    <textarea name="valueDescription" rows="4" placeholder="Provide a detailed description of what you offer, your expertise, and how it benefits the community" required></textarea>
                </div>
                
                <div class="form-group">
                    <label>Experience Level *</label>
                    <select name="experience" required>
                        <option value="">Select level</option>
                        <option value="Beginner">Beginner (0-2 years)</option>
                        <option value="Intermediate">Intermediate (2-5 years)</option>
                        <option value="Advanced">Advanced (5-10 years)</option>
                        <option value="Expert">Expert (10+ years)</option>
                    </select>
                </div>

                <div class="form-group">
                    <label>Professional Certifications/Licenses</label>
                    <textarea name="certifications" rows="2" placeholder="List any professional certifications, licenses, or credentials you hold"></textarea>
                </div>

                <div class="form-group">
                    <label>Languages Spoken *</label>
                    <input type="text" name="languages" required placeholder="e.g., English, Swahili, French">
                </div>
                
                <h3 style="color: #2a5298; margin: 25px 0 15px 0;">Proof of Innocence & Capabilities</h3>
                
                <div class="form-group">
                    <label>Certificate of Good Conduct Status *</label>
                    <select name="goodConduct" required>
                        <option value="">Select status</option>
                        <option value="Available">Available - Can provide immediately</option>
                        <option value="Will obtain">Will obtain upon request</option>
                        <option value="In process">Currently in process of obtaining</option>
                        <option value="Not applicable">Not applicable in my country</option>
                    </select>
                </div>
                
                <div class="form-group">
                    <label>Health Records Status *</label>
                    <select name="healthStatus" required>
                        <option value="">Select status</option>
                        <option value="Excellent">Excellent health - Can provide medical certificate</option>
                        <option value="Good">Good health - Regular checkups</option>
                        <option value="Will provide">Will provide upon request</option>
                        <option value="Private">Prefer to keep private</option>
                    </select>
                </div>
                
                <div class="form-group">
                    <label>Track Record/References</label>
                    <textarea name="trackRecord" rows="3" placeholder="Previous work experience, achievements, client testimonials, or references (include contact information if possible)"></textarea>
                </div>
                
                <div class="form-group">
                    <label>Family/Support System</label>
                    <textarea name="familySupport" rows="2" placeholder="Brief description of your family situation and support system"></textarea>
                </div>
                
                <div class="form-group">
                    <label>Educational Qualifications</label>
                    <textarea name="education" rows="2" placeholder="Degrees, certificates, training completed, institutions attended"></textarea>
                </div>

                <div class="form-group">
                    <label>Emergency Contact *</label>
                    <input type="text" name="emergencyContact" required placeholder="Name and phone number">
                </div>

                <div class="form-group">
                    <label>How did you hear about TAU Africa? *</label>
                    <select name="referralSource" required>
                        <option value="">Select source</option>
                        <option value="Social Media">Social Media (Twitter/X, TikTok, YouTube)</option>
                        <option value="Friend/Family">Friend or Family Member</option>
                        <option value="Community Event">Community Event</option>
                        <option value="Online Search">Online Search</option>
                        <option value="Business Network">Business Network</option>
                        <option value="Other">Other</option>
                    </select>
                </div>

                <div class="form-group">
                    <label>
                        <input type="checkbox" name="terms" required style="width: auto; margin-right: 10px;">
                        I agree to the TAU Africa Terms of Service and Privacy Policy *
                    </label>
                </div>
                
                <button type="submit" class="btn btn-register">Proceed to M-PESA Payment (KSH 500)</button>
            </form>
        </div>
    `;
}

// ===== COMPREHENSIVE TALK REGISTRATION MODAL =====
function createTalkRegistrationModal() {
    return `
        <div class="modal-content">
            <span class="close" onclick="closeAllModals()">&times;</span>
            <h2>Join TALK Team</h2>
            <p>Declare financial support, grants, or investments you're offering to the African development ecosystem</p>
            
            <div class="payment-info">
                <h3>Registration Fee: KSH 2,000</h3>
                <p>Secure M-PESA payment ‚Ä¢ Deposit goes to Valenta Liquid Pool Reserve for Kabiru value conversion</p>
            </div>
            
            <form onsubmit="processTalkRegistration(event)" id="talkForm">
                <div class="form-group">
                    <label>Full Name/Organization Name *</label>
                    <input type="text" name="fullName" required placeholder="Individual name or organization">
                </div>
                
                <div class="form-group">
                    <label>Email Address *</label>
                    <input type="email" name="email" required placeholder="your.email@example.com">
                </div>
                
                <div class="form-group">
                    <label>Phone Number (M-PESA) *</label>
                    <input type="tel" name="phone" required placeholder="254XXXXXXXXX" pattern="254[0-9]{9}">
                </div>
                
                <div class="form-group">
                    <label>Country/Location *</label>
                    <input type="text" name="location" required>
                </div>

                <div class="form-group">
                    <label>Organization Type *</label>
                    <select name="organizationType" required>
                        <option value="">Select type</option>
                        <option value="Individual Investor">Individual Investor</option>
                        <option value="Corporation">Corporation</option>
                        <option value="Foundation">Foundation/NGO</option>
                        <option value="Government Agency">Government Agency</option>
                        <option value="Investment Fund">Investment Fund</option>
                        <option value="Development Bank">Development Bank</option>
                        <option value="Family Office">Family Office</option>
                        <option value="Other">Other</option>
                    </select>
                </div>

                <div class="form-group">
                    <label>Website/LinkedIn Profile</label>
                    <input type="url" name="website" placeholder="https://example.com">
                </div>
                
                <div class="form-group">
                    <label>Financial Support Level *</label>
                    <div class="level-selection">
                        <div class="level-btn" onclick="selectLevel('ground', this)">Ground Level (&lt; $1,000)</div>
                        <div class="level-btn" onclick="selectLevel('middle', this)">Middle Level ($1,000-$5,000)</div>
                        <div class="level-btn" onclick="selectLevel('upper', this)">Upper Level ($5,000-$10,000)</div>
                        <div class="level-btn" onclick="selectLevel('high', this)">High Level ($10,000-$50,000)</div>
                        <div class="level-btn" onclick="selectLevel('top', this)">Top Level ($50,000+)</div>
                    </div>
                    <input type="hidden" name="supportLevel" id="supportLevel" required>
                </div>
                
                <div class="form-group">
                    <label>Type of Financial Support *</label>
                    <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 10px;">
                        <label><input type="checkbox" name="supportTypes" value="Grants"> Grants</label>
                        <label><input type="checkbox" name="supportTypes" value="Equity Investment"> Equity Investment</label>
                        <label><input type="checkbox" name="supportTypes" value="Debt Financing"> Debt Financing</label>
                        <label><input type="checkbox" name="supportTypes" value="Venture Capital"> Venture Capital</label>
                        <label><input type="checkbox" name="supportTypes" value="Angel Investment"> Angel Investment</label>
                        <label><input type="checkbox" name="supportTypes" value="Crowdfunding"> Crowdfunding</label>
                    </div>
                </div>
                
                <div class="form-group">
                    <label>Focus Areas/Industries *</label>
                    <textarea name="focusAreas" rows="3" placeholder="What sectors, industries, or types of projects do you want to support? (e.g., Agriculture, Technology, Education, Healthcare)" required></textarea>
                </div>

                <div class="form-group">
                    <label>Geographic Focus</label>
                    <input type="text" name="geographicFocus" placeholder="Specific countries or regions of interest">
                </div>

                <div class="form-group">
                    <label>Investment Criteria</label>
                    <textarea name="investmentCriteria" rows="3" placeholder="What criteria do you use when evaluating investment opportunities?"></textarea>
                </div>

                <div class="form-group">
                    <label>Previous African Investments</label>
                    <textarea name="previousInvestments" rows="2" placeholder="Brief description of previous investments or support in Africa"></textarea>
                </div>
                
                <div id="enhancedRequirements" style="display: none;">
                    <h3 style="color: #2a5298; margin: 25px 0 15px 0;">Enhanced Requirements (Middle Level & Above)</h3>
                    
                    <div class="form-group">
                        <label>Certificate of Good Conduct *</label>
                        <select name="goodConduct">
                            <option value="">Select status</option>
                            <option value="Available">Available - Can provide</option>
                            <option value="Will obtain">Will obtain upon request</option>
                            <option value="Not applicable">Not applicable in my country</option>
                        </select>
                    </div>
                    
                    <div class="form-group">
                        <label>Health Records Status *</label>
                        <select name="healthStatus">
                            <option value="">Select status</option>
                            <option value="Excellent">Excellent health - Can provide certificate</option>
                            <option value="Good">Good health - Regular checkups</option>
                            <option value="Will provide">Will provide upon request</option>
                        </select>
                    </div>
                    <div class="form-group">
                        <label>Family/Organizational Financial Support</label>
                        <textarea name="familyFinancial" rows="2" placeholder="Family financial situation or organizational financial backing"></textarea>
                    </div>
                </div>

                <div class="form-group">
                    <label>
                        <input type="checkbox" name="terms" required style="width: auto; margin-right: 10px;">
                        I agree to the TAU Africa Terms of Service and Privacy Policy *
                    </label>
                </div>
                
                <button type="submit" class="btn btn-register">Proceed to M-PESA Payment (KSH 2,000)</button>
            </form>
        </div>
    `;
}
 // ===== JOB CREATION TRAINING MODAL - COMPREHENSIVE =====
function createJobCreationModal() {
    return `
        <div class="modal-content">
            <span class="close" onclick="closeAllModals()">&times;</span>
            <h2>üíº Job Creation Training Program</h2>
            <p>Comprehensive entrepreneurship and job creation program designed for African innovators</p>
            
            <div class="payment-info">
                <h3>Training Fee: KSH 1,500</h3>
                <p>6-week intensive program ‚Ä¢ Digital materials ‚Ä¢ Certification ‚Ä¢ Mentorship support</p>
            </div>
            
            <form onsubmit="processJobCreationTraining(event)" id="jobCreationForm">
                <div class="form-group">
                    <label>Full Name *</label>
                    <input type="text" name="fullName" required>
                </div>
                
                <div class="form-group">
                    <label>Email *</label>
                    <input type="email" name="email" required>
                </div>
                
                <div class="form-group">
                    <label>Phone Number (M-PESA) *</label>
                    <input type="tel" name="phone" required placeholder="254XXXXXXXXX">
                </div>
                
                <div class="form-group">
                    <label>Location *</label>
                    <input type="text" name="location" required>
                </div>

                <div class="form-group">
                    <label>Age Range *</label>
                    <select name="ageRange" required>
                        <option value="">Select age range</option>
                        <option value="18-25">18-25 years</option>
                        <option value="26-35">26-35 years</option>
                        <option value="36-45">36-45 years</option>
                        <option value="46-55">46-55 years</option>
                        <option value="56+">56+ years</option>
                    </select>
                </div>
                
                <div class="form-group">
                    <label>Current Employment Status *</label>
                    <select name="employmentStatus" required>
                        <option value="">Select status</option>
                        <option value="Unemployed">Unemployed</option>
                        <option value="Underemployed">Underemployed</option>
                        <option value="Student">Student</option>
                        <option value="Self-employed">Self-employed</option>
                        <option value="Employed">Employed (seeking additional income)</option>
                        <option value="Recent Graduate">Recent Graduate</option>
                    </select>
                </div>
                
                <div class="form-group">
                    <label>Business Idea/Interest Area *</label>
                    <textarea name="businessIdea" rows="3" placeholder="What type of business or job creation are you interested in? Be specific about your vision." required></textarea>
                </div>

                <div class="form-group">
                    <label>Target Market/Customers *</label>
                    <textarea name="targetMarket" rows="2" placeholder="Who will be your customers or beneficiaries?" required></textarea>
                </div>

                <div class="form-group">
                    <label>Available Capital/Startup Funds</label>
                    <select name="startupFunds">
                        <option value="">Select range</option>
                        <option value="No funds">No funds available</option>
                        <option value="Under KSH 10K">Under KSH 10,000</option>
                        <option value="KSH 10K-50K">KSH 10,000 - 50,000</option>
                        <option value="KSH 50K-100K">KSH 50,000 - 100,000</option>
                        <option value="KSH 100K-500K">KSH 100,000 - 500,000</option>
                        <option value="Over KSH 500K">Over KSH 500,000</option>
                    </select>
                </div>
                
                <div class="form-group">
                    <label>Educational Background *</label>
                    <select name="education" required>
                        <option value="">Select level</option>
                        <option value="Primary School">Primary School</option>
                        <option value="Secondary School">Secondary School</option>
                        <option value="College Diploma">College Diploma</option>
                        <option value="University Degree">University Degree</option>
                        <option value="Postgraduate">Postgraduate</option>
                        <option value="Vocational Training">Vocational Training</option>
                        <option value="Self-taught">Self-taught</option>
                    </select>
                </div>

                <div class="form-group">
                    <label>Relevant Skills/Experience</label>
                    <textarea name="relevantSkills" rows="2" placeholder="List any skills or experience relevant to your business idea"></textarea>
                </div>
                
                <div class="form-group">
                    <label>Training Focus Areas (Select all that apply) *</label>
                    <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 10px; margin-top: 10px;">
                        <label><input type="checkbox" name="focus" value="Business Planning"> Business Planning</label>
                        <label><input type="checkbox" name="focus" value="Financial Management"> Financial Management</label>
                        <label><input type="checkbox" name="focus" value="Marketing & Sales"> Marketing & Sales</label>
                        <label><input type="checkbox" name="focus" value="Digital Skills"> Digital Skills</label>
                        <label><input type="checkbox" name="focus" value="Leadership"> Leadership</label>
                        <label><input type="checkbox" name="focus" value="Networking"> Networking</label>
                        <label><input type="checkbox" name="focus" value="Legal Compliance"> Legal Compliance</label>
                        <label><input type="checkbox" name="focus" value="Product Development"> Product Development</label>
                    </div>
                </div>

                <div class="form-group">
                    <label>Preferred Learning Format *</label>
                    <select name="learningFormat" required>
                        <option value="">Select format</option>
                        <option value="Online only">Online only</option>
                        <option value="In-person only">In-person only</option>
                        <option value="Hybrid">Hybrid (Online + In-person)</option>
                        <option value="Self-paced">Self-paced online</option>
                    </select>
                </div>

                <div class="form-group">
                    <label>Timeline to Start Business *</label>
                    <select name="businessTimeline" required>
                        <option value="">Select timeline</option>
                        <option value="Within 3 months">Within 3 months</option>
                        <option value="3-6 months">3-6 months</option>
                        <option value="6-12 months">6-12 months</option>
                        <option value="Over 1 year">Over 1 year</option>
                        <option value="Just exploring">Just exploring options</option>
                    </select>
                </div>

                <div class="form-group">
                    <label>
                        <input type="checkbox" name="terms" required style="width: auto; margin-right: 10px;">
                        I agree to the TAU Africa Terms of Service and Privacy Policy *
                    </label>
                </div>
                
                <button type="submit" class="btn btn-register">Proceed to M-PESA Payment (KSH 1,500)</button>
            </form>
        </div>
    `;
}

// ===== TRAINING MODAL =====
function createTrainingModal() {
    return `
        <div class="modal-content">
            <span class="close" onclick="closeAllModals()">&times;</span>
            <h2>üìö Join Training Programs</h2>
            
            <form onsubmit="processTrainingRegistration(event)">
                <div class="form-group">
                    <label>Full Name *</label>
                    <input type="text" name="fullName" required>
                </div>
                
                <div class="form-group">
                    <label>Email *</label>
                    <input type="email" name="email" required>
                </div>
                
                <div class="form-group">
                    <label>Phone Number *</label>
                    <input type="tel" name="phone" required>
                </div>
                
                <div class="form-group">
                    <label>Training Category *</label>
                    <select name="trainingCategory" required>
                        <option value="">Select training area</option>
                        <option>Digital Skills & Technology</option>
                        <option>Business & Entrepreneurship</option>
                        <option>Financial Literacy</option>
                        <option>Leadership Development</option>
                        <option>Agricultural Innovation</option>
                        <option>Pan-African Studies</option>
                        <option>Health & Wellness</option>
                        <option>Creative Arts</option>
                    </select>
                </div>
                
                <div class="form-group">
                    <label>Experience Level *</label>
                    <select name="level" required>
                        <option value="">Select level</option>
                        <option>Beginner</option>
                        <option>Intermediate</option>
                        <option>Advanced</option>
                    </select>
                </div>
                
                <div class="form-group">
                    <label>Learning Goals *</label>
                    <textarea name="goals" rows="3" placeholder="What do you hope to achieve through this training?" required></textarea>
                </div>
                
                <div class="form-group">
                    <label>Preferred Training Format</label>
                    <select name="format">
                        <option>Online</option>
                        <option>In-person</option>
                        <option>Hybrid</option>
                    </select>
                </div>
                
                <button type="submit" class="btn">Register for Training</button>
            </form>
        </div>
    `;
}

// ===== WORKSHOP MODAL =====
function createWorkshopModal() {
    return `
        <div class="modal-content">
            <span class="close" onclick="closeAllModals()">&times;</span>
            <h2>üéØ Host a Workshop</h2>
            
            <form onsubmit="processWorkshopProposal(event)">
                <div class="form-group">
                    <label>Your Name *</label>
                    <input type="text" name="hostName" required>
                </div>
                
                <div class="form-group">
                    <label>Email *</label>
                    <input type="email" name="email" required>
                </div>
                
                <div class="form-group">
                    <label>Phone Number *</label>
                    <input type="tel" name="phone" required>
                </div>
                
                <div class="form-group">
                    <label>Workshop Title *</label>
                    <input type="text" name="workshopTitle" required>
                </div>
                
                <div class="form-group">
                    <label>Workshop Category *</label>
                    <select name="category" required>
                        <option value="">Select category</option>
                        <option>Business & Entrepreneurship</option>
                        <option>Technology & Innovation</option>
                        <option>Arts & Culture</option>
                        <option>Health & Wellness</option>
                        <option>Education & Skills</option>
                        <option>Pan-African Studies</option>
                        <option>Financial Literacy</option>
                        <option>Agriculture & Food Security</option>
                    </select>
                </div>
                
                <div class="form-group">
                    <label>Workshop Description *</label>
                    <textarea name="description" rows="4" placeholder="Detailed description of workshop content and objectives" required></textarea>
                </div>
                
                <div class="form-group">
                    <label>Target Audience *</label>
                    <textarea name="audience" rows="2" placeholder="Who should attend this workshop?" required></textarea>
                </div>
                
                <div class="form-group">
                    <label>Duration *</label>
                    <select name="duration" required>
                        <option value="">Select duration</option>
                        <option>2 hours</option>
                        <option>Half day (4 hours)</option>
                        <option>Full day (8 hours)</option>
                        <option>2 days</option>
                        <option>3-5 days</option>
                        <option>1 week</option>
                    </select>
                </div>
                
                <div class="form-group">
                    <label>Your Expertise/Qualifications *</label>
                    <textarea name="expertise" rows="3" placeholder="Your background and qualifications for hosting this workshop" required></textarea>
                </div>
                
                <button type="submit" class="btn">Submit Workshop Proposal</button>
            </form>
        </div>
    `;
}

// ===== RESEARCH SERVICES MODAL =====
function createResearchModal() {
    return `
        <div class="modal-content">
            <span class="close" onclick="closeAllModals()">&times;</span>
            <h2>üî¨ Research Services</h2>
            
            <form onsubmit="processResearchRequest(event)">
                <div class="form-group">
                    <label>Organization/Individual Name *</label>
                    <input type="text" name="clientName" required>
                </div>
                
                <div class="form-group">
                    <label>Contact Email *</label>
                    <input type="email" name="email" required>
                </div>
                
                <div class="form-group">
                    <label>Phone Number *</label>
                    <input type="tel" name="phone" required>
                </div>
                
                <div class="form-group">
                    <label>Research Type *</label>
                    <select name="researchType" required>
                        <option value="">Select research type</option>
                        <option>Market Research</option>
                        <option>Academic Research</option>
                        <option>Policy Research</option>
                        <option>Social Impact Assessment</option>
                        <option>Business Intelligence</option>
                        <option>Pan-African Studies</option>
                        <option>Economic Analysis</option>
                        <option>Cultural Research</option>
                    </select>
                </div>
                
                <div class="form-group">
                    <label>Research Topic/Subject *</label>
                    <input type="text" name="topic" placeholder="Brief description of research topic" required>
                </div>
                
                <div class="form-group">
                    <label>Detailed Research Requirements *</label>
                    <textarea name="requirements" rows="4" placeholder="Specific research questions, methodology preferences, deliverables expected" required></textarea>
                </div>
                
                <div class="form-group">
                    <label>Timeline *</label>
                    <select name="timeline" required>
                        <option value="">Select timeline</option>
                        <option>1-2 weeks</option>
                        <option>1 month</option>
                        <option>2-3 months</option>
                        <option>3-6 months</option>
                        <option>6+ months</option>
                    </select>
                </div>
                
                <div class="form-group">
                    <label>Budget Range (USD)</label>
                    <select name="budget">
                        <option value="">Select budget range</option>
                        <option>Under $1,000</option>
                        <option>$1,000 - $5,000</option>
                        <option>$5,000 - $10,000</option>
                        <option>$10,000 - $25,000</option>
                        <option>$25,000+</option>
                        <option>To be discussed</option>
                    </select>
                </div>
                
                <button type="submit" class="btn">Submit Research Request</button>
            </form>
        </div>
    `;
}
</script>
 <script>
     window.openJobsGallery = function(startMode = null) {
    closeAllModals();
    const modal = document.createElement('div');
    modal.className = 'modal';
    modal.id = 'jobsGalleryModal';
    modal.style.display = 'block';
    
    modal.innerHTML = `
        <div class="modal-content" style="max-width: 1000px; min-height: 500px;">
            <span class="close" onclick="this.parentElement.parentElement.remove()">&times;</span>
            
            <div style="background: linear-gradient(45deg, #4169e1, #2ecc71); color: white; padding: 20px; border-radius: 12px; margin-bottom: 20px;">
                <h2 style="margin:0;">üíº JOBS GALLERY</h2>
            </div>

            <div id="jobSelectionMenu" style="display: grid; grid-template-columns: 1fr 1fr; gap: 15px; padding: 10px;">
                <button class="btn" style="height: 100px; font-weight: bold;" onclick="switchJobView('post')">üì¢ POST A JOB</button>
                <button class="btn" style="height: 100px; font-weight: bold;" onclick="switchJobView('browse')">üìÇ BROWSE PORTAL</button>
                <button class="btn" style="height: 100px; font-weight: bold;" onclick="switchJobView('search')">üîç SEARCH JOBS</button>
                <button class="btn" style="height: 100px; font-weight: bold;" onclick="switchJobView('apply')">üìù APPLY NOW</button>
            </div>

            <div id="jobContentView" style="display: none;">
                <button class="btn-small" onclick="backToJobMenu()" style="background: #666; margin-bottom: 15px;">‚¨ÖÔ∏è Back to Menu</button>
                <div id="jobFormContainer" style="padding: 10px; border: 1px solid #eee; border-radius: 8px;">
                    </div>
            </div>
        </div>
    `;
    document.body.appendChild(modal);

    // If the user clicked a specific button from the main page, jump straight to it
    if (startMode) {
        switchJobView(startMode);
    }
};

window.switchJobView = function(view) {
    const menu = document.getElementById('jobSelectionMenu');
    const content = document.getElementById('jobContentView');
    const container = document.getElementById('jobFormContainer');

    // HIDE the menu and SHOW the content container
    menu.style.display = 'none';
    content.style.display = 'block';

    // Fill the container with the right form
    if (view === 'post') container.innerHTML = getJobPostForm();
    else if (view === 'browse') {
        container.innerHTML = getJobsBrowsePortal();
        if (typeof loadJobsPortal === 'function') loadJobsPortal();
    }
    else if (view === 'search') container.innerHTML = getJobSearchForm();
    else if (view === 'apply') container.innerHTML = getJobApplicationForm();
};

window.backToJobMenu = function() {
    // SHOW the menu and HIDE the content container
    document.getElementById('jobSelectionMenu').style.display = 'grid';
    document.getElementById('jobContentView').style.display = 'none';
};
 </script>
    <script>
// ===== COMMUNITY PROGRAMS MODAL =====
function createCommunityModal() {
    return `
        <div class="modal-content">
            <span class="close" onclick="closeAllModals()">&times;</span>
            <h2>ü§ù Join Community Programs</h2>
            
            <form onsubmit="processCommunityRegistration(event)">
                <div class="form-group">
                    <label>Full Name *</label>
                    <input type="text" name="fullName" required>
                </div>
                
                <div class="form-group">
                    <label>Email *</label>
                    <input type="email" name="email" required>
                </div>
                
                <div class="form-group">
                    <label>Phone *</label>
                    <input type="tel" name="phone" required>
                </div>
                
                <div class="form-group">
                    <label>Location/Community *</label>
                    <input type="text" name="location" required>
                </div>
                
                <div class="form-group">
                    <label>Program Interest (Select all that apply) *</label>
                    <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 10px; margin-top: 10px;">
                        <label><input type="checkbox" name="programs" value="Agriculture"> Agriculture</label>
                        <label><input type="checkbox" name="programs" value="Climate"> Climate Action</label>
                        <label><input type="checkbox" name="programs" value="Environment"> Environment</label>
                        <label><input type="checkbox" name="programs" value="Water"> Water & Sanitation</label>
                        <label><input type="checkbox" name="programs" value="Education"> Education</label>
                        <label><input type="checkbox" name="programs" value="ChildCare"> Child Care</label>
                    </div>
                </div>
                
                <div class="form-group">
                    <label>Role Preference *</label>
                    <select name="role" required>
                        <option value="">How would you like to contribute?</option>
                        <option>Volunteer Worker</option>
                        <option>Community Organizer</option>
                        <option>Technical Advisor</option>
                        <option>Funding/Donor</option>
                        <option>Program Coordinator</option>
                    </select>
                </div>
                
                <div class="form-group">
                    <label>Available Time Commitment</label>
                    <select name="timeCommitment">
                        <option>2-4 hours per week</option>
                        <option>5-10 hours per week</option>
                        <option>10-20 hours per week</option>
                        <option>Full-time volunteer</option>
                        <option>Project-based</option>
                    </select>
                </div>
                
                <div class="form-group">
                    <label>Your Skills/Experience</label>
                    <textarea name="skills" rows="3" placeholder="What skills or experience can you contribute?"></textarea>
                </div>
                
                <button type="submit" class="btn">Join Community Programs</button>
            </form>
        </div>
    `;
}

// ===== CORPORATE REGISTRATION MODAL =====
function createCorporateModal() {
    return `
        <div class="modal-content">
            <span class="close" onclick="closeAllModals()">&times;</span>
            <h2>üè¢ Corporate Registration - Valenta Holdings</h2>
            
            <div class="payment-info">
                <h3>Corporate Registration Package</h3>
                <p>Comprehensive business registration and setup services</p>
            </div>
            
            <form onsubmit="processCorporateRegistration(event)">
                <div class="form-group">
                    <label>Company Name *</label>
                    <input type="text" name="companyName" required>
                </div>
                
                <div class="form-group">
                    <label>Business Type *</label>
                    <select name="businessType" required>
                        <option value="">Select business type</option>
                        <option>Limited Company</option>
                        <option>Partnership</option>
                        <option>Sole Proprietorship</option>
                        <option>NGO/Foundation</option>
                        <option>Cooperative</option>
                    </select>
                </div>
                
                <div class="form-group">
                    <label>Industry Sector *</label>
                    <select name="sector" required>
                        <option value="">Select sector</option>
                        <option>Technology & Innovation</option>
                        <option>Agriculture & Food</option>
                        <option>Healthcare & Pharmaceuticals</option>
                        <option>Education & Training</option>
                        <option>Finance & Banking</option>
                        <option>Manufacturing</option>
                        <option>Retail & Commerce</option>
                        <option>Energy & Environment</option>
                        <option>Tourism & Hospitality</option>
                        <option>Media & Entertainment</option>
                        <option>Construction & Real Estate</option>
                        <option>Transportation & Logistics</option>
                    </select>
                </div>
                
                <div class="form-group">
                    <label>Training for Trade Program</label>
                    <select name="trainingTrade">
                        <option value="">Not applicable</option>
                        <option>Yes - Include training for employees</option>
                        <option>Yes - Include skills development</option>
                        <option>Yes - Include professional certification</option>
                    </select>
                </div>
                
                <div class="form-group">
                    <label>Contact Person *</label>
                    <input type="text" name="contactName" required>
                </div>
                
                <div class="form-group">
                    <label>Email *</label>
                    <input type="email" name="email" required>
                </div>
                
                <div class="form-group">
                    <label>Phone Number *</label>
                    <input type="tel" name="phone" required>
                </div>
                
                <div class="form-group">
                    <label>Country *</label>
                    <input type="text" name="country" required>
                </div>
                
                <div class="form-group">
                    <label>Business Address *</label>
                    <textarea name="address" rows="3" required></textarea>
                </div>
                
                <div class="form-group">
                    <label>Business Description *</label>
                    <textarea name="businessDescription" rows="4" placeholder="Describe your business activities, products, services" required></textarea>
                </div>
                
                <div class="form-group">
                    <label>Expected Initial Investment (USD)</label>
                    <select name="investment">
                        <option value="">Select range</option>
                        <option>Under $10,000</option>
                        <option>$10,000 - $50,000</option>
                        <option>$50,000 - $100,000</option>
                        <option>$100,000 - $500,000</option>
                        <option>$500,000 - $1,000,000</option>
                        <option>Over $1,000,000</option>
                    </select>
                </div>
                
                <div class="form-group">
                    <label>Expected Number of Employees</label>
                    <select name="employees">
                        <option value="">Select range</option>
                        <option>1-5 employees</option>
                        <option>6-20 employees</option>
                        <option>21-50 employees</option>
                        <option>51-100 employees</option>
                        <option>100+ employees</option>
                    </select>
                </div>
                
                <div class="form-group">
                    <label>Pan-African Vision Alignment</label>
                    <textarea name="alignment" rows="3" placeholder="How does your business align with Pan-African development goals?"></textarea>
                </div>
                
                <button type="submit" class="btn">Submit Corporate Registration</button>
            </form>
        </div>
    `;
}

// ===== PAR SIRAI MODAL =====
function createParSiraiModal() {
    return `
        <div class="modal-content">
            <span class="close" onclick="closeAllModals()">&times;</span>
            <h2>üèõÔ∏è Kabiru Service Centers</h2>
            <p>Kabiru Technical & customercare centers</p>
            
            <div style="padding: 20px;">
                <div style="background: linear-gradient(45deg, #ff6b6b, #4ecdc4); color: white; padding: 30px; border-radius: 15px; margin: 20px 0; text-align: center;">
                    <h3>Welcome to Kabiru Service Center</h3>
                    <p>The spiritual and intellectual heart of Pan-African awakening, building kabiru as a FinTech African Digital-value currency</p>
                </div>
                
                <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(250px, 1fr)); gap: 20px;">
                    <div style="background: #f8f9fa; padding: 20px; border-radius: 15px;">
                        <h4>üìö CustomerCare Desk</h4>
                        <p>Access to kabiru connections, 1st Validation and technical solutions. A repository for Pan-African history, philosophy, and wisdom traditions that build kabiru</p>
                    </div>
                    <div style="background: #f8f9fa; padding: 20px; border-radius: 15px;">
                        <h4>üßò System validator Desk</h4>
                        <p>Access the kabiru tokenization, iKbp and iKb direct to your account and 2nd Validation level. Value  quality control protocol for genuine business. A repository for Meditation, prayer, and consciousness development programs that build kabiru</p>
                    </div>
                    <div style="background: #f8f9fa; padding: 20px; border-radius: 15px;">
                        <h4>üë• System Agents Circles</h4>
                        <p> Access the kabiru chain services, logistics valuers. You get Discussion groups and learning circles for token growth</p>
                    </div>
                    <div style="background: #f8f9fa; padding: 20px; border-radius: 15px;">
                        <h4>üåü Member and participation</h4>
                        <p>Full membership benefits Structured programs for economic, social and spiritual consciousness</p>
                    </div>
                </div>
                
                <form onsubmit="processParSiraiRegistration(event)" style="margin-top: 30px;">
                    <div class="form-group">
                        <label>Name *</label>
                        <input type="text" name="name" required>
                    </div>
                    <div class="form-group">
                        <label>Email *</label>
                        <input type="email" name="email" required>
                    </div>
                    <div class="form-group">
                        <label>Interest Area *</label>
                        <select name="interest" required>
                            <option value="">Select area</option>
                            <option>System Customer-Care</option>
                            <option>System Validator</option>
                            <option>System Agent </option>
                            <option>Public Access</option>
                            <option>Kabiru development Team</option>
                        </select>
                    </div>
                    <button type="submit" class="btn">Service Centre portal>
                </form>
            </div>
        </div>
    `;
}
</script>
    <script>
// ===== TRUST GRAPH MODAL =====
function createTrustGraphModal() {
    return `
        <div class="modal-content">
            <span class="close" onclick="closeAllModals()">&times;</span>
            <h2>üîó Trust Graph Ledger</h2>
            <div style="padding: 20px; text-align: center;">
                <div style="background: linear-gradient(45deg, #667eea, #764ba2); color: white; padding: 30px; border-radius: 15px; margin: 20px 0;">
                    <h3>Blockchain-Based Trust System</h3>
                    <p>Building transparent and verifiable trust networks across Africa</p>
                </div>
                <p style="margin: 20px 0;">The Trust Graph Ledger is currently in development. This system will enable:</p>
                <ul style="text-align: left; max-width: 500px; margin: 0 auto;">
                    <li>Verified identity and reputation tracking</li>
                    <li>Transparent transaction histories</li>
                    <li>Community-validated trust scores</li>
                    <li>Decentralized governance mechanisms</li>
                </ul>
            </div>
            
            <form onsubmit="processTrustGraphAccess(event)" id="trustGraphForm">
                <div class="form-group">
                    <label>Organization Name *</label>
                    <input type="text" name="organization" required>
                </div>
                <div class="form-group">
                    <label>Contact Email *</label>
                    <input type="email" name="email" required>
                </div>
                <div class="form-group">
                    <label>Access Level *</label>
                    <select name="accessLevel" required>
                        <option value="">Select level</option>
                        <option value="Basic">Basic Access</option>
                        <option value="Business">Corporate Access</option>
                        <option value="Enterprise">Sovereign Access</option>
                    </select>
                </div>
                <button type="submit" class="btn">Request Access</button>
            </form>
        </div>
    `;
}
</script>
<script>
// ===== FOUNDATION MODAL =====
function createFoundationModal() {
    return `
        <div class="modal-content">
            <span class="close" onclick="closeAllModals()">&times;</span>
            <h2>üåç TAU Africa Foundation</h2>
            <div style="padding: 20px;">
                <div style="background: linear-gradient(45deg, #2ecc71, #27ae60); color: white; padding: 30px; border-radius: 15px; margin: 20px 0; text-align: center;">
                    <h3>Foundation for Sustainable Development</h3>
                    <p>Empowering African communities through strategic partnerships</p>
                </div>
                
                <form onsubmit="processFoundationInquiry(event)">
                    <div class="form-group">
                        <label>Organization/Individual Name *</label>
                        <input type="text" name="name" required>
                    </div>
                    <div class="form-group">
                        <label>Email *</label>
                        <input type="email" name="email" required>
                    </div>
                    <div class="form-group">
                        <label>Inquiry Type *</label>
                        <select name="inquiryType" required>
                            <option value="">Select inquiry type</option>
                            <option>Grant Application</option>
                            <option>Partnership Opportunity</option>
                            <option>Donation/Contribution</option>
                            <option>Program Collaboration</option>
                            <option>General Information</option>
                        </select>
                    </div>
                    <div class="form-group">
                        <label>Message *</label>
                        <textarea name="message" rows="4" required></textarea>
                    </div>
                    <button type="submit" class="btn">Submit Foundation Inquiry</button>
                </form>
            </div>
        </div>
    `;
}
</script>
<script>
// ===== HOLDINGS MODAL =====
function createHoldingsModal() {
    return `
        <div class="modal-content">
            <span class="close" onclick="closeAllModals()">&times;</span>
            <h2>üè¢ Company Holdings</h2>
            <div style="padding: 20px;">
                <div style="background: linear-gradient(45deg, #9b59b6, #8e44ad); color: white; padding: 30px; border-radius: 15px; margin: 20px 0; text-align: center;">
                    <h3>Valenta Holdings Portfolio</h3>
                    <p>Strategic investments in African development</p>
                </div>
                
                <div style="display: grid; gap: 15px; margin: 20px 0;">
                    <div style="border: 1px solid #ddd; padding: 15px; border-radius: 10px;">
                        <h4>Kabiru Digital Currency</h4>
                        <p>Revolutionary blockchain-based currency for African trade</p>
                    </div>
                    <div style="border: 1px solid #ddd; padding: 15px; border-radius: 10px;">
                        <h4>AUFFI Community Network</h4>
                        <p>Pan-African social and spiritual unity platform</p>
                    </div>
                    <div style="border: 1px solid #ddd; padding: 15px; border-radius: 10px;">
                        <h4>Agricultural Innovation Centers</h4>
                        <p>Modern farming techniques and food security</p>
                    </div>
                </div>
                
                <form onsubmit="processHoldingsInquiry(event)">
                    <div class="form-group">
                        <label>Name/Organization *</label>
                        <input type="text" name="name" required>
                    </div>
                    <div class="form-group">
                        <label>Email *</label>
                        <input type="email" name="email" required>
                    </div>
                    <div class="form-group">
                        <label>Interest *</label>
                        <select name="interest" required>
                            <option value="">Select interest</option>
                            <option>Investment Opportunities</option>
                            <option>Partnership Proposals</option>
                            <option>Acquisition Inquiries</option>
                            <option>Joint Ventures</option>
                            <option>General Information</option>
                        </select>
                    </div>
                    <div class="form-group">
                        <label>Message *</label>
                        <textarea name="message" rows="3" required></textarea>
                    </div>
                    <button type="submit" class="btn">Submit Holdings Inquiry</button>
                </form>
            </div>
        </div>
    `;
}
</script>
<script> 
// ===== FORUM MODAL =====//
function createForumModal() {
    return `
        <div class="modal-content">
            <span class="close" onclick="closeAllModals()">&times;</span>
            <h2>üí¨ Member Forum</h2>
            <p>Connect with fellow TAU Africa members</p>
            
            <div style="background: #f8f9fa; padding: 20px; border-radius: 10px; margin: 20px 0;">
                <h3>Forum Features:</h3>
                <ul style="text-align: left;">
                    <li>Discussion boards by topic</li>
                    <li>Job sharing and networking</li>
                    <li>Training materials access</li>
                    <li>Voice calls and messaging</li>
                    <li>Business collaboration</li>
                </ul>
                
                <div style="margin-top: 20px; padding: 15px; background: #fff3cd; border-radius: 8px;">
                    <strong>Notice:</strong> Forum access requires active TASK or TALK membership
                </div>
            </div>
            
            <div style="text-align: center;">
                <button class="btn" onclick="openModal('taskRegistration')">Join TASK Team</button>
                <button class="btn" onclick="openModal('talkRegistration')">Join TALK Team</button>
                <button class="btn" onclick="showMemberLogin()">Member Login</button>
            </div>
        </div>
    `;
}
</script>
    <script>
// ============================================
// FORUM FIX
// ============================================
window.openForumFixed = function() {
    const currentMember = window.TauDB?.getCurrentMember();
    
    if (!currentMember) {
        showNotification('Please login to access forum', 'error');
        showRealMemberLogin();
        return;
    }
    
    // Force close all modals
    document.querySelectorAll('.modal').forEach(m => m.remove());
    
    // Wait a moment then open forum
    setTimeout(() => {
        if (typeof openModal === 'function') {
            openModal('forum');
        } else if (typeof createForumModal === 'function') {
            const modal = document.createElement('div');
            modal.className = 'modal';
            modal.style.display = 'block';
            modal.innerHTML = createForumModal();
            document.body.appendChild(modal);
        }
    }, 100);
};

// Override existing forum buttons
document.addEventListener('DOMContentLoaded', () => {
    setTimeout(() => {
        document.querySelectorAll('[onclick*="forum"]').forEach(btn => {
            btn.onclick = openForumFixed;
        });
    }, 2000);
});
    </script>
    <script>
   // =====================================================
   // TAU AFRICA DATABASE CONNECTION LAYER - COMPLETE
   // =====================================================

(function() {
    'use strict';

    // Database Configuration
    const DB_CONFIG = {
        dbKey: 'tauAfricaDB',
        credentialsKey: 'tauCredentials',
        referralsKey: 'tauReferrals',
        jobsPortalKey: 'tauJobsPortal',
        sessionKey: 'tauCurrentUser',
        activitiesKey: 'tauActivities',
        tasksKey: 'tauTasks',
        forumsKey: 'tauForums'
    };

    // Member ID & Referral Code Generation
    function generateMemberID(team, referralCode = null) {
        const prefix = team === 'TASK' ? 'TSK' : team === 'TALK' ? 'TLK' : 'JOB';
        const timestamp = Date.now().toString().slice(-6);
        const random = Math.floor(Math.random() * 1000).toString().padStart(3, '0');
        const id = `${prefix}-${timestamp}-${random}`;
        
        if (referralCode) {
            trackReferral(referralCode, id);
        }
        
        return id;
    }

    function generateReferralCode(memberId) {
        return btoa(memberId).substring(0, 8).toUpperCase();
    }

    // Referral Tracking with iKbp Rewards
    function trackReferral(referralCode, newMemberId) {
        try {
            const referrals = JSON.parse(localStorage.getItem(DB_CONFIG.referralsKey) || '{}');
            const members = JSON.parse(localStorage.getItem(DB_CONFIG.dbKey) || '[]');
            const referrer = members.find(m => m.referralCode === referralCode);
            
            if (referrer) {
                if (!referrals[referrer.id]) {
                    referrals[referrer.id] = {
                        memberId: referrer.id,
                        referredMembers: [],
                        totalEarnings: 0
                    };
                }
                
                const earnings = 500;
                referrals[referrer.id].referredMembers.push({
                    memberId: newMemberId,
                    date: new Date().toISOString(),
                    earnings: earnings
                });
                referrals[referrer.id].totalEarnings += earnings;
                
                localStorage.setItem(DB_CONFIG.referralsKey, JSON.stringify(referrals));
                updateMemberBalance(referrer.id, earnings);
                sendReferralNotification(referrer, earnings);
                
                console.log(`‚úÖ Referral tracked: ${referrer.id} earned ${earnings} iKbp`);
            }
        } catch (error) {
            console.error('Referral tracking error:', error);
        }
    }

    function updateMemberBalance(memberId, amount) {
        try {
            const members = JSON.parse(localStorage.getItem(DB_CONFIG.dbKey) || '[]');
            const memberIndex = members.findIndex(m => m.id === memberId);
            
            if (memberIndex !== -1) {
                members[memberIndex].iKbpBalance = (members[memberIndex].iKbpBalance || 0) + amount;
                localStorage.setItem(DB_CONFIG.dbKey, JSON.stringify(members));
                return true;
            }
            return false;
        } catch (error) {
            console.error('Balance update error:', error);
            return false;
        }
    }

    function sendReferralNotification(referrer, earnings) {
        const templateParams = {
            to_email: referrer.email,
            to_name: referrer.fullName,
            subject: 'üéâ Referral Bonus Earned - TAU Africa',
            message: `Congratulations ${referrer.fullName}!\n\nYou've earned ${earnings} iKbp (${earnings/10} KSH) from your referral.\n\nTotal Referral Earnings: ${getReferralEarnings(referrer.id)} iKbp\nCurrent Balance: ${referrer.iKbpBalance || 0} iKbp\n\nKeep sharing your referral code: ${referrer.referralCode}\n\nThank you for building TAU Africa!`,
            from_name: 'TAU Africa',
            from_email: 'grouptauafrica@gmail.com',
            phone: referrer.phone || 'Not provided',
            location: referrer.location || 'Not provided'
        };
        
        if (typeof emailjs !== 'undefined') {
            emailjs.send('service_xfira7g', 'template_bqxztig', templateParams)
                .then(() => console.log('‚úÖ Referral notification sent'))
                .catch(err => console.error('Referral email error:', err));
        }
    }

    function getReferralEarnings(memberId) {
        const referrals = JSON.parse(localStorage.getItem(DB_CONFIG.referralsKey) || '{}');
        return referrals[memberId]?.totalEarnings || 0;
    }

    function checkReferralCode() {
        const urlParams = new URLSearchParams(window.location.search);
        return urlParams.get('ref');
    }

    // Enhanced syncToDatabase Function
    function syncToDatabase(formData, team, referralCode = null) {
        try {
            const existingMembers = JSON.parse(localStorage.getItem(DB_CONFIG.dbKey) || '[]');
            
            const memberId = generateMemberID(team, referralCode);
            const memberReferralCode = generateReferralCode(memberId);
            
            const member = {
                id: memberId,
                referralCode: memberReferralCode,
                team: team,
                fullName: formData.fullName || formData.name,
                email: formData.email,
                phone: formData.phone,
                location: formData.location,
                paymentStatus: 'Paid',
                dateJoined: new Date().toISOString().split('T')[0],
                status: 'Active',
                fee: team === 'TASK' ? 500 : team === 'TALK' ? 2000 : 1500,
                accountCreated: new Date().toISOString(),
                lastLogin: null,
                activities: [],
                tasks: [],
                jobs: [],
                forumPosts: [],
                iKbpBalance: 0,
                referredBy: referralCode || null
            };
            
            Object.keys(formData).forEach(key => {
                if (!member[key]) {
                    member[key] = formData[key];
                }
            });
            
            existingMembers.push(member);
            localStorage.setItem(DB_CONFIG.dbKey, JSON.stringify(existingMembers));
            storeMemberCredentials(member);
            window.dispatchEvent(new CustomEvent('tauMemberAdded', { detail: member }));
            
            console.log('‚úÖ Member synced to database:', memberId);
            return { success: true, memberId, member };
            
        } catch (error) {
            console.error('‚ùå Database sync error:', error);
            return { success: false, error: error.message };
        }
    }

    function storeMemberCredentials(member) {
        const credentials = JSON.parse(localStorage.getItem(DB_CONFIG.credentialsKey) || '{}');
        credentials[member.id] = {
            email: member.email,
            phone: member.phone.slice(-4),
            fullName: member.fullName
        };
        localStorage.setItem(DB_CONFIG.credentialsKey, JSON.stringify(credentials));
    }
     
    // Authentication
    function authenticateMember(identifier, phoneLastFour) {
        try {
            const members = JSON.parse(localStorage.getItem(DB_CONFIG.dbKey) || '[]');
            const member = members.find(m => 
                (m.id === identifier || m.email === identifier) && 
                m.phone.slice(-4) === phoneLastFour
            );
            
            if (member) {
                member.lastLogin = new Date().toISOString();
                const memberIndex = members.findIndex(m => m.id === member.id);
                members[memberIndex] = member;
                localStorage.setItem(DB_CONFIG.dbKey, JSON.stringify(members));
                sessionStorage.setItem(DB_CONFIG.sessionKey, JSON.stringify(member));
                return { success: true, member };
            }
            
            return { success: false, error: 'Invalid credentials' };
        } catch (error) {
            return { success: false, error: error.message };
        }
    }

    function getCurrentMember() {
        const sessionData = sessionStorage.getItem(DB_CONFIG.sessionKey);
        if (sessionData) {
            const member = JSON.parse(sessionData);
            const members = JSON.parse(localStorage.getItem(DB_CONFIG.dbKey) || '[]');
            const freshMember = members.find(m => m.id === member.id);
            if (freshMember) {
                sessionStorage.setItem(DB_CONFIG.sessionKey, JSON.stringify(freshMember));
                return freshMember;
            }
        }
        return null;
    }

    function logoutMember() {
        sessionStorage.removeItem(DB_CONFIG.sessionKey);
        return true;
    }

    // Activity Management
    function addMemberActivity(memberId, activity) {
        try {
            const members = JSON.parse(localStorage.getItem(DB_CONFIG.dbKey) || '[]');
            const memberIndex = members.findIndex(m => m.id === memberId);
            
            if (memberIndex !== -1) {
                const activityRecord = {
                    id: `ACT-${Date.now()}`,
                    type: activity.type,
                    title: activity.title,
                    description: activity.description,
                    dateAdded: new Date().toISOString(),
                    status: 'Active',
                    iKbpReward: activity.reward || 100
                };
                
                members[memberIndex].activities.push(activityRecord);
                members[memberIndex].iKbpBalance += activityRecord.iKbpReward;
                localStorage.setItem(DB_CONFIG.dbKey, JSON.stringify(members));
                
                return { 
                    success: true, 
                    activity: activityRecord,
                    newBalance: members[memberIndex].iKbpBalance,
                    earned: activityRecord.iKbpReward
                };
            }
            
            return { success: false, error: 'Member not found' };
        } catch (error) {
            return { success: false, error: error.message };
        }
    }

    // Task Management
    function addMemberTask(memberId, task) {
        try {
            const members = JSON.parse(localStorage.getItem(DB_CONFIG.dbKey) || '[]');
            const memberIndex = members.findIndex(m => m.id === memberId);
            
            if (memberIndex !== -1) {
                const taskRecord = {
                    id: `TSK-${Date.now()}`,
                    title: task.title,
                    description: task.description,
                    category: task.category,
                    dateAssigned: new Date().toISOString(),
                    dueDate: task.dueDate || null,
                    status: 'Assigned',
                    iKbpReward: task.reward || 200,
                    completedDate: null
                };
                
                members[memberIndex].tasks.push(taskRecord);
                localStorage.setItem(DB_CONFIG.dbKey, JSON.stringify(members));
                return { success: true, task: taskRecord };
            }
            
            return { success: false, error: 'Member not found' };
        } catch (error) {
            return { success: false, error: error.message };
        }
    }

    function completeTask(memberId, taskId) {
        try {
            const members = JSON.parse(localStorage.getItem(DB_CONFIG.dbKey) || '[]');
            const memberIndex = members.findIndex(m => m.id === memberId);
            
            if (memberIndex !== -1) {
                const task = members[memberIndex].tasks.find(t => t.id === taskId);
                
                if (task && task.status !== 'Completed') {
                    task.status = 'Completed';
                    task.completedDate = new Date().toISOString();
                    members[memberIndex].iKbpBalance += task.iKbpReward;
                    localStorage.setItem(DB_CONFIG.dbKey, JSON.stringify(members));
                    
                    return { 
                        success: true, 
                        task, 
                        newBalance: members[memberIndex].iKbpBalance,
                        earned: task.iKbpReward
                    };
                }
            }
            
            return { success: false, error: 'Task not found or already completed' };
        } catch (error) {
            return { success: false, error: error.message };
        }
    }
    
        // Forum Management
    function createForumPost(memberId, post) {
        try {
            const forums = JSON.parse(localStorage.getItem(DB_CONFIG.forumsKey) || '[]');
            const members = JSON.parse(localStorage.getItem(DB_CONFIG.dbKey) || '[]');
            const member = members.find(m => m.id === memberId);
            
            if (member) {
                const forumPost = {
                    id: `POST-${Date.now()}`,
                    authorId: memberId,
                    authorName: member.fullName,
                    authorTeam: member.team,
                    title: post.title,
                    content: post.content,
                    category: post.category,
                    datePosted: new Date().toISOString(),
                    likes: 0,
                    comments: [],
                    iKbpEarned: 50
                };
                
                forums.push(forumPost);
                localStorage.setItem(DB_CONFIG.forumsKey, JSON.stringify(forums));
                updateMemberBalance(memberId, 50);
                
                return { success: true, post: forumPost, earned: 50 };
            }
            
            return { success: false, error: 'Member not found' };
        } catch (error) {
            return { success: false, error: error.message };
        }
    }

    function getForumPosts(filters = {}) {
        try {
            let posts = JSON.parse(localStorage.getItem(DB_CONFIG.forumsKey) || '[]');
            
            if (filters.category) {
                posts = posts.filter(p => p.category === filters.category);
            }
            if (filters.authorId) {
                posts = posts.filter(p => p.authorId === filters.authorId);
            }
            
            posts.sort((a, b) => new Date(b.datePosted) - new Date(a.datePosted));
            return { success: true, posts };
        } catch (error) {
            return { success: false, error: error.message };
        }
    }

    function addForumComment(postId, memberId, comment) {
        try {
            const forums = JSON.parse(localStorage.getItem(DB_CONFIG.forumsKey) || '[]');
            const members = JSON.parse(localStorage.getItem(DB_CONFIG.dbKey) || '[]');
            const member = members.find(m => m.id === memberId);
            const post = forums.find(p => p.id === postId);
            
            if (post && member) {
                const commentObj = {
                    id: `CMT-${Date.now()}`,
                    authorId: memberId,
                    authorName: member.fullName,
                    content: comment,
                    datePosted: new Date().toISOString()
                };
                
                post.comments.push(commentObj);
                localStorage.setItem(DB_CONFIG.forumsKey, JSON.stringify(forums));
                updateMemberBalance(memberId, 10);
                
                return { success: true, comment: commentObj, earned: 10 };
            }
            
            return { success: false, error: 'Post or member not found' };
        } catch (error) {
            return { success: false, error: error.message };
        }
    }

        // Welcome Email
    function sendWelcomeEmail(member) {
        const templateParams = {
            to_email:formData.email,
            to_name: formData.fullName,
            subject: 'üéâ Welcome to TAU Africa',
            message: `Welcome ${member.fullName}!\n\nMember ID: ${member.id}\nReferral Code: ${member.referralCode}\n\nLogin: ${window.location.origin}\n\nEarn iKbp by:\n- Referring members: 500 iKbp\n- Completing tasks: 100-500 iKbp\n- Forum posts: 50 iKbp\n\nBalance: ${member.iKbpBalance} iKbp`,
            from_name: 'TAU Africa',
            from_email: 'grouptauafrica@gmail.com',
            phone: formData.phone,
            location: formData.location
        };
        
        return emailjs.send('service_xfira7g', 'template_bqxztig', templateParams);
    }

    // Override Success Handlers
    window.processTaskSuccess = function(formData) {
        const referralCode = checkReferralCode();
        const syncResult = syncToDatabase(formData, 'TASK', referralCode);
        
        if (syncResult.success) {
            const member = syncResult.member;
            sendWelcomeEmail(member);
            if (typeof sendEmailToOrganization === 'function') {
                sendEmailToOrganization(formData, 'NEW TASK REGISTRATION');
            }
            if (typeof showNotification === 'function') {
                showNotification(`‚úÖ Registration Complete!\nMember ID: ${member.id}\nReferral Code: ${member.referralCode}`, 'success');
            }
            setTimeout(() => {
                if (typeof showSuccessModal === 'function') showSuccessModal(member);
                if (typeof closeAllModals === 'function') closeAllModals();
            }, 2000);
        }
    };

    window.processTalkSuccess = function(formData) {
        const referralCode = checkReferralCode();
        const syncResult = syncToDatabase(formData, 'TALK', referralCode);
        
        if (syncResult.success) {
            const member = syncResult.member;
            sendWelcomeEmail(member);
            if (typeof sendEmailToOrganization === 'function') {
                sendEmailToOrganization(formData, 'NEW TALK REGISTRATION');
            }
            if (typeof showNotification === 'function') {
                showNotification(`‚úÖ Registration Complete!\nMember ID: ${member.id}\nReferral Code: ${member.referralCode}`, 'success');
            }
            setTimeout(() => {
                if (typeof showSuccessModal === 'function') showSuccessModal(member);
                if (typeof closeAllModals === 'function') closeAllModals();
            }, 2000);
        }
    };

    window.processJobCreationSuccess = function(formData) {
        const referralCode = checkReferralCode();
        const syncResult = syncToDatabase(formData, 'JOB_CREATION', referralCode);
        
        if (syncResult.success) {
            const member = syncResult.member;
            sendWelcomeEmail(member);
            if (typeof sendEmailToOrganization === 'function') {
                sendEmailToOrganization(formData, 'JOB CREATION ENROLLMENT');
            }
            if (typeof showNotification === 'function') {
                showNotification(`‚úÖ Enrollment Complete!\nMember ID: ${member.id}`, 'success');
            }
            setTimeout(() => {
                if (typeof showSuccessModal === 'function') showSuccessModal(member);
                if (typeof closeAllModals === 'function') closeAllModals();
            }, 2000);
        }
    };

    // Export API
    window.TauDB = {
        sync: syncToDatabase,
        authenticate: authenticateMember,
        getCurrentMember: getCurrentMember,
        logout: logoutMember,
        addActivity: addMemberActivity,
        addTask: addMemberTask,
        completeTask: completeTask,
        createForumPost: createForumPost,
        getForumPosts: getForumPosts,
        addForumComment: addForumComment,
        getReferralEarnings: getReferralEarnings,
        checkReferralCode: checkReferralCode,
        sendWelcomeEmail: sendWelcomeEmail,
        updateBalance: updateMemberBalance
    };

    console.log('‚úÖ TAU DATABASE CONNECTOR LOADED');
    
    const ref = checkReferralCode();
    if (ref && typeof showNotification === 'function') {
        showNotification(`üéÅ Referral code: ${ref} - Referrer earns 500 iKbp when you register!`, 'info', 8000);
    }
})(); 
    </script>
<script>
    // ============================================
// ENHANCED MEMBER ACCOUNT DASHBOARD
// Add this to your main app after existing code
// ============================================

(function() {
    'use strict';
    
    console.log('üíº Loading Enhanced Member Account System...');
    
    // ============================================
    // COMPREHENSIVE MEMBER DASHBOARD
    // ============================================
    window.showEnhancedMemberDashboard = function(member) {
        if (!member) {
            member = window.TauDB?.getCurrentMember();
            if (!member) {
                showNotification('‚ùå Please login first', 'error');
                showRealMemberLogin();
                return;
            }
        }
        
        // Update member data from storage
        const members = JSON.parse(localStorage.getItem('tauAfricaDB') || '[]');
        const freshMember = members.find(m => m.id === member.id) || member;
        
        // Get member's activities, tasks, values
        const allActivities = JSON.parse(localStorage.getItem('tauActivities') || '[]');
        const allTasks = JSON.parse(localStorage.getItem('tauTasks') || '[]');
        const allValues = JSON.parse(localStorage.getItem('tauValues') || '[]');
        
        const myActivities = freshMember.activities || [];
        const myTasks = freshMember.tasks || [];
        const mySubmittedValues = allValues.filter(v => v.submittedBy === freshMember.id);
        const myClaimedValues = allValues.filter(v => v.claimedBy === freshMember.id);
        
        // Calculate statistics
        const completedActivities = myActivities.filter(a => a.status === 'Completed').length;
        const completedTasks = myTasks.filter(t => t.status === 'Completed').length;
        const pendingActivities = myActivities.filter(a => a.status !== 'Completed').length;
        const pendingTasks = myTasks.filter(t => t.status !== 'Completed').length;
        
        closeAllModals();
        
        const modal = document.createElement('div');
        modal.className = 'modal';
        modal.style.display = 'block';
        modal.innerHTML = `
            <div class="modal-content" style="max-width: 1200px; max-height: 90vh; overflow-y: auto;">
                <span class="close" onclick="this.parentElement.parentElement.remove()">&times;</span>
                
                <!-- ACCOUNT HEADER -->
                <div style="background: linear-gradient(45deg, #4169e1, #87ceeb); color: white; padding: 30px; border-radius: 15px; margin-bottom: 20px;">
                    <div style="display: flex; justify-content: space-between; align-items: center; flex-wrap: wrap;">
                        <div>
                            <h1 style="margin: 0;">Welcome, ${freshMember.fullName}! üëã</h1>
                            <p style="margin: 10px 0 0 0; opacity: 0.9;">
                                ${freshMember.team} Member ‚Ä¢ ID: ${freshMember.id}
                            </p>
                        </div>
                        <div style="text-align: right;">
                            <button onclick="showAccountDetails('${freshMember.id}')" class="btn" style="background: rgba(255,255,255,0.2);">
                                üìã Full Details
                            </button>
                            <button onclick="window.TauDB.logout(); location.reload();" class="btn" style="background: rgba(255,255,255,0.2); margin-left: 10px;">
                                üö™ Logout
                            </button>
                        </div>
                    </div>
                </div>
                
                <!-- BALANCE CARDS -->
                <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(200px, 1fr)); gap: 15px; margin-bottom: 30px;">
                    <div style="background: linear-gradient(45deg, #ffd700, #ffed4e); padding: 25px; border-radius: 15px; text-align: center; color: #333;">
                        <h3 style="margin: 0 0 10px 0;">üí∞ iKbp Balance</h3>
                        <h1 style="font-size: 2.5rem; margin: 0;">${(freshMember.iKbpBalance || 0).toLocaleString()}</h1>
                        <p style="margin: 10px 0 0 0;">${((freshMember.iKbpBalance || 0) / 10).toFixed(2)} KSH</p>
                    </div>
                    
                    <div style="background: linear-gradient(45deg, #667eea, #764ba2); padding: 25px; border-radius: 15px; text-align: center; color: white;">
                        <h3 style="margin: 0 0 10px 0;">üíé iKb Balance</h3>
                        <h1 style="font-size: 2.5rem; margin: 0;">${(freshMember.iKbBalance || 0).toFixed(4)}</h1>
                        <p style="margin: 10px 0 0 0;">${((freshMember.iKbBalance || 0) * 100000).toLocaleString()} KSH</p>
                    </div>
                    
                    <div style="background: linear-gradient(45deg, #ff6b6b, #ee5a24); padding: 25px; border-radius: 15px; text-align: center; color: white;">
                        <h3 style="margin: 0 0 10px 0;">üéÅ Referral Code</h3>
                        <h1 style="font-size: 1.8rem; margin: 0; letter-spacing: 3px;">${freshMember.referralCode}</h1>
                        <button onclick="copyReferralLink('${freshMember.referralCode}')" class="btn" style="margin-top: 10px; background: rgba(255,255,255,0.2); color: white; width: 100%;">
                            üìã Copy Link
                        </button>
                    </div>
                </div>
                
                <!-- QUICK STATS -->
                <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(150px, 1fr)); gap: 10px; margin-bottom: 30px;">
                    <div style="background: #e3f2fd; padding: 15px; border-radius: 10px; text-align: center;">
                        <div style="font-size: 2rem; font-weight: bold; color: #2196f3;">${completedActivities}</div>
                        <div style="font-size: 0.9rem; color: #666;">Activities Done</div>
                    </div>
                    <div style="background: #f3e5f5; padding: 15px; border-radius: 10px; text-align: center;">
                        <div style="font-size: 2rem; font-weight: bold; color: #9c27b0;">${completedTasks}</div>
                        <div style="font-size: 0.9rem; color: #666;">Tasks Done</div>
                    </div>
                    <div style="background: #fff3e0; padding: 15px; border-radius: 10px; text-align: center;">
                        <div style="font-size: 2rem; font-weight: bold; color: #ff9800;">${mySubmittedValues.length}</div>
                        <div style="font-size: 0.9rem; color: #666;">Values Submitted</div>
                    </div>
                    <div style="background: #e8f5e9; padding: 15px; border-radius: 10px; text-align: center;">
                        <div style="font-size: 2rem; font-weight: bold; color: #4caf50;">${myClaimedValues.length}</div>
                        <div style="font-size: 0.9rem; color: #666;">Values Claimed</div>
                    </div>
                </div>
                
                <!-- MINING SECTIONS -->
                <div style="display: grid; grid-template-columns: 1fr 1fr 1fr; gap: 20px; margin-bottom: 30px;">
                    <!-- ACTIVITIES MINING -->
                    <div style="background: white; border: 3px solid #ff6b6b; border-radius: 15px; padding: 20px;">
                        <h3 style="color: #ff6b6b; margin: 0 0 15px 0;">üìö ACTIVITIES MINING</h3>
                        <div style="margin-bottom: 15px;">
                            <div style="font-size: 0.9rem; color: #666; margin-bottom: 5px;">Completed: ${completedActivities}</div>
                            <div style="font-size: 0.9rem; color: #666;">Pending: ${pendingActivities}</div>
                        </div>
                        <button onclick="showActivitiesMining('${freshMember.id}')" class="btn" style="width: 100%; background: #ff6b6b;">
                            ‚õèÔ∏è Mine Activities
                        </button>
                    </div>
                    
                    <!-- TASKS MINING -->
                    <div style="background: white; border: 3px solid #667eea; border-radius: 15px; padding: 20px;">
                        <h3 style="color: #667eea; margin: 0 0 15px 0;">‚úÖ TASKS MINING</h3>
                        <div style="margin-bottom: 15px;">
                            <div style="font-size: 0.9rem; color: #666; margin-bottom: 5px;">Completed: ${completedTasks}</div>
                            <div style="font-size: 0.9rem; color: #666;">Pending: ${pendingTasks}</div>
                        </div>
                        <button onclick="showTasksMining('${freshMember.id}')" class="btn" style="width: 100%; background: #667eea;">
                            ‚õèÔ∏è Mine Tasks
                        </button>
                    </div>
                    
                    <!-- VALUES MINING -->
                    <div style="background: white; border: 3px solid #ffd700; border-radius: 15px; padding: 20px;">
                        <h3 style="color: #f39c12; margin: 0 0 15px 0;">üíé VALUES MINING</h3>
                        <div style="margin-bottom: 15px;">
                            <div style="font-size: 0.9rem; color: #666; margin-bottom: 5px;">Submitted: ${mySubmittedValues.length}</div>
                            <div style="font-size: 0.9rem; color: #666;">Claimed: ${myClaimedValues.length}</div>
                        </div>
                        <button onclick="showValuesMining('${freshMember.id}')" class="btn" style="width: 100%; background: linear-gradient(45deg, #ffd700, #f39c12);">
                            ‚õèÔ∏è Mine Values
                        </button>
                    </div>
                </div>
                
                <!-- KABIRU TRANSFER -->
                <div style="background: linear-gradient(45deg, #FFD700, #FFA500); padding: 20px; border-radius: 15px; text-align: center; margin-bottom: 20px;">
                    <h3 style="color: #333; margin: 0 0 15px 0;">üí∏ Kabiru Mining Transfer</h3>
                    <button onclick="initiateKabiruWithdrawal()" class="btn" style="width: 100%; max-width: 400px; background: #333; color: #FFD700; font-size: 16px;">
                        Transfer to Kabiru Mining App
                    </button>
                    <p style="color: #333; font-size: 12px; margin: 10px 0 0 0;">Minimum: 10,000 iKbp or 0.0001 iKb</p>
                </div>
                
                <!-- UPGRADE SECTION (for PUBLIC members) -->
                ${freshMember.type === 'public' ? `
                <div style="background: #fff3cd; padding: 20px; border-radius: 10px; text-align: center; margin-top: 20px;">
                    <h4>üîì Unlock Full Mining Access</h4>
                    <p>Upgrade to TASK or TALK for full access to activities, tasks, and unlimited mining!</p>
                    <button class="btn" onclick="closeAllModals(); setTimeout(() => openModal('taskRegistration'), 500)">
                        Join TASK (KSH 500)
                    </button>
                    <button class="btn" onclick="closeAllModals(); setTimeout(() => openModal('talkRegistration'), 500)">
                        Join TALK (KSH 2,000)
                    </button>
                </div>
                ` : ''}
            </div>
        `;
        
        document.body.appendChild(modal);
    };
    
    // ============================================
    // ACCOUNT DETAILS DROPDOWN
    // ============================================
    window.showAccountDetails = function(memberId) {
        const members = JSON.parse(localStorage.getItem('tauAfricaDB') || '[]');
        const member = members.find(m => m.id === memberId);
        
        if (!member) return;
        
        const modal = document.createElement('div');
        modal.className = 'modal';
        modal.style.display = 'block';
        modal.innerHTML = `
            <div class="modal-content">
                <span class="close" onclick="this.parentElement.parentElement.remove()">&times;</span>
                
                <h2>üìã Account Details</h2>
                
                <div style="background: #f8f9fa; padding: 20px; border-radius: 10px; margin: 20px 0;">
                    <div style="display: grid; grid-template-columns: 150px 1fr; gap: 15px;">
                        <strong>Member ID:</strong> <span>${member.id}</span>
                        <strong>Full Name:</strong> <span>${member.fullName}</span>
                        <strong>Email:</strong> <span>${member.email}</span>
                        <strong>Phone:</strong> <span>${member.phone}</span>
                        <strong>Location:</strong> <span>${member.location}</span>
                        <strong>Team:</strong> <span>${member.team}</span>
                        <strong>Membership:</strong> <span>${member.type || member.team}</span>
                        <strong>Status:</strong> <span style="color: #27ae60;">${member.status}</span>
                        <strong>Date Joined:</strong> <span>${member.dateJoined || new Date(member.accountCreated).toLocaleDateString()}</span>
                        <strong>Last Login:</strong> <span>${member.lastLogin ? new Date(member.lastLogin).toLocaleString() : 'Never'}</span>
                        <strong>Referral Code:</strong> <span>${member.referralCode}</span>
                        <strong>Referred By:</strong> <span>${member.referredBy || 'Direct'}</span>
                    </div>
                </div>
                
                <button onclick="this.parentElement.parentElement.remove()" class="btn" style="width: 100%;">Close</button>
            </div>
        `;
        
        document.body.appendChild(modal);
    };
    
    // ============================================
    // ACTIVITIES MINING INTERFACE
    // ============================================
    window.showActivitiesMining = function(memberId) {
        const members = JSON.parse(localStorage.getItem('tauAfricaDB') || '[]');
        const member = members.find(m => m.id === memberId);
        
        if (!member) return;
        
        // Get all validated activities available for members
        const allActivities = JSON.parse(localStorage.getItem('tauActivities') || '[]');
        const availableActivities = allActivities.filter(a => a.validated && a.status === 'Active');
        
        // Get member's activities
        const myActivities = member.activities || [];
        const myActivityIds = myActivities.map(a => a.id);
        
        // Filter out already claimed
        const unclaimedActivities = availableActivities.filter(a => !myActivityIds.includes(a.id));
        
        closeAllModals();
        
        const modal = document.createElement('div');
        modal.className = 'modal';
        modal.style.display = 'block';
        modal.innerHTML = `
            <div class="modal-content" style="max-width: 1000px;">
                <span class="close" onclick="this.parentElement.parentElement.remove()">&times;</span>
                
                <div style="background: linear-gradient(45deg, #ff6b6b, #ee5a24); color: white; padding: 25px; border-radius: 15px; margin-bottom: 20px;">
                    <h2 style="margin: 0;">üìö ACTIVITIES MINING</h2>
                    <p style="margin: 10px 0 0 0;">Complete activities to earn iKbp</p>
                </div>
                
                <!-- MY ACTIVITIES -->
                <div style="margin-bottom: 30px;">
                    <h3>My Activities (${myActivities.length})</h3>
                    <div style="max-height: 300px; overflow-y: auto;">
                        ${myActivities.length > 0 ? myActivities.map(activity => `
                            <div style="background: ${activity.status === 'Completed' ? '#e8f5e9' : '#fff3e0'}; padding: 15px; border-radius: 10px; margin-bottom: 10px; border-left: 4px solid ${activity.status === 'Completed' ? '#4caf50' : '#ff9800'};">
                                <div style="display: flex; justify-content: space-between; align-items: start;">
                                    <div style="flex: 1;">
                                        <h4 style="margin: 0 0 5px 0;">${activity.title || activity.type}</h4>
                                        <p style="margin: 0 0 10px 0; font-size: 0.9rem; color: #666;">${activity.description}</p>
                                        <div style="font-size: 0.9rem; color: #666;">
                                            <strong>Reward:</strong> ${activity.iKbpReward || activity.reward} iKbp ‚Ä¢ 
                                            <strong>Status:</strong> ${activity.status}
                                        </div>
                                    </div>
                                    ${activity.status !== 'Completed' ? `
                                        <button onclick="completeActivity('${memberId}', '${activity.id}')" class="btn" style="background: #4caf50;">
                                            ‚úì Complete
                                        </button>
                                    ` : `
                                        <div style="background: #4caf50; color: white; padding: 10px 15px; border-radius: 8px; font-weight: bold;">
                                            ‚úì Done
                                        </div>
                                    `}
                                </div>
                            </div>
                        `).join('') : '<p style="text-align: center; padding: 40px; color: #999;">No activities yet</p>'}
                    </div>
                </div>
                
                <!-- AVAILABLE ACTIVITIES -->
                <div>
                    <h3>Available Activities (${unclaimedActivities.length})</h3>
                    <div style="max-height: 300px; overflow-y: auto;">
                        ${unclaimedActivities.length > 0 ? unclaimedActivities.map(activity => `
                            <div style="background: white; border: 2px solid #ff6b6b; padding: 15px; border-radius: 10px; margin-bottom: 10px;">
                                <h4 style="margin: 0 0 5px 0; color: #ff6b6b;">${activity.title}</h4>
                                <p style="margin: 0 0 10px 0; font-size: 0.9rem;">${activity.description}</p>
                                <div style="display: flex; justify-content: space-between; align-items: center;">
                                    <div style="font-size: 0.9rem; color: #666;">
                                        <strong style="color: #ffd700;">Reward: ${activity.reward} iKbp</strong>
                                    </div>
                                    <button onclick="claimActivity('${memberId}', '${activity.id}')" class="btn" style="background: #ff6b6b;">
                                        ‚õèÔ∏è Claim & Start
                                    </button>
                                </div>
                            </div>
                        `).join('') : '<p style="text-align: center; padding: 40px; color: #999;">No available activities. Check back later!</p>'}
                    </div>
                </div>
            </div>
        `;
        
        document.body.appendChild(modal);
    };
    
    // Claim activity
    window.claimActivity = function(memberId, activityId) {
        const allActivities = JSON.parse(localStorage.getItem('tauActivities') || '[]');
        const activity = allActivities.find(a => a.id === activityId);
        
        if (!activity) {
            showNotification('‚ùå Activity not found', 'error');
            return;
        }
        
        const members = JSON.parse(localStorage.getItem('tauAfricaDB') || '[]');
        const memberIndex = members.findIndex(m => m.id === memberId);
        
        if (memberIndex === -1) return;
        
        if (!members[memberIndex].activities) {
            members[memberIndex].activities = [];
        }
        
        const claimedActivity = {
            ...activity,
            claimedAt: new Date().toISOString(),
            status: 'In Progress'
        };
        
        members[memberIndex].activities.push(claimedActivity);
        localStorage.setItem('tauAfricaDB', JSON.stringify(members));
        
        showNotification('‚úÖ Activity claimed! Complete it to earn iKbp.', 'success');
        
        // Refresh
        setTimeout(() => {
            showActivitiesMining(memberId);
        }, 1000);
    };
    
    // Complete activity
    window.completeActivity = function(memberId, activityId) {
        const confirmed = confirm('Mark this activity as complete?');
        if (!confirmed) return;
        
        const members = JSON.parse(localStorage.getItem('tauAfricaDB') || '[]');
        const memberIndex = members.findIndex(m => m.id === memberId);
        
        if (memberIndex === -1) return;
        
        const activityIndex = members[memberIndex].activities.findIndex(a => a.id === activityId);
        
        if (activityIndex === -1) return;
        
        // Update activity status
        members[memberIndex].activities[activityIndex].status = 'Completed';
        members[memberIndex].activities[activityIndex].completedAt = new Date().toISOString();
        
        const reward = members[memberIndex].activities[activityIndex].iKbpReward || 
                      members[memberIndex].activities[activityIndex].reward || 
                      100;
        
        // Award iKbp
        members[memberIndex].iKbpBalance = (members[memberIndex].iKbpBalance || 0) + reward;
        
        localStorage.setItem('tauAfricaDB', JSON.stringify(members));
        
        // Create notification
        if (typeof createNotification === 'function') {
            createNotification(memberId, 'üéâ Activity Completed!', `Earned ${reward} iKbp!`, 'success');
        }
        
        showNotification(`üéâ Activity completed! Earned ${reward} iKbp!`, 'success');
        
        // Refresh
        setTimeout(() => {
            showActivitiesMining(memberId);
        }, 1500);
    };
    
    // Override existing dashboard function
    window.showRealMemberDashboard = window.showEnhancedMemberDashboard;
    
    console.log('‚úÖ Enhanced Member Account System loaded');
    
})();
</script>
    <script>
        // ============================================
// TASKS MINING & VALUES MINING INTERFACES
// Add after member account system
// ============================================

(function() {
    'use strict';
    
    console.log('‚õèÔ∏è Loading Tasks & Values Mining...');
    
    // ============================================
    // TASKS MINING INTERFACE
    // ============================================
    window.showTasksMining = function(memberId) {
        const members = JSON.parse(localStorage.getItem('tauAfricaDB') || '[]');
        const member = members.find(m => m.id === memberId);
        
        if (!member) return;
        
        // Get all validated tasks
        const allTasks = JSON.parse(localStorage.getItem('tauTasks') || '[]');
        const availableTasks = allTasks.filter(t => t.validated && t.status === 'Active');
        
        // Get member's tasks
        const myTasks = member.tasks || [];
        const myTaskIds = myTasks.map(t => t.id);
        
        // Filter unclaimed
        const unclaimedTasks = availableTasks.filter(t => !myTaskIds.includes(t.id));
        
        closeAllModals();
        
        const modal = document.createElement('div');
        modal.className = 'modal';
        modal.style.display = 'block';
        modal.innerHTML = `
            <div class="modal-content" style="max-width: 1000px;">
                <span class="close" onclick="this.parentElement.parentElement.remove()">&times;</span>
                
                <div style="background: linear-gradient(45deg, #667eea, #764ba2); color: white; padding: 25px; border-radius: 15px; margin-bottom: 20px;">
                    <h2 style="margin: 0;">‚úÖ TASKS MINING</h2>
                    <p style="margin: 10px 0 0 0;">Complete tasks to earn iKbp</p>
                </div>
                
                <!-- MY TASKS -->
                <div style="margin-bottom: 30px;">
                    <h3>My Tasks (${myTasks.length})</h3>
                    <div style="max-height: 300px; overflow-y: auto;">
                        ${myTasks.length > 0 ? myTasks.map(task => `
                            <div style="background: ${task.status === 'Completed' ? '#e8f5e9' : '#fff3e0'}; padding: 15px; border-radius: 10px; margin-bottom: 10px; border-left: 4px solid ${task.status === 'Completed' ? '#4caf50' : '#667eea'};">
                                <div style="display: flex; justify-content: space-between; align-items: start;">
                                    <div style="flex: 1;">
                                        <h4 style="margin: 0 0 5px 0;">${task.title}</h4>
                                        <p style="margin: 0 0 10px 0; font-size: 0.9rem; color: #666;">${task.description}</p>
                                        <div style="font-size: 0.9rem; color: #666;">
                                            <strong>Category:</strong> ${task.category} ‚Ä¢ 
                                            <strong>Reward:</strong> ${task.iKbpReward || task.reward} iKbp ‚Ä¢ 
                                            <strong>Status:</strong> ${task.status}
                                        </div>
                                        ${task.dueDate ? `<div style="font-size: 0.85rem; color: #e74c3c; margin-top: 5px;">Due: ${new Date(task.dueDate).toLocaleDateString()}</div>` : ''}
                                    </div>
                                    ${task.status !== 'Completed' ? `
                                        <button onclick="completeTask('${memberId}', '${task.id}')" class="btn" style="background: #4caf50;">
                                            ‚úì Complete
                                        </button>
                                    ` : `
                                        <div style="background: #4caf50; color: white; padding: 10px 15px; border-radius: 8px; font-weight: bold;">
                                            ‚úì Done
                                        </div>
                                    `}
                                </div>
                            </div>
                        `).join('') : '<p style="text-align: center; padding: 40px; color: #999;">No tasks yet</p>'}
                    </div>
                </div>
                
                <!-- AVAILABLE TASKS -->
                <div>
                    <h3>Available Tasks (${unclaimedTasks.length})</h3>
                    <div style="max-height: 300px; overflow-y: auto;">
                        ${unclaimedTasks.length > 0 ? unclaimedTasks.map(task => `
                            <div style="background: white; border: 2px solid #667eea; padding: 15px; border-radius: 10px; margin-bottom: 10px;">
                                <div style="display: flex; justify-content: space-between; align-items: start; margin-bottom: 10px;">
                                    <h4 style="margin: 0; color: #667eea;">${task.title}</h4>
                                    <span style="background: #667eea; color: white; padding: 5px 10px; border-radius: 8px; font-size: 0.85rem;">${task.category}</span>
                                </div>
                                <p style="margin: 0 0 10px 0; font-size: 0.9rem;">${task.description}</p>
                                <div style="display: flex; justify-content: space-between; align-items: center;">
                                    <div style="font-size: 0.9rem; color: #666;">
                                        <strong style="color: #ffd700;">Reward: ${task.reward} iKbp</strong>
                                    </div>
                                    <button onclick="claimTask('${memberId}', '${task.id}')" class="btn" style="background: #667eea;">
                                        ‚õèÔ∏è Claim & Start
                                    </button>
                                </div>
                            </div>
                        `).join('') : '<p style="text-align: center; padding: 40px; color: #999;">No available tasks. Check back later!</p>'}
                    </div>
                </div>
            </div>
        `;
        
        document.body.appendChild(modal);
    };
    
    // Claim task
    window.claimTask = function(memberId, taskId) {
        const allTasks = JSON.parse(localStorage.getItem('tauTasks') || '[]');
        const task = allTasks.find(t => t.id === taskId);
        
        if (!task) {
            showNotification('‚ùå Task not found', 'error');
            return;
        }
        
        const members = JSON.parse(localStorage.getItem('tauAfricaDB') || '[]');
        const memberIndex = members.findIndex(m => m.id === memberId);
        
        if (memberIndex === -1) return;
        
        if (!members[memberIndex].tasks) {
            members[memberIndex].tasks = [];
        }
        
        const claimedTask = {
            ...task,
            claimedAt: new Date().toISOString(),
            status: 'Assigned'
        };
        
        members[memberIndex].tasks.push(claimedTask);
        localStorage.setItem('tauAfricaDB', JSON.stringify(members));
        
        showNotification('‚úÖ Task claimed! Complete it to earn iKbp.', 'success');
        
        setTimeout(() => {
            showTasksMining(memberId);
        }, 1000);
    };
    
    // Complete task
    window.completeTask = function(memberId, taskId) {
        const confirmed = confirm('Mark this task as complete?');
        if (!confirmed) return;
        
        const members = JSON.parse(localStorage.getItem('tauAfricaDB') || '[]');
        const memberIndex = members.findIndex(m => m.id === memberId);
        
        if (memberIndex === -1) return;
        
        const taskIndex = members[memberIndex].tasks.findIndex(t => t.id === taskId);
        
        if (taskIndex === -1) return;
        
        // Update task status
        members[memberIndex].tasks[taskIndex].status = 'Completed';
        members[memberIndex].tasks[taskIndex].completedDate = new Date().toISOString();
        
        const reward = members[memberIndex].tasks[taskIndex].iKbpReward || 
                      members[memberIndex].tasks[taskIndex].reward || 
                      200;
        
        // Award iKbp
        members[memberIndex].iKbpBalance = (members[memberIndex].iKbpBalance || 0) + reward;
        
        localStorage.setItem('tauAfricaDB', JSON.stringify(members));
        
        // Create notification
        if (typeof createNotification === 'function') {
            createNotification(memberId, 'üéâ Task Completed!', `Earned ${reward} iKbp!`, 'success');
        }
        
        showNotification(`üéâ Task completed! Earned ${reward} iKbp!`, 'success');
        
        setTimeout(() => {
            showTasksMining(memberId);
        }, 1500);
    };
    
    // ============================================
    // VALUES MINING INTERFACE
    // ============================================
    window.showValuesMining = function(memberId) {
        const members = JSON.parse(localStorage.getItem('tauAfricaDB') || '[]');
        const member = members.find(m => m.id === memberId);
        
        if (!member) return;
        
        // Get all values
        const allValues = JSON.parse(localStorage.getItem('tauValues') || '[]');
        
        // My submitted values
        const mySubmittedValues = allValues.filter(v => v.submittedBy === memberId);
        
        // My claimed values
        const myClaimedValues = allValues.filter(v => v.claimedBy === memberId);
        
        // Available to claim (validated, not claimed)
        const availableValues = allValues.filter(v => 
            v.validated && 
            v.status === 'Approved' && 
            !v.claimedBy
        );
        
        closeAllModals();
        
        const modal = document.createElement('div');
        modal.className = 'modal';
        modal.style.display = 'block';
        modal.innerHTML = `
            <div class="modal-content" style="max-width: 1000px;">
                <span class="close" onclick="this.parentElement.parentElement.remove()">&times;</span>
                
                <div style="background: linear-gradient(45deg, #ffd700, #f39c12); padding: 25px; border-radius: 15px; margin-bottom: 20px;">
                    <h2 style="margin: 0; color: #333;">üíé VALUES MINING</h2>
                    <p style="margin: 10px 0 0 0; color: #333;">Submit values or claim existing values to earn iKb</p>
                </div>
                
                <!-- SUBMIT VALUE BUTTON -->
                <button onclick="openValueSubmissionModal()" class="btn" style="width: 100%; margin-bottom: 20px; background: #27ae60; font-size: 16px; padding: 15px;">
                    ‚ûï Submit New Value
                </button>
                
                <!-- MY SUBMITTED VALUES -->
                <div style="margin-bottom: 30px;">
                    <h3>My Submitted Values (${mySubmittedValues.length})</h3>
                    <div style="max-height: 250px; overflow-y: auto;">
                        ${mySubmittedValues.length > 0 ? mySubmittedValues.map(value => `
                            <div style="background: ${value.status === 'Approved' ? '#e8f5e9' : '#fff3cd'}; padding: 15px; border-radius: 10px; margin-bottom: 10px; border-left: 4px solid ${value.status === 'Approved' ? '#4caf50' : '#f39c12'};">
                                <h4 style="margin: 0 0 5px 0;">${value.title}</h4>
                                <p style="margin: 0 0 10px 0; font-size: 0.9rem;">${value.description.substring(0, 100)}...</p>
                                <div style="display: flex; justify-content: space-between; align-items: center;">
                                    <div style="font-size: 0.9rem; color: #666;">
                                        <strong>Worth:</strong> ${value.worthIkb} iKb (${value.worthKsh} KSH) ‚Ä¢ 
                                        <strong>Status:</strong> <span style="color: ${value.status === 'Approved' ? '#4caf50' : '#f39c12'}">${value.status}</span>
                                    </div>
                                    <span style="background: #667eea; color: white; padding: 5px 10px; border-radius: 8px; font-size: 0.85rem;">${value.validationCode}</span>
                                </div>
                            </div>
                        `).join('') : '<p style="text-align: center; padding: 40px; color: #999;">No submitted values yet</p>'}
                    </div>
                </div>
                
                <!-- MY CLAIMED VALUES -->
                <div style="margin-bottom: 30px;">
                    <h3>My Claimed Values (${myClaimedValues.length})</h3>
                    <div style="max-height: 200px; overflow-y: auto;">
                        ${myClaimedValues.length > 0 ? myClaimedValues.map(value => `
                            <div style="background: #e3f2fd; padding: 15px; border-radius: 10px; margin-bottom: 10px; border-left: 4px solid #2196f3;">
                                <h4 style="margin: 0 0 5px 0;">${value.title}</h4>
                                <div style="font-size: 0.9rem; color: #666;">
                                    <strong>Worth:</strong> ${value.worthIkb} iKb ‚Ä¢ 
                                    <strong>Claimed:</strong> ${new Date(value.claimedAt).toLocaleDateString()}
                                </div>
                            </div>
                        `).join('') : '<p style="text-align: center; padding: 40px; color: #999;">No claimed values yet</p>'}
                    </div>
                </div>
                
                <!-- AVAILABLE VALUES TO CLAIM -->
                <div>
                    <h3>Available Values (${availableValues.length})</h3>
                    <div style="max-height: 300px; overflow-y: auto;">
                        ${availableValues.length > 0 ? availableValues.map(value => `
                            <div style="background: white; border: 2px solid #ffd700; padding: 15px; border-radius: 10px; margin-bottom: 10px;">
                                <div style="display: flex; justify-content: space-between; align-items: start; margin-bottom: 10px;">
                                    <h4 style="margin: 0; color: #f39c12;">${value.title}</h4>
                                    <span style="background: #667eea; color: white; padding: 5px 10px; border-radius: 8px; font-size: 0.85rem;">${value.category}</span>
                                </div>
                                <p style="margin: 0 0 10px 0; font-size: 0.9rem;">${value.description.substring(0, 150)}...</p>
                                <div style="font-size: 0.85rem; color: #666; margin-bottom: 10px;">
                                    <strong>Provider:</strong> ${value.submittedByName} ‚Ä¢ 
                                    <strong>Location:</strong> ${value.location}
                                </div>
                                <div style="display: flex; justify-content: space-between; align-items: center;">
                                    <div style="font-size: 1.1rem;">
                                        <strong style="color: #f39c12;">${value.worthIkb} iKb</strong>
                                        <span style="font-size: 0.85rem; color: #666;">(${value.worthKsh} KSH)</span>
                                    </div>
                                    <button onclick="claimValue('${memberId}', '${value.id}')" class="btn" style="background: linear-gradient(45deg, #ffd700, #f39c12);">
                                        üíé Claim Value
                                    </button>
                                </div>
                            </div>
                        `).join('') : '<p style="text-align: center; padding: 40px; color: #999;">No available values. Check back later or submit your own!</p>'}
                    </div>
                </div>
            </div>
        `;
        
        document.body.appendChild(modal);
    };
    
    // Claim value
    window.claimValue = function(memberId, valueId) {
        const modal = document.createElement('div');
        modal.className = 'modal';
        modal.style.display = 'block';
        modal.innerHTML = `
            <div class="modal-content">
                <span class="close" onclick="this.parentElement.parentElement.remove()">&times;</span>
                <h2>üíé Claim Value</h2>
                
                <form onsubmit="submitValueClaim(event, '${memberId}', '${valueId}')">
                    <div class="form-group">
                        <label>How will you provide/exchange this value? *</label>
                        <textarea name="proposal" rows="4" required placeholder="Describe your plan to receive or provide this value..."></textarea>
                    </div>
                    
                    <button type="submit" class="btn" style="width: 100%;">Submit Claim</button>
                </form>
            </div>
        `;
        
        document.body.appendChild(modal);
    };
    
    // Submit value claim
    window.submitValueClaim = function(event, memberId, valueId) {
        event.preventDefault();
        
        const formData = new FormData(event.target);
        const proposal = formData.get('proposal');
        
        const allValues = JSON.parse(localStorage.getItem('tauValues') || '[]');
        const valueIndex = allValues.findIndex(v => v.id === valueId);
        
        if (valueIndex === -1) {
            showNotification('‚ùå Value not found', 'error');
            return;
        }
        
        // Update value
        allValues[valueIndex].claimedBy = memberId;
        allValues[valueIndex].claimedAt = new Date().toISOString();
        allValues[valueIndex].claimProposal = proposal;
        allValues[valueIndex].status = 'Claimed - Awaiting Delivery';
        
        localStorage.setItem('tauValues', JSON.stringify(allValues));
        
        showNotification('‚úÖ Value claim submitted! The provider will be notified.', 'success');
        
        closeAllModals();
        
        setTimeout(() => {
            showValuesMining(memberId);
        }, 1500);
    };
    
    console.log('‚úÖ Tasks & Values Mining loaded');
    
})();
    </script>
    <script>
// ============================================
// LOCKED VALIDATOR DASHBOARD
// Validator access with authentication & reports
// ============================================

(function() {
    'use strict';
    
    console.log('üîê Loading Validator Dashboard...');
    
    // Store validator session
    let validatorSession = null;
    
    // ============================================
    // VALIDATOR LOGIN
    // ============================================
    window.showValidatorInterface = function() {
        // Check if already logged in as validator
        const storedSession = sessionStorage.getItem('validatorSession');
        
        if (storedSession) {
            validatorSession = JSON.parse(storedSession);
            showValidatorDashboard(validatorSession);
            return;
        }
        
        // Show login modal
        const modal = document.createElement('div');
        modal.className = 'modal';
        modal.style.display = 'block';
        modal.innerHTML = `
            <div class="modal-content">
                <span class="close" onclick="this.parentElement.parentElement.remove()">&times;</span>
                
                <div style="background: linear-gradient(45deg, #9b59b6, #8e44ad); color: white; padding: 25px; border-radius: 15px; margin-bottom: 20px; text-align: center;">
                    <h2 style="margin: 0;">üîê Validator Access</h2>
                    <p style="margin: 10px 0 0 0;">Enter credentials to access validation system</p>
                </div>
                
                <form onsubmit="processValidatorLogin(event)">
                    <div class="form-group">
                        <label>Member ID or Email *</label>
                        <input type="text" name="identifier" required placeholder="Your member ID or email">
                    </div>
                    
                    <div class="form-group">
                        <label>Phone (Last 4 digits) *</label>
                        <input type="text" name="phone" required maxlength="4" pattern="[0-9]{4}" placeholder="Last 4 digits">
                    </div>
                    
                    <div style="background: #e3f2fd; padding: 15px; border-radius: 10px; margin: 20px 0;">
                        <strong>Validator Benefits:</strong>
                        <ul style="margin: 10px 0 0 20px; font-size: 0.9rem;">
                            <li>Validate values: Earn 5% per stage</li>
                            <li>Validate tasks/activities: Earn transaction fees</li>
                            <li>View validation history</li>
                            <li>Track earnings</li>
                        </ul>
                    </div>
                    
                    <button type="submit" class="btn" style="width: 100%; background: #9b59b6;">
                        üîì Login to Validate
                    </button>
                </form>
            </div>
        `;
        
        document.body.appendChild(modal);
    };
    
    // Process validator login
    window.processValidatorLogin = function(event) {
        event.preventDefault();
        
        const formData = new FormData(event.target);
        const identifier = formData.get('identifier').trim();
        const phoneLastFour = formData.get('phone').trim();
        
        // Authenticate using TauDB
        const result = window.TauDB?.authenticate(identifier, phoneLastFour);
        
        if (result && result.success) {
            validatorSession = {
                memberId: result.member.id,
                memberName: result.member.fullName,
                loginTime: new Date().toISOString()
            };
            
            sessionStorage.setItem('validatorSession', JSON.stringify(validatorSession));
            
            showNotification('‚úÖ Validator login successful!', 'success');
            
            setTimeout(() => {
                closeAllModals();
                showValidatorDashboard(validatorSession);
            }, 1000);
        } else {
            showNotification('‚ùå Invalid credentials', 'error');
        }
    };
    
    // ============================================
    // VALIDATOR DASHBOARD
    // ============================================
    function showValidatorDashboard(session) {
        const validatorId = session.memberId;
        
        // Get validation history
        const codes = JSON.parse(localStorage.getItem('tauValidatorCodes') || '[]');
        const myValidations = codes.filter(c => c.validatedBy === validatorId && c.status === 'used');
        
        // Calculate earnings
        let totalEarnings = 0;
        myValidations.forEach(validation => {
            const storageKey = validation.itemType === 'value' ? 'tauValues' : 'tauJobsPortal';
            const items = JSON.parse(localStorage.getItem(storageKey) || '[]');
            const item = items.find(i => i.id === validation.itemId);
            
            if (item) {
                const worthKsh = parseFloat(item.worthKsh || 0);
                const feeAmount = worthKsh * 0.30; // 30% total fee
                const stageEarnings = feeAmount * (0.05 / 0.30); // 5% per stage
                totalEarnings += stageEarnings;
            }
        });
        
        // Get pending validations
        const pendingCodes = codes.filter(c => c.status === 'pending');
        
        closeAllModals();
        
        const modal = document.createElement('div');
        modal.className = 'modal';
        modal.style.display = 'block';
        modal.innerHTML = `
            <div class="modal-content" style="max-width: 1200px;">
                <span class="close" onclick="sessionStorage.removeItem('validatorSession'); this.parentElement.parentElement.remove()">&times;</span>
                
                <!-- DASHBOARD HEADER -->
                <div style="background: linear-gradient(45deg, #9b59b6, #8e44ad); color: white; padding: 25px; border-radius: 15px; margin-bottom: 20px;">
                    <div style="display: flex; justify-content: space-between; align-items: center;">
                        <div>
                            <h1 style="margin: 0;">üîê Validator Dashboard</h1>
                            <p style="margin: 10px 0 0 0;">${session.memberName}</p>
                        </div>
                        <button onclick="sessionStorage.removeItem('validatorSession'); location.reload();" class="btn" style="background: rgba(255,255,255,0.2);">
                            üö™ Logout
                        </button>
                    </div>
                </div>
                
                <!-- STATS CARDS -->
                <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(200px, 1fr)); gap: 15px; margin-bottom: 30px;">
                    <div style="background: linear-gradient(45deg, #2ecc71, #27ae60); color: white; padding: 25px; border-radius: 15px; text-align: center;">
                        <h3 style="margin: 0 0 10px 0;">üí∞ Total Earnings</h3>
                        <h1 style="font-size: 2rem; margin: 0;">${(totalEarnings * 10).toFixed(2)} iKbp</h1>
                        <p style="margin: 10px 0 0 0;">${totalEarnings.toFixed(2)} KSH</p>
                    </div>
                    
                    <div style="background: linear-gradient(45deg, #3498db, #2980b9); color: white; padding: 25px; border-radius: 15px; text-align: center;">
                        <h3 style="margin: 0 0 10px 0;">‚úÖ Completed</h3>
                        <h1 style="font-size: 2rem; margin: 0;">${myValidations.length}</h1>
                        <p style="margin: 10px 0 0 0;">Validations</p>
                    </div>
                    
                    <div style="background: linear-gradient(45deg, #f39c12, #e67e22); color: white; padding: 25px; border-radius: 15px; text-align: center;">
                        <h3 style="margin: 0 0 10px 0;">‚è≥ Pending</h3>
                        <h1 style="font-size: 2rem; margin: 0;">${pendingCodes.length}</h1>
                        <p style="margin: 10px 0 0 0;">Available</p>
                    </div>
                </div>
                
                <!-- VALIDATE SECTION -->
                <div style="background: white; border: 3px solid #9b59b6; border-radius: 15px; padding: 25px; margin-bottom: 30px;">
                    <h3 style="color: #9b59b6; margin: 0 0 20px 0;">üîê Validate Item</h3>
                    
                    <form onsubmit="processValidatorCode(event, '${validatorId}')">
                        <div class="form-group">
                            <label>Validation Code *</label>
                            <input type="text" name="code" required placeholder="VAL1-XXXXX-XXXX" style="text-transform: uppercase; letter-spacing: 2px; font-size: 18px; text-align: center;">
                        </div>
                        
                        <div style="background: #f0f4ff; padding: 15px; border-radius: 10px; margin: 15px 0;">
                            <strong>Validation Stages:</strong>
                            <div style="display: grid; grid-template-columns: 1fr 1fr 1fr; gap: 10px; margin-top: 10px;">
                                <div style="background: #3498db; color: white; padding: 10px; border-radius: 8px; text-align: center;">
                                    <strong>Stage 1</strong>
                                    <div style="font-size: 0.85rem; margin-top: 5px;">Human Verify (5%)</div>
                                </div>
                                <div style="background: #f39c12; color: white; padding: 10px; border-radius: 8px; text-align: center;">
                                    <strong>Stage 2</strong>
                                    <div style="font-size: 0.85rem; margin-top: 5px;">Quality Check (5%)</div>
                                </div>
                                <div style="background: #2ecc71; color: white; padding: 10px; border-radius: 8px; text-align: center;">
                                    <strong>Stage 3</strong>
                                    <div style="font-size: 0.85rem; margin-top: 5px;">Chain Verify (5%)</div>
                                </div>
                            </div>
                        </div>
                        
                        <button type="submit" class="btn" style="width: 100%; background: #9b59b6; font-size: 16px; padding: 15px;">
                            ‚úÖ Validate & Earn
                        </button>
                    </form>
                </div>
                
                <!-- VALIDATION HISTORY -->
                <div>
                    <h3>üìä Validation History</h3>
                    <div style="max-height: 400px; overflow-y: auto;">
                        ${myValidations.length > 0 ? myValidations.map(validation => {
                            const storageKey = validation.itemType === 'value' ? 'tauValues' : 'tauJobsPortal';
                            const items = JSON.parse(localStorage.getItem(storageKey) || '[]');
                            const item = items.find(i => i.id === validation.itemId);
                            
                            if (!item) return '';
                            
                            const worthKsh = parseFloat(item.worthKsh || 0);
                            const feeAmount = worthKsh * 0.30;
                            const stageEarnings = feeAmount * (0.05 / 0.30);
                            
                            return `
                                <div style="background: #f8f9fa; padding: 15px; border-radius: 10px; margin-bottom: 10px; border-left: 4px solid ${validation.stage === 1 ? '#3498db' : validation.stage === 2 ? '#f39c12' : '#2ecc71'};">
                                    <div style="display: flex; justify-content: space-between; align-items: start;">
                                        <div style="flex: 1;">
                                            <h4 style="margin: 0 0 5px 0;">${item.title}</h4>
                                            <div style="font-size: 0.9rem; color: #666;">
                                                <strong>Code:</strong> ${validation.code} ‚Ä¢ 
                                                <strong>Stage:</strong> ${validation.stage} ‚Ä¢ 
                                                <strong>Type:</strong> ${validation.itemType}
                                            </div>
                                            <div style="font-size: 0.85rem; color: #999; margin-top: 5px;">
                                                Validated: ${new Date(validation.validatedAt).toLocaleString()}
                                            </div>
                                        </div>
                                        <div style="text-align: right;">
                                            <div style="font-size: 1.2rem; font-weight: bold; color: #2ecc71;">
                                                +${(stageEarnings * 10).toFixed(2)} iKbp
                                            </div>
                                            <div style="font-size: 0.85rem; color: #666;">
                                                ${stageEarnings.toFixed(2)} KSH
                                            </div>
                                        </div>
                                    </div>
                                </div>
                            `;
                        }).join('') : '<p style="text-align: center; padding: 40px; color: #999;">No validation history yet</p>'}
                    </div>
                </div>
            </div>
        `;
        
        document.body.appendChild(modal);
    }
    
    // Process validation code
    window.processValidatorCode = async function(event, validatorId) {
        event.preventDefault();
        
        const formData = new FormData(event.target);
        const code = formData.get('code').toUpperCase();
        
        showNotification('‚è≥ Processing validation...', 'info');
        
        if (typeof validateWithCode === 'function') {
            const result = await validateWithCode(code, validatorId);
            
            if (result.success) {
                showNotification(`üéâ Stage ${result.stage} validated! Earned ${result.earningsIkbp.toFixed(2)} iKbp!`, 'success');
                
                // Refresh dashboard
                setTimeout(() => {
                    const session = JSON.parse(sessionStorage.getItem('validatorSession'));
                    if (session) {
                        showValidatorDashboard(session);
                    }
                }, 2000);
            } else {
                showNotification(`‚ùå ${result.error}`, 'error');
            }
        } else {
            showNotification('‚ùå Validation system not loaded', 'error');
        }
    };
    
    console.log('‚úÖ Validator Dashboard loaded');
    
})();
    </script>
    <script>
// TAU AFRICA UI COMPONENTS - COMPLETE
// =====================================================

(function() {
    'use strict';

    // FORUM MODAL - COMPLETE
    window.createForumModal = function() {
        const currentMember = window.TauDB.getCurrentMember();
        
        if (!currentMember) {
            return `
                <div class="modal-content">
                    <span class="close" onclick="closeAllModals()">&times;</span>
                    <h2 style="color: #2a5298;">üí¨ Member Forum</h2>
                    <div style="background: #fff3cd; padding: 20px; border-radius: 10px; margin: 20px 0;">
                        <p><strong>‚ö†Ô∏è Login Required</strong></p>
                        <p>Please login to access forum.</p>
                    </div>
                    <button class="btn" onclick="closeAllModals(); showRealMemberLogin()">Login</button>
                </div>
            `;
        }

        const forumResult = window.TauDB.getForumPosts();
        const posts = forumResult.success ? forumResult.posts : [];

        return `
            <div class="modal-content" style="max-width: 900px;">
                <span class="close" onclick="closeAllModals()">&times;</span>
                
                <div style="background: linear-gradient(45deg, #667eea, #764ba2); color: white; padding: 25px; border-radius: 15px; margin-bottom: 20px;">
                    <h2 style="margin: 0;">üí¨ TAU Africa Forum</h2>
                    <p style="margin: 10px 0 0 0;">Welcome, ${currentMember.fullName}!</p>
                </div>

                <button class="btn" onclick="showCreatePostModal()" style="width: 100%; margin-bottom: 20px;">
                    ‚úçÔ∏è Create Post (Earn 50 iKbp)
                </button>

                <div style="display: flex; gap: 10px; margin-bottom: 20px; flex-wrap: wrap;">
                    <button class="btn btn-small" onclick="filterForumPosts('all')">All Posts</button>
                    <button class="btn btn-small" onclick="filterForumPosts('General')">General</button>
                    <button class="btn btn-small" onclick="filterForumPosts('Job Sharing')">Jobs</button>
                    <button class="btn btn-small" onclick="filterForumPosts('Training')">Training</button>
                </div>

                <div id="forumPostsList" style="max-height: 500px; overflow-y: auto;">
                    ${posts.length > 0 ? posts.map(post => `
                        <div style="background: white; border: 2px solid #eee; border-radius: 10px; padding: 20px; margin-bottom: 15px;">
                            <h3 style="margin: 0 0 10px 0; color: #2a5298;">${post.title}</h3>
                            <p style="margin: 0 0 10px 0; font-size: 0.9rem; color: #666;">
                                By <strong>${post.authorName}</strong> (${post.authorTeam}) ‚Ä¢ 
                                ${new Date(post.datePosted).toLocaleDateString()}
                            </p>
                            <span style="background: #667eea; color: white; padding: 5px 10px; border-radius: 5px; font-size: 0.8rem;">${post.category}</span>
                            <p style="margin: 15px 0;">${post.content}</p>
                            <div style="display: flex; gap: 15px; margin-top: 10px;">
                                <button class="btn btn-small" onclick="showComments('${post.id}')">üí¨ Comments (${post.comments ? post.comments.length : 0})</button>
                                <button class="btn btn-small" onclick="addCommentToPost('${post.id}')">Add Comment (+10 iKbp)</button>
                            </div>
                            <div id="comments-${post.id}" style="display: none; margin-top: 15px;">
                                ${post.comments && post.comments.length > 0 ? post.comments.map(c => `
                                    <div style="background: #f8f9fa; padding: 10px; border-radius: 8px; margin: 10px 0;">
                                        <p style="margin: 0; font-size: 0.85rem; color: #666;"><strong>${c.authorName}</strong></p>
                                        <p style="margin: 5px 0 0 0;">${c.content}</p>
                                    </div>
                                `).join('') : '<p>No comments yet.</p>'}
                            </div>
                        </div>
                    `).join('') : '<p style="text-align: center; padding: 40px;">No posts yet. Be the first!</p>'}
                </div>
            </div>
        `;
    };

    window.showCreatePostModal = function() {
        const modal = document.createElement('div');
        modal.className = 'modal';
        modal.style.display = 'block';
        modal.innerHTML = `
            <div class="modal-content">
                <span class="close" onclick="this.parentElement.parentElement.remove()">&times;</span>
                <h2>Create Forum Post</h2>
                
                <form onsubmit="submitForumPost(event)">
                    <div class="form-group">
                        <label>Title *</label>
                        <input type="text" name="title" required maxlength="100">
                    </div>
                    
                    <div class="form-group">
                        <label>Category *</label>
                        <select name="category" required>
                            <option value="">Select category</option>
                            <option value="General">General Discussion</option>
                            <option value="Job Sharing">Job Sharing</option>
                            <option value="Training">Training</option>
                            <option value="Business">Business</option>
                            <option value="Questions">Questions</option>
                        </select>
                    </div>
                    
                    <div class="form-group">
                    <label>Category *</label>
                    <select name="category" required>
                            <option value="">Select category</option>
                            <option value="General">General Discussion</option>
                            <option value="Job Sharing">Job Sharing</option>
                            <option value="Training">Training</option>
                            <option value="Business">Business</option>
                            <option value="Questions">Questions</option>
                        </select>
                    </div>
                    
                    <div class="form-group">
                        <label>Content *</label>
                        <textarea name="content" rows="6" required maxlength="2000"></textarea>
                    </div>
                    
                    <button type="submit" class="btn" style="width: 100%;">Post & Earn 50 iKbp</button>
                </form>
            </div>
        `;
        document.body.appendChild(modal);
    };

    window.submitForumPost = function(event) {
        event.preventDefault();
        const currentMember = window.TauDB.getCurrentMember();
        if (!currentMember) return;
        
        const formData = new FormData(event.target);
        const result = window.TauDB.createForumPost(currentMember.id, {
            title: formData.get('title'),
            category: formData.get('category'),
            content: formData.get('content')
        });
        
        if (result.success) {
            showNotification(`‚úÖ Post created! You earned ${result.earned} iKbp!`, 'success');
            closeAllModals();
            openModal('forum');
        }
    };

    window.filterForumPosts = function(category) {
        const filters = category === 'all' ? {} : { category: category };
        const result = window.TauDB.getForumPosts(filters);
        
        if (result.success) {
            const listContainer = document.getElementById('forumPostsList');
            if (listContainer) {
                listContainer.innerHTML = result.posts.length > 0 ? result.posts.map(post => `
                    <div style="background: white; border: 2px solid #eee; border-radius: 10px; padding: 20px; margin-bottom: 15px;">
                        <h3 style="margin: 0 0 10px 0;">${post.title}</h3>
                        <p style="margin: 0 0 10px 0; font-size: 0.9rem; color: #666;">
                            By <strong>${post.authorName}</strong> ‚Ä¢ ${new Date(post.datePosted).toLocaleDateString()}
                        </p>
                        <span style="background: #667eea; color: white; padding: 5px 10px; border-radius: 5px;">${post.category}</span>
                        <p style="margin: 15px 0;">${post.content}</p>
                    </div>
                `).join('') : '<p>No posts in this category.</p>';
            }
        }
    };

    window.showComments = function(postId) {
        const div = document.getElementById(`comments-${postId}`);
        if (div) div.style.display = div.style.display === 'none' ? 'block' : 'none';
    };

    window.addCommentToPost = function(postId) {
        const currentMember = window.TauDB.getCurrentMember();
        if (!currentMember) return;
        
        const comment = prompt('Enter your comment:');
        if (comment && comment.trim()) {
            const result = window.TauDB.addForumComment(postId, currentMember.id, comment.trim());
            if (result.success) {
                showNotification(`‚úÖ Comment added! Earned ${result.earned} iKbp!`, 'success');
                openModal('forum');
            }
        }
    };
</script>
    
<script>
    // ACTIVITIES MODAL - COMPLETE
    window.createActivitiesModal = function() {
        const currentMember = window.TauDB.getCurrentMember();
        
        if (!currentMember) {
            return `
                <div class="modal-content">
                    <span class="close" onclick="closeAllModals()">&times;</span>
                    <h2>üìö Activities</h2>
                    <p>Login required</p>
                    <button class="btn" onclick="closeAllModals(); showRealMemberLogin()">Login</button>
                </div>
            `;
        }

        return `
            <div class="modal-content" style="max-width: 800px;">
                <span class="close" onclick="closeAllModals()">&times;</span>
                
                <div style="background: linear-gradient(45deg, #ff6b6b, #4ecdc4); color: white; padding: 25px; border-radius: 15px; margin-bottom: 20px;">
                    <h2 style="margin: 0;">üìö Your Activities</h2>
                    <p style="margin: 10px 0 0 0;">Track contributions & earn iKbp!</p>
                </div>

                <button class="btn" onclick="showAddActivityModal()" style="width: 100%; margin-bottom: 20px;">
                    ‚ûï Add Activity (Earn 100 iKbp)
                </button>

                <div style="max-height: 400px; overflow-y: auto;">
                    ${currentMember.activities && currentMember.activities.length > 0 ? 
                        currentMember.activities.map(activity => `
                            <div style="background: white; border: 2px solid #eee; border-radius: 10px; padding: 20px; margin-bottom: 15px;">
                                <h3 style="margin: 0 0 10px 0;">${activity.title || activity.type}</h3>
                                <p style="margin: 0 0 10px 0;">${activity.description}</p>
                                <p style="margin: 0; font-size: 0.9rem; color: #666;">
                                    Added: ${new Date(activity.dateAdded).toLocaleDateString()} ‚Ä¢ 
                                    <strong style="color: #ffd700;">+${activity.iKbpReward} iKbp</strong>
                                </p>
                            </div>
                        `).join('')
                        : '<p style="text-align: center; padding: 40px;">No activities yet.</p>'
                    }
                </div>

                <div style="background: #f8f9fa; padding: 15px; border-radius: 10px; margin-top: 20px;">
                    <p><strong>Balance:</strong> ${currentMember.iKbpBalance} iKbp</p>
                </div>
            </div>
        `;
    };

    window.showAddActivityModal = function() {
        const modal = document.createElement('div');
        modal.className = 'modal';
        modal.style.display = 'block';
        modal.innerHTML = `
            <div class="modal-content">
                <span class="close" onclick="this.parentElement.parentElement.remove()">&times;</span>
                <h2>Add Activity</h2>
                
                <form onsubmit="submitActivity(event)">
                    <div class="form-group">
                        <label>Activity Type *</label>
                        <select name="type" required>
                            <option value="">Select type</option>
                            <option value="Training">Training/Workshop</option>
                            <option value="Community Service">Community Service</option>
                            <option value="Mentoring">Mentoring</option>
                            <option value="Skill Development">Skill Development</option>
                            <option value="Business">Business Activity</option>
                            <option value="Other">Other</option>
                        </select>
                    </div>
                    
                    <div class="form-group">
                        <label>Title *</label>
                        <input type="text" name="title" required>
                    </div>
                    
                    <div class="form-group">
                        <label>Description *</label>
                        <textarea name="description" rows="4" required></textarea>
                    </div>
                    
                    <button type="submit" class="btn" style="width: 100%;">Add & Earn 100 iKbp</button>
                </form>
            </div>
        `;
        document.body.appendChild(modal);
    };

    window.submitActivity = function(event) {
        event.preventDefault();
        const currentMember = window.TauDB.getCurrentMember();
        if (!currentMember) return;
        
        const formData = new FormData(event.target);
        const result = window.TauDB.addActivity(currentMember.id, {
            type: formData.get('type'),
            title: formData.get('title'),
            description: formData.get('description'),
            reward: 100
        });
        
        if (result.success) {
            showNotification(`‚úÖ Activity added! Earned ${result.earned} iKbp! Balance: ${result.newBalance} iKbp`, 'success');
            closeAllModals();
            setTimeout(() => openModal('activities'), 500);
        }
    };
</script>
    <script>
    // TASKS MODAL - COMPLETE
    window.createTasksModal = function() {
        const currentMember = window.TauDB.getCurrentMember();
        
        if (!currentMember) {
            return `
                <div class="modal-content">
                    <span class="close" onclick="closeAllModals()">&times;</span>
                    <h2>‚úÖ Tasks</h2>
                    <p>Login required</p>
                    <button class="btn" onclick="closeAllModals(); showRealMemberLogin()">Login</button>
                </div>
            `;
        }

        const activeTasks = currentMember.tasks ? currentMember.tasks.filter(t => t.status !== 'Completed') : [];
        const completedTasks = currentMember.tasks ? currentMember.tasks.filter(t => t.status === 'Completed') : [];

        return `
            <div class="modal-content" style="max-width: 900px;">
                <span class="close" onclick="closeAllModals()">&times;</span>
                
                <div style="background: linear-gradient(45deg, #667eea, #764ba2); color: white; padding: 25px; border-radius: 15px; margin-bottom: 20px;">
                    <h2 style="margin: 0;">‚úÖ Your Tasks</h2>
                </div>

                <h3 style="margin-bottom: 15px;">Active Tasks (${activeTasks.length})</h3>
                <div style="max-height: 300px; overflow-y: auto; margin-bottom: 30px;">
                    ${activeTasks.length > 0 ? 
                        activeTasks.map(task => `
                            <div style="background: white; border: 2px solid #4169e1; border-radius: 10px; padding: 20px; margin-bottom: 15px;">
                                <h3 style="margin: 0 0 10px 0;">${task.title}</h3>
                                <p style="margin: 0 0 10px 0;">${task.description}</p>
                                <p style="margin: 0 0 10px 0; font-size: 0.9rem; color: #666;">
                                    Category: ${task.category} ‚Ä¢ Reward: <strong style="color: #ffd700;">${task.iKbpReward} iKbp</strong>
                                </p>
                                <button class="btn btn-success" onclick="markTaskComplete('${task.id}')">‚úì Complete Task</button>
                            </div>
                        `).join('')
                        : '<p style="text-align: center; padding: 40px;">No active tasks.</p>'
                    }
                </div>

                <h3 style="margin-bottom: 15px;">Completed Tasks (${completedTasks.length})</h3>
                <div style="max-height: 200px; overflow-y: auto;">
                    ${completedTasks.length > 0 ? 
                        completedTasks.map(task => `
                            <div style="background: #f8f9fa; border: 2px solid #2ecc71; border-radius: 10px; padding: 15px; margin-bottom: 10px;">
                                <h4 style="margin: 0;">${task.title}</h4>
                                <p style="margin: 5px 0 0 0; font-size: 0.9rem; color: #666;">
                                    Completed: ${new Date(task.completedDate).toLocaleDateString()} ‚Ä¢ 
                                    <strong style="color: #2ecc71;">+${task.iKbpReward} iKbp</strong>
                                </p>
                            </div>
                        `).join('')
                        : '<p>No completed tasks yet.</p>'
                    }
                </div>
            </div>
        `;
    };

    window.markTaskComplete = function(taskId) {
        const currentMember = window.TauDB.getCurrentMember();
        if (!currentMember) return;
        
        const confirmed = confirm('Mark this task as complete?');
        if (!confirmed) return;
        
        const result = window.TauDB.completeTask(currentMember.id, taskId);
        
        if (result.success) {
            showNotification(`üéâ Task completed! Earned ${result.earned} iKbp! Balance: ${result.newBalance} iKbp`, 'success');
            closeAllModals();
            setTimeout(() => openModal('tasks'), 500);
        }
    };
</script>
    <script>
    // MEMBER LOGIN - COMPLETE
    window.showRealMemberLogin = function() {
        const modal = document.createElement('div');
        modal.className = 'modal';
        modal.style.display = 'block';
        modal.innerHTML = `
            <div class="modal-content">
                <span class="close" onclick="this.parentElement.parentElement.remove()">&times;</span>
                <h2 style="text-align: center;">üîê Member Login</h2>
                
                <form onsubmit="processRealLogin(event)" style="margin-top: 30px;">
                    <div class="form-group">
                        <label>Member ID or Email *</label>
                        <input type="text" id="loginIdentifier" required>
                    </div>
                    
                    <div class="form-group">
                        <label>Phone (Last 4 digits) *</label>
                        <input type="text" id="loginPhone" required maxlength="4" pattern="[0-9]{4}">
                    </div>
                    
                    <button type="submit" class="btn" style="width: 100%;">Login</button>
                </form>
                
                <div style="text-align: center; margin-top: 20px;">
                    <p>No account?</p>
                    <button class="btn btn-small" onclick="closeAllModals(); openModal('taskRegistration')">Join TASK</button>
                    <button class="btn btn-small" onclick="closeAllModals(); openModal('talkRegistration')">Join TALK</button>
                </div>
            </div>
        `;
        document.body.appendChild(modal);
    };

    window.processRealLogin = function(event) {
        event.preventDefault();
        
        const identifier = document.getElementById('loginIdentifier').value.trim();
        const phoneLastFour = document.getElementById('loginPhone').value.trim();
        
        const result = window.TauDB.authenticate(identifier, phoneLastFour);
        
        if (result.success) {
            showNotification('‚úÖ Login successful!', 'success');
            setTimeout(() => {
                closeAllModals();
                showRealMemberDashboard(result.member);
            }, 1000);
        } else {
            showNotification('‚ùå Invalid credentials', 'error');
        }
    };
    </script>
    <script>
    // MEMBER DASHBOARD - COMPLETE
    window.showRealMemberDashboard = function(member) {
        const modal = document.createElement('div');
        modal.className = 'modal';
        modal.style.display = 'block';
        
        const currentMember = window.TauDB.getCurrentMember() || member;
        const referralEarnings = window.TauDB.getReferralEarnings(currentMember.id);
        
        modal.innerHTML = `
            <div class="modal-content" style="max-width: 1200px;">
                <span class="close" onclick="window.TauDB.logout(); this.parentElement.parentElement.remove()">&times;</span>
                
                <div style="background: linear-gradient(45deg, #4169e1, #87ceeb); color: white; padding: 30px; border-radius: 15px; margin-bottom: 30px;">
                    <h1 style="margin: 0;">Welcome, ${currentMember.fullName}! üëã</h1>
                    <p style="margin: 10px 0 0 0;">Member ID: ${currentMember.id} ‚Ä¢ Team: ${currentMember.team}</p>
                </div>
                
                <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(250px, 1fr)); gap: 20px; margin-bottom: 30px;">
                    <div style="background: #ffd700; padding: 25px; border-radius: 15px; text-align: center;">
                        <h3>üí∞ Balance</h3>
                        <h1 style="font-size: 2.5rem;">${currentMember.iKbpBalance || 0}</h1>
                        <p>iKbp (${((currentMember.iKbpBalance || 0) / 10).toFixed(2)} KSH)</p>
                    </div>
                    
                    <div style="background: #667eea; color: white; padding: 25px; border-radius: 15px; text-align: center;">
                        <h3>‚úÖ Tasks</h3>
                        <h1 style="font-size: 2.5rem;">${currentMember.tasks ? currentMember.tasks.filter(t => t.status !== 'Completed').length : 0}</h1>
                        <button class="btn" onclick="closeAllModals(); openModal('tasks')" style="margin-top: 10px; width: 100%;">View</button>
                    </div>
                    
                    <div style="background: #ff6b6b; color: white; padding: 25px; border-radius: 15px; text-align: center;">
                        <h3>üìö Activities</h3>
                        <h1 style="font-size: 2.5rem;">${currentMember.activities ? currentMember.activities.length : 0}</h1>
                        <button class="btn" onclick="closeAllModals(); openModal('activities')" style="margin-top: 10px; width: 100%;">View</button>
                    </div>
                    
                    <div style="background: #2ecc71; color: white; padding: 25px; border-radius: 15px; text-align: center;">
                        <h3>üéÅ Referrals</h3>
                        <h1 style="font-size: 2.5rem;">${referralEarnings}</h1>
                        <p>iKbp Earned</p>
                    </div>
                </div>
                
                <div style="background: #667eea; color: white; padding: 25px; border-radius: 15px; margin-bottom: 20px;">
                    <h4>üéÅ Your Referral Code</h4>
                    <h1 style="letter-spacing: 3px;">${currentMember.referralCode}</h1>
                    <button class="btn" onclick="copyReferralLink('${currentMember.referralCode}')" style="background: white; color: #667eea; width: 100%;">Copy Link</button>
                </div>
                <div style="margin-top: 30px; padding: 20px; background: #f8f9fa; border-radius: 10px;">
    <h3>Quick Actions</h3>
    <button class="btn" onclick="openModal('forum')">üí¨ Forum</button>
    <button class="btn" onclick="openModal('activities')">üìö Activities</button>
    <button class="btn" onclick="openModal('tasks')">‚úÖ Tasks</button>
    
    // In showRealMemberDashboard() function, add this button:

<div style="margin-top: 30px; padding: 20px; background: linear-gradient(45deg, #FFD700, #FFA500); border-radius: 15px; text-align: center;">
    <h3 style="color: #333; margin-bottom: 15px;">üíé Kabiru Mining Transfer</h3>
    <div style="background: rgba(0,0,0,0.1); padding: 15px; border-radius: 10px; margin-bottom: 15px;">
        <div style="font-size: 24px; font-weight: bold; color: #333;">
            ${currentMember.iKbpBalance?.toLocaleString() || 0} iKbp
        </div>
        <div style="font-size: 18px; color: #333; margin-top: 5px;">
            ${(currentMember.iKbBalance || 0).toFixed(4)} iKb
        </div>
    </div>
    <button onclick="initiateKabiruWithdrawal()" class="btn" style="width: 100%; background: #333; color: #FFD700;">
        üí∏ Withdraw to Kabiru Mining
    </button>
    <p style="color: #333; font-size: 12px; margin-top: 10px;">
        Minimum: 10,000 iKbp or 0.0001 iKb
    </p>
</div>
    
    <button class="btn btn-success" onclick="window.open('https://magero1985.github.io/Kabiru-Mining-Portal-/', '_blank')">
        ‚ö° Mining
    </button>
</div>
                
                <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(200px, 1fr)); gap: 15px;">
                    <button class="btn" onclick="closeAllModals(); openModal('forum')">üí¨ Forum</button>
                    <button class="btn" onclick="closeAllModals(); openModal('activities')">üìö Activities</button>
                    <button class="btn" onclick="closeAllModals(); openModal('tasks')">‚úÖ Tasks</button>
                    <button class="btn" onclick="window.open('https://magero1985.github.io/Kabiru-Mining-Portal-/', '_blank')">‚ö° Mining</button>
                </div>
            </div>
        `;
        
        document.body.appendChild(modal);
    };

    // SUCCESS MODAL - COMPLETE
    window.showSuccessModal = function(member) {
        const modal = document.createElement('div');
        modal.className = 'modal';
        modal.style.display = 'block';
        modal.innerHTML = `
            <div class="modal-content">
                <h2 style="color: #2ecc71; text-align: center;">üéâ Registration Successful!</h2>
                
                <div style="background: #4169e1; color: white; padding: 30px; border-radius: 15px; margin: 20px 0; text-align: center;">
                    <h3>Your Member ID</h3>
                    <h1 style="font-size: 2.5rem; letter-spacing: 2px;">${member.id}</h1>
                </div>
                
                <div style="background: #ffd700; padding: 20px; border-radius: 10px; margin: 20px 0;">
                    <h4 style="color: #333;">üí∞ Referral Code</h4>
                    <h2 style="color: #333; letter-spacing: 3px;">${member.referralCode}</h2>
                    <button class="btn" onclick="copyReferralLink('${member.referralCode}')" style="width: 100%;">Copy Link</button>
                    <p style="color: #333; margin-top: 10px;">Earn 500 iKbp per referral!</p>
                </div>
                
                <button class="btn" onclick="proceedToLogin()" style="width: 100%;">Access Account</button>
                <button class="btn" onclick="closeAllModals()" style="width: 100%; margin-top: 10px; background: #95a5a6;">Close</button>
            </div>
        `;
        document.body.appendChild(modal);
    };

    window.proceedToLogin = function() {
        closeAllModals();
        showRealMemberLogin();
    };

    // COPY REFERRAL LINK - COMPLETE
    window.copyReferralLink = function(referralCode) {
        const link = `${window.location.origin}${window.location.pathname}?ref=${referralCode}`;
        
        if (navigator.clipboard) {
            navigator.clipboard.writeText(link).then(() => {
                showNotification('‚úÖ Referral link copied! Share to earn 500 iKbp!', 'success');
            }).catch(() => {
                prompt('Copy your referral link:', link);
            });
        } else {
            prompt('Copy your referral link:', link);
        }
    };

    // OVERRIDE EXISTING FUNCTIONS
    window.showMemberLogin = function() {
        showRealMemberLogin();
    };

    const originalGetModalContent = window.getModalContent;
    window.getModalContent = function(type) {
        switch(type) {
            case 'forum':
                return createForumModal();
            case 'activities':
                return createActivitiesModal();
            case 'tasks':
                return createTasksModal();
            default:
                return originalGetModalContent ? originalGetModalContent(type) : 
                    '<div class="modal-content"><span class="close" onclick="closeAllModals()">&times;</span><h2>Coming Soon</h2></div>';
        }
    };

    console.log('‚úÖ TAU UI COMPONENTS LOADED - COMPLETE');
})();
</script>
    <script>
// ============================================
// TAU AFRICA - WELCOME BONUS SOCKET
// ============================================
(function() {
    'use strict';
    
    function initWelcomeBonusSystem() {
        const DB_KEY = 'tauAfricaDB';
        const BONUS_KEY = 'tauWelcomeBonuses';
        const BONUS_AMOUNT = 500;
        
        function checkAndAwardBonuses() {
            try {
                const members = JSON.parse(localStorage.getItem(DB_KEY) || '[]');
                const bonusTracking = JSON.parse(localStorage.getItem(BONUS_KEY) || '{}');
                let newBonuses = 0;
                
                members.forEach(member => {
                    if (!bonusTracking[member.id]) {
                        // Award welcome bonus
                        member.iKbpBalance = (member.iKbpBalance || 0) + BONUS_AMOUNT;
                        
                        // Track bonus
                        bonusTracking[member.id] = {
                            awarded: true,
                            amount: BONUS_AMOUNT,
                            date: new Date().toISOString(),
                            memberId: member.id,
                            memberName: member.fullName
                        };
                        
                        newBonuses++;
                        console.log(`‚úÖ Welcome bonus awarded: ${member.fullName} (+${BONUS_AMOUNT} iKbp)`);
                    }
                });
                
                if (newBonuses > 0) {
                    localStorage.setItem(DB_KEY, JSON.stringify(members));
                    localStorage.setItem(BONUS_KEY, JSON.stringify(bonusTracking));
                    console.log(`üéÅ Total new bonuses awarded: ${newBonuses}`);
                }
            } catch (error) {
                console.error('Welcome bonus error:', error);
            }
        }
        
        // Check every 5 seconds for new registrations
        setInterval(checkAndAwardBonuses, 5000);
        checkAndAwardBonuses(); // Initial check
        
        console.log('‚úÖ Welcome Bonus System initialized');
    }
    
    // Auto-initialize when DOM loads
    if (document.readyState === 'loading') {
        document.addEventListener('DOMContentLoaded', initWelcomeBonusSystem);
    } else {
        initWelcomeBonusSystem();
    }
})();
</script>
<script>
// ============================================
// TAU AFRICA - NOTIFICATION SOCKET
// ============================================
(function() {
    'use strict';
    
    function initNotificationSystem() {
        const NOTIF_KEY = 'tauNotifications';
        
        window.openTauNotifications = function() {
            const panel = document.getElementById('tauNotificationPanel');
            panel.style.display = panel.style.display === 'none' ? 'block' : 'none';
            loadNotifications();
        };
        
        function loadNotifications() {
            const currentMember = window.TauDB?.getCurrentMember();
            if (!currentMember) {
                document.getElementById('tauNotificationList').innerHTML = 
                    '<p style="text-align: center; color: #666;">Please login to view notifications</p>';
                return;
            }
            
            const allNotifications = JSON.parse(localStorage.getItem(NOTIF_KEY) || '{}');
            const memberNotifs = allNotifications[currentMember.id] || [];
            const unreadCount = memberNotifs.filter(n => !n.read).length;
            
            // Update badge
            const badge = document.getElementById('tauNotifBadge');
            if (unreadCount > 0) {
                badge.style.display = 'block';
                badge.textContent = unreadCount;
            } else {
                badge.style.display = 'none';
            }
            
            // Render notifications
            const list = document.getElementById('tauNotificationList');
            if (memberNotifs.length === 0) {
                list.innerHTML = '<p style="text-align: center; color: #666; padding: 20px;">No notifications yet</p>';
                return;
            }
            
            list.innerHTML = memberNotifs.map(notif => `
                <div style="padding: 15px; border-bottom: 1px solid #eee; background: ${notif.read ? '#fff' : '#f0f4ff'}; border-left: 4px solid ${notif.read ? '#ddd' : '#667eea'};">
                    <strong>${notif.title}</strong>
                    <p style="margin: 5px 0; font-size: 14px; color: #666;">${notif.message}</p>
                    <small style="color: #999;">${new Date(notif.timestamp).toLocaleString()}</small>
                    ${!notif.read ? `<button onclick="markNotificationRead('${notif.id}')" style="margin-top: 8px; background: #667eea; color: white; border: none; padding: 5px 10px; border-radius: 5px; cursor: pointer; font-size: 12px;">Mark as read</button>` : ''}
                </div>
            `).join('');
        }
        
        window.markNotificationRead = function(notifId) {
            const currentMember = window.TauDB?.getCurrentMember();
            if (!currentMember) return;
            
            const allNotifications = JSON.parse(localStorage.getItem(NOTIF_KEY) || '{}');
            if (allNotifications[currentMember.id]) {
                const notif = allNotifications[currentMember.id].find(n => n.id === notifId);
                if (notif) notif.read = true;
                localStorage.setItem(NOTIF_KEY, JSON.stringify(allNotifications));
                loadNotifications();
            }
        };
        
        // Check for new notifications every 10 seconds
        setInterval(() => {
            const currentMember = window.TauDB?.getCurrentMember();
            if (currentMember) {
                const allNotifications = JSON.parse(localStorage.getItem(NOTIF_KEY) || '{}');
                const memberNotifs = allNotifications[currentMember.id] || [];
                const unreadCount = memberNotifs.filter(n => !n.read).length;
                
                const badge = document.getElementById('tauNotifBadge');
                if (unreadCount > 0) {
                    badge.style.display = 'block';
                    badge.textContent = unreadCount;
                } else {
                    badge.style.display = 'none';
                }
            }
        }, 10000);
        
        console.log('‚úÖ Notification System initialized');
    }
    
    if (document.readyState === 'loading') {
        document.addEventListener('DOMContentLoaded', initNotificationSystem);
    } else {
        initNotificationSystem();
    }
})();
</script>
    <script>
// ============================================
// TAU AFRICA - LIMITS ENFORCEMENT SOCKET
// ============================================
(function() {
    'use strict';
    
    const EARNING_LIMITS = {
        1: 2000,
        2: 5000,
        3: 11000,
        4: 23000
    };
    
    const WITHDRAWAL_LIMITS = {
        1: 10000,  // KSH 1,000
        2: 25000,  // KSH 2,500
        3: 35000,  // KSH 3,500
        4: 50000   // KSH 5,000
    };
    
    window.TauLimits = {
        checkEarningLimit: function(memberId, amount) {
            const members = JSON.parse(localStorage.getItem('tauAfricaDB') || '[]');
            const member = members.find(m => m.id === memberId);
            if (!member) return { allowed: false, reason: 'Member not found' };
            
            const level = member.level || 1;
            const today = new Date().toISOString().split('T')[0];
            const dailyEarnings = JSON.parse(localStorage.getItem('tauDailyEarnings') || '{}');
            
            if (!dailyEarnings[today]) dailyEarnings[today] = {};
            const todayEarned = dailyEarnings[today][memberId] || 0;
            
            const limit = EARNING_LIMITS[level];
            const remaining = limit - todayEarned;
            
            if (todayEarned + amount > limit) {
                return {
                    allowed: false,
                    reason: `Daily earning limit reached. Level ${level} max: ${limit} iKbp`,
                    earned: todayEarned,
                    limit: limit,
                    remaining: remaining
                };
            }
            
            // Update daily earnings
            dailyEarnings[today][memberId] = todayEarned + amount;
            localStorage.setItem('tauDailyEarnings', JSON.stringify(dailyEarnings));
            
            return {
                allowed: true,
                earned: todayEarned + amount,
                limit: limit,
                remaining: limit - (todayEarned + amount)
            };
        },
        
        checkWithdrawalLimit: function(memberId, amount) {
            const members = JSON.parse(localStorage.getItem('tauAfricaDB') || '[]');
            const member = members.find(m => m.id === memberId);
            if (!member) return { allowed: false, reason: 'Member not found' };
            
            const level = member.level || 1;
            const limit = WITHDRAWAL_LIMITS[level];
            
            if (amount > limit) {
                return {
                    allowed: false,
                    reason: `Exceeds daily withdrawal limit. Level ${level} max: ${limit} iKbp (KSH ${limit/10})`,
                    limit: limit,
                    limitKsh: limit / 10
                };
            }
            
            if (amount > (member.iKbpBalance || 0)) {
                return {
                    allowed: false,
                    reason: 'Insufficient balance',
                    balance: member.iKbpBalance || 0
                };
            }
            
            return { allowed: true, limit: limit, limitKsh: limit / 10 };
        },
        
        getLimits: function(level) {
            return {
                earningLimit: EARNING_LIMITS[level] || EARNING_LIMITS[1],
                withdrawalLimit: WITHDRAWAL_LIMITS[level] || WITHDRAWAL_LIMITS[1],
                withdrawalLimitKsh: (WITHDRAWAL_LIMITS[level] || WITHDRAWAL_LIMITS[1]) / 10
            };
        }
    };
    
    console.log('‚úÖ Limits Enforcement System initialized');
})();
    </script>
    <script>
        // ===== ADMIN DATABASE ACCESS WITH ROLE CHECKING =====
function openAdminDatabase() {
    const currentMember = window.TauDB?.getCurrentMember();
    
    // Define admin/validator roles
    const ADMIN_ROLES = ['admin', 'validator', 'moderator'];
    const ADMIN_IDS = ['TSK-000000-001', 'TLK-000000-001']; // Add your admin Member IDs
    const ADMIN_EMAILS = [
        'admin@tauafrica.org',
        'validator@tauafrica.org',
        'grouptauafrica@gmail.com'
    ];
    
    // Check if user has admin access
    const hasAccess = currentMember && (
        ADMIN_IDS.includes(currentMember.id) ||
        ADMIN_EMAILS.includes(currentMember.email) ||
        ADMIN_ROLES.includes(currentMember.role)
    );
    
    if (hasAccess) {
        // User has admin access - open database
        const dbWindow = window.open('databse.html', '_blank', 'width=1400,height=900');
        
        if (!dbWindow) {
            showNotification('‚ö†Ô∏è Please allow popups for this site', 'error');
            // Fallback: Open in same tab
            window.location.href = 'databse.html';
        } else {
            showNotification('‚úÖ Opening Admin Dashboard...', 'success');
        }
    } else {
        // User doesn't have access - show access request
        showAdminAccessRequest();
    }
}

function showAdminAccessRequest() {
    const modal = document.createElement('div');
    modal.className = 'modal';
    modal.style.display = 'block';
    modal.innerHTML = `
        

            √ó
            
üîê Admin Access Request

            
This area is restricted to admins and validators only.


            
            

                

                    Admin Access Code
                    
Enter admin code

                

                Verify & Access
            

            
            

                Need admin access?
                
Contact: grouptauafrica@gmail.com


            

        

    `;
    document.body.appendChild(modal);
}

function requestAdminAccess(event) {
    event.preventDefault();
    const code = document.getElementById('adminAccessCode').value;
    const correctCode = 'TAU2025ADMIN'; // Change this to your secret code
    
    if (code === correctCode) {
        closeAllModals();
        const dbWindow = window.open('databse.html', '_blank', 'width=1400,height=900');
        if (!dbWindow) {
            showNotification('‚ö†Ô∏è Please allow popups', 'error');
            window.location.href = 'databse.html';
        }
        showNotification('‚úÖ Access granted!', 'success');
    } else {
        showNotification('‚ùå Invalid access code', 'error');
    }
}
    // ===== ADMIN ACCESS WITH VERIFICATION =====
function openAdminDatabase() {
    // Check if user has admin privileges
    const currentMember = window.TauDB?.getCurrentMember();
    
    // Option 1: Check by specific Member IDs
    const adminIds = ['TSK-000000-001', 'TLK-000000-001']; // Add your admin IDs
    
    // Option 2: Check by email domain
    const adminEmails = ['admin@tauafrica.org', 'validator@tauafrica.org'];
    
    if (currentMember && 
        (adminIds.includes(currentMember.id) || 
         adminEmails.includes(currentMember.email) ||
         currentMember.role === 'admin' || 
         currentMember.role === 'validator')) {
        
        const dbWindow = window.open('databse.html', '_blank', 'width=1400,height=900');
        
        if (!dbWindow) {
            showNotification('‚ö†Ô∏è Please allow popups', 'error');
            window.location.href = 'databse.html';
        } else {
            showNotification('‚úÖ Opening Admin Dashboard...', 'success');
        }
    } else {
        // Show access request form
        showAdminAccessRequest();
    }
}
window.openAdminBridge = function() {
    const code = prompt('Enter Admin Access Code:');
    if (code === 'TAU2025ADMIN') {
        // FIXED: Corrected spelling from 'databse.html' to 'database.html'
        const bridgeWindow = window.open('database.html', 'tauBridge', 'width=1400,height=900');
        
        if (!bridgeWindow) {
            showNotification('‚ö†Ô∏è Please allow popups to open the admin page', 'error');
            window.location.href = 'database.html'; // Fallback to current tab
        }
    } else {
        showNotification('‚ùå Invalid Access Code', 'error');
    }
};
    // Check admin access
    const ADMIN_IDS = ['TSK-000000-001', 'TLK-000000-001'];
    const ADMIN_EMAILS = ['admin@tauafrica.org', 'grouptauafrica@gmail.com'];
    
    const hasAccess = currentMember && (
        ADMIN_IDS.includes(currentMember.id) ||
        ADMIN_EMAILS.includes(currentMember.email) ||
        currentMember.role === 'admin'
    );
    
    if (!hasAccess) {
        const code = prompt('Enter Admin Access Code:');
        if (code !== 'TAU2025ADMIN') {
            showNotification('‚ùå Invalid access code', 'error');
            return;
        }
    }
    
    // Open bridge in new window
    const bridgeWindow = window.open(
        'https://magero1985.github.io/Tau-Africa/bridge.html',
        'tauBridge',
        'width=1200,height=800'
    );
    
    if (!bridgeWindow) {
        showNotification('‚ö†Ô∏è Please allow popups', 'error');
        // Fallback: open in same tab
        window.location.href = 'https://magero1985.github.io/Tau-Africa/bridge.html';
    } else {
        showNotification('‚úÖ Opening Admin Bridge...', 'success');
    }
};
function showAdminAccessRequest() {
    const modal = document.createElement('div');
    modal.className = 'modal';
    modal.style.display = 'block';
    modal.innerHTML = `
        <div class="modal-content">
            <span class="close" onclick="this.parentElement.parentElement.remove()">√ó</span>
            <h2>üîê Admin Access Request</h2>
            <p>This area is restricted to admins and validators only.</p>
            
            <form onsubmit="requestAdminAccess(event)">
                <div class="form-group">
                    <label>Admin Access Code</label>
                    <input type="password" id="adminAccessCode" placeholder="Enter admin code" required>
                </div>
                <button type="submit" class="btn">Verify & Access</button>
            </form>
            
            <div style="margin-top: 20px; padding: 15px; background: #f8f9fa; border-radius: 10px;">
                <small>Don't have access? Contact: grouptauafrica@gmail.com</small>
            </div>
        </div>
    `;
    document.body.appendChild(modal);
}

function requestAdminAccess(event) {
    event.preventDefault();
    const code = document.getElementById('adminAccessCode').value;
    const correctCode = 'TAU2025ADMIN'; // Change this to your secret code
    
    if (code === correctCode) {
        closeAllModals();
        const dbWindow = window.open('databse.html', '_blank', 'width=1400,height=900');
        if (!dbWindow) window.location.href = 'databse.html';
        showNotification('‚úÖ Access granted!', 'success');
    } else {
        showNotification('‚ùå Invalid access code', 'error');
    }
}
    // ============================================
// PWA UPDATE SYSTEM
// ============================================

(function() {
    'use strict';
    
    const APP_VERSION = '1.0.0'; // INCREMENT THIS FOR UPDATES
    
    if ('serviceWorker' in navigator) {
        navigator.serviceWorker.register('/Tau-Africa/service-worker.js').then(registration => {
            console.log('‚úÖ PWA registered');
            
            // Check for updates
            registration.addEventListener('updatefound', () => {
                const newWorker = registration.installing;
                
                newWorker.addEventListener('statechange', () => {
                    if (newWorker.state === 'installed' && navigator.serviceWorker.controller) {
                        showUpdateNotification();
                    }
                });
            });
        });
        
        // Auto-check for updates every hour
        setInterval(() => {
            navigator.serviceWorker.getRegistration().then(registration => {
                if (registration) registration.update();
            });
        }, 3600000);
    }
    
    function showUpdateNotification() {
        const notification = document.createElement('div');
        notification.style.cssText = 'position: fixed; top: 20px; right: 20px; z-index: 10000; padding: 20px; border-radius: 10px; background: linear-gradient(45deg, #27ae60, #2ecc71); color: white; box-shadow: 0 10px 30px rgba(0,0,0,0.3); max-width: 350px;';
        notification.innerHTML = `
            <h3 style="margin: 0 0 10px 0;">üéâ Update Available!</h3>
            <p style="margin: 0 0 15px 0;">New features and improvements ready to install.</p>
            <button onclick="window.location.reload()" class="btn" style="width: 100%; background: white; color: #27ae60;">Update Now</button>
            <button onclick="this.parentElement.remove()" class="btn" style="width: 100%; margin-top: 10px; background: rgba(255,255,255,0.2);">Later</button>
        `;
        document.body.appendChild(notification);
    }
    
    localStorage.setItem('tauAppVersion', APP_VERSION);
    console.log('‚úÖ PWA Update System active (v' + APP_VERSION + ')');
})();
</script>
    <script>
// ============================================
// UNIVERSAL REAL-TIME SYNC SOCKET
// Add to: Main App, Database, and Bridge
// ============================================
(function() {
    'use strict';
    
    const SYNC_INTERVAL = 2000; // Check every 2 seconds
    const STORAGE_KEYS = {
        members: 'tauAfricaDB',
        tasks: 'tauTasks',
        activities: 'tauActivities',
        values: 'tauValues',
        validations: 'tauPendingValidations',
        notifications: 'tauNotifications',
        codes: 'tauValidatorCodes'
    };
    
    // Track last known state
    let lastState = {};
    
    function initSync() {
        // Initialize last state
        Object.keys(STORAGE_KEYS).forEach(key => {
            const data = localStorage.getItem(STORAGE_KEYS[key]) || '[]';
            lastState[key] = data;
        });
        
        console.log('‚úÖ Universal Sync Socket initialized');
    }
    
    function checkForChanges() {
        let hasChanges = false;
        
        Object.keys(STORAGE_KEYS).forEach(key => {
            const currentData = localStorage.getItem(STORAGE_KEYS[key]) || '[]';
            
            if (currentData !== lastState[key]) {
                hasChanges = true;
                lastState[key] = currentData;
                handleDataChange(key, JSON.parse(currentData));
            }
        });
        
        if (hasChanges) {
            triggerUIRefresh();
        }
    }
    
    function handleDataChange(key, data) {
        console.log(`üîÑ Data changed: ${key}`, data.length);
        
        // Trigger appropriate refresh based on key
        switch(key) {
            case 'members':
                if (typeof updateStats === 'function') updateStats();
                if (typeof renderMembers === 'function') renderMembers();
                break;
            case 'tasks':
                if (typeof loadTasks === 'function') loadTasks();
                if (typeof refreshPublicTasks === 'function') refreshPublicTasks();
                break;
            case 'activities':
                if (typeof loadActivities === 'function') loadActivities();
                if (typeof refreshPublicActivities === 'function') refreshPublicActivities();
                break;
            case 'values':
                if (typeof loadValues === 'function') loadValues();
                if (typeof refreshPublicValues === 'function') refreshPublicValues();
                break;
            case 'validations':
                if (typeof loadValidations === 'function') loadValidations();
                break;
            case 'notifications':
                if (typeof loadNotifications === 'function') loadNotifications();
                createNotificationPopup(data);
                break;
        }
    }
    
    function triggerUIRefresh() {
        // Update badge counts
        const currentMember = window.TauDB?.getCurrentMember();
        if (currentMember) {
            updateNotificationBadge();
            updateTaskBadge();
        }
        
        // Dispatch custom event for any listeners
        window.dispatchEvent(new CustomEvent('tauDataSync', {
            detail: { timestamp: Date.now() }
        }));
    }
    
    function updateNotificationBadge() {
        const currentMember = window.TauDB?.getCurrentMember();
        if (!currentMember) return;
        
        const notifs = JSON.parse(localStorage.getItem(STORAGE_KEYS.notifications) || '{}');
        const memberNotifs = notifs[currentMember.id] || [];
        const unread = memberNotifs.filter(n => !n.read).length;
        
        const badge = document.getElementById('tauNotifBadge');
        if (badge) {
            if (unread > 0) {
                badge.style.display = 'block';
                badge.textContent = unread;
            } else {
                badge.style.display = 'none';
            }
        }
    }
    
    function updateTaskBadge() {
        const tasks = JSON.parse(localStorage.getItem(STORAGE_KEYS.tasks) || '[]');
        const activities = JSON.parse(localStorage.getItem(STORAGE_KEYS.activities) || '[]');
        const values = JSON.parse(localStorage.getItem(STORAGE_KEYS.values) || '[]');
        
        const activeTasks = tasks.filter(t => t.validated).length;
        const activeActivities = activities.filter(a => a.validated).length;
        const activeValues = values.filter(v => v.validated && v.status === 'Approved').length;
        
        console.log(`üìä Active items - Tasks: ${activeTasks}, Activities: ${activeActivities}, Values: ${activeValues}`);
    }
    
    function createNotificationPopup(notifications) {
        const currentMember = window.TauDB?.getCurrentMember();
        if (!currentMember) return;
        
        const memberNotifs = notifications[currentMember.id] || [];
        const latest = memberNotifs.filter(n => !n.read).slice(0, 1)[0];
        
        if (latest && typeof showNotification === 'function') {
            showNotification(latest.title + ': ' + latest.message, 'info');
        }
    }
    
    // Start sync loop
    initSync();
    setInterval(checkForChanges, SYNC_INTERVAL);
    
    // Listen for storage events from other tabs/windows
    window.addEventListener('storage', function(e) {
        if (Object.values(STORAGE_KEYS).includes(e.key)) {
            console.log('üîÑ Storage event detected:', e.key);
            checkForChanges();
        }
    });
    
    console.log('üöÄ Real-time sync active');
})();
        </script>
    <script>
// ============================================
// NOTIFICATION GENERATOR
// ============================================
(function() {
    'use strict';
    
    window.createNotification = function(memberId, title, message, type = 'info') {
        const NOTIF_KEY = 'tauNotifications';
        const allNotifications = JSON.parse(localStorage.getItem(NOTIF_KEY) || '{}');
        
        if (!allNotifications[memberId]) {
            allNotifications[memberId] = [];
        }
        
        const notification = {
            id: `NOTIF-${Date.now()}`,
            title: title,
            message: message,
            timestamp: new Date().toISOString(),
            read: false,
            type: type
        };
        
        allNotifications[memberId].unshift(notification);
        
        // Keep only last 50 notifications
        if (allNotifications[memberId].length > 50) {
            allNotifications[memberId] = allNotifications[memberId].slice(0, 50);
        }
        
        localStorage.setItem(NOTIF_KEY, JSON.stringify(allNotifications));
        console.log(`üì¨ Notification created for ${memberId}:`, title);
    };
    
    window.notifyAllMembers = function(title, message) {
        const members = JSON.parse(localStorage.getItem('tauAfricaDB') || '[]');
        members.forEach(member => {
            createNotification(member.id, title, message, 'info');
        });
        console.log(`üì¢ Broadcast notification sent to ${members.length} members`);
    };
})()
// ============================================
// INTEGRATION TEST SUITE
// ============================================
window.runIntegrationTest = function() {
    console.log('üß™ Starting Integration Test...');
    
    const tests = {
        storage: false,
        sync: false,
        notifications: false,
        opportunities: false
    };
    
    // Test 1: Storage
    try {
        localStorage.setItem('test', 'ok');
        tests.storage = localStorage.getItem('test') === 'ok';
        localStorage.removeItem('test');
    } catch(e) {
        console.error('‚ùå Storage test failed:', e);
    }
    
    // Test 2: Sync Socket
    tests.sync = typeof checkForChanges === 'function';
    
    // Test 3: Notifications
    tests.notifications = typeof createNotification === 'function';
    
    // Test 4: Opportunities
    tests.opportunities = typeof refreshPublicOpportunities === 'function';
    
    // Display results
    console.log('üìä Test Results:');
    console.log('Storage:', tests.storage ? '‚úÖ' : '‚ùå');
    console.log('Sync:', tests.sync ? '‚úÖ' : '‚ùå');
    console.log('Notifications:', tests.notifications ? '‚úÖ' : '‚ùå');
    console.log('Opportunities:', tests.opportunities ? '‚úÖ' : '‚ùå');
    
    const allPassed = Object.values(tests).every(t => t);
    
    if (allPassed) {
        showNotification('‚úÖ All integration tests passed!', 'success');
    } else {
        showNotification('‚ö†Ô∏è Some tests failed - check console', 'error');
    }
    
    return tests;
};

// Add test button to header (for debugging)
console.log('üí° Run window.runIntegrationTest() to check integration');
    </script>
<script>
// ============================================
// FIXED FIREBASE SYNCHRONIZATION
// Replace the Firebase bridge section
// ============================================

(function() {
    'use strict';
    
    console.log('üî• TAU Firebase Sync - Starting...');
    
    // ============================================
    // FIREBASE CONFIGURATION
    // ============================================
      const FIREBASE_CONFIG = {
        apiKey: "AIzaSyBcTzvl5lwpojRQM5lwyWe3hwp4upogUWw",
        authDomain: "tau-main-app.firebaseapp.com",
        projectId: "tau-main-app",
        storageBucket: "tau-main-app.firebasestorage.app",
        messagingSenderId: "69734421488",
        appId: "1:69734421488:web:d13ae38f1c7d79cc854335"
    };
    
    let db, isOnline = false;
    
    // Initialize Firebase
    try {
        if (!firebase.apps.length) {
            firebase.initializeApp(FIREBASE_CONFIG);
        }
        db = firebase.firestore();
        
        // Enable offline persistence
        db.enablePersistence({ synchronizeTabs: true })
            .then(() => {
                console.log('‚úÖ Offline persistence enabled');
                isOnline = true;
            })
            .catch(err => {
                if (err.code === 'failed-precondition') {
                    console.warn('‚ö†Ô∏è Multiple tabs open, persistence disabled');
                } else if (err.code === 'unimplemented') {
                    console.warn('‚ö†Ô∏è Browser doesn\'t support persistence');
                }
                isOnline = true; // Still online, just no persistence
            });
        
        console.log('‚úÖ Firebase connected');
        
    } catch (error) {
        console.error('‚ùå Firebase init failed:', error);
        isOnline = false;
    }
    
    // ============================================
    // ENHANCED TauDB WITH FIREBASE SYNC
    // ============================================
    if (window.TauDB) {
        // Wrap original sync function
        const originalSync = window.TauDB.sync;
        window.TauDB.sync = async function(formData, team, referralCode) {
            // Call original function
            const result = originalSync.call(this, formData, team, referralCode);
            
            if (result.success && db && isOnline) {
                // Sync to Firestore
                try {
                    const memberDoc = {
                        ...result.member,
                        syncedAt: firebase.firestore.FieldValue.serverTimestamp(),
                        lastModified: firebase.firestore.FieldValue.serverTimestamp()
                    };
                    
                    await db.collection('members').doc(result.memberId).set(memberDoc, { merge: true });
                    console.log('‚òÅÔ∏è Member synced to Firestore:', result.memberId);
                    
                } catch (error) {
                    console.error('‚ö†Ô∏è Firestore sync warning:', error);
                    // Don't fail the registration, localStorage has the data
                }
            }
            
            return result;
        };
        
        // Wrap addActivity
        const originalAddActivity = window.TauDB.addActivity;
        window.TauDB.addActivity = async function(memberId, activity) {
            const result = originalAddActivity.call(this, memberId, activity);
            
            if (result.success && db && isOnline) {
                try {
                    await db.collection('members').doc(memberId).update({
                        activities: firebase.firestore.FieldValue.arrayUnion(result.activity),
                        iKbpBalance: firebase.firestore.FieldValue.increment(result.earned || 0),
                        lastModified: firebase.firestore.FieldValue.serverTimestamp()
                    });
                    console.log('‚òÅÔ∏è Activity synced to Firestore');
                } catch (error) {
                    console.error('‚ö†Ô∏è Activity sync warning:', error);
                }
            }
            
            return result;
        };
        
        // Wrap addTask
        const originalAddTask = window.TauDB.addTask;
        window.TauDB.addTask = async function(memberId, task) {
            const result = originalAddTask.call(this, memberId, task);
            
            if (result.success && db && isOnline) {
                try {
                    await db.collection('members').doc(memberId).update({
                        tasks: firebase.firestore.FieldValue.arrayUnion(result.task),
                        lastModified: firebase.firestore.FieldValue.serverTimestamp()
                    });
                    console.log('‚òÅÔ∏è Task synced to Firestore');
                } catch (error) {
                    console.error('‚ö†Ô∏è Task sync warning:', error);
                }
            }
            
            return result;
        };
        
        // Wrap completeTask
        const originalCompleteTask = window.TauDB.completeTask;
        window.TauDB.completeTask = async function(memberId, taskId) {
            const result = originalCompleteTask.call(this, memberId, taskId);
            
            if (result.success && db && isOnline) {
                try {
                    const memberRef = db.collection('members').doc(memberId);
                    const memberDoc = await memberRef.get();
                    
                    if (memberDoc.exists) {
                        const tasks = memberDoc.data().tasks || [];
                        const taskIndex = tasks.findIndex(t => t.id === taskId);
                        
                        if (taskIndex !== -1) {
                            tasks[taskIndex].status = 'Completed';
                            tasks[taskIndex].completedDate = new Date().toISOString();
                            
                            await memberRef.update({
                                tasks: tasks,
                                iKbpBalance: firebase.firestore.FieldValue.increment(result.earned || 0),
                                lastModified: firebase.firestore.FieldValue.serverTimestamp()
                            });
                            console.log('‚òÅÔ∏è Task completion synced to Firestore');
                        }
                    }
                } catch (error) {
                    console.error('‚ö†Ô∏è Task completion sync warning:', error);
                }
            }
            
            return result;
        };
    }
    
    // ============================================
    // REAL-TIME SYNC FROM FIRESTORE
    // ============================================
    function setupRealtimeListeners() {
        if (!db || !isOnline) return;
        
        // Listen to members collection
        db.collection('members').onSnapshot(snapshot => {
            snapshot.docChanges().forEach(change => {
                if (change.type === 'added' || change.type === 'modified') {
                    const memberData = change.doc.data();
                    updateLocalStorage('tauAfricaDB', memberData, memberData.id);
                    console.log('üîÑ Member updated from Firestore:', memberData.id);
                }
            });
        }, error => {
            console.error('Firestore listener error:', error);
        });
        
        console.log('üëÇ Real-time listeners active');
    }
    
    function updateLocalStorage(key, data, id) {
        try {
            const localData = JSON.parse(localStorage.getItem(key) || '[]');
            const index = localData.findIndex(item => item.id === id);
            
            if (index >= 0) {
                localData[index] = { ...localData[index], ...data };
            } else {
                localData.push(data);
            }
            
            localStorage.setItem(key, JSON.stringify(localData));
        } catch (error) {
            console.error('localStorage update error:', error);
        }
    }
    
    // ============================================
    // SYNC FROM FIRESTORE ON LOGIN
    // ============================================
    window.syncFromFirestore = async function(memberId) {
        if (!db || !isOnline || !memberId) return;
        
        try {
            const memberDoc = await db.collection('members').doc(memberId).get();
            
            if (memberDoc.exists) {
                const firestoreData = memberDoc.data();
                updateLocalStorage('tauAfricaDB', firestoreData, memberId);
                console.log('‚úÖ Synced member from Firestore:', memberId);
                
                // Update session
                if (sessionStorage.getItem('tauCurrentUser')) {
                    sessionStorage.setItem('tauCurrentUser', JSON.stringify(firestoreData));
                }
                
                return firestoreData;
            }
        } catch (error) {
            console.error('‚ö†Ô∏è Firestore sync error:', error);
        }
    };
    
    // Hook into authentication to sync on login
    if (window.TauDB && window.TauDB.authenticate) {
        const originalAuthenticate = window.TauDB.authenticate;
        window.TauDB.authenticate = async function(identifier, phoneLastFour) {
            const result = originalAuthenticate.call(this, identifier, phoneLastFour);
            
            if (result.success && result.member) {
                // Sync from Firestore after login
                const synced = await syncFromFirestore(result.member.id);
                if (synced) {
                    result.member = synced;
  }
</script>
  <script>
  // ============================================
    // 1. INITIATE KABIRU WITHDRAWAL (Missing Function)
    // ============================================
    window.initiateKabiruWithdrawal = async function() {
        const currentMember = window.TauDB?.getCurrentMember();
        
        if (!currentMember) {
            showNotification('‚ùå Please login first', 'error');
            showRealMemberLogin();
            return;
        }
        
        const availableIkbp = currentMember.iKbpBalance || 0;
        const availableIkb = currentMember.iKbBalance || 0;
        
        // Check minimum
        if (availableIkbp < 10000 && availableIkb < 0.0001) {
            showNotification('‚ùå Minimum required: 10,000 iKbp or 0.0001 iKb', 'error');
            return;
        }
        
        // Confirmation
        const confirmMsg = `Transfer to Kabiru Mining App?\n\n` +
                          `${availableIkbp.toLocaleString()} iKbp\n` +
                          `${availableIkb.toFixed(4)} iKb\n\n` +
                          `This will transfer ALL your balance to Kabiru Mining wallet.`;
        
        if (!confirm(confirmMsg)) return;
        
        try {
            const db = firebase.firestore();
            
            if (db) {
                // FIRESTORE METHOD (Online)
                console.log('‚òÅÔ∏è Creating Firestore transfer...');
                
                // Create pending transfer in member document
                await db.collection('members').doc(currentMember.id).update({
                    pendingKabiruTransfer: {
                        iKbp: availableIkbp,
                        iKb: availableIkb,
                        timestamp: firebase.firestore.FieldValue.serverTimestamp(),
                        status: 'pending'
                    },
                    iKbpBalance: 0,
                    iKbBalance: 0,
                    lastSync: firebase.firestore.FieldValue.serverTimestamp()
                });
                
                console.log('‚úÖ Firestore transfer created');
                
                // Update localStorage immediately
                const members = JSON.parse(localStorage.getItem('tauAfricaDB') || '[]');
                const memberIndex = members.findIndex(m => m.id === currentMember.id);
                
                if (memberIndex !== -1) {
                    members[memberIndex].pendingKabiruTransfer = {
                        iKbp: availableIkbp,
                        iKb: availableIkb,
                        timestamp: new Date().toISOString(),
                        status: 'pending'
                    };
                    members[memberIndex].iKbpBalance = 0;
                    members[memberIndex].iKbBalance = 0;
                    localStorage.setItem('tauAfricaDB', JSON.stringify(members));
                    
                    // Update session
                    sessionStorage.setItem('tauCurrentUser', JSON.stringify(members[memberIndex]));
                }
                
                // Create notification
   </script>
        
    <script>   
    (function() {
    'use strict';
    
    console.log('üåâ TAU-Kabiru Bridge - Initializing...');
    
    // ============================================
    // FIREBASE CONFIG (Same for both apps)
    // ============================================
      const FIREBASE_CONFIG = {
        apiKey: "AIzaSyBcTzvl5lwpojRQM5lwyWe3hwp4upogUWw",
        authDomain: "tau-main-app.firebaseapp.com",
        projectId: "tau-main-app",
        storageBucket: "tau-main-app.firebasestorage.app",
        messagingSenderId: "69734421488",
        appId: "1:69734421488:web:d13ae38f1c7d79cc854335"
    };
    let db, isKabiruApp = false;
    
    // Detect which app this is
    if (window.location.href.includes('Kabiru-Mining-Portal')) {
        isKabiruApp = true;
        console.log('üìç Detected: Kabiru Mining App');
    } else {
        console.log('üìç Detected: TAU Main App');
    }
    
    // Initialize Firebase
    try {
        if (!firebase.apps.length) {
            firebase.initializeApp(FIREBASE_CONFIG);
        }
        db = firebase.firestore();
        console.log('‚úÖ Firebase connected');
    } catch (error) {
        console.error('‚ùå Firebase init failed:', error);
        db = null;
    }
    
    // ============================================
    // MAIN APP SIDE: Enhanced Withdrawal
    // ============================================
    if (!isKabiruApp && db) {
        
        window.initiateKabiruWithdrawal = async function() {
            const currentMember = window.TauDB?.getCurrentMember();
            
            if (!currentMember) {
                if (typeof showNotification === 'function') {
                    showNotification('Please login first', 'error');
                }
                return;
            }
            
            const availableIkbp = currentMember.iKbpBalance || 0;
            const availableIkb = currentMember.iKbBalance || 0;
            
            // Minimum check
            if (availableIkbp < 10000 && availableIkb < 0.0001) {
                if (typeof showNotification === 'function') {
                    showNotification('‚ùå Minimum: 10,000 iKbp or 0.0001 iKb', 'error');
                }
                return;
            }
            
            const confirmMsg = `Transfer to Kabiru Mining App?\n\n` +
                              `${availableIkbp.toLocaleString()} iKbp\n` +
                              `${availableIkb.toFixed(6)} iKb\n\n` +
                              `This will zero your TAU balance and credit Kabiru.`;
            
            if (!confirm(confirmMsg)) return;
            
            try {
                // Create transfer record
                const transferId = 'XFER-' + Date.now();
                
                await db.collection('kabiru_transfers').add({
                    transferId: transferId,
                    memberId: currentMember.id,
                    memberName: currentMember.fullName,
                    memberEmail: currentMember.email,
                    iKbp: availableIkbp,
                    iKb: availableIkb,
                    timestamp: firebase.firestore.FieldValue.serverTimestamp(),
                    status: 'pending',
                    direction: 'tau_to_kabiru'
                });
                
                // Update member document
                await db.collection('members').doc(currentMember.id).update({
                    pendingKabiruTransfer: {
                        transferId: transferId,
                        iKbp: availableIkbp,
                        iKb: availableIkb,
                        timestamp: new Date().toISOString(),
                        status: 'pending'
                    },
                    lastTransferToKabiru: new Date().toISOString()
                });
                
                // Zero out TAU balances locally
                const members = JSON.parse(localStorage.getItem('tauAfricaDB') || '[]');
                const memberIndex = members.findIndex(m => m.id === currentMember.id);
                if (memberIndex !== -1) {
                    members[memberIndex].iKbpBalance = 0;
                    members[memberIndex].iKbBalance = 0;
                    members[memberIndex].pendingKabiruTransfer = {
                        transferId: transferId,
                        iKbp: availableIkbp,
                        iKb: availableIkb,
                        status: 'pending'
                    };
                    localStorage.setItem('tauAfricaDB', JSON.stringify(members));
                    
                    // Update session
                    sessionStorage.setItem('tauCurrentUser', JSON.stringify(members[memberIndex]));
                }
                
                if (typeof showNotification === 'function') {
                    showNotification('‚úÖ Transfer initiated! Open Kabiru Mining App to receive.', 'success');
                }
                
                // Show transfer ID
                alert(`Transfer ID: ${transferId}\n\nOpen Kabiru Mining App and login to receive your tokens.`);
                
                console.log('‚úÖ Transfer created:', transferId);
                
            } catch (error) {
                console.error('‚ùå Transfer failed:', error);
                if (typeof showNotification === 'function') {
                    showNotification('‚ùå Transfer failed: ' + error.message, 'error');
                }
            }
        };
        
        console.log('‚úÖ Main App: Withdrawal function enhanced');
    }
    
    // ============================================
    // KABIRU APP SIDE: Listen for Incoming Transfers
    // ============================================
    if (isKabiruApp && db) {
        
        console.log('üëÇ Kabiru App: Listening for transfers...');
        
        // Function to get current Kabiru user
        function getCurrentKabiruMember() {
            // Adjust this based on your Kabiru app's storage
            const kabiruUser = sessionStorage.getItem('kabiruCurrentUser') || 
                               sessionStorage.getItem('tauCurrentUser');
            
            if (kabiruUser) {
                return JSON.parse(kabiruUser);
            }
            
            // Try localStorage as fallback
            const allMembers = JSON.parse(localStorage.getItem('tauAfricaDB') || '[]');
            if (allMembers.length > 0) {
                // Return last logged in member (you may need to adjust this)
                return allMembers[0];
            }
            
            return null;
        }
        
        // Listen for transfers in real-time
        function startTransferListener() {
            const currentMember = getCurrentKabiruMember();
            
            if (!currentMember) {
                console.log('‚ö†Ô∏è No member logged in, waiting...');
                // Retry after 5 seconds
                setTimeout(startTransferListener, 5000);
                return;
            }
            
            console.log('üë§ Listening for transfers to:', currentMember.id);
            
            // Listen to kabiru_transfers collection
            db.collection('kabiru_transfers')
                .where('memberId', '==', currentMember.id)
                .where('status', '==', 'pending')
                .onSnapshot(snapshot => {
                    snapshot.docChanges().forEach(change => {
                        if (change.type === 'added') {
                            const transfer = change.doc.data();
                            processIncomingTransfer(transfer, change.doc.id);
                        }
                    });
                });
        }
        
        // Process incoming transfer
        async function processIncomingTransfer(transfer, docId) {
            console.log('üì• Incoming transfer detected:', transfer);
            
            try {
                // Get current Kabiru balances (adjust storage keys as needed)
                const kabiruData = JSON.parse(localStorage.getItem('kabiruMiningData') || 
                                             localStorage.getItem('tauAfricaDB') || '[]');
                
                const memberIndex = kabiruData.findIndex(m => m.id === transfer.memberId);
                
                if (memberIndex !== -1) {
                    // Credit the balances
                    kabiruData[memberIndex].iKbpBalance = 
                        (kabiruData[memberIndex].iKbpBalance || 0) + (transfer.iKbp || 0);
                    kabiruData[memberIndex].iKbBalance = 
                        (kabiruData[memberIndex].iKbBalance || 0) + (transfer.iKb || 0);
                    
                    // Save to localStorage
                    localStorage.setItem('kabiruMiningData', JSON.stringify(kabiruData));
                    
                    console.log('‚úÖ Balances credited:', {
                        iKbp: transfer.iKbp,
                        iKb: transfer.iKb
                    });
                } else {
                    // Create new member record in Kabiru
                    kabiruData.push({
                        id: transfer.memberId,
                        fullName: transfer.memberName,
                        email: transfer.memberEmail,
                        iKbpBalance: transfer.iKbp || 0,
                        iKbBalance: transfer.iKb || 0,
                        importedFromTAU: true,
                        importDate: new Date().toISOString()
                    });
                    
                    localStorage.setItem('kabiruMiningData', JSON.stringify(kabiruData));
                    console.log('‚úÖ New member created with balances');
                }
                
                // Mark transfer as completed
                await db.collection('kabiru_transfers').doc(docId).update({
                    status: 'completed',
                    completedAt: firebase.firestore.FieldValue.serverTimestamp()
                });
                
                // Update member document
                await db.collection('members').doc(transfer.memberId).update({
                    'pendingKabiruTransfer.status': 'completed',
                    lastKabiruSync: firebase.firestore.FieldValue.serverTimestamp()
                });
                
                // Show success notification
                if (typeof showNotification === 'function') {
                    showNotification(
                        `‚úÖ Received from TAU!\n${transfer.iKbp} iKbp + ${transfer.iKb} iKb`, 
                        'success'
                    );
                } else {
                    alert(`‚úÖ Transfer Complete!\n\nReceived:\n${transfer.iKbp} iKbp\n${transfer.iKb} iKb`);
                }
                
                // Trigger UI refresh if functions exist
                if (typeof updateMiningStats === 'function') updateMiningStats();
                if (typeof refreshBalance === 'function') refreshBalance();
                
            } catch (error) {
                console.error('‚ùå Transfer processing error:', error);
                
                // Mark transfer as failed
                await db.collection('kabiru_transfers').doc(docId).update({
                    status: 'failed',
                    error: error.message,
                    failedAt: firebase.firestore.FieldValue.serverTimestamp()
                });
            }
        }
        
        // Start listening after 2 seconds
        setTimeout(startTransferListener, 2000);
        
        console.log('‚úÖ Kabiru App: Transfer listener installed');
    }
    
    // ============================================
    // REVERSE SYNC: Kabiru ‚Üí TAU (Activities/Tasks)
    // ============================================
    if (isKabiruApp && db) {
        
        // When user completes activities/tasks in Kabiru and wants to send back to TAU
        window.sendToTAU = async function(iKbp, iKb, reason) {
            const currentMember = getCurrentKabiruMember();
            
            if (!currentMember) {
                alert('Please login first');
                return;
            }
            
            try {
                // Create reverse transfer
                const transferId = 'KXFER-' + Date.now();
                
                await db.collection('kabiru_transfers').add({
                    transferId: transferId,
                    memberId: currentMember.id,
                    memberName: currentMember.fullName,
                    iKbp: iKbp || 0,
                    iKb: iKb || 0,
                    reason: reason || 'Mining earnings',
                    timestamp: firebase.firestore.FieldValue.serverTimestamp(),
                    status: 'pending',
                    direction: 'kabiru_to_tau'
                });
                
                console.log('‚úÖ Reverse transfer created:', transferId);
                alert('‚úÖ Transfer to TAU initiated!');
                
            } catch (error) {
                console.error('‚ùå Reverse transfer failed:', error);
                alert('‚ùå Transfer failed: ' + error.message);
            }
        };
        
        console.log('‚úÖ Kabiru App: Reverse transfer function ready');
    }
    
    // ============================================
    // MAIN APP: Listen for Reverse Transfers
    // ============================================
    if (!isKabiruApp && db) {
        
        function listenForReverseTransfers() {
            const currentMember = window.TauDB?.getCurrentMember();
            
            if (!currentMember) {
                setTimeout(listenForReverseTransfers, 5000);

    return;
            }
            
            db.collection('kabiru_transfers')
                .where('memberId', '==', currentMember.id)
                .where('direction', '==', 'kabiru_to_tau')
                .where('status', '==', 'pending')
                .onSnapshot(snapshot => {
                    snapshot.docChanges().forEach(async change => {
                        if (change.type === 'added') {
                            const transfer = change.doc.data();
                            
                            // Credit TAU balance
                            if (window.TauDB?.updateBalance) {
                                window.TauDB.updateBalance(currentMember.id, transfer.iKbp || 0);
                            }
                            
                            // Mark as completed
                            await db.collection('kabiru_transfers').doc(change.doc.id).update({
                                status: 'completed',
                                completedAt: firebase.firestore.FieldValue.serverTimestamp()
                            });
                            
                            if (typeof showNotification === 'function') {
                                showNotification(`‚úÖ Received from Kabiru: ${transfer.iKbp} iKbp`, 'success');
                            }
                        }
                    });
                });
        }
        
        setTimeout(listenForReverseTransfers, 3000);
        console.log('‚úÖ Main App: Reverse transfer listener ready');
    }
    
    // ============================================
    // EXPOSE GLOBAL API
    // ============================================
    window.TauKabiruBridge = {
        isKabiruApp: isKabiruApp,
        transferToKabiru: !isKabiruApp ? window.initiateKabiruWithdrawal : null,
        transferToTAU: isKabiruApp ? window.sendToTAU : null,
        checkPendingTransfers: async function(memberId) {
            if (!db) return [];
            const snapshot = await db.collection('kabiru_transfers')
                .where('memberId', '==', memberId)
                .where('status', '==', 'pending')
                .get();
            return snapshot.docs.map(doc => ({id: doc.id, ...doc.data()}));
        }
    };
    
    console.log('‚úÖ TAU-Kabiru Bridge loaded successfully');
    console.log(`üìç App Mode: ${isKabiruApp ? 'Kabiru Mining' : 'TAU Main'}`);
    
})();
</sctpt>
    
   <script>       
    // ============================================
    // 2. ADD TRANSFER BUTTON TO DASHBOARD (Missing UI)
    // ============================================
    
    // Override showRealMemberDashboard to include transfer button
    const originalShowDashboard = window.showRealMemberDashboard;
    
    window.showRealMemberDashboard = function(member) {
        // Call original function first
        if (originalShowDashboard) {
            originalShowDashboard(member);
        }
        
        // Then add transfer section
        setTimeout(() => {
            const modal = document.querySelector('.modal.active, .modal[style*="display: block"]');
            if (!modal) return;
            
            const modalContent = modal.querySelector('.modal-content');
            if (!modalContent) return;
            
            // Check if transfer section already exists
            if (modalContent.querySelector('#kabiruTransferSection')) return;
            
            const currentMember = window.TauDB?.getCurrentMember() || member;
            
            // Create transfer section
            const transferSection = document.createElement('div');
            transferSection.id = 'kabiruTransferSection';
            transferSection.innerHTML = `
                <div style="margin-top: 30px; padding: 20px; background: linear-gradient(45deg, #FFD700, #FFA500); border-radius: 15px; text-align: center;">
                    <h3 style="color: #333; margin-bottom: 15px;">üíé Kabiru Mining Transfer</h3>
                    <div style="background: rgba(0,0,0,0.1); padding: 15px; border-radius: 10px; margin-bottom: 15px;">
                        <div style="font-size: 24px; font-weight: bold; color: #333;">
                            ${(currentMember.iKbpBalance || 0).toLocaleString()} iKbp
                        </div>
                        <div style="font-size: 18px; color: #333; margin-top: 5px;">
                            ${(currentMember.iKbBalance || 0).toFixed(4)} iKb
                        </div>
                    </div>
                    <button onclick="initiateKabiruWithdrawal()" class="btn" style="width: 100%; background: #333; color: #FFD700; font-size: 16px; padding: 15px;">
                        üí∏ Withdraw to Kabiru Mining
                    </button>
                    <p style="color: #333; font-size: 12px; margin-top: 10px;">
                        Minimum: 10,000 iKbp or 0.0001 iKb
                    </p>
                </div>
            `;
            
            // Insert before logout/close buttons
            const lastDiv = modalContent.querySelector('div[style*="grid-template-columns"]');
            if (lastDiv) {
                lastDiv.parentNode.insertBefore(transferSection, lastDiv);
            } else {
                modalContent.appendChild(transferSection);
            }
            
            console.log('‚úÖ Transfer button added to dashboard');
            
        }, 500);
    };
    
    // ============================================
    // 3. AUTO-SYNC COMPLETED TRANSFERS (Listener)
    // ============================================
    function setupTransferCompletionListener() {
        const db = firebase.firestore();
        if (!db) return;
        
        const currentMember = window.TauDB?.getCurrentMember();
        if (!currentMember) return;
        
        console.log('üëÇ Listening for transfer completions...');
        
        // Listen for when Kabiru Mining marks transfer as completed
        db.collection('members').doc(currentMember.id)
            .onSnapshot(doc => {
                if (!doc.exists) return;
                
                const data = doc.data();
                
                if (data.pendingKabiruTransfer && 
                    data.pendingKabiruTransfer.status === 'completed') {
                    
                    console.log('‚úÖ Transfer completed by Kabiru Mining!');
                    
                    // Update localStorage to remove pending transfer
                    const members = JSON.parse(localStorage.getItem('tauAfricaDB') || '[]');
                    const memberIndex = members.findIndex(m => m.id === currentMember.id);
                    
                    if (memberIndex !== -1) {
                        members[memberIndex].pendingKabiruTransfer = null;
                        localStorage.setItem('tauAfricaDB', JSON.stringify(members));
                    }
                    
                    // Notify user
                    if (typeof createNotification === 'function') {
                        createNotification(
                            currentMember.id,
                            '‚úÖ Transfer Complete!',
                            'Your tokens have been received in Kabiru Mining App',
                            'success'
                        );
                    }
                    
                    showNotification('‚úÖ Transfer received in Kabiru Mining!', 'success');
                }
            }, error => {
                console.error('Transfer listener error:', error);
            });
    }
    
    // ============================================
    // 4. AUTO-START LISTENER ON LOGIN
    // ============================================
    
    // Hook into authentication
    const originalAuth = window.TauDB?.authenticate;
    if (originalAuth) {
        window.TauDB.authenticate = function(identifier, phoneLastFour) {
            const result = originalAuth.call(this, identifier, phoneLastFour);
            
            if (result.success) {
                // Start transfer completion listener
                setTimeout(() => {
                    setupTransferCompletionListener();
                }, 1000);
            }
            
            return result;
        };
    }
    
    // ============================================
    // 5. CHECK FOR PENDING TRANSFERS ON PAGE LOAD
    // ============================================
    function checkPendingTransfers() {
        const currentMember = window.TauDB?.getCurrentMember();
        if (!currentMember) return;
        
        if (currentMember.pendingKabiruTransfer && 
            currentMember.pendingKabiruTransfer.status === 'pending') {
            
            console.log('‚è≥ Pending transfer detected:', currentMember.pendingKabiruTransfer);
            
            showNotification(
                '‚è≥ Transfer pending: Open Kabiru Mining App to complete',
                'info'
            );
        }
    }
    
    // Check on load
    setTimeout(checkPendingTransfers, 2000);
    
    console.log('‚úÖ Kabiru Transfer System LOADED');
    console.log('üí° Users can now transfer TAU ‚Üí Kabiru Mining');
    
})();
</script>

 <style>
    //============================================//
    //   VISUAL INDICATOR FOR PENDING TRANSFERS   //
    // ============================================//

/* Add pulsing indicator for pending transfers */
@keyframes transferPulse {
    0%, 100% { 
        box-shadow: 0 0 0 0 rgba(255, 215, 0, 0.7);
    }
    50% { 
        box-shadow: 0 0 0 10px rgba(255, 215, 0, 0);
    }
}

.pending-transfer-indicator {
    animation: transferPulse 2s infinite;
}
</style>
   <script>
// 1. CHECK STORAGE INTEGRITY
// ============================================
     function checkStorage() {
        const requiredKeys = [
            'tauAfricaDB',
            'tauTasks',
            'tauActivities',
            'tauValues',
            'tauPendingValidations',
            'tauNotifications',
            'tauValidatorCodes'
        ];
        
        const issues = [];
        
        requiredKeys.forEach(key => {
            try {
                const data = localStorage.getItem(key);
                if (!data) {
                    localStorage.setItem(key, '[]');
                    console.log(`‚úÖ Created missing storage: ${key}`);
                }
                
                // Validate JSON
                JSON.parse(data || '[]');
                
            } catch (error) {
                issues.push(`‚ùå Storage error (${key}): ${error.message}`);
                localStorage.setItem(key, '[]'); // Reset if corrupted
            }
        });
        
        return {
            passed: issues.length === 0,
            issues: issues
        };
    }
    
    // ============================================
    // 2. CHECK CROSS-APP DATA FLOW
    // ============================================
    function checkDataFlow() {
        const tasks = JSON.parse(localStorage.getItem('tauTasks') || '[]');
        const activities = JSON.parse(localStorage.getItem('tauActivities') || '[]');
        const members = JSON.parse(localStorage.getItem('tauAfricaDB') || '[]');
        
        const report = {
            members: members.length,
            tasks: tasks.length,
            activities: activities.length,
            validatedTasks: tasks.filter(t => t.validated).length,
            validatedActivities: activities.filter(a => a.validated).length
        };
        
        console.log('üìä Data Flow Status:', report);
        return report;
    }
    
    // ============================================
    // 3. CHECK FUNCTION AVAILABILITY
    // ============================================
    function checkFunctions() {
        const requiredFunctions = [
            'TauDB.sync',
            'TauDB.authenticate',
            'TauDB.addActivity',
            'TauDB.addTask',
            'createNotification',
            'showNotification',
            'refreshPublicOpportunities'
        ];
        
        const issues = [];
        
        requiredFunctions.forEach(funcPath => {
            const parts = funcPath.split('.');
            let obj = window;
            
            for (let part of parts) {
                if (!obj || typeof obj[part] === 'undefined') {
                    issues.push(`‚ùå Missing: ${funcPath}`);
                    return;
                }
                obj = obj[part];
            }
            
            console.log(`‚úÖ Available: ${funcPath}`);
        });
        
        return {
            passed: issues.length === 0,
            issues: issues
        };
    }
    
    // ============================================
    // 4. CHECK FIREBASE CONNECTION
    // ============================================
    function checkFirebase() {
        if (typeof firebase === 'undefined') {
            return {
                passed: false,
                message: '‚ùå Firebase library not loaded'
            };
        }
        
        if (!firebase.apps.length) {
            return {
                passed: false,
                message: '‚ùå Firebase not initialized'
            };
        }
        
        return {
            passed: true,
            message: '‚úÖ Firebase connected'
        };
    }
    
    // ============================================
    // 5. CHECK KABIRU INTEGRATION
    // ============================================
    function checkKabiruIntegration() {
        const issues = [];
        
        // Check if withdrawal function exists
        if (typeof initiateKabiruWithdrawal !== 'function') {
            issues.push('‚ùå Missing: initiateKabiruWithdrawal()');
        } else {
            console.log('‚úÖ Kabiru withdrawal function available');
        }
        
        // Check if mining link is intact
        const kabiruLinks = document.querySelectorAll('a[href*="Kabiru-Mining-Portal"]');
        if (kabiruLinks.length === 0) {
            issues.push('‚ö†Ô∏è Warning: No Kabiru Mining links found');
        } else {
            console.log(`‚úÖ Found ${kabiruLinks.length} Kabiru Mining link(s)`);
        }
        
        return {
            passed: issues.length === 0,
            issues: issues
        };
    }
    
    // ============================================
    // 6. FIX DUPLICATE FIREBASE BRIDGES
    // ============================================
    function fixDuplicateBridges() {
        // Prevent multiple Firebase initializations
        if (window.tauFirebaseBridgeInitialized) {
            console.log('‚ö†Ô∏è Firebase bridge already initialized, skipping...');
            return;
        }
        
        window.tauFirebaseBridgeInitialized = true;
        console.log('‚úÖ Firebase bridge initialization flag set');
    }
    
    // ============================================
    // 7. COMPREHENSIVE HEALTH CHECK
    // ============================================
    function runHealthCheck() {
        console.log('\n' + '='.repeat(60));
        console.log('üè• TAU AFRICA INTEGRATION HEALTH CHECK');
        console.log('='.repeat(60) + '\n');
        
        const results = {
            storage: checkStorage(),
            dataFlow: checkDataFlow(),
            functions: checkFunctions(),
            firebase: checkFirebase(),
            kabiru: checkKabiruIntegration()
        };
        
        console.log('\nüìã SUMMARY:');
        console.log('‚îÄ'.repeat(60));
        
        let allPassed = true;
        
        if (results.storage.passed) {
            console.log('‚úÖ Storage: HEALTHY');
        } else {
            console.log('‚ùå Storage: ISSUES FOUND');
            results.storage.issues.forEach(issue => console.log('  ' + issue));
            allPassed = false;
        }
        
        console.log(`‚úÖ Data Flow: ${results.dataFlow.members} members, ${results.dataFlow.tasks} tasks, ${results.dataFlow.activities} activities`);
        
        if (results.functions.passed) {
            console.log('‚úÖ Core Functions: ALL AVAILABLE');
        } else {
            console.log('‚ùå Core Functions: ISSUES FOUND');
            results.functions.issues.forEach(issue => console.log('  ' + issue));
            allPassed = false;
        }
        
        console.log(results.firebase.message);
        
        if (results.kabiru.passed) {
            console.log('‚úÖ Kabiru Integration: INTACT');
        } else {
            console.log('‚ö†Ô∏è Kabiru Integration: WARNINGS');
            results.kabiru.issues.forEach(issue => console.log('  ' + issue));
        }
        
        console.log('\n' + '='.repeat(60));
        
        if (allPassed) {
            console.log('üéâ ALL SYSTEMS OPERATIONAL');
            if (typeof showNotification === 'function') {
                showNotification('‚úÖ Integration Health Check: PASSED', 'success');
            }
        } else {
            console.log('‚ö†Ô∏è SOME ISSUES DETECTED (see details above)');
            if (typeof showNotification === 'function') {
                showNotification('‚ö†Ô∏è Integration check found issues - check console', 'info');
            }
        }
        
        console.log('='.repeat(60) + '\n');
        
        return results;
    }
   // ============================================
    // 8. AUTO-FIX COMMON ISSUES
    // ============================================
    function autoFix() {
        console.log('üîß Auto-fixing common issues...');
        
        fixDuplicateBridges();
        checkStorage(); // Creates missing storage
        
        // Ensure notification system exists
        if (!document.getElementById('notification')) {
            const notif = document.createElement('div');
            notif.id = 'notification';
            notif.className = 'notification';
            document.body.appendChild(notif);
            console.log('‚úÖ Created notification element');
        }
        
        console.log('‚úÖ Auto-fix complete');
    }
    
    // ============================================
    // 9. EXPOSE GLOBAL API
    // ============================================
    window.TauIntegration = {
        healthCheck: runHealthCheck,
        checkStorage: checkStorage,
        checkDataFlow: checkDataFlow,
        checkFunctions: checkFunctions,
        checkFirebase: checkFirebase,
        checkKabiru: checkKabiruIntegration,
        autoFix: autoFix
    };
    
    // ============================================
    // 10. RUN ON LOAD
    // ============================================
    autoFix();
    
    setTimeout(() => {
        runHealthCheck();
    }, 2000);
    
    console.log('‚úÖ TAU Integration Health Check loaded');
    console.log('üí° Run window.TauIntegration.healthCheck() anytime to check status');
    
})();
   </script>
    <script>
<script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-app-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-firestore-compat.js"></script>

    </script>
<script>
(function() {
    'use strict';
    
    console.log('üîß TAU Firebase Sync Fix - Starting...');
    
    // ============================================
    // 1. PREVENT DUPLICATE INITIALIZATION
    // ============================================
    if (window.tauFirebaseSyncLoaded) {
        console.log('‚ö†Ô∏è Firebase sync already loaded, skipping...');
        return;
    }
    window.tauFirebaseSyncLoaded = true;
    
    // ============================================
    // 2. FIREBASE CONFIGURATION (Verified Working)
    // ============================================
      const FIREBASE_CONFIG = {
        apiKey: "AIzaSyBcTzvl5lwpojRQM5lwyWe3hwp4upogUWw",
        authDomain: "tau-main-app.firebaseapp.com",
        projectId: "tau-main-app",
        storageBucket: "tau-main-app.firebasestorage.app",
        messagingSenderId: "69734421488",
        appId: "1:69734421488:web:d13ae38f1c7d79cc854335"
    };
    
    let db, isOnline = false;
    
    // ============================================
    // 3. SAFE FIREBASE INITIALIZATION
    // ============================================
    function initFirebase() {
        if (typeof firebase === 'undefined') {
            console.error('‚ùå Firebase library not loaded - check script tags');
            updateSyncStatus(false);
            setTimeout(initFirebase, 2000); // Retry
            return false;
        }
        
        try {
            // Initialize Firebase (only if not already done)
            if (!firebase.apps.length) {
                firebase.initializeApp(FIREBASE_CONFIG);
                console.log('‚úÖ Firebase initialized');
            } else {
                console.log('‚ÑπÔ∏è Firebase already initialized');
            }
            
            db = firebase.firestore();
            
            // Enable offline persistence
            db.enablePersistence({ synchronizeTabs: true })
                .then(() => {
                    console.log('‚úÖ Offline persistence enabled');
                    isOnline = true;
                    updateSyncStatus(true);
                    
                    // Start real-time sync
                    setupRealtimeSync();
                    
                    // Initial data load
                    loadInitialData();
                })
                .catch(err => {
                    if (err.code === 'failed-precondition') {
                        console.warn('‚ö†Ô∏è Multiple tabs open - persistence disabled');
                    } else if (err.code === 'unimplemented') {
                        console.warn('‚ö†Ô∏è Browser doesn\'t support persistence');
                    }
                    isOnline = true;
                    updateSyncStatus(true);
                    setupRealtimeSync();
                    loadInitialData();
                });
            
            return true;
            
        } catch (error) {
            console.error('‚ùå Firebase initialization error:', error);
            updateSyncStatus(false);
            return false;
        }
    }
    
    // ============================================
    // 4. UPDATE SYNC STATUS INDICATOR
    // ============================================
    function updateSyncStatus(online) {
        // Update all sync indicators on page
        const indicators = document.querySelectorAll('#syncIndicator, .sync-indicator');
        indicators.forEach(indicator => {
            if (indicator) {
                indicator.className = online ? 'sync-indicator online' : 'sync-indicator offline';
                const text = indicator.querySelector('#syncText, span');
                if (text) {
                    text.textContent = online ? 'üü¢ Firestore Connected' : 'üî¥ Offline Mode';
                }
            }
        });
        
        // Update Firebase status in settings (if exists)
        const statusEl = document.getElementById('firebaseStatus');
        if (statusEl) {
            statusEl.textContent = online ? 'Connected' : 'Offline';
            statusEl.style.color = online ? '#2ecc71' : '#e74c3c';
        }
    }
    
    // ============================================
    // 5. STORAGE KEY MAPPING
    // ============================================
    const STORAGE_MAP = {
        'members': 'tauAfricaDB',
        'tasks': 'tauTasks',
        'activities': 'tauActivities',
        'values': 'tauValues',
        'validations': 'tauPendingValidations',
        'notifications': 'tauNotifications'
    };
    
    // ============================================
    // 6. SAVE TO BOTH LOCALSTORAGE AND FIRESTORE
    // ============================================
    async function syncSave(collection, id, data) {
        const localKey = STORAGE_MAP[collection] || collection;
        
        // 1. Save to localStorage (always succeeds)
        try {
            const localData = JSON.parse(localStorage.getItem(localKey) || '[]');
            const index = localData.findIndex(item => item.id === id);
            
            if (index >= 0) {
                localData[index] = { ...localData[index], ...data };
            } else {
                localData.push(data);
            }
            
            localStorage.setItem(localKey, JSON.stringify(localData));
            console.log(`üíæ Saved to localStorage: ${collection}/${id}`);
        } catch (error) {
            console.error('localStorage save error:', error);
        }
        
        // 2. Save to Firestore (if online)
        if (db && isOnline) {
            try {
                await db.collection(collection).doc(id).set({
                    ...data,
                    lastSync: firebase.firestore.FieldValue.serverTimestamp()
                }, { merge: true });
                
                console.log(`‚òÅÔ∏è Synced to Firestore: ${collection}/${id}`);
                return { success: true, synced: true };
            } catch (error) {
                console.error(`‚ö†Ô∏è Firestore sync failed for ${collection}/${id}:`, error);
                return { success: true, synced: false };
            }
        }
        
        return { success: true, synced: false };
    }
    
    // ============================================
    // 7. LOAD FROM FIRESTORE WITH FALLBACK
    // ============================================
    async function syncLoad(collection) {
        const localKey = STORAGE_MAP[collection] || collection;
        
        // Try Firestore first
        if (db && isOnline) {
            try {
                const snapshot = await db.collection(collection).get();
                const data = [];
                
                snapshot.forEach(doc => {
                    data.push({
                        ...doc.data(),
                        firestoreId: doc.id
                    });
                });
                
                // Update localStorage with fresh data
                localStorage.setItem(localKey, JSON.stringify(data));
                console.log(`‚òÅÔ∏è Loaded ${data.length} items from Firestore: ${collection}`);
                return data;
                
            } catch (error) {
                console.error(`‚ö†Ô∏è Firestore load failed for ${collection}:`, error);
            }
        }
        
        // Fallback to localStorage
        const localData = JSON.parse(localStorage.getItem(localKey) || '[]');
        console.log(`üíæ Loaded ${localData.length} items from localStorage: ${collection}`);
        return localData;
    }
    
    // ============================================
    // 8. REAL-TIME SYNC LISTENERS
    // ============================================
    function setupRealtimeSync() {
        if (!db || !isOnline) {
            console.warn('‚ö†Ô∏è Cannot setup real-time sync - Firestore offline');
            return;
        }
        
        console.log('üëÇ Setting up real-time sync listeners...');
        
        // Listen to each collection
        Object.keys(STORAGE_MAP).forEach(collection => {
            db.collection(collection).onSnapshot(
                snapshot => {
                    const localKey = STORAGE_MAP[collection];
                    const localData = JSON.parse(localStorage.getItem(localKey) || '[]');
                    let hasChanges = false;
                    
                    snapshot.docChanges().forEach(change => {
                        const data = {
                            ...change.doc.data(),
                            firestoreId: change.doc.id
                        };
                        
                        if (change.type === 'added' || change.type === 'modified') {
                            const index = localData.findIndex(item => item.id === data.id);
                            if (index >= 0) {
                                localData[index] = data;
                            } else {
                                localData.push(data);
                            }
                            hasChanges = true;
                        } else if (change.type === 'removed') {
                            const filtered = localData.filter(item => item.id !== data.id);
                            localStorage.setItem(localKey, JSON.stringify(filtered));
                            console.log(`üîÑ Real-time delete: ${collection}/${data.id}`);
                            triggerUIRefresh(collection);
                            return;
                        }
                    });
                    
                    if (hasChanges) {
                        localStorage.setItem(localKey, JSON.stringify(localData));
                        console.log(`üîÑ Real-time update: ${collection} (${localData.length} items)`);
                        triggerUIRefresh(collection);
                    }
                },
                error => {
                    console.error(`‚ùå Real-time sync error for ${collection}:`, error);
                }
            );
        });
        
        console.log('‚úÖ Real-time sync active for all collections');
    }
    
    // ============================================
    // 9. TRIGGER UI REFRESH
    // ============================================
    function triggerUIRefresh(collection) {
        // Call existing UI refresh functions if they exist
        switch(collection) {
            case 'members':
                if (typeof renderMembers === 'function') renderMembers();
                if (typeof updateStats === 'function') updateStats();
                break;
            case 'tasks':
                if (typeof loadTasks === 'function') loadTasks();
                if (typeof refreshPublicTasks === 'function') refreshPublicTasks();
                break;
            case 'activities':
                if (typeof loadActivities === 'function') loadActivities();
                if (typeof refreshPublicActivities === 'function') refreshPublicActivities();
                break;
            case 'values':
                if (typeof loadValues === 'function') loadValues();
                if (typeof refreshPublicValues === 'function') refreshPublicValues();
                break;
        }
        
        // Dispatch custom event for other listeners
        window.dispatchEvent(new CustomEvent('tauFirebaseSync', {
            detail: { collection, timestamp: Date.now() }
        }));
    }
    
    // ============================================
    // 10. LOAD INITIAL DATA FROM FIRESTORE
    // ============================================
    async function loadInitialData() {
        if (!db || !isOnline) return;
        
        console.log('üì• Loading initial data from Firestore...');
        
        try {
            await Promise.all([
                syncLoad('members'),
                syncLoad('tasks'),
                syncLoad('activities'),
                syncLoad('values')
            ]);
            
            // Trigger UI refresh for all
            triggerUIRefresh('members');
            triggerUIRefresh('tasks');
            triggerUIRefresh('activities');
            triggerUIRefresh('values');
            
            console.log('‚úÖ Initial data load complete');
            
        } catch (error) {
            console.error('‚ùå Initial data load failed:', error);
        }
    }
    
    // ============================================
    // 11. ENHANCE EXISTING TauDB FUNCTIONS
    // ============================================
    function enhanceTauDB() {
        if (!window.TauDB) {
            console.warn('‚ö†Ô∏è TauDB not found, retrying...');
            setTimeout(enhanceTauDB, 1000);
            return;
        }
        
        console.log('üîß Enhancing TauDB with Firestore sync...');
        
        // Enhance sync function
        const originalSync = window.TauDB.sync;
        window.TauDB.sync = async function(formData, team, referralCode) {
            const result = originalSync.call(this, formData, team, referralCode);
            
            if (result.success && result.member) {
                await syncSave('members', result.memberId, result.member);
            }
            
            return result;
        };
        
        // Enhance updateBalance
        const originalUpdateBalance = window.TauDB.updateBalance;
        window.TauDB.updateBalance = async function(memberId, amount) {
            const result = originalUpdateBalance.call(this, memberId, amount);
            
            if (result) {
                const members = JSON.parse(localStorage.getItem('tauAfricaDB') || '[]');
                const member = members.find(m => m.id === memberId);
                if (member) {
                    await syncSave('members', memberId, member);
                }
            }
            
            return result;
        };
        
        // Enhance addActivity
        const originalAddActivity = window.TauDB.addActivity;
        window.TauDB.addActivity = async function(memberId, activity) {
            const result = originalAddActivity.call(this, memberId, activity);
            
            if (result.success) {
                const members = JSON.parse(localStorage.getItem('tauAfricaDB') || '[]');
                const member = members.find(m => m.id === memberId);
                if (member) {
                    await syncSave('members', memberId, member);
                }
            }
            
            return result;
        };
        
        // Enhance addTask
        const originalAddTask = window.TauDB.addTask;
        window.TauDB.addTask = async function(memberId, task) {
            const result = originalAddTask.call(this, memberId, task);
            
            if (result.success) {
                const members = JSON.parse(localStorage.getItem('tauAfricaDB') || '[]');
                const member = members.find(m => m.id === memberId);
                if (member) {
                    await syncSave('members', memberId, member);
                }
            }
            
            return result;
        };
        
        console.log('‚úÖ TauDB enhanced with Firestore sync');
    }
    
    // ============================================
    // 12. EXPOSE GLOBAL API
    // ============================================
    window.TauFirestore = {
        save: syncSave,
        load: syncLoad,
        isOnline: () => isOnline,
        db: db,
        testConnection: async function() {
            if (!db) {
                console.error('‚ùå Firestore not initialized');
                return false;
            }
            
            try {
                await db.collection('_test_').doc('connection').set({
                    test: true,
                    timestamp: firebase.firestore.FieldValue.serverTimestamp()
                });
                console.log('‚úÖ Firestore connection test passed');
                return true;
            } catch (error) {
                console.error('‚ùå Firestore connection test failed:', error);
                return false;
            }
        }
    };
    
    // ============================================
    // 13. START INITIALIZATION
    // ============================================
    
    // Wait for DOM to be ready
    if (document.readyState === 'loading') {
        document.addEventListener('DOMContentLoaded', () => {
            setTimeout(() => {
                initFirebase();
                setTimeout(enhanceTauDB, 2000);
            }, 500);
        });
    } else {
        setTimeout(() => {
            initFirebase();
            setTimeout(enhanceTauDB, 2000);
        }, 500);
    }
    
    // ============================================
    // 14. STARTUP REPORT
    // ============================================
    setTimeout(() => {
        console.log('\n' + '='.repeat(60));
        console.log('üî• TAU FIREBASE SYNC STATUS');
        console.log('='.repeat(60));
        console.log('Firebase:', db ? '‚úÖ Connected' : '‚ùå Offline');
        console.log('Real-time Sync:', isOnline ? '‚úÖ Active' : '‚ùå Disabled');
        console.log('TauDB Enhanced:', window.TauDB ? '‚úÖ Yes' : '‚ö†Ô∏è Pending');
        console.log('='.repeat(60));
        
        if (isOnline) {
            console.log('‚úÖ All registrations sync to Firestore');
            console.log('‚úÖ Database & Main App connected');
            console.log('‚úÖ Real-time updates active');
        } else {
            console.log('‚ö†Ô∏è OFFLINE MODE - Local storage only');
            console.log('üí° Will sync when connection restored');
        }
        
        console.log('\nüí° Debug commands:');
        console.log('  window.TauFirestore.testConnection()');
        console.log('  window.TauFirestore.load("members")');
        console.log('='.repeat(60) + '\n');
        
    }, 5000);
    
    console.log('‚úÖ TAU Firebase Sync Fix loaded');
    
})();
</script>
        <script>
  // ============================================
// COMPLETE PUBLIC REGISTRATION SYSTEM
// With OTP, Password Toggle, Forgot Password
// ============================================

(function() {
    'use strict';
    
    console.log('üåç Loading Public Registration System...');
    
    // Store OTP codes temporarily
    const otpCodes = {};
    
    // Generate OTP
    function generateOTP() {
        return Math.floor(100000 + Math.random() * 900000).toString();
    }
    
    // Send OTP via email
    async function sendOTP(email, otp) {
        if (typeof emailjs === 'undefined') {
            console.error('‚ùå EmailJS not loaded');
            return false;
        }
        
        const templateParams = {
            to_email: email,
            to_name: 'New User',
            subject: 'TAU Africa - Email Verification Code',
            message: `Your verification code is: ${otp}\n\nThis code expires in 10 minutes.\n\nIf you didn't request this, please ignore this email.`,
            from_name: 'TAU Africa',
            from_email: 'grouptauafrica@gmail.com'
        };
        
        try {
            await emailjs.send('service_xfira7g', 'template_bqxztig', templateParams);
            console.log('‚úÖ OTP sent to:', email);
            return true;
        } catch (error) {
            console.error('‚ùå OTP send failed:', error);
            return false;
        }
    }
    
    // Show public registration modal
    window.showPublicRegistration = function() {
        closeAllModals();
        
        const modal = document.createElement('div');
        modal.className = 'modal';
        modal.style.display = 'block';
        modal.innerHTML = `
            <div class="modal-content">
                <span class="close" onclick="this.parentElement.parentElement.remove()">&times;</span>
                
                <h2 style="text-align: center; color: #27ae60;">üåç TAU Africa Public Access</h2>
                <p style="text-align: center; margin-bottom: 30px; color: #666;">
                    Free access to submit and claim values
                </p>
                
                <div style="display: flex; gap: 10px; margin-bottom: 20px; justify-content: center;">
                    <button class="btn btn-small" onclick="switchPublicTab('register')" id="pubRegTab" style="background: #27ae60;">Register</button>
                    <button class="btn btn-small" onclick="switchPublicTab('login')" id="pubLoginTab" style="background: #95a5a6;">Login</button>
                </div>
                
                <!-- REGISTER FORM -->
                <div id="publicRegisterTab">
                    <form onsubmit="startPublicRegistration(event)" id="publicRegForm">
                        <div class="form-group">
                            <label>Full Name *</label>
                            <input type="text" name="fullName" required placeholder="John Doe">
                        </div>
                        
                        <div class="form-group">
                            <label>Email *</label>
                            <input type="email" name="email" required placeholder="you@example.com" id="publicEmail">
                        </div>
                        
                        <div class="form-group">
                            <label>Phone *</label>
                            <input type="tel" name="phone" required placeholder="254XXXXXXXXX" pattern="254[0-9]{9}">
                        </div>
                        
                        <div class="form-group">
                            <label>Location *</label>
                            <input type="text" name="location" required placeholder="City, Country">
                        </div>
                        
                        <div class="form-group">
                            <label>Password *</label>
                            <div style="position: relative;">
                                <input type="password" name="password" required minlength="6" placeholder="Minimum 6 characters" id="publicPassword">
                                <span onclick="togglePasswordVisibility('publicPassword')" style="position: absolute; right: 10px; top: 50%; transform: translateY(-50%); cursor: pointer; font-size: 20px;">üëÅÔ∏è</span>
                            </div>
                        </div>
                        
                        <div class="form-group">
                            <label>Confirm Password *</label>
                            <div style="position: relative;">
                                <input type="password" name="confirmPassword" required minlength="6" id="publicConfirmPassword">
                                <span onclick="togglePasswordVisibility('publicConfirmPassword')" style="position: absolute; right: 10px; top: 50%; transform: translateY(-50%); cursor: pointer; font-size: 20px;">üëÅÔ∏è</span>
                            </div>
                        </div>
                        
                        <div style="background: #e8f5e9; padding: 15px; border-radius: 10px; margin-bottom: 20px;">
                            <strong>üÜì What you get:</strong>
                            <ul style="margin: 10px 0 0 20px; font-size: 14px;">
                                <li>Submit values to the marketplace</li>
                                <li>Claim available values</li>
                                <li>View all opportunities</li>
                                <li>Upgrade to TASK/TALK anytime</li>
                            </ul>
                        </div>
                        
                        <button type="submit" class="btn" style="width: 100%; background: #27ae60;">Create Free Account</button>
                    </form>
                </div>
                
                <!-- LOGIN FORM -->
                <div id="publicLoginTab" style="display: none;">
                    <form onsubmit="processPublicLogin(event)">
                        <div class="form-group">
                            <label>Email or Member ID *</label>
                            <input type="text" name="identifier" required placeholder="your@email.com or PUB-XXX">
                        </div>
                        
                        <div class="form-group">
                            <label>Password *</label>
                            <div style="position: relative;">
                                <input type="password" name="password" required id="publicLoginPassword">
                                <span onclick="togglePasswordVisibility('publicLoginPassword')" style="position: absolute; right: 10px; top: 50%; transform: translateY(-50%); cursor: pointer; font-size: 20px;">üëÅÔ∏è</span>
                            </div>
                        </div>
                        
                        <button type="submit" class="btn" style="width: 100%; background: #27ae60;">Login</button>
                        
                        <div style="text-align: center; margin-top: 15px;">
                            <a href="#" onclick="showForgotPassword(); return false;" style="color: #27ae60; text-decoration: none;">Forgot Password?</a>
                        </div>
                    </form>
                </div>
            </div>
        `;
        
        document.body.appendChild(modal);
    };
    
    // Switch between register/login tabs
    window.switchPublicTab = function(tab) {
        document.getElementById('publicRegisterTab').style.display = tab === 'register' ? 'block' : 'none';
        document.getElementById('publicLoginTab').style.display = tab === 'login' ? 'block' : 'none';
        
        document.getElementById('pubRegTab').style.background = tab === 'register' ? '#27ae60' : '#95a5a6';
        document.getElementById('pubLoginTab').style.background = tab === 'login' ? '#27ae60' : '#95a5a6';
    };
    
    // Toggle password visibility
    window.togglePasswordVisibility = function(inputId) {
        const input = document.getElementById(inputId);
        if (input) {
            input.type = input.type === 'password' ? 'text' : 'password';
        }
    };
    
    // Start registration (send OTP)
    window.startPublicRegistration = async function(event) {
        event.preventDefault();
        
        const formData = new FormData(event.target);
        const email = formData.get('email');
        const password = formData.get('password');
        const confirmPassword = formData.get('confirmPassword');
        
        if (password !== confirmPassword) {
            showNotification('‚ùå Passwords do not match', 'error');
            return;
        }
        
        const members = JSON.parse(localStorage.getItem('tauAfricaDB') || '[]');
        const exists = members.find(m => m.email === email);
        
        if (exists) {
            showNotification('‚ùå Email already registered', 'error');
            return;
        }
        
        const otp = generateOTP();
        otpCodes[email] = {
            code: otp,
            formData: Object.fromEntries(formData.entries()),
            timestamp: Date.now()
        };
        
        showNotification('üìß Sending verification code...', 'info');
        
        const sent = await sendOTP(email, otp);
        
        if (sent) {
            showNotification('‚úÖ Verification code sent! Check your email.', 'success');
            showOTPVerification(email);
        } else {
            showNotification('‚ùå Failed to send verification code', 'error');
        }
    };
    
    // Show OTP verification screen
    function showOTPVerification(email) {
        closeAllModals();
        
        const modal = document.createElement('div');
        modal.className = 'modal';
        modal.style.display = 'block';
        modal.innerHTML = `
            <div class="modal-content">
                <span class="close" onclick="this.parentElement.parentElement.remove()">&times;</span>
                
                <h2 style="text-align: center;">üìß Email Verification</h2>
                <p style="text-align: center; margin-bottom: 30px;">
                    Enter the 6-digit code sent to<br>
                    <strong>${email}</strong>
                </p>
                
                <form onsubmit="verifyOTPAndRegister(event, '${email}')">
                    <div class="form-group">
                        <label>Verification Code *</label>
                        <input type="text" name="otp" required maxlength="6" pattern="[0-9]{6}" placeholder="000000" style="text-align: center; font-size: 24px; letter-spacing: 5px;">
                    </div>
                    
                    <button type="submit" class="btn" style="width: 100%; background: #27ae60;">Verify & Create Account</button>
                    
                    <div style="text-align: center; margin-top: 15px;">
                        <a href="#" onclick="resendOTP('${email}'); return false;" style="color: #27ae60;">Didn't receive code? Resend</a>
                    </div>
                </form>
            </div>
        `;
        
        document.body.appendChild(modal);
    }
    
    // Verify OTP and complete registration
    window.verifyOTPAndRegister = async function(event, email) {
        event.preventDefault();
        
        const formData = new FormData(event.target);
        const enteredOTP = formData.get('otp');
        const stored = otpCodes[email];
        
        if (!stored) {
            showNotification('‚ùå Verification expired. Please try again.', 'error');
            return;
        }
        
        if (Date.now() - stored.timestamp > 600000) {
            delete otpCodes[email];
            showNotification('‚ùå Verification code expired. Please request a new one.', 'error');
            return;
        }
        
        if (enteredOTP !== stored.code) {
            showNotification('‚ùå Invalid verification code', 'error');
            return;
        }
        
        const originalData = stored.formData;
        delete otpCodes[email];
        
        const publicMember = {
            id: 'PUB-' + Date.now(),
            type: 'public',
            fullName: originalData.fullName,
            email: originalData.email,
            phone: originalData.phone,
            location: originalData.location,
            password: btoa(originalData.password),
            accountCreated: new Date().toISOString(),
            status: 'Active',
            verified: true,
            iKbpBalance: 0,
            iKbBalance: 0,
            canSubmitValues: true,
            canClaimValues: true,
            membership: 'Public'
        };
        
        const members = JSON.parse(localStorage.getItem('tauAfricaDB') || '[]');
        members.push(publicMember);
        localStorage.setItem('tauAfricaDB', JSON.stringify(members));
        
        if (typeof firebase !== 'undefined' && firebase.apps.length > 0) {
            try {
                const db = firebase.firestore();
                await db.collection('members').doc(publicMember.id).set(publicMember);
            } catch (error) {
                console.warn('‚ö†Ô∏è Firestore save warning:', error);
            }
        }
        
        if (typeof sendWelcomeEmail === 'function') {
            sendWelcomeEmail(publicMember);
        }
        
        showNotification('‚úÖ Account created successfully!', 'success');
        
        setTimeout(() => {
            closeAllModals();
            showPublicDashboard(publicMember);
        }, 2000);
    };
    
    // Resend OTP
    window.resendOTP = async function(email) {
        const stored = otpCodes[email];
        if (!stored) {
            showNotification('‚ùå Session expired. Please start again.', 'error');
            return;
        }
        
        const newOTP = generateOTP();
        otpCodes[email].code = newOTP;
        otpCodes[email].timestamp = Date.now();
        
        const sent = await sendOTP(email, newOTP);
        
        if (sent) {
            showNotification('‚úÖ New verification code sent!', 'success');
        } else {
            showNotification('‚ùå Failed to send code', 'error');
        }
    };
    
    // Public login
    window.processPublicLogin = async function(event) {
        event.preventDefault();
        
        const formData = new FormData(event.target);
        const identifier = formData.get('identifier').trim();
        const password = formData.get('password');
        const hashedPassword = btoa(password);
        
        const members = JSON.parse(localStorage.getItem('tauAfricaDB') || '[]');
        const member = members.find(m => 
            (m.email === identifier || m.id === identifier) && 
            m.password === hashedPassword &&
            m.type === 'public'
        );
        
        if (member) {
            sessionStorage.setItem('tauCurrentUser', JSON.stringify(member));
            showNotification('‚úÖ Login successful!', 'success');
            
            setTimeout(() => {
                closeAllModals();
                showPublicDashboard(member);
            }, 1000);
        } else {
            showNotification('‚ùå Invalid credentials', 'error');
        }
    };
    
    // Public dashboard
    window.showPublicDashboard = function(member) {
        const modal = document.createElement('div');
        modal.className = 'modal';
        modal.style.display = 'block';
        modal.innerHTML = `
            <div class="modal-content" style="max-width: 900px;">
                <span class="close" onclick="sessionStorage.removeItem('tauCurrentUser'); this.parentElement.parentElement.remove()">&times;</span>
                
                <div style="background: linear-gradient(45deg, #27ae60, #2ecc71); color: white; padding: 25px; border-radius: 15px; margin-bottom: 20px; text-align: center;">
                    <h2>Welcome, ${member.fullName}! üëã</h2>
                    <p style="margin: 10px 0 0 0;">Public Member ID: ${member.id}</p>
                </div>
                
                <div style="display: grid; grid-template-columns: 1fr 1fr 1fr; gap: 15px; margin-bottom: 20px;">
                    <button class="btn" onclick="openValueSubmissionModal()">üíé Submit Value</button>
                    <button class="btn" onclick="closeAllModals(); refreshPublicOpportunities();">üîç Browse Values</button>
                    <button class="btn" onclick="viewMySubmissions('${member.id}')">üìã My Submissions</button>
                </div>
                
                <div style="background: #fff3cd; padding: 20px; border-radius: 10px; text-align: center; margin-top: 20px;">
                    <h4>üîì Unlock Full Membership</h4>
                    <p>Upgrade to TASK or TALK to earn iKbp, access activities, and more!</p>
                    <button class="btn" onclick="closeAllModals(); setTimeout(() => openModal('taskRegistration'), 500)">Join TASK (KSH 500)</button>
                    <button class="btn" onclick="closeAllModals(); setTimeout(() => openModal('talkRegistration'), 500)">Join TALK (KSH 2,000)</button>
                </div>
            </div>
        `;
        document.body.appendChild(modal);
    };
    
    // Forgot password
    window.showForgotPassword = function() {
        alert('Password reset: Contact grouptauafrica@gmail.com with your email/Member ID for assistance.');
    };
    
    // View my submissions
    window.viewMySubmissions = function(memberId) {
        const values = JSON.parse(localStorage.getItem('tauValues') || '[]');
        const myValues = values.filter(v => v.submittedBy === memberId);
        
        const modal = document.createElement('div');
        modal.className = 'modal';
        modal.style.display = 'block';
        modal.innerHTML = `
            <div class="modal-content">
                <span class="close" onclick="this.parentElement.parentElement.remove()">&times;</span>
                <h2>üìã My Submissions</h2>
                
                <div style="max-height: 400px; overflow-y: auto;">
                    ${myValues.length > 0 ? myValues.map(v => `
                        <div style="background: #f8f9fa; padding: 15px; border-radius: 10px; margin-bottom: 10px;">
                            <h4>${v.title}</h4>
                            <p>${v.description}</p>
                            <p><strong>Worth:</strong> ${v.worthIkb} iKb (${v.worthKsh} KSH)</p>
                            <p><strong>Status:</strong> <span style="color: ${v.status === 'Approved' ? '#27ae60' : v.status === 'Pending Review' ? '#f39c12' : '#e74c3c'}">${v.status}</span></p>
                            <p><strong>Code:</strong> ${v.validationCode}</p>
                        </div>
                    `).join('') : '<p style="text-align: center; padding: 40px;">No submissions yet</p>'}
                </div>
            </div>
        `;
        document.body.appendChild(modal);
    };
    
    console.log('‚úÖ Public Registration System COMPLETE');
})();
</script>
        <script>
// UNIVERSAL SYNC HEARTBEAT - Add to ALL apps
// ============================================

(function() {
    'use strict';
    
    let lastSyncTime = Date.now();
    const SYNC_INTERVAL = 3000; // Every 3 seconds
    
    function syncAcrossApps() {
        try {
            // Read from localStorage
            const members = JSON.parse(localStorage.getItem('tauAfricaDB') || '[]');
            const tasks = JSON.parse(localStorage.getItem('tauTasks') || '[]');
            const activities = JSON.parse(localStorage.getItem('tauActivities') || '[]');
            const values = JSON.parse(localStorage.getItem('tauValues') || '[]');
            
            // If Firestore is available, sync there too
            if (typeof firebase !== 'undefined' && firebase.apps.length > 0) {
                const db = firebase.firestore();
                
                // Batch write (efficient)
                const batch = db.batch();
                let writeCount = 0;
                
                members.slice(0, 10).forEach(member => { // Limit to 10 per sync
                    const ref = db.collection('members').doc(member.id);
                    batch.set(ref, {
                        ...member,
                        lastSync: firebase.firestore.FieldValue.serverTimestamp()
                    }, { merge: true });
                    writeCount++;
                });
                
                if (writeCount > 0) {
                    batch.commit()
                        .then(() => console.log(`üîÑ Synced ${writeCount} members to Firestore`))
                        .catch(err => console.warn('Sync warning:', err));
                }
            }
            
            // Trigger UI refresh
            if (typeof updateStats === 'function') updateStats();
            if (typeof renderMembers === 'function') renderMembers();
            
            lastSyncTime = Date.now();
            
        } catch (error) {
            console.error('Sync error:', error);
        }
    }
    
    // Run sync every 3 seconds
    setInterval(syncAcrossApps, SYNC_INTERVAL);
    
    // Listen for storage changes from other tabs/windows
    window.addEventListener('storage', (e) => {
        if (e.key && (e.key.includes('tau') || e.key.includes('Tau'))) {
            console.log('üîÑ Cross-tab sync detected:', e.key);
            syncAcrossApps();
        }
    });
    
    // Initial sync
    setTimeout(syncAcrossApps, 1000);
    
    console.log('‚úÖ Universal sync heartbeat active');
})();
</script>
<script>
// ============================================
// FIX REAL LOGIN SYSTEM - CONSOLIDATED
// ============================================
(function() {
    'use strict';
    
    console.log('üîê Fixing login system...');
    
    // Single unified login function
    window.showMemberLogin = window.showRealMemberLogin = function() {
        closeAllModals(); // Close any existing modals first
        
        const modal = document.createElement('div');
        modal.className = 'modal';
        modal.style.display = 'block';
        modal.innerHTML = `
            <div class="modal-content">
                <span class="close" onclick="this.parentElement.parentElement.remove()">&times;</span>
                <h2 style="text-align: center;">üîê Member Login</h2>
                
                <form onsubmit="processRealLogin(event)" style="margin-top: 30px;">
                    <div class="form-group">
                        <label>Member ID or Email *</label>
                        <input type="text" id="loginIdentifier" required>
                    </div>
                    
                    <div class="form-group">
                        <label>Phone (Last 4 digits) *</label>
                        <input type="text" id="loginPhone" required maxlength="4" pattern="[0-9]{4}">
                    </div>
                    
                    <button type="submit" class="btn" style="width: 100%;">Login</button>
                </form>
                
                <div style="text-align: center; margin-top: 20px;">
                    <p>No account?</p>
                    <button class="btn btn-small" onclick="closeAllModals(); openModal('taskRegistration')">Join TASK</button>
                    <button class="btn btn-small" onclick="closeAllModals(); openModal('talkRegistration')">Join TALK</button>
                </div>
            </div>
        `;
        document.body.appendChild(modal);
    };
    
    // Ensure processRealLogin works correctly
    window.processRealLogin = function(event) {
        event.preventDefault();
        
        const identifier = document.getElementById('loginIdentifier').value.trim();
        const phoneLastFour = document.getElementById('loginPhone').value.trim();
        
        console.log('üîê Login attempt:', { identifier, phoneLastFour });
        
        if (!identifier || !phoneLastFour) {
            showNotification('‚ùå Please fill all fields', 'error');
            return;
        }
        
        // Use TauDB authentication
        const result = window.TauDB?.authenticate(identifier, phoneLastFour);
        
        if (result && result.success) {
            console.log('‚úÖ Login successful:', result.member.id);
            showNotification('‚úÖ Login successful!', 'success');
            
            setTimeout(() => {
                closeAllModals();
                showRealMemberDashboard(result.member);
            }, 1000);
        } else {
            console.error('‚ùå Login failed');
            showNotification('‚ùå Invalid credentials', 'error');
        }
    };
    
    console.log('‚úÖ Unified login system ready');
    
    // Debug: Check if floating button exists
    setTimeout(() => {
        const floatingBtn = document.querySelector('.floating-btn');
        if (floatingBtn) {
            console.log('‚úÖ Floating login button found');
            // Ensure it has the click handler
            floatingBtn.onclick = showRealMemberLogin;
        } else {
            console.error('‚ùå Floating login button not found!');
        }
    }, 1000);
})();
</script>
        <script>
// ============================================
// PREVENT DUPLICATE REGISTRATIONS
// ============================================

(function() {
    'use strict';
    
    // Enhance TauDB.sync to check for duplicates
    if (window.TauDB && window.TauDB.sync) {
        const originalSync = window.TauDB.sync;
        
        window.TauDB.sync = async function(formData, team, referralCode) {
            console.log('üîç Checking for duplicate registration...');
            
            const email = formData.email;
            const phone = formData.phone;
            
            // Check localStorage first
            const localMembers = JSON.parse(localStorage.getItem('tauAfricaDB') || '[]');
            const localDuplicate = localMembers.find(m => 
                m.email === email || m.phone === phone
            );
            
            if (localDuplicate) {
                showNotification('‚ùå Email or phone already registered!', 'error');
                return { 
                    success: false, 
                    error: 'Duplicate registration',
                    existingMember: localDuplicate
                };
            }
            
            // No duplicates found, proceed with registration
            return originalSync.call(this, formData, team, referralCode);
        };
        
        console.log('‚úÖ Duplicate prevention enabled');
    }
})();
</script>
    <script>
// ============================================
// TAU AFRICA - COMPLETE REGISTRATION FIX
// Add this BEFORE closing tag
// Remove ALL other registration code first
// ============================================
  
(function() {
    'use strict';
    
    console.log('üîß Loading Fixed Registration System...');
    
    // ============================================
    // 1. FIREBASE INITIALIZATION
    // ============================================
      const FIREBASE_CONFIG = {
        apiKey: "AIzaSyBcTzvl5lwpojRQM5lwyWe3hwp4upogUWw",
        authDomain: "tau-main-app.firebaseapp.com",
        projectId: "tau-main-app",
        storageBucket: "tau-main-app.firebasestorage.app",
        messagingSenderId: "69734421488",
        appId: "1:69734421488:web:d13ae38f1c7d79cc854335"
    };
    
    let db = null;
    let isOnline = false;
    
    function initFirebase() {
        if (typeof firebase === 'undefined') {
            console.error('‚ùå Firebase not loaded');
            setTimeout(initFirebase, 1000);
            return;
        }
        
        try {
            if (!firebase.apps.length) {
                firebase.initializeApp(FIREBASE_CONFIG);
            }
            db = firebase.firestore();
            isOnline = true;
            console.log('‚úÖ Firebase initialized');
        } catch (error) {
            console.error('‚ùå Firebase init failed:', error);
        }
    }
    
    // ============================================
    // 2. HELPER FUNCTIONS
    // ============================================
    function generateMemberID(team, referralCode) {
        const prefix = team === 'TASK' ? 'TSK' : 
                      team === 'TALK' ? 'TLK' : 
                      team === 'PUBLIC' ? 'PUB' : 
                      'JOB';
        
        const timestamp = Date.now().toString().slice(-6);
        const random = Math.floor(Math.random() * 1000).toString().padStart(3, '0');
        return `${prefix}-${timestamp}-${random}`;
    }
    
    function generateReferralCode(memberId) {
        return btoa(memberId).substring(0, 8).toUpperCase();
    }
    
    // ============================================
    // 3. CORE REGISTRATION FUNCTION
    // ============================================
    window.registerMember = async function(formData, team, referralCode = null) {
        console.log('üéØ Starting registration:', { team, referralCode });
        
        try {
            // 1. Generate IDs
            const memberId = generateMemberID(team, referralCode);
            const memberReferralCode = generateReferralCode(memberId);
            
            console.log('üìù Generated IDs:', { memberId, memberReferralCode });
            
            // 2. Create member object
            const member = {
                id: memberId,
                referralCode: memberReferralCode,
                team: team,
                fullName: formData.fullName || formData.name,
                email: formData.email,
                phone: formData.phone,
                location: formData.location,
                paymentStatus: formData.paymentStatus || 'Paid',
                dateJoined: new Date().toISOString().split('T')[0],
                status: 'Active',
                fee: team === 'TASK' ? 500 : 
                     team === 'TALK' ? 2000 : 
                     team === 'PUBLIC' ? 0 : 1500,
                accountCreated: new Date().toISOString(),
                lastLogin: null,
                iKbpBalance: 500,
                iKbBalance: 0,
                referredBy: referralCode || null,
                activities: [],
                tasks: [],
                ...formData
            };
            
            console.log('üë§ Member object created:', member);
            
            // 3. SAVE TO LOCALSTORAGE
            const localMembers = JSON.parse(localStorage.getItem('tauAfricaDB') || '[]');
            
            // Check duplicates
            const existingIndex = localMembers.findIndex(m => 
                m.email === member.email || m.phone === member.phone
            );
            
            if (existingIndex >= 0) {
                console.error('‚ùå Duplicate found');
                return { 
                    success: false, 
                    error: 'Email or phone already registered'
                };
            }
            
            localMembers.push(member);
            localStorage.setItem('tauAfricaDB', JSON.stringify(localMembers));
            console.log('‚úÖ Saved to localStorage');
            
            // 4. Save credentials
            const credentials = JSON.parse(localStorage.getItem('tauCredentials') || '{}');
            credentials[memberId] = {
                email: member.email,
                phone: member.phone.slice(-4),
                fullName: member.fullName
            };
            localStorage.setItem('tauCredentials', JSON.stringify(credentials));
            console.log('üîë Credentials saved');
            
            // 5. SAVE TO FIRESTORE
            if (db && isOnline) {
                try {
                    await db.collection('members').doc(memberId).set({
                        ...member,
                        createdAt: firebase.firestore.FieldValue.serverTimestamp(),
                        lastSync: firebase.firestore.FieldValue.serverTimestamp()
                    });
                    console.log('‚òÅÔ∏è Saved to Firestore');
                } catch (firestoreError) {
                    console.warn('‚ö†Ô∏è Firestore save failed:', firestoreError);
                }
            }
            
            // 6. Track referral
            if (referralCode) {
                trackReferral(referralCode, memberId);
            }
            
            // 7. Create notification
            if (typeof createNotification === 'function') {
                createNotification(
                    memberId,
                    'üéâ Welcome to TAU Africa!',
                    `Welcome bonus: 500 iKbp\nReferral Code: ${memberReferralCode}`,
                    'success'
                );
            }
            
            console.log('‚úÖ Registration complete:', memberId);
            
            return {
                success: true,
                memberId: memberId,
                member: member
            };
            
        } catch (error) {
            console.error('‚ùå Registration error:', error);
            return {
                success: false,
                error: error.message
            };
        }
    };
    
    function trackReferral(referralCode, newMemberId) {
        try {
            const members = JSON.parse(localStorage.getItem('tauAfricaDB') || '[]');
            const referrer = members.find(m => m.referralCode === referralCode);
            
            if (referrer) {
                referrer.iKbpBalance = (referrer.iKbpBalance || 0) + 500;
                
                const index = members.findIndex(m => m.id === referrer.id);
                if (index >= 0) {
                    members[index] = referrer;
                    localStorage.setItem('tauAfricaDB', JSON.stringify(members));
                }
                
                if (db && isOnline) {
                    db.collection('members').doc(referrer.id).update({
                        iKbpBalance: firebase.firestore.FieldValue.increment(500)
                    }).catch(err => console.warn('Referral warning:', err));
                }
                
                console.log('üéÅ Referral bonus awarded:', referrer.id);
            }
        } catch (error) {
            console.error('Referral error:', error);
        }
    }
    
    // ============================================
    // 4. SUCCESS HANDLERS
    // ============================================
    window.processTaskSuccess = async function(formData) {
        console.log('üéØ TASK registration...');
        
        const referralCode = window.TauDB?.checkReferralCode();
        const result = await registerMember(formData, 'TASK', referralCode);
        
        if (result.success) {
            const member = result.member;
            
            if (typeof showNotification === 'function') {
                showNotification('üìß Sending emails...', 'info');
            }
            
            const emailPromises = [];
            
            if (typeof sendWelcomeEmail === 'function') {
                emailPromises.push(sendWelcomeEmail(member));
            }
            
            if (typeof sendEmailToAdmin === 'function') {
                emailPromises.push(sendEmailToAdmin(member, 'NEW TASK REGISTRATION'));
            }
            
            await Promise.allSettled(emailPromises);
            
            if (typeof showNotification === 'function') {
                showNotification('‚úÖ Registration complete!', 'success');
            }
            
            setTimeout(() => {
                if (typeof closeAllModals === 'function') closeAllModals();
                if (typeof showSuccessModal === 'function') showSuccessModal(member);
            }, 2000);
        } else {
            if (typeof showNotification === 'function') {
                showNotification('‚ùå Failed: ' + result.error, 'error');
            }
        }
    };
    
    window.processTalkSuccess = async function(formData) {
        console.log('üéØ TALK registration...');
        
        const referralCode = window.TauDB?.checkReferralCode();
        const result = await registerMember(formData, 'TALK', referralCode);
        
        if (result.success) {
            const member = result.member;
            
            if (typeof showNotification === 'function') {
                showNotification('üìß Sending emails...', 'info');
            }
            
            const emailPromises = [];
            if (typeof sendWelcomeEmail === 'function') {
                emailPromises.push(sendWelcomeEmail(member));
            }
            if (typeof sendEmailToAdmin === 'function') {
                emailPromises.push(sendEmailToAdmin(member, 'NEW TALK REGISTRATION'));
            }
            
            await Promise.allSettled(emailPromises);
            
            if (typeof showNotification === 'function') {
                showNotification('‚úÖ Registration complete!', 'success');
            }
            
            setTimeout(() => {
                if (typeof closeAllModals === 'function') closeAllModals();
                if (typeof showSuccessModal === 'function') showSuccessModal(member);
            }, 2000);
        } else {
            if (typeof showNotification === 'function') {
                showNotification('‚ùå Failed: ' + result.error, 'error');
            }
        }
    };
    
    window.processJobCreationSuccess = async function(formData) {
        console.log('üéØ Job Creation registration...');
        
        const referralCode = window.TauDB?.checkReferralCode();
        const result = await registerMember(formData, 'JOB_CREATION', referralCode);
        
        if (result.success) {
            const member = result.member;
            
            const emailPromises = [];
            if (typeof sendWelcomeEmail === 'function') {
                emailPromises.push(sendWelcomeEmail(member));
            }
            if (typeof sendEmailToAdmin === 'function') {
                emailPromises.push(sendEmailToAdmin(member, 'JOB CREATION ENROLLMENT'));
            }
            
            await Promise.allSettled(emailPromises);
            
            if (typeof showNotification === 'function') {
                showNotification('‚úÖ Enrollment complete!', 'success');
            }
            
            setTimeout(() => {
                if (typeof closeAllModals === 'function') closeAllModals();
                if (typeof showSuccessModal === 'function') showSuccessModal(member);
            }, 2000);
        } else {
            if (typeof showNotification === 'function') {
                showNotification('‚ùå Failed: ' + result.error, 'error');
            }
        }
    };
    
    // ============================================
    // 5. OVERRIDE TauDB
    // ============================================
    if (typeof window.TauDB === 'undefined') {
        window.TauDB = {};
    }
    
    window.TauDB.sync = async function(formData, team, referralCode) {
        return await registerMember(formData, team, referralCode);
    };
    
    window.TauDB.checkReferralCode = function() {
        const urlParams = new URLSearchParams(window.location.search);
        return urlParams.get('ref');
    };
    
    // ============================================
    // 6. INITIALIZE
    // ============================================
    initFirebase();
    
    console.log('‚úÖ Fixed Registration System Loaded');
    
})();
     </script>
    <script>
// ============================================
// 3-STAGE VALIDATION SYSTEM FOR VALUES & JOBS
// ============================================
(function() {
    'use strict';
    
    const VALIDATION_FEES = {
        system: 0.15,      // 15%
        validator1: 0.05,  // 5%
        validator2: 0.05,  // 5%
        validator3: 0.05,  // 5%
        total: 0.30        // 30%
    };
    
    const TRANSACTION_FEE = 0.00001; // 0.001% for tasks/activities
    
    // Generate validation codes
    function generateValidatorCode(stage) {
        const prefix = stage === 1 ? 'VAL1' : stage === 2 ? 'VAL2' : 'VAL3';
        const timestamp = Date.now().toString(36).toUpperCase();
        const random = Math.random().toString(36).substring(2, 6).toUpperCase();
        return `${prefix}-${timestamp}-${random}`;
    }
    
    // Create validation code in database
    window.createValidationCode = async function(itemType, itemId, stage) {
        const code = generateValidatorCode(stage);
        const codes = JSON.parse(localStorage.getItem('tauValidatorCodes') || '[]');
        
        const validationCode = {
            id: `CODE-${Date.now()}`,
            code: code,
            itemType: itemType, // 'value' or 'job'
            itemId: itemId,
            stage: stage,
            status: 'pending',
            created: new Date().toISOString(),
            validatedBy: null,
            validatedAt: null
        };
        
        codes.push(validationCode);
        localStorage.setItem('tauValidatorCodes', JSON.stringify(codes));
        
        // Save to Firestore
        if (typeof firebase !== 'undefined' && firebase.apps.length > 0) {
            const db = firebase.firestore();
            await db.collection('validationCodes').doc(validationCode.id).set(validationCode);
        }
        
        console.log(`‚úÖ Validation code created: ${code} (Stage ${stage})`);
        return validationCode;
    };
    
    // Validate with code
    window.validateWithCode = async function(code, validatorId) {
        const codes = JSON.parse(localStorage.getItem('tauValidatorCodes') || '[]');
        const codeObj = codes.find(c => c.code === code && c.status === 'pending');
        
        if (!codeObj) {
            return { success: false, error: 'Invalid or already used code' };
        }
        
        const { itemType, itemId, stage } = codeObj;
        
        // Get the item
        const storageKey = itemType === 'value' ? 'tauValues' : 'tauJobsPortal';
        const items = JSON.parse(localStorage.getItem(storageKey) || '[]');
        const item = items.find(i => i.id === itemId);
        
        if (!item) {
            return { success: false, error: 'Item not found' };
        }
        
        // Update code status
        codeObj.status = 'used';
        codeObj.validatedBy = validatorId;
        codeObj.validatedAt = new Date().toISOString();
        localStorage.setItem('tauValidatorCodes', JSON.stringify(codes));
        
        // Update item validation stage
        if (!item.validationStages) {
            item.validationStages = {};
        }
        
        item.validationStages[`stage${stage}`] = {
            validated: true,
            validatedBy: validatorId,
            validatedAt: new Date().toISOString(),
            code: code
        };
        
        // Calculate earnings
        let earnings = 0;
        const worthKsh = parseFloat(item.worthKsh || 0);
        const feeAmount = worthKsh * VALIDATION_FEES.total;
        
        if (stage === 1) {
            earnings = feeAmount * (VALIDATION_FEES.validator1 / VALIDATION_FEES.total);
            item.status = 'Stage 1 Complete - Awaiting Claimer';
        } else if (stage === 2) {
            earnings = feeAmount * (VALIDATION_FEES.validator2 / VALIDATION_FEES.total);
            item.status = 'Stage 2 Complete - Ready for Chain';
        } else if (stage === 3) {
            earnings = feeAmount * (VALIDATION_FEES.validator3 / VALIDATION_FEES.total);
            item.status = 'Fully Validated - Ready for Claim';
            item.validated = true;
            
            // Calculate and distribute all fees
            const systemFee = feeAmount * (VALIDATION_FEES.system / VALIDATION_FEES.total);
            
            // Award system fee
            const systemAccount = {
                id: 'SYSTEM',
                iKbpBalance: (JSON.parse(localStorage.getItem('systemBalance') || '0')) + (systemFee * 10)
            };
            localStorage.setItem('systemBalance', JSON.stringify(systemAccount.iKbpBalance));
        }
        
        // Save updated item
        const itemIndex = items.findIndex(i => i.id === itemId);
        items[itemIndex] = item;
        localStorage.setItem(storageKey, JSON.stringify(items));
        
        // Award validator
        if (window.TauDB?.updateBalance) {
            window.TauDB.updateBalance(validatorId, earnings * 10); // Convert to iKbp
        }
        
        // Create notification
        if (typeof createNotification === 'function') {
            createNotification(
                validatorId,
                `‚úÖ Validation Complete!`,
                `Stage ${stage} validated. Earned ${(earnings * 10).toFixed(2)} iKbp`,
                'success'
            );
        }
        
        // Save to Firestore
        if (typeof firebase !== 'undefined' && firebase.apps.length > 0) {
            const db = firebase.firestore();
            await db.collection('validationCodes').doc(codeObj.id).set(codeObj, { merge: true });
            
            if (itemType === 'value') {
                await db.collection('values').doc(itemId).set(item, { merge: true });
            } else {
                await db.collection('jobs').doc(itemId).set(item, { merge: true });
            }
        }
        
        console.log(`‚úÖ Stage ${stage} validation complete. Validator earned ${earnings} KSH`);
        
        return {
            success: true,
            stage: stage,
            earnings: earnings,
            earningsIkbp: earnings * 10,
            item: item
        };
    };
    
    // Admin: Generate codes for item
    window.generateValidationCodes = async function(itemType, itemId) {
        const item = itemType === 'value' 
            ? JSON.parse(localStorage.getItem('tauValues') || '[]').find(v => v.id === itemId)
            : JSON.parse(localStorage.getItem('tauJobsPortal') || '[]').find(j => j.id === itemId);
        
        if (!item) {
            showNotification('‚ùå Item not found', 'error');
            return;
        }
        
        const codes = [];
        for (let stage = 1; stage <= 3; stage++) {
            const code = await createValidationCode(itemType, itemId, stage);
            codes.push(code);
        }
        
        showNotification(`‚úÖ 3 validation codes generated for ${item.title}`, 'success');
        
        // Display codes modal
        const modal = document.createElement('div');
        modal.className = 'modal';
        modal.style.display = 'block';
        modal.innerHTML = `
            <div class="modal-content">
                <span class="close" onclick="this.parentElement.parentElement.remove()">&times;</span>
                <h2>üîê Validation Codes Generated</h2>
                <p><strong>${item.title}</strong></p>
                
                <div style="background: #f8f9fa; padding: 20px; border-radius: 10px; margin: 20px 0;">
                    ${codes.map(c => `
                        <div style="background: white; padding: 15px; border-radius: 8px; margin-bottom: 10px; border-left: 4px solid ${c.stage === 1 ? '#3498db' : c.stage === 2 ? '#f39c12' : '#2ecc71'};">
                            <h4>Stage ${c.stage}: Human Validation ${c.stage === 1 ? '(5%)' : c.stage === 2 ? '(5%)' : '(5%)'}</h4>
                            <div style="font-size: 20px; font-weight: bold; letter-spacing: 2px; margin: 10px 0;">${c.code}</div>
                            <button onclick="copyToClipboard('${c.code}')" class="btn btn-small">Copy Code</button>
                        </div>
                    `).join('')}
                </div>
                
                <button onclick="this.parentElement.parentElement.remove()" class="btn">Close</button>
            </div>
        `;
        document.body.appendChild(modal);
        
        return codes;
    };
    
    // Validator interface
    window.showValidatorInterface = function() {
        const currentMember = window.TauDB?.getCurrentMember();
        
        if (!currentMember) {
            showNotification('‚ùå Please login first', 'error');
            return;
        }
        
        const modal = document.createElement('div');
        modal.className = 'modal';
        modal.style.display = 'block';
        modal.innerHTML = `
            <div class="modal-content">
                <span class="close" onclick="this.parentElement.parentElement.remove()">&times;</span>
<h2>üîê Validator Interface</h2>
                <p>Enter validation code to validate items and earn fees</p>
                
                <form onsubmit="processValidation(event, '${currentMember.id}')">
                    <div class="form-group">
                        <label>Validation Code *</label>
                        <input type="text" name="code" required placeholder="VAL1-XXXXX-XXXX" style="text-transform: uppercase; letter-spacing: 2px;">
                    </div>
                    
                    <div style="background: #e3f2fd; padding: 20px; border-radius: 10px; margin: 20px 0;">
                        <h4>Validation Stages:</h4>
                        <ul style="margin: 10px 0 0 20px;">
                            <li><strong>Stage 1 (VAL1):</strong> Human validation - Verify claimer is real (5%)</li>
                            <li><strong>Stage 2 (VAL2):</strong> Value validation - Verify item quality (5%)</li>
                            <li><strong>Stage 3 (VAL3):</strong> Chain validation - Verify logistics (5%)</li>
                        </ul>
                    </div>
                    
                    <button type="submit" class="btn" style="width: 100%;">Validate & Earn</button>
                </form>
            </div>
        `;
        
        document.body.appendChild(modal);
    };
    
    // Process validation submission
    window.processValidation = async function(event, validatorId) {
        event.preventDefault();
        
        const formData = new FormData(event.target);
        const code = formData.get('code').toUpperCase();
        
        showNotification('‚è≥ Processing validation...', 'info');
        
        const result = await validateWithCode(code, validatorId);
        
        if (result.success) {
            closeAllModals();
            
            const modal = document.createElement('div');
            modal.className = 'modal';
            modal.style.display = 'block';
            modal.innerHTML = `
                <div class="modal-content">
                    <h2 style="color: #2ecc71; text-align: center;">‚úÖ Validation Successful!</h2>
                    
                    <div style="background: linear-gradient(45deg, #2ecc71, #27ae60); color: white; padding: 30px; border-radius: 15px; margin: 20px 0; text-align: center;">
                        <h3>Stage ${result.stage} Complete</h3>
                        <h1 style="font-size: 3rem; margin: 20px 0;">+${result.earningsIkbp.toFixed(2)} iKbp</h1>
                        <p style="font-size: 1.2rem;">KSH ${result.earnings.toFixed(2)}</p>
                    </div>
                    
                    <div style="background: #f8f9fa; padding: 20px; border-radius: 10px;">
                        <h4>Item Status:</h4>
                        <p>${result.item.status}</p>
                    </div>
                    
                    <button onclick="this.parentElement.parentElement.remove()" class="btn" style="width: 100%; margin-top: 20px;">Close</button>
                </div>
            `;
            document.body.appendChild(modal);
            
        } else {
            showNotification(`‚ùå ${result.error}`, 'error');
        }
    };
    
    // 2-Stage validation for tasks/activities
    window.validateTaskActivity = async function(itemId, itemType, validatorId) {
        const storageKey = itemType === 'task' ? 'tauTasks' : 'tauActivities';
        const items = JSON.parse(localStorage.getItem(storageKey) || '[]');
        const item = items.find(i => i.id === itemId);
        
        if (!item) {
            return { success: false, error: 'Item not found' };
        }
        
        // Stage 1: Member completion
        if (!item.completedBy) {
            return { success: false, error: 'Item not completed by member yet' };
        }
        
        // Stage 2: Admin approval
        item.validated = true;
        item.approvedBy = validatorId;
        item.approvedAt = new Date().toISOString();
        
        // Calculate transaction fee
        const reward = parseFloat(item.reward || 0);
        const fee = reward * TRANSACTION_FEE;
        const netReward = reward - fee;
        
        // Award member net reward
        if (window.TauDB?.updateBalance) {
            window.TauDB.updateBalance(item.completedBy, netReward);
        }
        
        // Award system fee
        const systemBalance = parseFloat(localStorage.getItem('systemBalance') || '0');
        localStorage.setItem('systemBalance', (systemBalance + fee).toString());
        
        // Save updated item
        const itemIndex = items.findIndex(i => i.id === itemId);
        items[itemIndex] = item;
        localStorage.setItem(storageKey, JSON.stringify(items));
        
        // Notify member
        if (typeof createNotification === 'function') {
            createNotification(
                item.completedBy,
                '‚úÖ Task/Activity Approved!',
                `Earned ${netReward.toFixed(2)} iKbp (${(reward * TRANSACTION_FEE * 100).toFixed(3)}% fee applied)`,
                'success'
            );
        }
        
        // Save to Firestore
        if (typeof firebase !== 'undefined' && firebase.apps.length > 0) {
            const db = firebase.firestore();
            const collection = itemType === 'task' ? 'tasks' : 'activities';
            await db.collection(collection).doc(itemId).set(item, { merge: true });
        }
        
        console.log(`‚úÖ ${itemType} approved. Fee: ${fee} iKbp, Net reward: ${netReward} iKbp`);
        
        return {
            success: true,
            netReward: netReward,
            fee: fee,
            item: item
        };
    };
    
    console.log('‚úÖ 3-Stage Validation System loaded');
})();
                </script>
    <script>
<!-- FINAL INITIALIZATION -->
console.log('='.repeat(60));
console.log('üöÄ TAU AFRICA - SYSTEM READY');
console.log('='.repeat(60));
console.log('‚úÖ All systems loaded and operational');
console.log('üí° Open browser console (F12) for full diagnostics');
console.log('='.repeat(60));
    </script>
    <script>
// ============================================
// VALIDATOR INTERFACE FIX
// ============================================
window.showValidatorInterface = function() {
    const currentMember = window.TauDB?.getCurrentMember();
    
    if (!currentMember) {
        showNotification('‚ùå Please login to validate', 'error');
        showRealMemberLogin();
        return;
    }
    
    const modal = document.createElement('div');
    modal.className = 'modal';
    modal.style.display = 'block';
    modal.innerHTML = `
        <div class="modal-content">
            <span class="close" onclick="this.parentElement.parentElement.remove()">&times;</span>
            
            <h2>üîê Validator Interface</h2>
            <p>Enter validation code to validate items and earn fees</p>
            
            <form onsubmit="processValidatorCode(event, '${currentMember.id}')">
                <div class="form-group">
                    <label>Validation Code *</label>
                    <input type="text" name="code" required placeholder="VAL1-XXXXX-XXXX" style="text-transform: uppercase; letter-spacing: 2px;">
                </div>
                
                <div style="background: #e3f2fd; padding: 20px; border-radius: 10px; margin: 20px 0;">
                    <h4>Validation Stages:</h4>
                    <ul style="margin: 10px 0 0 20px;">
                        <li><strong>Stage 1 (VAL1):</strong> Human validation - Verify claimer is real (5%)</li>
                        <li><strong>Stage 2 (VAL2):</strong> Value validation - Verify item quality (5%)</li>
                        <li><strong>Stage 3 (VAL3):</strong> Chain validation - Verify logistics (5%)</li>
                    </ul>
                </div>
                
                <button type="submit" class="btn" style="width: 100%;">Validate & Earn</button>
            </form>
        </div>
    `;
    
    document.body.appendChild(modal);
};

window.processValidatorCode = async function(event, validatorId) {
    event.preventDefault();
    
    const formData = new FormData(event.target);
    const code = formData.get('code').toUpperCase();
    
    showNotification('‚è≥ Processing validation...', 'info');
    
    if (typeof validateWithCode === 'function') {
        const result = await validateWithCode(code, validatorId);
        
        if (result.success) {
            closeAllModals();
            showNotification(`‚úÖ Validation Complete! Earned ${result.earningsIkbp.toFixed(2)} iKbp`, 'success');
        } else {
            showNotification(`‚ùå ${result.error}`, 'error');
        }
    } else {
        showNotification('‚ùå Validation system not loaded', 'error');
    }
};
    </script>
    <script>
// ============================================
// PULSING NOTIFICATION FOR PUBLIC USERS
// Invites non-members to join for full mining access
// ============================================

(function() {
    'use strict';
    
    console.log('üì¢ Loading Public User Notifications...');
    
    // Show pulsing notification for public/non-members
    function showPublicUpgradeNotification() {
        const currentMember = window.TauDB?.getCurrentMember();
        
        // Show for public members or non-logged-in users
        if (!currentMember || currentMember.type === 'public') {
            // Check if already shown recently
            const lastShown = localStorage.getItem('lastUpgradeNotif');
            if (lastShown && Date.now() - parseInt(lastShown) < 3600000) {
                // Don't show more than once per hour
                return;
            }
            
            // Check if notification already exists
            if (document.getElementById('upgradeNotification')) return;
            
            const notification = document.createElement('div');
            notification.id = 'upgradeNotification';
            notification.style.cssText = `
                position: fixed;
                bottom: 30px;
                right: 30px;
                width: 350px;
                background: linear-gradient(45deg, #667eea, #764ba2);
                color: white;
                padding: 20px;
                border-radius: 15px;
                box-shadow: 0 10px 30px rgba(0,0,0,0.3);
                z-index: 9999;
                animation: pulseNotif 2s infinite;
                cursor: pointer;
            `;
            
            notification.innerHTML = `
                <div style="position: absolute; top: 10px; right: 10px; cursor: pointer; font-size: 20px;" onclick="closeUpgradeNotif()">√ó</div>
                
                <div style="text-align: center;">
                    <div style="font-size: 3rem; margin-bottom: 10px;">‚ö°</div>
                    <h3 style="margin: 0 0 10px 0;">Unlock Full Mining Power!</h3>
                    <p style="margin: 0 0 15px 0; font-size: 0.9rem; opacity: 0.9;">
                        ${currentMember ? 'Upgrade to' : 'Join'} TASK or TALK membership to:
                    </p>
                    <ul style="text-align: left; margin: 0 0 15px 20px; font-size: 0.85rem;">
                        <li>Mine unlimited activities & tasks</li>
                        <li>Earn iKbp & iKb tokens</li>
                        <li>Access all values</li>
                        <li>Get welcome bonus: 500 iKbp</li>
                        <li>Earn referral rewards</li>
                    </ul>
                    <button onclick="showUpgradeOptions()" style="background: #ffd700; color: #333; border: none; padding: 12px 20px; border-radius: 25px; font-weight: bold; cursor: pointer; width: 100%; font-size: 14px;">
                        üöÄ Unlock Now
                    </button>
                </div>
            `;
            
            document.body.appendChild(notification);
            
            // Add pulsing animation
            const style = document.createElement('style');
            style.textContent = `
                @keyframes pulseNotif {
                    0%, 100% {
                        transform: scale(1);
                        box-shadow: 0 10px 30px rgba(102, 126, 234, 0.5);
                    }
                    50% {
                        transform: scale(1.05);
                        box-shadow: 0 10px 40px rgba(102, 126, 234, 0.8);
                    }
                }
            `;
            document.head.appendChild(style);
            
            // Mark as shown
            localStorage.setItem('lastUpgradeNotif', Date.now().toString());
            
            console.log('üì¢ Public upgrade notification shown');
        }
    }
    
    // Close notification
    window.closeUpgradeNotif = function() {
        const notif = document.getElementById('upgradeNotification');
        if (notif) notif.remove();
    };
    
    // Show upgrade options
    window.showUpgradeOptions = function() {
        closeUpgradeNotif();
        
        const modal = document.createElement('div');
        modal.className = 'modal';
        modal.style.display = 'block';
        modal.innerHTML = `
            <div class="modal-content">
                <span class="close" onclick="this.parentElement.parentElement.remove()">&times;</span>
                
                <div style="background: linear-gradient(45deg, #667eea, #764ba2); color: white; padding: 25px; border-radius: 15px; margin-bottom: 20px; text-align: center;">
                    <h2 style="margin: 0;">üöÄ Unlock Full Mining Access</h2>
                    <p style="margin: 10px 0 0 0;">Choose your membership level</p>
                </div>
                
                <!-- MEMBERSHIP OPTIONS -->
                <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 20px; margin-bottom: 20px;">
                    <!-- TASK TEAM -->
                    <div style="border: 3px solid #ff6b6b; border-radius: 15px; padding: 20px; text-align: center;">
                        <h3 style="color: #ff6b6b; margin: 0 0 10px 0;">üìö TASK Team</h3>
                        <div style="font-size: 2rem; font-weight: bold; color: #333; margin: 15px 0;">
                            KSH 500
                        </div>
                        <div style="background: #f8f9fa; padding: 15px; border-radius: 10px; margin-bottom: 15px; text-align: left;">
                            <strong>Benefits:</strong>
                            <ul style="margin: 10px 0 0 0; padding-left: 20px; font-size: 0.9rem;">
                                <li>Mine activities</li>
                                <li>Mine tasks</li>
                                <li>Submit & claim values</li>
                                <li>Earn iKbp & iKb</li>
                                <li>500 iKbp welcome bonus</li>
                                <li>Referral earnings</li>
                            </ul>
                        </div>
                        <button onclick="closeAllModals(); setTimeout(() => openModal('taskRegistration'), 500)" class="btn" style="width: 100%; background: #ff6b6b;">
                            Join TASK Team
                        </button>
                    </div>
                    
                    <!-- TALK TEAM -->
                    <div style="border: 3px solid #667eea; border-radius: 15px; padding: 20px; text-align: center;">
                        <h3 style="color: #667eea; margin: 0 0 10px 0;">üíº TALK Team</h3>
                        <div style="font-size: 2rem; font-weight: bold; color: #333; margin: 15px 0;">
                            KSH 2,000
                        </div>
                        <div style="background: #f8f9fa; padding: 15px; border-radius: 10px; margin-bottom: 15px; text-align: left;">
                            <strong>All TASK benefits +:</strong>
                            <ul style="margin: 10px 0 0 0; padding-left: 20px; font-size: 0.9rem;">
                                <li>Premium support</li>
                                <li>Higher earning limits</li>
                                <li>Investment opportunities</li>
                                <li>Enhanced referrals</li>
                                <li>Priority access</li>
                                <li>Exclusive programs</li>
                            </ul>
                        </div>
                        <button onclick="closeAllModals(); setTimeout(() => openModal('talkRegistration'), 500)" class="btn" style="width: 100%; background: #667eea;">
                            Join TALK Team
                        </button>
                    </div>
                </div>
                
                <!-- COMPARISON -->
                <div style="background: #fff3cd; padding: 15px; border-radius: 10px; margin-top: 20px;">
                    <strong>üí° Why Upgrade?</strong>
                    <p style="margin: 10px 0 0 0; font-size: 0.9rem;">
                        Public access is limited to submitting and claiming values only. 
                        Membership unlocks the full mining ecosystem: activities, tasks, unlimited earning potential, and community features.
                    </p>
                </div>
            </div>
        `;
        
        document.body.appendChild(modal);
    };
    
    // Show notification after 5 seconds of page load
    setTimeout(showPublicUpgradeNotification, 5000);
    
    // Show again every 5 minutes for public users
    setInterval(() => {
        const currentMember = window.TauDB?.getCurrentMember();
        if (!currentMember || currentMember.type === 'public') {
            showPublicUpgradeNotification();
        }
    }, 300000); // 5 minutes
    
    console.log('‚úÖ Public upgrade notifications loaded');
    
})();
    </script>
    <script>
        // ============================================
// TAU AFRICA - COMPLETE INTEGRATION FIX
// Add this to your main app HTML before closing </body>
// ============================================

(function() {
    'use strict';
    
    console.log('üîß TAU Complete Integration Fix - Loading...');
    
    // ============================================
    // 1. PUBLIC GALLERY - SHOW ALL APPROVED ITEMS
    // ============================================
    
    window.refreshPublicOpportunities = function() {
        const container = document.getElementById('publicOpportunitiesContainer');
        if (!container) {
            console.warn('Public opportunities container not found');
            return;
        }
        
        // Get all approved/validated items
        const tasks = JSON.parse(localStorage.getItem('tauTasks') || '[]')
            .filter(t => t.validated && t.status === 'Active');
        
        const activities = JSON.parse(localStorage.getItem('tauActivities') || '[]')
            .filter(a => a.validated && a.status === 'Active');
        
        const values = JSON.parse(localStorage.getItem('tauValues') || '[]')
            .filter(v => v.validated && v.status === 'Approved' && !v.claimedBy);
        
        console.log('üìä Public Gallery:', {
            tasks: tasks.length,
            activities: activities.length,
            values: values.length
        });
        
        // Apply current filter
        let filteredItems = [];
        const filter = currentFilter || 'all';
        
        if (filter === 'all' || filter === 'activities') {
            filteredItems = filteredItems.concat(activities.map(a => ({...a, type: 'activity'})));
        }
        if (filter === 'all' || filter === 'tasks') {
            filteredItems = filteredItems.concat(tasks.map(t => ({...t, type: 'task'})));
        }
        if (filter === 'all' || filter === 'values') {
            filteredItems = filteredItems.concat(values.map(v => ({...v, type: 'value'})));
        }
        
        if (filteredItems.length === 0) {
            container.innerHTML = `
                <div style="text-align: center; padding: 60px 20px; background: white; border-radius: 15px;">
                    <div style="font-size: 4rem; margin-bottom: 20px;">üì≠</div>
                    <h3 style="color: #666; margin-bottom: 10px;">No opportunities available yet</h3>
                    <p style="color: #999;">Check back soon or submit your own values!</p>
                </div>
            `;
            return;
        }
        
        // Render items
        container.innerHTML = `
            <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(300px, 1fr)); gap: 20px;">
                ${filteredItems.map(item => createOpportunityCard(item)).join('')}
            </div>
        `;
    };
    
    function createOpportunityCard(item) {
        const isValue = item.type === 'value';
        const currentMember = window.TauDB?.getCurrentMember();
        const canInteract = currentMember && (currentMember.team === 'TASK' || currentMember.team === 'TALK');
        
        const colorMap = {
            'activity': '#ff6b6b',
            'task': '#4169e1',
            'value': '#ffd700'
        };
        
        const iconMap = {
            'activity': 'üìö',
            'task': '‚úÖ',
            'value': 'üíé'
        };
        
        // Show validation stage for values
        let stageInfo = '';
        if (isValue && item.validationStages) {
            const stages = item.validationStages;
            const stage1 = stages.stage1?.validated;
            const stage2 = stages.stage2?.validated;
            const stage3 = stages.stage3?.validated;
            
            stageInfo = `
                <div style="display: flex; gap: 5px; margin: 10px 0;">
                    <div style="flex: 1; height: 8px; background: ${stage1 ? '#2ecc71' : '#ddd'}; border-radius: 4px;" title="Stage 1: Human Validation"></div>
                    <div style="flex: 1; height: 8px; background: ${stage2 ? '#2ecc71' : '#ddd'}; border-radius: 4px;" title="Stage 2: Quality Check"></div>
                    <div style="flex: 1; height: 8px; background: ${stage3 ? '#2ecc71' : '#ddd'}; border-radius: 4px;" title="Stage 3: Chain Verification"></div>
                </div>
                <div style="font-size: 11px; color: #666; margin-bottom: 10px;">
                    ${!stage1 ? '‚è≥ Awaiting Code 1' : !stage2 ? '‚è≥ Awaiting Code 2' : !stage3 ? '‚è≥ Awaiting Code 3' : '‚úÖ Fully Validated'}
                </div>
            `;
        }
        
        return `
            <div style="background: white; border-left: 4px solid ${colorMap[item.type]}; border-radius: 15px; padding: 25px; box-shadow: 0 5px 15px rgba(0,0,0,0.1); transition: transform 0.2s;">
                <div style="display: flex; justify-content: space-between; align-items: start; margin-bottom: 15px;">
                    <div style="flex: 1;">
                        <div style="font-size: 1.5rem; margin-bottom: 5px;">${iconMap[item.type]}</div>
                        <h3 style="margin: 0 0 10px 0; color: #2a5298;">${item.title}</h3>
                    </div>
                    <span style="background: ${colorMap[item.type]}; color: white; padding: 5px 12px; border-radius: 12px; font-size: 12px; font-weight: 600; white-space: nowrap;">
                        ${item.type.toUpperCase()}
                    </span>
                </div>
                
                <p style="color: #666; margin-bottom: 15px; line-height: 1.6;">${item.description}</p>
                
                ${stageInfo}
                
                <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 15px;">
                    <div style="background: ${colorMap[item.type]}; color: ${isValue ? '#333' : 'white'}; padding: 8px 15px; border-radius: 20px; font-weight: bold;">
                        ${isValue ? item.worthIkb + ' iKb' : item.reward + ' iKbp'}
                    </div>
                    ${item.category ? `<span style="font-size: 12px; color: #999;">${item.category}</span>` : ''}
                </div>
                
                ${isValue ? `
                    <button class="btn" onclick="handleValueClaim('${item.id}')" style="width: 100%; padding: 12px; background: linear-gradient(45deg, #ffd700, #f39c12);">
                        üíé Claim Value
                    </button>
                ` : `
                    <button class="btn" onclick="handleTaskActivityComplete('${item.type}', '${item.id}')" style="width: 100%; padding: 12px; background: ${colorMap[item.type]};">
                        ${canInteract ? '‚úÖ Complete & Earn' : 'üîí Login to Complete'}
                    </button>
                `}
                
                ${item.location ? `<div style="font-size: 12px; color: #999; margin-top: 10px;">üìç ${item.location}</div>` : ''}
            </div>
        `;
    }
    
    // Handle value claim
    window.handleValueClaim = function(valueId) {
        const values = JSON.parse(localStorage.getItem('tauValues') || '[]');
        const value = values.find(v => v.id === valueId);
        
        if (!value) {
            showNotification('‚ùå Value not found', 'error');
            return;
        }
        
        // Check validation stages
        const stages = value.validationStages || {};
        if (!stages.stage1?.validated) {
            showNotification('‚è≥ This value is awaiting Stage 1 validation (Code 1)', 'info');
            return;
        }
        if (!stages.stage2?.validated) {
            showNotification('‚è≥ This value is awaiting Stage 2 validation (Code 2)', 'info');
            return;
        }
        if (!stages.stage3?.validated) {
            showNotification('‚è≥ This value is awaiting Stage 3 validation (Code 3)', 'info');
            return;
        }
        
        // All stages complete - allow claiming
        openValueClaimModal(value);
    };
    
    function openValueClaimModal(value) {
        const currentMember = window.TauDB?.getCurrentMember();
        
        if (!currentMember) {
            showNotification('Please login or register to claim values', 'info');
            setTimeout(() => {
                showPublicRegistration();
            }, 1000);
            return;
        }
        
        closeAllModals();
        
        const modal = document.createElement('div');
        modal.className = 'modal';
        modal.style.display = 'block';
        modal.innerHTML = `
            <div class="modal-content">
                <span class="close" onclick="this.parentElement.parentElement.remove()">&times;</span>
                
                <h2>üíé Claim Value</h2>
                
                <div style="background: linear-gradient(45deg, #ffd700, #ffed4e); padding: 20px; border-radius: 10px; margin: 20px 0;">
                    <h3 style="color: #333; margin: 0 0 10px 0;">${value.title}</h3>
                    <p style="color: #666; margin: 0 0 10px 0;">${value.description}</p>
                    <div style="font-size: 1.5rem; font-weight: bold; color: #333;">
                        ${value.worthIkb} iKb
                        <span style="font-size: 1rem; opacity: 0.7;">(${value.worthKsh} KSH)</span>
                    </div>
                </div>
                
                <div style="background: #e8f5e9; padding: 15px; border-radius: 10px; margin-bottom: 20px;">
                    <strong>‚úÖ Fully Validated</strong>
                    <div style="display: flex; gap: 5px; margin-top: 10px;">
                        <div style="flex: 1; height: 8px; background: #2ecc71; border-radius: 4px;"></div>
                        <div style="flex: 1; height: 8px; background: #2ecc71; border-radius: 4px;"></div>
                        <div style="flex: 1; height: 8px; background: #2ecc71; border-radius: 4px;"></div>
                    </div>
                    <div style="font-size: 12px; color: #666; margin-top: 5px;">
                        All 3 validation stages complete
                    </div>
                </div>
                
                <form onsubmit="submitValueClaim(event, '${value.id}', '${currentMember.id}')">
                    <div class="form-group">
                        <label>How will you provide/exchange this value? *</label>
                        <textarea name="proposal" rows="4" required placeholder="Describe your plan to deliver or receive this value..."></textarea>
                    </div>
                    
                    <button type="submit" class="btn" style="width: 100%; background: linear-gradient(45deg, #ffd700, #f39c12);">
                        Submit Claim
                    </button>
                </form>
            </div>
        `;
        
        document.body.appendChild(modal);
    }

    window.submitValueClaim = async function(event, valueId, memberId) {
        event.preventDefault();
        
        const formData = new FormData(event.target);
        const proposal = formData.get('proposal');
        
        const values = JSON.parse(localStorage.getItem('tauValues') || '[]');
        const valueIndex = values.findIndex(v => v.id === valueId);
        
        if (valueIndex === -1) {
            showNotification('‚ùå Value not found', 'error');
            return;
        }
        
        // Update value
        values[valueIndex].claimedBy = memberId;
        values[valueIndex].claimedAt = new Date().toISOString();
        values[valueIndex].claimProposal = proposal;
        values[valueIndex].status = 'Claimed - In Progress';
        
        localStorage.setItem('tauValues', JSON.stringify(values));
        
        // Save to Firestore
        if (typeof firebase !== 'undefined' && firebase.apps.length > 0) {
            try {
                const db = firebase.firestore();
                await db.collection('values').doc(valueId).set(values[valueIndex], { merge: true });
            } catch (error) {
                console.warn('Firestore sync warning:', error);
            }
        }
        
        // Notify submitter
        if (typeof createNotification === 'function') {
            createNotification(
                values[valueIndex].submittedBy,
                'üíé Your Value Was Claimed!',
                `"${values[valueIndex].title}" was claimed by a member`,
                'success'
            );
        }
        
        showNotification('‚úÖ Value claimed! Provider will be notified.', 'success');
        closeAllModals();
        refreshPublicOpportunities();
      }
    // Handle task/activity completion
    window.handleTaskActivityComplete = function(type, itemId) {
        const currentMember = window.TauDB?.getCurrentMember();
        
        if (!currentMember) {
            showNotification('Please register to complete tasks and activities', 'info');
            setTimeout(() => {
                const modal = document.createElement('div');
                modal.className = 'modal';
                modal.style.display = 'block';
                modal.innerHTML = `
                    <div class="modal-content">
                        <span class="close" onclick="this.parentElement.parentElement.remove()">&times;</span>
                        
                        <h2>üîí Members Only</h2>
                        <p>Tasks and activities are available to TASK and TALK members only.</p>
                        
                        <div style="background: #fff3cd; padding: 20px; border-radius: 10px; margin: 20px 0;">
                            <strong>Join to unlock:</strong>
                            <ul style="margin: 10px 0 0 20px;">
                                <li>Complete tasks & activities</li>
                                <li>Earn iKbp & iKb</li>
                                <li>Submit & claim values</li>
                                <li>Access full mining</li>
                            </ul>
                        </div>
                        
                        <button onclick="closeAllModals(); setTimeout(() => openModal('taskRegistration'), 500)" class="btn" style="width: 100%; margin-bottom: 10px;">
                            Join TASK Team (KSH 500)
                        </button>
                        <button onclick="closeAllModals(); setTimeout(() => openModal('talkRegistration'), 500)" class="btn" style="width: 100%;">
                            Join TALK Team (KSH 2,000)
                        </button>
                    </div>
                `;
                document.body.appendChild(modal);
            }, 500);
            return;
        }
        
        // Check if member can interact
        if (currentMember.type === 'public') {
            showNotification('Please upgrade to TASK or TALK membership', 'info');
            setTimeout(() => showUpgradeOptions(), 500);
            return;
        }
        
        // Member can interact - show completion modal
        const storageKey = type === 'task' ? 'tauTasks' : 'tauActivities';
        const items = JSON.parse(localStorage.getItem(storageKey) || '[]');
        const item = items.find(i => i.id === itemId);
        
        if (!item) {
            showNotification('‚ùå Item not found', 'error');
            return;
        }
        
        const modal = document.createElement('div');
        modal.className = 'modal';
        modal.style.display = 'block';
        modal.innerHTML = `
            <div class="modal-content">
                <span class="close" onclick="this.parentElement.parentElement.remove()">&times;</span>
                
                <h2>${type === 'task' ? '‚úÖ' : 'üìö'} Complete ${type === 'task' ? 'Task' : 'Activity'}</h2>
                
                <div style="background: #f8f9fa; padding: 20px; border-radius: 10px; margin: 20px 0;">
                    <h3 style="margin: 0 0 10px 0;">${item.title}</h3>
                    <p style="margin: 0 0 10px 0;">${item.description}</p>
                    <div style="font-size: 1.2rem; font-weight: bold; color: #ffd700;">
                        Reward: ${item.reward} iKbp
                    </div>
                </div>
                
                <form onsubmit="submitCompletion(event, '${type}', '${itemId}', '${currentMember.id}')">
                    <div class="form-group">
                        <label>Proof of Completion *</label>
                        <textarea name="proof" rows="4" required placeholder="Describe what you did, provide links, attach evidence..."></textarea>
                    </div>
                    
                    <button type="submit" class="btn" style="width: 100%;">
                        Submit for Validation
                    </button>
                </form>
            </div>
        `;
        
        document.body.appendChild(modal);
        }
    window.submitCompletion = async function(event, type, itemId, memberId) {
        event.preventDefault();
        
        const formData = new FormData(event.target);
        const proof = formData.get('proof');
        
        const storageKey = type === 'task' ? 'tauTasks' : 'tauActivities';
        const items = JSON.parse(localStorage.getItem(storageKey) || '[]');
        const item = items.find(i => i.id === itemId);
        
        if (!item) {
            showNotification('‚ùå Item not found', 'error');
            return;
        }
        
        // Add to member's record
        const members = JSON.parse(localStorage.getItem('tauAfricaDB') || '[]');
        const memberIndex = members.findIndex(m => m.id === memberId);
        
        if (memberIndex === -1) {
            showNotification('‚ùå Member not found', 'error');
            return;
        }
        
        const completionRecord = {
            ...item,
            completedAt: new Date().toISOString(),
            proof: proof,
            status: 'Pending Approval',
            approvedReward: 0
        };
        
        if (type === 'task') {
            if (!members[memberIndex].tasks) members[memberIndex].tasks = [];
            members[memberIndex].tasks.push(completionRecord);
        } else {
            if (!members[memberIndex].activities) members[memberIndex].activities = [];
            members[memberIndex].activities.push(completionRecord);
        }
        
        localStorage.setItem('tauAfricaDB', JSON.stringify(members));
        
        // Create admin notification
        const adminNotifs = JSON.parse(localStorage.getItem('tauAdminNotifications') || '[]');
        adminNotifs.unshift({
            id: 'ADMIN-' + Date.now(),
            type: type + '_completion',
            data: {
                memberId: memberId,
                memberName: members[memberIndex].fullName,
                itemTitle: item.title,
                itemId: itemId,
                proof: proof,
                reward: item.reward
            },
            timestamp: new Date().toISOString(),
            read: false
        });
        localStorage.setItem('tauAdminNotifications', JSON.stringify(adminNotifs));
        
        // Notify member
        if (typeof createNotification === 'function') {
            createNotification(
                memberId,
                '‚úÖ Submitted for Review',
                `Your ${type} completion is pending admin approval`,
                'info'
            );
        }
        
        showNotification('‚úÖ Submitted! You\'ll be notified when approved.', 'success');
        closeAllModals();
    };
 </script>
    <script>
    // ============================================
    // 2. ENHANCED MEMBER DASHBOARD WITH DROPDOWN
    // ============================================
    
    window.showRealMemberDashboard = window.showEnhancedMemberDashboard = function(member) {
        if (!member) {
            member = window.TauDB?.getCurrentMember();
            if (!member) {
                showNotification('Please login first', 'error');
                showRealMemberLogin();
                return;
            }
        }
        
        // Refresh member data
        const members = JSON.parse(localStorage.getItem('tauAfricaDB') || '[]');
        const freshMember = members.find(m => m.id === member.id) || member;
        
        const myTasks = freshMember.tasks || [];
        const myActivities = freshMember.activities || [];
        
        const completedTasks = myTasks.filter(t => t.status === 'Completed' || t.status === 'Approved').length;
        const completedActivities = myActivities.filter(a => a.status === 'Completed' || a.status === 'Approved').length;
        const pendingTasks = myTasks.filter(t => t.status === 'Pending Approval').length;
        const pendingActivities = myActivities.filter(a => a.status === 'Pending Approval').length;
        
        closeAllModals();
        
        const modal = document.createElement('div');
        modal.className = 'modal';
        modal.style.display = 'block';
        modal.innerHTML = `
            <div class="modal-content" style="max-width: 1200px; max-height: 90vh; overflow-y: auto;">
                <span class="close" onclick="sessionStorage.removeItem('tauCurrentUser'); this.parentElement.parentElement.remove()">&times;</span>
                
                <!-- HEADER -->
                <div style="background: linear-gradient(45deg, #4169e1, #87ceeb); color: white; padding: 25px; border-radius: 15px; margin-bottom: 20px;">
                    <div style="display: flex; justify-content: space-between; align-items: center; flex-wrap: wrap;">
                        <div>
                            <h1 style="margin: 0;">Welcome, ${freshMember.fullName}! üëã</h1>
                            <p style="margin: 10px 0 0 0; opacity: 0.9;">
                                ${freshMember.team} Member ‚Ä¢ ID: ${freshMember.id}
                            </p>
                        </div>
                        <div style="text-align: right;">
                            <button onclick="showAccountDetails('${freshMember.id}')" class="btn" style="background: rgba(255,255,255,0.2); margin-right: 10px;">
                                üìã Account Details
                            </button>
                            <button onclick="window.TauDB.logout(); sessionStorage.removeItem('tauCurrentUser'); location.reload();" class="btn" style="background: rgba(255,255,255,0.2);">
                                üö™ Logout
                            </button>
                        </div>
                    </div>
                </div>
                
                <!-- BALANCE CARDS -->
                <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(200px, 1fr)); gap: 15px; margin-bottom: 30px;">
                    <div style="background: linear-gradient(45deg, #ffd700, #ffed4e); padding: 25px; border-radius: 15px; text-align: center; color: #333;">
                        <h3 style="margin: 0 0 10px 0;">üí∞ iKbp Balance</h3>
                        <h1 style="font-size: 2.5rem; margin: 0;">${(freshMember.iKbpBalance || 0).toLocaleString()}</h1>
                        <p style="margin: 10px 0 0 0;">${((freshMember.iKbpBalance || 0) / 10).toFixed(2)} KSH</p>
                    </div>
                    
                    <div style="background: linear-gradient(45deg, #667eea, #764ba2); padding: 25px; border-radius: 15px; text-align: center; color: white;">
                        <h3 style="margin: 0 0 10px 0;">üíé iKb Balance</h3>
                        <h1 style="font-size: 2.5rem; margin: 0;">${(freshMember.iKbBalance || 0).toFixed(4)}</h1>
                        <p style="margin: 10px 0 0 0;">${((freshMember.iKbBalance || 0) * 100000).toLocaleString()} KSH</p>
                    </div>
                    
                    <div style="background: linear-gradient(45deg, #ff6b6b, #ee5a24); padding: 25px; border-radius: 15px; text-align: center; color: white;">
                        <h3 style="margin: 0 0 10px 0;">üéÅ Referral Code</h3>
                        <h1 style="font-size: 1.8rem; margin: 0; letter-spacing: 3px;">${freshMember.referralCode}</h1>
                        <button onclick="copyReferralLink('${freshMember.referralCode}')" class="btn" style="margin-top: 10px; background: rgba(255,255,255,0.2); color: white; width: 100%;">
                            üìã Copy Link
                        </button>
                    </div>
                </div>
                
                <!-- PROGRESS STATS -->
                <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(150px, 1fr)); gap: 10px; margin-bottom: 30px;">
                    <div style="background: #e3f2fd; padding: 15px; border-radius: 10px; text-align: center;">
                        <div style="font-size: 2rem; font-weight: bold; color: #2196f3;">${completedActivities}</div>
                        <div style="font-size: 0.9rem; color: #666;">Activities Done</div>
                    </div>
                    <div style="background: #f3e5f5; padding: 15px; border-radius: 10px; text-align: center;">
                        <div style="font-size: 2rem; font-weight: bold; color: #9c27b0;">${completedTasks}</div>
                        <div style="font-size: 0.9rem; color: #666;">Tasks Done</div>
                    </div>
                    <div style="background: #fff3e0; padding: 15px; border-radius: 10px; text-align: center;">
                        <div style="font-size: 2rem; font-weight: bold; color: #ff9800;">${pendingActivities}</div>
                        <div style="font-size: 0.9rem; color: #666;">Activities Pending</div>
                    </div>
                    <div style="background: #e8f5e9; padding: 15px; border-radius: 10px; text-align: center;">
                        <div style="font-size: 2rem; font-weight: bold; color: #4caf50;">${pendingTasks}</div>
                        <div style="font-size: 0.9rem; color: #666;">Tasks Pending</div>
                    </div>
                </div>
                <!-- MINING SECTIONS WITH HORIZONTAL SCROLL -->
<div style="margin-bottom: 30px;">
    <h3 style="margin-bottom: 15px;">‚õèÔ∏è Mining Sections</h3>
    <div style="overflow-x: auto; -webkit-overflow-scrolling: touch;">
        <div style="display: flex; gap: 20px; padding-bottom: 10px; min-width: min-content;">
            <div style="min-width: 300px; background: white; border: 3px solid #ff6b6b; border-radius: 15px; padding: 20px; flex-shrink: 0;">
                <h3 style="color: #ff6b6b; margin: 0 0 15px 0;">üìö ACTIVITIES</h3>
                <div style="margin-bottom: 15px;">
                    <div style="font-size: 0.9rem; color: #666;">Completed: ${completedActivities}</div>
                    <div style="font-size: 0.9rem; color: #666;">Pending: ${pendingActivities}</div>
                </div>
                <button onclick="showActivitiesMining('${freshMember.id}')" class="btn" style="width: 100%; background: #ff6b6b;">
                    ‚õèÔ∏è Mine Activities
                </button>
            </div>
            
            <div style="min-width: 300px; background: white; border: 3px solid #667eea; border-radius: 15px; padding: 20px; flex-shrink: 0;">
                <h3 style="color: #667eea; margin: 0 0 15px 0;">‚úÖ TASKS</h3>
                <div style="margin-bottom: 15px;">
                    <div style="font-size: 0.9rem; color: #666;">Completed: ${completedTasks}</div>
                    <div style="font-size: 0.9rem; color: #666;">Pending: ${pendingTasks}</div>
                </div>
                <button onclick="showTasksMining('${freshMember.id}')" class="btn" style="width: 100%; background: #667eea;">
                    ‚õèÔ∏è Mine Tasks
                </button>
            </div>
            
            <div style="min-width: 300px; background: white; border: 3px solid #ffd700; border-radius: 15px; padding: 20px; flex-shrink: 0;">
                <h3 style="color: #f39c12; margin: 0 0 15px 0;">üíé VALUES</h3>
                <button onclick="showValuesMining('${freshMember.id}')" class="btn" style="width: 100%; background: linear-gradient(45deg, #ffd700, #f39c12);">
                    ‚õèÔ∏è Mine Values
                </button>
            </div>
        </div>
    </div>
</div>
                
                <!-- KABIRU TRANSFER -->
                <div style="background: linear-gradient(45deg, #FFD700, #FFA500); padding: 20px; border-radius: 15px; text-align: center; margin-bottom: 20px;">
                    <h3 style="color: #333; margin: 0 0 15px 0;">üí∏ Kabiru Mining Transfer</h3>
                    <button onclick="initiateKabiruWithdrawal()" class="btn" style="width: 100%; max-width: 400px; background: #333; color: #FFD700; font-size: 16px;">
                        Transfer to Kabiru Mining App
                    </button>
                    <p style="color: #333; font-size: 12px; margin: 10px 0 0 0;">Minimum: 10,000 iKbp or 0.0001 iKb</p>
                </div>
            </div>
        `;
        
        document.body.appendChild(modal);
    };
    
    // Account details dropdown
    window.showAccountDetails = function(memberId) {
        const members = JSON.parse(localStorage.getItem('tauAfricaDB') || '[]');
        const member = members.find(m => m.id === memberId);
        
        if (!member) return;
        
        const modal = document.createElement('div');
        modal.className = 'modal';
        modal.style.display = 'block';
        modal.innerHTML = `
            <div class="modal-content">
                <span class="close" onclick="this.parentElement.parentElement.remove()">&times;</span>
                
                <h2>üìã Full Account Details</h2>
                
                <div style="background: #f8f9fa; padding: 20px; border-radius: 10px; margin: 20px 0;">
                    <table style="width: 100%; border-collapse: collapse;">
                        <tr style="border-bottom: 1px solid #ddd;">
                            <td style="padding: 12px; font-weight: bold; width: 200px;">Member ID</td>
                            <td style="padding: 12px;">${member.id}</td>
                        </tr>
                        <tr style="border-bottom: 1px solid #ddd;">
                            <td style="padding: 12px; font-weight: bold;">Full Name</td>
                            <td style="padding: 12px;">${member.fullName}</td>
                        </tr>
                        <tr style="border-bottom: 1px solid #ddd;">
                            <td style="padding: 12px; font-weight: bold;">Email</td>
                            <td style="padding: 12px;">${member.email}</td>
                        </tr>
                        <tr style="border-bottom: 1px solid #ddd;">
                            <td style="padding: 12px; font-weight: bold;">Phone</td>
                            <td style="padding: 12px;">${member.phone}</td>
                        </tr>
                        <tr style="border-bottom: 1px solid #ddd;">
                            <td style="padding: 12px; font-weight: bold;">Location</td>
                            <td style="padding: 12px;">${member.location}</td>
                        </tr>
                        <tr style="border-bottom: 1px solid #ddd;">
                            <td style="padding: 12px; font-weight: bold;">Team</td>
                            <td style="padding: 12px;">${member.team}</td>
                        </tr>
                        <tr style="border-bottom: 1px solid #ddd;">
                            <td style="padding: 12px; font-weight: bold;">Membership Type</td>
                            <td style="padding: 12px;">${member.type || member.team}</td>
                        </tr>
                        <tr style="border-bottom: 1px solid #ddd;">
                            <td style="padding: 12px; font-weight: bold;">Status</td>
                            <td style="padding: 12px;"><span style="color: #27ae60; font-weight: bold;">${member.status}</span></td>
                        </tr>
                        <tr style="border-bottom: 1px solid #ddd;">
                            <td style="padding: 12px; font-weight: bold;">Date Joined</td>
                            <td style="padding: 12px;">${member.dateJoined || new Date(member.accountCreated).toLocaleDateString()}</td>
                        </tr>
                        <tr style="border-bottom: 1px solid #ddd;">
                            <td style="padding: 12px; font-weight: bold;">Last Login</td>
                            <td style="padding: 12px;">${member.lastLogin ? new Date(member.lastLogin).toLocaleString() : 'Never'}</td>
                        </tr>
                        <tr style="border-bottom: 1px solid #ddd;">
                            <td style="padding: 12px; font-weight: bold;">Referral Code</td>
                            <td style="padding: 12px;">${member.referralCode}</td>
                        </tr>
                        <tr style="border-bottom: 1px solid #ddd;">
                            <td style="padding: 12px; font-weight: bold;">Referred By</td>
                            <td style="padding: 12px;">${member.referredBy || 'Direct Registration'}</td>
                        </tr>
                        <tr style="border-bottom: 1px solid #ddd;">
                            <td style="padding: 12px; font-weight: bold;">Registration Fee</td>
                            <td style="padding: 12px;">KSH ${member.fee}</td>
                        </tr>
                        <tr style="border-bottom: 1px solid #ddd;">
                            <td style="padding: 12px; font-weight: bold;">Payment Status</td>
                            <td style="padding: 12px;"><span style="color: #27ae60; font-weight: bold;">${member.paymentStatus}</span></td>
                        </tr>
                    </table>
                </div>
                
                <button onclick="this.parentElement.parentElement.remove()" class="btn" style="width: 100%;">Close</button>
            </div>
        `;
        
        document.body.appendChild(modal);
    };
    
    // ============================================
    // 3. 3-STAGE VALUE VALIDATION WITH INSTRUCTIONS
    // ============================================
    
    // Enhanced validator interface with stage instructions
    window.showValidatorInterface = function() {
        const currentMember = window.TauDB?.getCurrentMember();
        
        if (!currentMember) {
            showNotification('‚ùå Please login first', 'error');
            showRealMemberLogin();
            return;
        }
        
        const modal = document.createElement('div');
        modal.className = 'modal';
        modal.style.display = 'block';
        modal.innerHTML = `
            <div class="modal-content">
                <span class="close" onclick="this.parentElement.parentElement.remove()">&times;</span>
                
                <div style="background: linear-gradient(45deg, #9b59b6, #8e44ad); color: white; padding: 25px; border-radius: 15px; margin-bottom: 20px;">
                    <h2 style="margin: 0;">üîê Validator Interface</h2>
                    <p style="margin: 10px 0 0 0;">Enter validation codes to validate items and earn fees</p>
                </div>
                
                <form onsubmit="processValidatorCode(event, '${currentMember.id}')">
                    <div class="form-group">
                        <label>Validation Code *</label>
                        <input type="text" name="code" required placeholder="VAL1-XXXXX-XXXX or VAL2-XXXXX-XXXX or VAL3-XXXXX-XXXX" style="text-transform: uppercase; letter-spacing: 2px; font-size: 16px; text-align: center;">
                    </div>
                    
                    <div style="background: #f0f4ff; padding: 20px; border-radius: 10px; margin: 20px 0;">
                        <h4 style="margin: 0 0 15px 0; color: #1976d2;">üìã Validation Process:</h4>
                        
                        <div style="display: grid; gap: 15px;">
                            <!-- Stage 1 -->
                            <div style="background: white; padding: 15px; border-radius: 10px; border-left: 4px solid #3498db;">
                                <div style="display: flex; align-items: center; margin-bottom: 10px;">
                                    <div style="background: #3498db; color: white; width: 40px; height: 40px; border-radius: 50%; display: flex; align-items: center; justify-content: center; font-weight: bold; margin-right: 15px;">1</div>
                                    <div>
                                        <strong style="color: #3498db;">Stage 1: Human Validation (5%)</strong>
                                        <div style="font-size: 12px; color: #666;">Code format: VAL1-XXXXX-XXXX</div>
                                    </div>
                                </div>
                                <div style="font-size: 14px; color: #666; margin-left: 55px;">
                                    ‚úì Verify the claimer is a real person<br>
                                    ‚úì Check identity documents<br>
                                    ‚úì Confirm contact information<br>
                                    <strong style="color: #e74c3c;">‚ö†Ô∏è Value waits here until Code 1 is entered</strong>
                                </div>
                            </div>
                            
                            <!-- Stage 2 -->
                            <div style="background: white; padding: 15px; border-radius: 10px; border-left: 4px solid #f39c12;">
                                <div style="display: flex; align-items: center; margin-bottom: 10px;">
                                    <div style="background: #f39c12; color: white; width: 40px; height: 40px; border-radius: 50%; display: flex; align-items: center; justify-content: center; font-weight: bold; margin-right: 15px;">2</div>
                                    <div>
                                        <strong style="color: #f39c12;">Stage 2: Quality Validation (5%)</strong>
                                        <div style="font-size: 12px; color: #666;">Code format: VAL2-XXXXX-XXXX</div>
                                    </div>
                                </div>
                                <div style="font-size: 14px; color: #666; margin-left: 55px;">
                                    ‚úì Verify value quality and authenticity<br>
                                    ‚úì Check product/service standards<br>
                                    ‚úì Confirm worth assessment<br>
                                    <strong style="color: #e74c3c;">‚ö†Ô∏è Value waits here until Code 2 is entered</strong>
                                </div>
                            </div>
                            
                            <!-- Stage 3 -->
                            <div style="background: white; padding: 15px; border-radius: 10px; border-left: 4px solid #2ecc71;">
                                <div style="display: flex; align-items: center; margin-bottom: 10px;">
                                    <div style="background: #2ecc71; color: white; width: 40px; height: 40px; border-radius: 50%; display: flex; align-items: center; justify-content: center; font-weight: bold; margin-right: 15px;">3</div>
                                    <div>
                                        <strong style="color: #2ecc71;">Stage 3: Chain Validation (5%)</strong>
                                        <div style="font-size: 12px; color: #666;">Code format: VAL3-XXXXX-XXXX</div>
                                    </div>
        </div>
        <div style="font-size: 14px; color: #666; margin-left: 55px;">
                                    ‚úì Verify logistics and delivery capability<br>
                                    ‚úì Confirm value transfer method<br>
                                    ‚úì Approve for final release<br>
                                    <strong style="color: #27ae60;">‚úÖ After Code 3, value is fully validated and ready</strong>
                                </div>
                            </div>
                        </div>
                    </div>
                    
                    <div style="background: #fff3cd; padding: 15px; border-radius: 10px; margin-bottom: 20px;">
                        <strong>üí° Important:</strong>
                        <ul style="margin: 10px 0 0 20px; font-size: 14px;">
                            <li>Codes must be used in order: Code 1 ‚Üí Code 2 ‚Üí Code 3</li>
                            <li>Cannot skip stages</li>
                            <li>Each validator earns 5% of the 30% total validation fee</li>
                            <li>System takes 15%, validators share 15%</li>
                        </ul>
                    </div>
                    
                    <button type="submit" class="btn" style="width: 100%; background: #9b59b6; font-size: 16px; padding: 15px;">
                        ‚úÖ Validate & Earn
                    </button>
                </form>
            </div>
        `;
        
        document.body.appendChild(modal);
    };
    
    window.processValidatorCode = async function(event, validatorId) {
        event.preventDefault();
        
        const formData = new FormData(event.target);
        const code = formData.get('code').toUpperCase().trim();
        
        showNotification('‚è≥ Processing validation...', 'info');
        
        // Validate the code
        const codes = JSON.parse(localStorage.getItem('tauValidatorCodes') || '[]');
        const codeObj = codes.find(c => c.code === code && c.status === 'pending');
        
        if (!codeObj) {
            showNotification('‚ùå Invalid or already used code', 'error');
            return;
        }
        
        const { itemType, itemId, stage } = codeObj;
        
        // Get the item
        const storageKey = itemType === 'value' ? 'tauValues' : 'tauJobsPortal';
        const items = JSON.parse(localStorage.getItem(storageKey) || '[]');
        const itemIndex = items.findIndex(i => i.id === itemId);
        
        if (itemIndex === -1) {
            showNotification('‚ùå Item not found', 'error');
            return;
        }
        
        const item = items[itemIndex];
        
        // Check if previous stages are complete
        if (stage === 2 && !item.validationStages?.stage1?.validated) {
            showNotification('‚ùå Stage 1 must be completed first (Code 1 required)', 'error');
            return;
        }
        
        if (stage === 3 && (!item.validationStages?.stage1?.validated || !item.validationStages?.stage2?.validated)) {
            showNotification('‚ùå Stages 1 and 2 must be completed first (Codes 1 & 2 required)', 'error');
            return;
        }
        
        // Mark code as used
        const codeIndex = codes.findIndex(c => c.code === code);
        codes[codeIndex].status = 'used';
        codes[codeIndex].validatedBy = validatorId;
        codes[codeIndex].validatedAt = new Date().toISOString();
        localStorage.setItem('tauValidatorCodes', JSON.stringify(codes));
        
        // Update item validation stage
        if (!item.validationStages) {
            item.validationStages = {};
        }
        
        item.validationStages[`stage${stage}`] = {
            validated: true,
            validatedBy: validatorId,
            validatedAt: new Date().toISOString(),
            code: code
        };
        
        // Update item status based on stage
        if (stage === 1) {
            item.status = 'Stage 1 Complete - Awaiting Code 2';
        } else if (stage === 2) {
            item.status = 'Stage 2 Complete - Awaiting Code 3';
        } else if (stage === 3) {
            item.status = 'Approved';
            item.validated = true;
        }
        
        // Calculate earnings
        const worthKsh = parseFloat(item.worthKsh || 0);
        const totalFee = worthKsh * 0.30; // 30%
        const validatorEarning = totalFee * (0.05 / 0.30); // 5% of total value
        const earningsIkbp = validatorEarning * 10; // Convert to iKbp
        
        // Save updated item
        items[itemIndex] = item;
        localStorage.setItem(storageKey, JSON.stringify(items));
        
        // Award validator
        if (window.TauDB?.updateBalance) {
            window.TauDB.updateBalance(validatorId, earningsIkbp);
        }
        
        // Save to Firestore
        if (typeof firebase !== 'undefined' && firebase.apps.length > 0) {
            try {
                const db = firebase.firestore();
                await db.collection('validationCodes').doc(codes[codeIndex].id).set(codes[codeIndex], { merge: true });
                if (itemType === 'value') {
                    await db.collection('values').doc(itemId).set(item, { merge: true });
                }
            } catch (error) {
                console.warn('Firestore sync warning:', error);
            }
        }
        
        // Create notification
        if (typeof createNotification === 'function') {
            createNotification(
                validatorId,
                `‚úÖ Stage ${stage} Validation Complete!`,
                `Earned ${earningsIkbp.toFixed(2)} iKbp (${validatorEarning.toFixed(2)} KSH)`,
                'success'
            );
        }
        
        closeAllModals();
        
        // Show success modal
        const successModal = document.createElement('div');
        successModal.className = 'modal';
        successModal.style.display = 'block';
        successModal.innerHTML = `
            <div class="modal-content">
                <h2 style="color: #2ecc71; text-align: center;">‚úÖ Validation Successful!</h2>
                
                <div style="background: linear-gradient(45deg, #2ecc71, #27ae60); color: white; padding: 30px; border-radius: 15px; margin: 20px 0; text-align: center;">
                    <h3>Stage ${stage} Complete</h3>
                    <h1 style="font-size: 3rem; margin: 20px 0;">+${earningsIkbp.toFixed(2)} iKbp</h1>
                    <p style="font-size: 1.2rem;">KSH ${validatorEarning.toFixed(2)}</p>
                </div>
                
                <div style="background: #f8f9fa; padding: 20px; border-radius: 10px;">
                    <h4>Item: ${item.title}</h4>
                    <p><strong>Status:</strong> ${item.status}</p>
                    
                    <div style="display: flex; gap: 5px; margin: 15px 0;">
                        <div style="flex: 1; height: 10px; background: ${item.validationStages?.stage1?.validated ? '#2ecc71' : '#ddd'}; border-radius: 5px;"></div>
                        <div style="flex: 1; height: 10px; background: ${item.validationStages?.stage2?.validated ? '#2ecc71' : '#ddd'}; border-radius: 5px;"></div>
                        <div style="flex: 1; height: 10px; background: ${item.validationStages?.stage3?.validated ? '#2ecc71' : '#ddd'}; border-radius: 5px;"></div>
                    </div>
                    
                    <p style="font-size: 14px; color: #666;">
                        ${stage === 3 ? '‚úÖ Fully validated - Ready for claiming!' : `‚è≥ Awaiting Code ${stage + 1}`}
                    </p>
                </div>
                
                <button onclick="this.parentElement.parentElement.remove(); refreshPublicOpportunities();" class="btn" style="width: 100%; margin-top: 20px;">Close</button>
            </div>
        `;
        document.body.appendChild(successModal);
        
        // Refresh public gallery if stage 3 complete
        if (stage === 3) {
            setTimeout(() => {
                if (typeof refreshPublicOpportunities === 'function') {
                    refreshPublicOpportunities();
                }
            }, 500);
        }
        
        console.log(`‚úÖ Stage ${stage} validated. Validator earned ${earningsIkbp} iKbp`);
    };
    
    // ============================================
    // 4. ADMIN VALUE POSTING (Generate 3 Codes)
    // ============================================
    
    window.generateValidationCodes = async function(itemType, itemId) {
        const storageKey = itemType === 'value' ? 'tauValues' : 'tauJobsPortal';
        const item = JSON.parse(localStorage.getItem(storageKey) || '[]').find(i => i.id === itemId);
        
        if (!item) {
            showNotification('‚ùå Item not found', 'error');
            return;
        }
        
        const codes = [];
        const allCodes = JSON.parse(localStorage.getItem('tauValidatorCodes') || '[]');
        
        // Generate 3 codes
        for (let stage = 1; stage <= 3; stage++) {
            const prefix = `VAL${stage}`;
            const timestamp = Date.now().toString(36).toUpperCase();
            const random = Math.random().toString(36).substring(2, 6).toUpperCase();
            const code = `${prefix}-${timestamp}-${random}`;
            
            const validationCode = {
                id: `CODE-${Date.now()}-${stage}`,
                code: code,
                itemType: itemType,
                itemId: itemId,
                stage: stage,
                status: 'pending',
                created: new Date().toISOString(),
                validatedBy: null,
                validatedAt: null
            };
            
            codes.push(validationCode);
            allCodes.push(validationCode);
        }
        
        localStorage.setItem('tauValidatorCodes', JSON.stringify(allCodes));
        
        // Save to Firestore
        if (typeof firebase !== 'undefined' && firebase.apps.length > 0) {
            try {
                const db = firebase.firestore();
                for (const code of codes) {
                    await db.collection('validationCodes').doc(code.id).set(code);
                }
            } catch (error) {
                console.warn('Firestore sync warning:', error);
            }
        }
        
        showNotification(`‚úÖ 3 validation codes generated for "${item.title}"`, 'success');
        
        // Display codes modal
        const modal = document.createElement('div');
        modal.className = 'modal';
        modal.style.display = 'block';
        modal.innerHTML = `
            <div class="modal-content">
                <span class="close" onclick="this.parentElement.parentElement.remove()">&times;</span>
                <h2>üîê Validation Codes Generated</h2>
                <p><strong>${item.title}</strong></p>
                <p style="color: #666; font-size: 14px;">Share these codes with validators in sequence</p>
                
                <div style="background: #f8f9fa; padding: 20px; border-radius: 10px; margin: 20px 0;">
                    ${codes.map((c, idx) => `
                        <div style="background: white; padding: 20px; border-radius: 10px; margin-bottom: 15px; border-left: 4px solid ${c.stage === 1 ? '#3498db' : c.stage === 2 ? '#f39c12' : '#2ecc71'};">
                            <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 10px;">
                                <h4 style="margin: 0;">Stage ${c.stage}: ${c.stage === 1 ? 'Human Validation' : c.stage === 2 ? 'Quality Check' : 'Chain Verification'} (5%)</h4>
                                <span style="background: ${c.stage === 1 ? '#3498db' : c.stage === 2 ? '#f39c12' : '#2ecc71'}; color: white; padding: 5px 10px; border-radius: 5px; font-size: 12px;">5% Fee</span>
                            </div>
                            <div style="background: #f8f9fa; padding: 15px; border-radius: 8px; margin: 10px 0;">
                                <div style="font-size: 20px; font-weight: bold; letter-spacing: 3px; text-align: center; margin-bottom: 10px;">${c.code}</div>
                                <button onclick="copyToClipboard('${c.code}')" class="btn btn-small" style="width: 100%;">üìã Copy Code ${c.stage}</button>
                            </div>
                            <p style="font-size: 12px; color: #666; margin: 10px 0 0 0;">
                                ${c.stage === 1 ? '‚ö†Ô∏è Give this code first - Value will wait at Stage 1 until validated' : 
                                  c.stage === 2 ? '‚ö†Ô∏è Give this code second - Value will wait at Stage 2 until validated' : 
                                  '‚ö†Ô∏è Give this code last - Value will be approved after this stage'}
                            </p>
                        </div>
                    `).join('')}
                </div>
                
                <div style="background: #fff3cd; padding: 15px; border-radius: 10px; margin-bottom: 20px;">
                    <strong>üìã Instructions:</strong>
                    <ol style="margin: 10px 0 0 20px; font-size: 14px;">
                        <li>Give Code 1 to first validator</li>
                        <li>Value waits until Code 1 is entered</li>
                        <li>After Code 1, give Code 2 to second validator</li>
                        <li>Value waits until Code 2 is entered</li>
                        <li>After Code 2, give Code 3 to third validator</li>
                        <li>After Code 3, value is approved and visible in public gallery</li>
                    </ol>
                </div>
                
                <button onclick="this.parentElement.parentElement.remove()" class="btn" style="width: 100%;">Close</button>
            </div>
        `;
        document.body.appendChild(modal);
        
        return codes;
    };
    
    // Copy to clipboard helper
    window.copyToClipboard = function(text) {
        if (navigator.clipboard) {
            navigator.clipboard.writeText(text).then(() => {
                showNotification('‚úÖ Copied to clipboard!', 'success');
            }).catch(() => {
                prompt('Copy this code:', text);
            });
        } else {
            prompt('Copy this code:', text);
        }
    };
    
    // ============================================
    // 5. INITIALIZE ON LOAD
    // ============================================
    
    // Refresh public opportunities every 5 seconds
    let currentFilter = 'all';
    
    window.filterOpportunities = function(filter) {
        currentFilter = filter;
        
        // Update button styles
        ['all', 'activities', 'tasks', 'values'].forEach(f => {
            const btn = document.getElementById('filter-' + f);
            if (btn) {
                btn.style.background = f === filter ? 
                    'linear-gradient(45deg, #4169e1, #87ceeb)' : 
                    'linear-gradient(45deg, #95a5a6, #7f8c8d)';
            }
        });
        
        refreshPublicOpportunities();
    };
    
    // Auto-refresh
    setInterval(() => {
        if (document.getElementById('publicOpportunitiesContainer')) {
            refreshPublicOpportunities();
        }
    }, 5000);
    
    // Initial load
    setTimeout(() => {
        refreshPublicOpportunities();
    }, 1000);
    
    console.log('‚úÖ TAU Complete Integration Fix loaded');
    console.log('üìä Features enabled:');
    console.log('  ‚úÖ Public gallery shows all approved items');
    console.log('  ‚úÖ Enhanced member dashboard with dropdown');
    console.log('  ‚úÖ 3-stage validation with instructions');
    console.log('  ‚úÖ Auto-refresh every 5 seconds');
    
})();

    </script>
    <script>
        // ============================================
// TAU AFRICA - JOBS GALLERY & ACTIVITIES SYSTEM
// Complete implementation with validation
// ============================================

(function() {
    'use strict';
    
    console.log('üíº Loading Jobs Gallery & Activities System...');
    
    // ============================================
    // 1. JOBS GALLERY MODAL - COMPLETE INTERFACE
    // ============================================
    
    window.openJobsGallery = function() {
        closeAllModals();
        
        const modal = document.createElement('div');
        modal.className = 'modal';
        modal.style.display = 'block';
        modal.innerHTML = `
            <div class="modal-content" style="max-width: 1200px;">
                <span class="close" onclick="this.parentElement.parentElement.remove()">&times;</span>
                
                <div style="background: linear-gradient(45deg, #667eea, #764ba2); color: white; padding: 25px; border-radius: 15px; margin-bottom: 20px;">
                    <h2 style="margin: 0;">üíº JOBS GALLERY</h2>
                    <p style="margin: 10px 0 0 0;">Post jobs, find jobs, and apply - All in one place</p>
                </div>
                
                <!-- TAB NAVIGATION -->
                <div style="display: flex; gap: 10px; margin-bottom: 20px; flex-wrap: wrap;">
                    <button class="btn btn-small" onclick="switchJobTab('post')" id="jobTabPost" style="background: #667eea;">Post Job Opening</button>
                    <button class="btn btn-small" onclick="switchJobTab('browse')" id="jobTabBrowse" style="background: #95a5a6;">Browse Jobs Portal</button>
                    <button class="btn btn-small" onclick="switchJobTab('search')" id="jobTabSearch" style="background: #95a5a6;">Search Jobs</button>
                    <button class="btn btn-small" onclick="switchJobTab('apply')" id="jobTabApply" style="background: #95a5a6;">Apply for Job</button>
                </div>
                
                <!-- TAB CONTENT -->
                <div id="jobTabContent"></div>
            </div>
        `;
        
        document.body.appendChild(modal);
        
        // Show default tab
        switchJobTab('post');
    };
    
    // Switch between job tabs
    window.switchJobTab = function(tab) {
        // Update button styles
        ['post', 'browse', 'search', 'apply'].forEach(t => {
            const btn = document.getElementById('jobTab' + t.charAt(0).toUpperCase() + t.slice(1));
            if (btn) {
                btn.style.background = t === tab ? '#667eea' : '#95a5a6';
            }
        });
        
        const content = document.getElementById('jobTabContent');
        if (!content) return;
        
        switch(tab) {
            case 'post':
                content.innerHTML = getJobPostForm();
                break;
            case 'browse':
                content.innerHTML = getJobsBrowsePortal();
                loadJobsPortal();
                break;
            case 'search':
                content.innerHTML = getJobSearchForm();
                break;
            case 'apply':
                content.innerHTML = getJobApplicationForm();
                break;
        }
    };
    
    // ============================================
    // 2. POST JOB OPENING (Public & Members)
    // ============================================
    
    function getJobPostForm() {
        return `
            <form onsubmit="submitJobOpening(event)">
                <div style="background: #e3f2fd; padding: 15px; border-radius: 10px; margin-bottom: 20px;">
                    <strong>üì¢ Anyone can post jobs!</strong>
                    <p style="margin: 10px 0 0 0; font-size: 14px;">
                        Jobs undergo 3-stage validation before appearing in Jobs Portal
                    </p>
                </div>
                
                <div class="form-group">
                    <label>Your Name *</label>
                    <input type="text" name="posterName" required placeholder="Your full name or company name">
                </div>
                
                <div class="form-group">
                    <label>Email *</label>
                    <input type="email" name="posterEmail" required placeholder="your@email.com">
                </div>
                
                <div class="form-group">
                    <label>Phone *</label>
                    <input type="tel" name="posterPhone" required placeholder="254XXXXXXXXX">
                </div>
                
                <div class="form-group">
                    <label>Company/Organization Name *</label>
                    <input type="text" name="companyName" required>
                </div>
                
                <div class="form-group">
                    <label>Job Title *</label>
                    <input type="text" name="jobTitle" required placeholder="e.g., Software Developer">
                </div>
                
                <div class="form-group">
                    <label>Job Category *</label>
                    <select name="jobCategory" required>
                        <option value="">Select category</option>
                        <option value="IT & Digital">IT & Digital Economy</option>
                        <option value="Marketing">Marketing & Advertising</option>
                        <option value="Admin">Front Desk & Data Handlers</option>
                        <option value="Management">Management</option>
                        <option value="Healthcare">Healthcare</option>
                        <option value="Sales">Sales & Customer Service</option>
                        <option value="Education">Education & Training</option>
                        <option value="Engineering">Engineering</option>
                        <option value="Finance">Finance & Accounting</option>
                        <option value="Agriculture">Agriculture & Food</option>
                        <option value="Manufacturing">Manufacturing</option>
                        <option value="Logistics">Transportation & Logistics</option>
                        <option value="Other">Other</option>
                    </select>
                </div>
                
                <div class="form-group">
                    <label>Job Type *</label>
                    <select name="jobType" required>
                        <option value="">Select type</option>
                        <option value="Full-time">Full-time</option>
                        <option value="Part-time">Part-time</option>
                        <option value="Contract">Contract</option>
                        <option value="Freelance">Freelance</option>
                        <option value="Internship">Internship</option>
                        <option value="Temporary">Temporary</option>
                    </select>
                </div>
                
                <div class="form-group">
                    <label>Location *</label>
                    <input type="text" name="jobLocation" required placeholder="City, Country or Remote">
                </div>
                
                <div class="form-group">
                    <label>Job Description *</label>
                    <textarea name="jobDescription" rows="6" required placeholder="Detailed job description, responsibilities, requirements..."></textarea>
                </div>
                
                <div class="form-group">
                    <label>Required Qualifications *</label>
                    <textarea name="qualifications" rows="4" required placeholder="Education, experience, skills required..."></textarea>
                </div>
                
                <div class="form-group">
                    <label>Experience Level *</label>
                    <select name="experienceLevel" required>
                        <option value="">Select level</option>
                        <option value="Entry Level">Entry Level (0-2 years)</option>
                        <option value="Mid Level">Mid Level (2-5 years)</option>
                        <option value="Senior Level">Senior Level (5-10 years)</option>
                        <option value="Executive">Executive Level (10+ years)</option>
                    </select>
                </div>
                
                <div class="form-group">
                    <label>Salary Range (Optional)</label>
                    <input type="text" name="salaryRange" placeholder="e.g., KSH 50,000 - 80,000">
                </div>
                
                <div class="form-group">
                    <label>Application Deadline</label>
                    <input type="date" name="deadline">
                </div>
                
                <div class="form-group">
                    <label>Worth in KSH (Job Value) *</label>
                    <input type="number" name="worthKsh" required min="0" step="0.01" placeholder="Enter job's market value">
                    <small>This determines validation fees (30% of worth)</small>
                </div>
                
                <button type="submit" class="btn" style="width: 100%; background: #667eea; font-size: 16px; padding: 15px;">
                    üì§ Submit Job for Validation
                </button>
            </form>
        `;
    }
    
    window.submitJobOpening = async function(event) {
        event.preventDefault();
        
        const formData = new FormData(event.target);
        const currentMember = window.TauDB?.getCurrentMember();
        
        const jobId = 'JOB-' + Date.now();
        const validationCode = generateJobValidationCode();
        
        const job = {
            id: jobId,
            validationCode: validationCode,
            type: 'job',
            
            // Poster info
            postedBy: currentMember?.id || 'PUBLIC-' + Date.now(),
            posterName: formData.get('posterName'),
            posterEmail: formData.get('posterEmail'),
            posterPhone: formData.get('posterPhone'),
            
            // Job details
            companyName: formData.get('companyName'),
            title: formData.get('jobTitle'),
            category: formData.get('jobCategory'),
            jobType: formData.get('jobType'),
            location: formData.get('jobLocation'),
            description: formData.get('jobDescription'),
            qualifications: formData.get('qualifications'),
            experienceLevel: formData.get('experienceLevel'),
            salaryRange: formData.get('salaryRange') || 'Not specified',
            deadline: formData.get('deadline'),
            
            // Validation
            worthKsh: parseFloat(formData.get('worthKsh')),
            worthIkb: (parseFloat(formData.get('worthKsh')) / 100000).toFixed(6),
            validated: false,
            status: 'Pending Review',
            validationStages: {},
            
            // Metadata
            postedAt: new Date().toISOString(),
            claimedBy: null,
            applications: []
        };
        
        // Save job
        const jobs = JSON.parse(localStorage.getItem('tauJobsPortal') || '[]');
        jobs.push(job);
        localStorage.setItem('tauJobsPortal', JSON.stringify(jobs));
        
        // Save to Firestore
        if (typeof firebase !== 'undefined' && firebase.apps.length > 0) {
            try {
                const db = firebase.firestore();
                await db.collection('jobs').doc(jobId).set(job);
            } catch (error) {
                console.warn('Firestore sync warning:', error);
            }
        }
        
        // Notify admin
        const adminNotifs = JSON.parse(localStorage.getItem('tauAdminNotifications') || '[]');
        adminNotifs.unshift({
            id: 'ADMIN-' + Date.now(),
            type: 'new_job_posting',
            data: {
                jobTitle: job.title,
                company: job.companyName,
                postedBy: job.posterName,
                validationCode: validationCode,
                jobId: jobId
            },
            timestamp: new Date().toISOString(),
            read: false
        });
        localStorage.setItem('tauAdminNotifications', JSON.stringify(adminNotifs));
        
        closeAllModals();
        
        // Show success modal
        const modal = document.createElement('div');
        modal.className = 'modal';
        modal.style.display = 'block';
        modal.innerHTML = `
            <div class="modal-content">
                <span class="close" onclick="this.parentElement.parentElement.remove()">&times;</span>
                
                <div style="text-align: center;">
                    <div style="font-size: 5rem; margin-bottom: 20px;">‚úÖ</div>
                    <h2 style="color: #2ecc71;">Job Posted Successfully!</h2>
                </div>
                
                <div style="background: linear-gradient(45deg, #ffd700, #ffed4e); padding: 25px; border-radius: 15px; margin: 25px 0; text-align: center;">
                    <h3 style="color: #333; margin: 0 0 15px 0;">Job Validation Code</h3>
                    <div style="background: white; padding: 15px; border-radius: 10px; font-size: 24px; font-weight: bold; letter-spacing: 3px; color: #333;">
                        ${validationCode}
                    </div>
                    <button onclick="copyToClipboard('${validationCode}')" class="btn" style="margin-top: 15px; background: white; color: #333;">
                        üìã Copy Code
                    </button>
                </div>
                
                <div style="background: #e3f2fd; padding: 20px; border-radius: 10px; margin: 20px 0;">
                    <h4 style="margin: 0 0 10px 0; color: #1976d2;">What Happens Next?</h4>
                    <ol style="margin: 0; padding-left: 20px; color: #666;">
                        <li>Admins will generate 3 validation codes (VAL1, VAL2, VAL3)</li>
                        <li>Job undergoes 3-stage validation process</li>
                        <li>After all 3 stages, job appears in Jobs Portal</li>
                        <li>Members can then claim the job</li>
                        <li>You'll receive notifications on progress</li>
                    </ol>
                </div>
                
                <div style="background: #f8f9fa; padding: 15px; border-radius: 10px;">
                    <strong>üìã Job Details:</strong>
                    <p style="margin: 10px 0 0 0;">
                        <strong>Title:</strong> ${job.title}<br>
                        <strong>Company:</strong> ${job.companyName}<br>
                        <strong>Location:</strong> ${job.location}<br>
                        <strong>Worth:</strong> ${job.worthIkb} iKb (${job.worthKsh} KSH)
                    </p>
                </div>
                
                <button onclick="this.parentElement.parentElement.remove()" class="btn" style="width: 100%; margin-top: 20px;">
                    Close
                </button>
            </div>
        `;
        
        document.body.appendChild(modal);
        
        showNotification('‚úÖ Job posted! Awaiting validation.', 'success');
    };
    
    function generateJobValidationCode() {
        const timestamp = Date.now().toString(36).toUpperCase();
        const random = Math.random().toString(36).substring(2, 8).toUpperCase();
        return `JOB-${timestamp}-${random}`;
    }
    
    // ============================================
    // 3. JOBS PORTAL - BROWSE VALIDATED JOBS
    // ============================================
    
    function getJobsBrowsePortal() {
        return `
            <div style="background: #fff3cd; padding: 15px; border-radius: 10px; margin-bottom: 20px;">
                <strong>üíº Jobs Portal</strong>
                <p style="margin: 10px 0 0 0; font-size: 14px;">
                    Validated jobs ready for claiming. Members can claim jobs through 3-stage validation process.
                </p>
            </div>
            
            <div id="jobsPortalContainer" style="min-height: 300px;">
                <div style="text-align: center; padding: 40px;">
                    <div class="spinner"></div>
                    <p>Loading jobs...</p>
                </div>
            </div>
        `;
    }
    
    window.loadJobsPortal = function() {
        const container = document.getElementById('jobsPortalContainer');
        if (!container) return;
        
        const jobs = JSON.parse(localStorage.getItem('tauJobsPortal') || '[]');
        
        // Show validated jobs only
        const validatedJobs = jobs.filter(j => j.validated && j.status === 'Approved' && !j.claimedBy);
        
        if (validatedJobs.length === 0) {
            container.innerHTML = `
                <div style="text-align: center; padding: 60px 20px; background: white; border-radius: 15px;">
                    <div style="font-size: 4rem; margin-bottom: 20px;">üíº</div>
                    <h3 style="color: #666; margin-bottom: 10px;">No jobs available yet</h3>
                    <p style="color: #999;">Check back soon or post your own job!</p>
                </div>
            `;
            return;
        }
        
        container.innerHTML = `
            <div style="display: grid; gap: 20px;">
                ${validatedJobs.map(job => createJobCard(job)).join('')}
            </div>
        `;
    };
    
    function createJobCard(job) {
        const currentMember = window.TauDB?.getCurrentMember();
        const canClaim = currentMember && (currentMember.team === 'TASK' || currentMember.team === 'TALK');
        
        // Calculate validation stages
        const stages = job.validationStages || {};
        const stage1 = stages.stage1?.validated;
        const stage2 = stages.stage2?.validated;
        const stage3 = stages.stage3?.validated;
        
        return `
            <div style="background: white; border-left: 4px solid #667eea; border-radius: 15px; padding: 25px; box-shadow: 0 5px 15px rgba(0,0,0,0.1);">
                <div style="display: flex; justify-content: between; align-items: start; margin-bottom: 15px;">
                    <div style="flex: 1;">
                        <h3 style="margin: 0 0 10px 0; color: #2a5298;">${job.title}</h3>
                        <div style="font-size: 14px; color: #666; margin-bottom: 10px;">
                            <strong>${job.companyName}</strong> ‚Ä¢ ${job.location}
                        </div>
                    </div>
                    <span style="background: #667eea; color: white; padding: 5px 12px; border-radius: 12px; font-size: 12px; font-weight: 600; white-space: nowrap;">
                        ${job.jobType}
                    </span>
                </div>
                
                <p style="color: #666; margin-bottom: 15px; line-height: 1.6;">${job.description.substring(0, 200)}${job.description.length > 200 ? '...' : ''}</p>
                
                <div style="background: #f8f9fa; padding: 15px; border-radius: 10px; margin-bottom: 15px;">
                    <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 10px; font-size: 14px;">
                        <div><strong>Category:</strong> ${job.category}</div>
                        <div><strong>Experience:</strong> ${job.experienceLevel}</div>
                        <div><strong>Salary:</strong> ${job.salaryRange}</div>
                        <div><strong>Deadline:</strong> ${job.deadline ? new Date(job.deadline).toLocaleDateString() : 'N/A'}</div>
                    </div>
                </div>
                
                <!-- Validation Progress -->
                <div style="display: flex; gap: 5px; margin: 15px 0;">
                    <div style="flex: 1; height: 8px; background: ${stage1 ? '#2ecc71' : '#ddd'}; border-radius: 4px;" title="Stage 1: Human Validation"></div>
                    <div style="flex: 1; height: 8px; background: ${stage2 ? '#2ecc71' : '#ddd'}; border-radius: 4px;" title="Stage 2: Quality Check"></div>
                    <div style="flex: 1; height: 8px; background: ${stage3 ? '#2ecc71' : '#ddd'}; border-radius: 4px;" title="Stage 3: Chain Verification"></div>
                </div>
                
                <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 15px;">
                    <div style="background: linear-gradient(45deg, #ffd700, #f39c12); padding: 8px 15px; border-radius: 20px; font-weight: bold; color: #333;">
                        ${job.worthIkb} iKb
                    </div>
                    <button onclick="viewJobDetails('${job.id}')" class="btn btn-small">
                        View Details
                    </button>
                </div>
                
                <button onclick="claimJob('${job.id}')" class="btn" style="width: 100%; padding: 12px; background: ${canClaim ? '#667eea' : '#95a5a6'};">
                    ${canClaim ? 'üíº Claim Job' : 'üîí Members Only'}
                </button>
            </div>
        `;
    }
    
    window.viewJobDetails = function(jobId) {
        const jobs = JSON.parse(localStorage.getItem('tauJobsPortal') || '[]');
        const job = jobs.find(j => j.id === jobId);
        
        if (!job) {
            showNotification('‚ùå Job not found', 'error');
            return;
        }
        
        const modal = document.createElement('div');
        modal.className = 'modal';
        modal.style.display = 'block';
        modal.innerHTML = `
            <div class="modal-content" style="max-width: 800px;">
                <span class="close" onclick="this.parentElement.parentElement.remove()">&times;</span>
                
                <h2>${job.title}</h2>
                
                <div style="background: #f8f9fa; padding: 20px; border-radius: 10px; margin: 20px 0;">
                    <h3 style="margin: 0 0 10px 0;">${job.companyName}</h3>
                    <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 15px; font-size: 14px;">
                        <div><strong>Location:</strong> ${job.location}</div>
                        <div><strong>Type:</strong> ${job.jobType}</div>
                        <div><strong>Category:</strong> ${job.category}</div>
                        <div><strong>Experience:</strong> ${job.experienceLevel}</div>
                        <div><strong>Salary:</strong> ${job.salaryRange}</div>
                        <div><strong>Deadline:</strong> ${job.deadline ? new Date(job.deadline).toLocaleDateString() : 'Not specified'}</div>
                    </div>
                </div>
                
                <div style="margin: 20px 0;">
                    <h4>Job Description:</h4>
                    <p style="line-height: 1.8; color: #666;">${job.description}</p>
                </div>
                
                <div style="margin: 20px 0;">
                    <h4>Required Qualifications:</h4>
                    <p style="line-height: 1.8; color: #666;">${job.qualifications}</p>
                </div>
                
                <div style="background: linear-gradient(45deg, #ffd700, #ffed4e); padding: 20px; border-radius: 10px; text-align: center; margin: 20px 0;">
                    <h4 style="color: #333; margin: 0 0 10px 0;">Job Worth</h4>
                    <div style="font-size: 2rem; font-weight: bold; color: #333;">${job.worthIkb} iKb</div>
                    <div style="font-size: 1rem; color: #666;">${job.worthKsh} KSH</div>
                </div>
                
                <button onclick="this.parentElement.parentElement.remove(); claimJob('${job.id}')" class="btn" style="width: 100%; padding: 15px; background: #667eea;">
                    üíº Claim This Job
                </button>
            </div>
        `;
        
        document.body.appendChild(modal);
    };
    
    window.claimJob = function(jobId) {
        const currentMember = window.TauDB?.getCurrentMember();
        
        if (!currentMember) {
            showNotification('Please login to claim jobs', 'info');
            setTimeout(() => showRealMemberLogin(), 500);
            return;
        }
        
        if (currentMember.type === 'public') {
            showNotification('Please upgrade to TASK or TALK membership to claim jobs', 'info');
            setTimeout(() => showUpgradeOptions(), 500);
            return;
        }
        
        const jobs = JSON.parse(localStorage.getItem('tauJobsPortal') || '[]');
        const job = jobs.find(j => j.id === jobId);
        
        if (!job) {
            showNotification('‚ùå Job not found', 'error');
            return;
        }
        
        // Check if job is fully validated
        const stages = job.validationStages || {};
        if (!stages.stage1?.validated || !stages.stage2?.validated || !stages.stage3?.validated) {
            showNotification('‚è≥ This job is still undergoing validation', 'info');
            return;
        }
        
        if (job.claimedBy) {
            showNotification('‚ùå This job has already been claimed', 'error');
            return;
        }
        
        closeAllModals();
        
        const modal = document.createElement('div');
        modal.className = 'modal';
        modal.style.display = 'block';
        modal.innerHTML = `
            <div class="modal-content">
                <span class="close" onclick="this.parentElement.parentElement.remove()">&times;</span>
                
                <h2>üíº Claim Job</h2>
                
                <div style="background: #f8f9fa; padding: 20px; border-radius: 10px; margin: 20px 0;">
                    <h3 style="margin: 0 0 10px 0;">${job.title}</h3>
                    <p style="margin: 0;"><strong>${job.companyName}</strong></p>
                </div>
                
                <form onsubmit="submitJobClaim(event, '${jobId}', '${currentMember.id}')">
                    <div class="form-group">
                        <label>Why are you a good fit for this role? *</label>
                        <textarea name="fitReason" rows="4" required placeholder="Explain your qualifications and experience..."></textarea>
                    </div>
                    
                    <div class="form-group">
                        <label>Your CV/Resume Summary *</label>
                        <textarea name="cvSummary" rows="4" required placeholder="Brief summary of your education and work experience..."></textarea>
                    </div>
                    
                    <div class="form-group">
                        <label>Available Start Date</label>
                        <input type="date" name="startDate">
                    </div>
                    
                    <button type="submit" class="btn" style="width: 100%; background: #667eea;">
                        Submit Job Claim
                    </button>
                </form>
            </div>
        `;
        
        document.body.appendChild(modal);
    };
    
    window.submitJobClaim = async function(event, jobId, memberId) {
        event.preventDefault();
        
        const formData = new FormData(event.target);
        
        const jobs = JSON.parse(localStorage.getItem('tauJobsPortal') || '[]');
        const jobIndex = jobs.findIndex(j => j.id === jobId);
        
        if (jobIndex === -1) {
            showNotification('‚ùå Job not found', 'error');
            return;
        }
        
        // Update job
        jobs[jobIndex].claimedBy = memberId;
        jobs[jobIndex].claimedAt = new Date().toISOString();
        jobs[jobIndex].claimDetails = {
            fitReason: formData.get('fitReason'),
            cvSummary: formData.get('cvSummary'),
            startDate: formData.get('startDate')
        };
        jobs[jobIndex].status = 'Claimed - In Progress';
        
        localStorage.setItem('tauJobsPortal', JSON.stringify(jobs));
        
        // Save to Firestore
        if (typeof firebase !== 'undefined' && firebase.apps.length > 0) {
            try {
                const db = firebase.firestore();
                await db.collection('jobs').doc(jobId).set(jobs[jobIndex], { merge: true });
            } catch (error) {
                console.warn('Firestore sync warning:', error);
            }
        }
        
        // Notify job poster
        if (typeof createNotification === 'function' && jobs[jobIndex].postedBy && jobs[jobIndex].postedBy.startsWith('TSK') || jobs[jobIndex].postedBy.startsWith('TLK')) {
            createNotification(
                jobs[jobIndex].postedBy,
                'üíº Your Job Was Claimed!',
                `"${jobs[jobIndex].title}" was claimed by a member`,
                'success'
            );
        }
        
        showNotification('‚úÖ Job claimed! Employer will be notified.', 'success');
        closeAllModals();
        
        // Refresh jobs portal
        setTimeout(() => {
            if (typeof loadJobsPortal === 'function') {
                loadJobsPortal();
            }
        }, 500);
    };
 
    // ============================================
    // 4. JOB SEARCH FORM
    // ============================================
    
    function getJobSearchForm() {
        return `
            <form onsubmit="searchJobs(event)">
                <div class="form-group">
                    <label>Job Title/Keywords</label>
                    <input type="text" name="keywords" placeholder="e.g., Developer, Manager, Designer">
                </div>
                
                <div class="form-group">
                    <label>Category</label>
                    <select name="category">
                        <option value="">All categories</option>
                        <option value="IT & Digital">IT & Digital</option>
                        <option value="Marketing">Marketing</option>
                        <option value="Admin">Admin</option>
                        <option value="Management">Management</option>
                        <option value="Healthcare">Healthcare</option>
                        <option value="Sales">Sales</option>
                        <option value="Education">Education</option>
                        <option value="Engineering">Engineering</option>
                        <option value="Finance">Finance</option>
                        <option value="Agriculture">Agriculture</option>
                        <option value="Manufacturing">Manufacturing</option>
                        <option value="Logistics">Logistics</option>
                    </select>
                </div>
                
                <div class="form-group">
                    <label>Location</label>
                    <input type="text" name="location" placeholder="City, Country or Remote">
                </div>
                
                <div class="form-group">
                    <label>Job Type</label>
                    <select name="jobType">
                        <option value="">All types</option>
                        <option value="Full-time">Full-time</option>
                        <option value="Part-time">Part-time</option>
                        <option value="Contract">Contract</option>
                        <option value="Freelance">Freelance</option>
                        <option value="Internship">Internship</option>
                    </select>
                </div>
                
                <div class="form-group">
                    <label>Experience Level</label>
                    <select name="experience">
                        <option value="">Any level</option>
                        <option value="Entry Level">Entry Level</option>
                        <option value="Mid Level">Mid Level</option>
                        <option value="Senior Level">Senior Level</option>
                        <option value="Executive">Executive</option>
                    </select>
                </div>
                
                <button type="submit" class="btn" style="width: 100%; background: #667eea;">
                    üîç Search Jobs
                </button>
            </form>
            
            <div id="searchResults" style="margin-top: 30px;"></div>
        `;
    }
    
    window.searchJobs = function(event) {
        event.preventDefault();
        
        const formData = new FormData(event.target);
        const searchCriteria = {
            keywords: formData.get('keywords')?.toLowerCase() || '',
            category: formData.get('category'),
            location: formData.get('location')?.toLowerCase() || '',
            jobType: formData.get('jobType'),
            experience: formData.get('experience')
        };
        
        const jobs = JSON.parse(localStorage.getItem('tauJobsPortal') || '[]');
        
        // Filter validated jobs
        let results = jobs.filter(j => j.validated && j.status === 'Approved');
        
        // Apply filters
        if (searchCriteria.keywords) {
            results = results.filter(j => 
                j.title.toLowerCase().includes(searchCriteria.keywords) ||
                j.description.toLowerCase().includes(searchCriteria.keywords) ||
                j.companyName.toLowerCase().includes(searchCriteria.keywords)
            );
        }
        
        if (searchCriteria.category) {
            results = results.filter(j => j.category === searchCriteria.category);
        }
        
        if (searchCriteria.location) {
            results = results.filter(j => 
                j.location.toLowerCase().includes(searchCriteria.location)
            );
        }
        
        if (searchCriteria.jobType) {
            results = results.filter(j => j.jobType === searchCriteria.jobType);
        }
        
        if (searchCriteria.experience) {
            results = results.filter(j => j.experienceLevel === searchCriteria.experience);
        }
        
        const resultsContainer = document.getElementById('searchResults');
        
        if (results.length === 0) {
            resultsContainer.innerHTML = `
                <div style="text-align: center; padding: 40px; background: white; border-radius: 15px;">
                    <div style="font-size: 3rem; margin-bottom: 15px;">üîç</div>
                    <h3 style="color: #666;">No jobs found</h3>
                    <p style="color: #999;">Try different search criteria</p>
                </div>
            `;
            return;
        }
        
        resultsContainer.innerHTML = `
            <h3>Search Results (${results.length})</h3>
            <div style="display: grid; gap: 20px; margin-top: 20px;">
                ${results.map(job => createJobCard(job)).join('')}
            </div>
        `;
    };
    // ============================================
    // 5. JOB APPLICATION FORM
    // ============================================
    
    function getJobApplicationForm() {
        return `
            <div style="background: #e3f2fd; padding: 15px; border-radius: 10px; margin-bottom: 20px;">
                <strong>üìù Apply for Jobs</strong>
                <p style="margin: 10px 0 0 0; font-size: 14px;">
                    Submit applications for jobs in the portal. Employers will review your application.
                </p>
            </div>
            
            <form onsubmit="submitJobApplication(event)">
                <div class="form-group">
                    <label>Select Job *</label>
                    <select name="jobId" required id="jobSelectDropdown">
                        <option value="">Select a job to apply for</option>
                    </select>
                </div>
                
                <div class="form-group">
                    <label>Your Full Name *</label>
                    <input type="text" name="applicantName" required>
                </div>
                
                <div class="form-group">
                    <label>Email *</label>
                    <input type="email" name="applicantEmail" required>
                </div>
                
                <div class="form-group">
                    <label>Phone *</label>
                    <input type="tel" name="applicantPhone" required>
                </div>
                
                <div class="form-group">
                    <label>Current Location *</label>
                    <input type="text" name="applicantLocation" required>
                </div>
                
                <div class="form-group">
                    <label>Cover Letter *</label>
                    <textarea name="coverLetter" rows="6" required placeholder="Tell us why you're a great fit for this role..."></textarea>
                </div>
                
                <div class="form-group">
                    <label>Education Background *</label>
                    <textarea name="education" rows="3" required placeholder="Your degrees, certifications, and training..."></textarea>
                </div>
                
                <div class="form-group">
                    <label>Work Experience *</label>
                    <textarea name="experience" rows="4" required placeholder="Your relevant work experience..."></textarea>
                </div>
                
                <div class="form-group">
                    <label>Key Skills *</label>
                    <textarea name="skills" rows="3" required placeholder="List your relevant skills..."></textarea>
                </div>
                
                <div class="form-group">
                    <label>References</label>
                    <textarea name="references" rows="2" placeholder="Professional references (optional)"></textarea>
                </div>
                
                <button type="submit" class="btn" style="width: 100%; background: #667eea; padding: 15px;">
                    üì§ Submit Application
                </button>
            </form>
        `;
    }
    
    // Populate job dropdown when application form loads
    setTimeout(() => {
        const dropdown = document.getElementById('jobSelectDropdown');
        if (dropdown) {
            const jobs = JSON.parse(localStorage.getItem('tauJobsPortal') || '[]');
            const availableJobs = jobs.filter(j => j.validated && j.status === 'Approved' && !j.claimedBy);
            
            availableJobs.forEach(job => {
                const option = document.createElement('option');
                option.value = job.id;
                option.textContent = `${job.title} - ${job.companyName}`;
                dropdown.appendChild(option);
            });
        }
    }, 500);
    
    window.submitJobApplication = async function(event) {
        event.preventDefault();
        
        const formData = new FormData(event.target);
        const jobId = formData.get('jobId');
        
        const application = {
            id: 'APP-' + Date.now(),
            jobId: jobId,
            applicantName: formData.get('applicantName'),
            applicantEmail: formData.get('applicantEmail'),
            applicantPhone: formData.get('applicantPhone'),
            applicantLocation: formData.get('applicantLocation'),
            coverLetter: formData.get('coverLetter'),
            education: formData.get('education'),
            experience: formData.get('experience'),
            skills: formData.get('skills'),
            references: formData.get('references') || 'Not provided',
            appliedAt: new Date().toISOString(),
            status: 'Submitted'
        };
        
        // Save application to job
        const jobs = JSON.parse(localStorage.getItem('tauJobsPortal') || '[]');
        const jobIndex = jobs.findIndex(j => j.id === jobId);
        
        if (jobIndex === -1) {
            showNotification('‚ùå Job not found', 'error');
            return;
        }
        
        if (!jobs[jobIndex].applications) {
            jobs[jobIndex].applications = [];
        }
        
        jobs[jobIndex].applications.push(application);
        localStorage.setItem('tauJobsPortal', JSON.stringify(jobs));
        
        // Save to Firestore
        if (typeof firebase !== 'undefined' && firebase.apps.length > 0) {
            try {
                const db = firebase.firestore();
                await db.collection('jobs').doc(jobId).set(jobs[jobIndex], { merge: true });
            } catch (error) {
                console.warn('Firestore sync warning:', error);
            }
        }
        
        showNotification('‚úÖ Application submitted successfully!', 'success');
        event.target.reset();
        
        // Show success modal
        const modal = document.createElement('div');
        modal.className = 'modal';
        modal.style.display = 'block';
        modal.innerHTML = `
            <div class="modal-content">
                <span class="close" onclick="this.parentElement.parentElement.remove()">&times;</span>
                
                <div style="text-align: center;">
                    <div style="font-size: 5rem; margin-bottom: 20px;">‚úÖ</div>
                    <h2 style="color: #2ecc71;">Application Submitted!</h2>
                </div>
                
                <div style="background: #f8f9fa; padding: 20px; border-radius: 10px; margin: 20px 0;">
                    <p style="margin: 0; text-align: center;">
                        Your application for <strong>${jobs[jobIndex].title}</strong> at <strong>${jobs[jobIndex].companyName}</strong> has been submitted.
                    </p>
                </div>
                
                <div style="background: #e3f2fd; padding: 15px; border-radius: 10px;">
                    <strong>What happens next?</strong>
                    <ul style="margin: 10px 0 0 20px; font-size: 14px;">
                        <li>The employer will review your application</li>
                        <li>You may be contacted for an interview</li>
                        <li>Keep checking your email and phone</li>
                    </ul>
                </div>
                
                <button onclick="this.parentElement.parentElement.remove()" class="btn" style="width: 100%; margin-top: 20px;">
                    Close
                </button>
            </div>
        `;
        
        document.body.appendChild(modal);
    };
    
    console.log('‚úÖ Jobs Gallery & Activities System loaded');
    
})();
</script>   
<script>
// ============================================
// FIX KABIRU TRANSFER BUTTON
// ============================================
window.initiateKabiruWithdrawal = async function() {
    const currentMember = window.TauDB?.getCurrentMember();
    
    if (!currentMember) {
        showNotification('‚ùå Please login first', 'error');
        showRealMemberLogin();
        return;
    }
    
    const availableIkbp = currentMember.iKbpBalance || 0;
    const availableIkb = currentMember.iKbBalance || 0;
    
    // Check minimum
    if (availableIkbp < 10000 && availableIkb < 0.0001) {
        showNotification('‚ùå Minimum: 10,000 iKbp or 0.0001 iKb', 'error');
        return;
    }
    
    const confirmMsg = `Transfer to Kabiru Mining?\n\n${availableIkbp.toLocaleString()} iKbp\n${availableIkb.toFixed(6)} iKb\n\nThis will zero your TAU balance.`;
    
    if (!confirm(confirmMsg)) return;
    
    try {
        const transferId = 'XFER-' + Date.now();
        
        // Save transfer to Firestore
        if (typeof firebase !== 'undefined' && firebase.apps.length > 0) {
            const db = firebase.firestore();
            await db.collection('kabiru_transfers').add({
                transferId: transferId,
                memberId: currentMember.id,
                memberName: currentMember.fullName,
                memberEmail: currentMember.email,
                iKbp: availableIkbp,
                iKb: availableIkb,
                timestamp: firebase.firestore.FieldValue.serverTimestamp(),
                status: 'pending'
            });
        }
        
        // Zero out TAU balances
        const members = JSON.parse(localStorage.getItem('tauAfricaDB') || '[]');
        const memberIndex = members.findIndex(m => m.id === currentMember.id);
        if (memberIndex !== -1) {
            members[memberIndex].iKbpBalance = 0;
            members[memberIndex].iKbBalance = 0;
            localStorage.setItem('tauAfricaDB', JSON.stringify(members));
            sessionStorage.setItem('tauCurrentUser', JSON.stringify(members[memberIndex]));
        }
        
        showNotification('‚úÖ Transfer initiated! Open Kabiru Mining to receive.', 'success');
        
        alert(`Transfer ID: ${transferId}\n\nOpen Kabiru Mining App and login to receive your tokens.`);
        
        // Refresh dashboard
        setTimeout(() => {
            closeAllModals();
            showRealMemberDashboard(members[memberIndex]);
        }, 2000);
        
    } catch (error) {
        console.error('Transfer error:', error);
        showNotification('‚ùå Transfer failed: ' + error.message, 'error');
    }
};

console.log('‚úÖ Kabiru transfer button fixed');
    </script>
    <script>
// ============================================
// FIX ADMIN BRIDGE BUTTON
// ============================================
window.openAdminBridge = function() {
    const currentMember = window.TauDB?.getCurrentMember();
    
    // Check admin access
    const ADMIN_IDS = ['TSK-000000-001', 'TLK-000000-001'];
    const ADMIN_EMAILS = ['admin@tauafrica.org', 'grouptauafrica@gmail.com'];
    
    const hasAccess = currentMember && (
        ADMIN_IDS.includes(currentMember.id) ||
        ADMIN_EMAILS.includes(currentMember.email) ||
        currentMember.role === 'admin'
    );
    
    if (!hasAccess) {
        const code = prompt('Enter Admin Access Code:');
        if (code !== 'TAU2025ADMIN') {
            showNotification('‚ùå Invalid access code', 'error');
            return;
        }
    }
    
    // Open database page
    const bridgeWindow = window.open('databse.html', 'tauBridge', 'width=1400,height=900');
    
    if (!bridgeWindow) {
        showNotification('‚ö†Ô∏è Please allow popups', 'error');
        window.location.href = 'databse.html';
    } else {
        showNotification('‚úÖ Opening Admin Bridge...', 'success');
    }
};

console.log('‚úÖ Admin bridge button fixed');
    </script>
    <script>
// ============================================
// LOGIN STATUS INDICATOR & IMPROVED DASHBOARD
// Add this before closing </body> tag
// ============================================

(function() {
    'use strict';
    
    console.log('üîß Loading UI improvements...');
    
    // ============================================
    // 1. LOGIN STATUS INDICATOR
    // ============================================
    
    function createLoginStatusIndicator() {
        // Check if already exists
        if (document.getElementById('loginStatusIndicator')) return;
        
        const indicator = document.createElement('div');
        indicator.id = 'loginStatusIndicator';
        indicator.style.cssText = `
            position: fixed;
            top: 20px;
            left: 20px;
            z-index: 9998;
            background: rgba(255, 255, 255, 0.95);
            padding: 10px 15px;
            border-radius: 25px;
            box-shadow: 0 4px 12px rgba(0,0,0,0.15);
            font-size: 13px;
            cursor: pointer;
            transition: all 0.3s ease;
            backdrop-filter: blur(10px);
            border: 2px solid rgba(65, 105, 225, 0.3);
        `;
        
        document.body.appendChild(indicator);
        updateLoginStatus();
        
        // Update status every 3 seconds
        setInterval(updateLoginStatus, 3000);
    }
    
    function updateLoginStatus() {
        const indicator = document.getElementById('loginStatusIndicator');
        if (!indicator) return;
        
        const currentMember = window.TauDB?.getCurrentMember();
        
        if (currentMember) {
            // User is logged in
            indicator.innerHTML = `
                <div style="display: flex; align-items: center; gap: 10px;">
                    <div style="width: 8px; height: 8px; background: #2ecc71; border-radius: 50%; animation: pulse 2s infinite;"></div>
                    <div>
                        <div style="font-weight: bold; color: #2a5298;">${currentMember.fullName}</div>
                        <div style="font-size: 11px; color: #666;">${currentMember.email}</div>
                    </div>
                </div>
            `;
            
            indicator.onclick = () => {
                showQuickMenu(currentMember);
            };
            
            indicator.style.borderColor = 'rgba(46, 204, 113, 0.5)';
            
        } else {
            // User is not logged in - pulsing reminder
            indicator.innerHTML = `
                <div style="display: flex; align-items: center; gap: 10px;">
                    <div style="width: 8px; height: 8px; background: #e74c3c; border-radius: 50%; animation: pulse 2s infinite;"></div>
                    <div style="font-weight: bold; color: #e74c3c;">Not Logged In</div>
                </div>
            `;
            
            indicator.onclick = () => {
                showLoginRegisterMenu();
            };
            
            indicator.style.borderColor = 'rgba(231, 76, 60, 0.5)';
            indicator.style.animation = 'pulseIndicator 3s infinite';
        }
    }
    
    // Quick menu for logged-in users
    function showQuickMenu(member) {
        const menu = document.createElement('div');
        menu.style.cssText = `
            position: fixed;
            top: 80px;
            left: 20px;
            background: white;
            border-radius: 15px;
            box-shadow: 0 10px 30px rgba(0,0,0,0.2);
            padding: 15px;
            z-index: 9999;
            min-width: 250px;
        `;
        
        menu.innerHTML = `
            <div style="padding-bottom: 10px; border-bottom: 1px solid #eee; margin-bottom: 10px;">
                <strong>${member.fullName}</strong>
                <div style="font-size: 12px; color: #666;">${member.team} Member</div>
            </div>
            
            <div style="display: grid; gap: 8px;">
                <button onclick="closeQuickMenu(); showRealMemberDashboard();" class="btn btn-small" style="width: 100%; text-align: left;">
                    üìä Dashboard
                </button>
                <button onclick="closeQuickMenu(); showActivitiesMining('${member.id}');" class="btn btn-small" style="width: 100%; text-align: left;">
                    üìö Activities
                </button>
                <button onclick="closeQuickMenu(); showTasksMining('${member.id}');" class="btn btn-small" style="width: 100%; text-align: left;">
                    ‚úÖ Tasks
                </button>
                <button onclick="closeQuickMenu(); showValuesMining('${member.id}');" class="btn btn-small" style="width: 100%; text-align: left;">
                    üíé Values
                </button>
                <button onclick="closeQuickMenu(); sessionStorage.removeItem('tauCurrentUser'); location.reload();" class="btn btn-small" style="width: 100%; text-align: left; background: #e74c3c;">
                    üö™ Logout
                </button>
            </div>
        `;
        
        menu.onclick = (e) => e.stopPropagation();
        
        document.body.appendChild(menu);
        
        // Close when clicking outside
        setTimeout(() => {
            document.addEventListener('click', function closeHandler() {
                closeQuickMenu();
                document.removeEventListener('click', closeHandler);
            });
        }, 100);
    }
    
    window.closeQuickMenu = function() {
        const menus = document.querySelectorAll('div[style*="position: fixed"][style*="top: 80px"]');
        menus.forEach(m => m.remove());
    };
    
    // Login/Register menu for non-logged users
    function showLoginRegisterMenu() {
        const menu = document.createElement('div');
        menu.style.cssText = `
            position: fixed;
            top: 80px;
            left: 20px;
            background: white;
            border-radius: 15px;
            box-shadow: 0 10px 30px rgba(0,0,0,0.2);
            padding: 15px;
            z-index: 9999;
            min-width: 250px;
        `;
        
        menu.innerHTML = `
            <div style="padding-bottom: 10px; border-bottom: 1px solid #eee; margin-bottom: 10px;">
                <strong style="color: #e74c3c;">‚ö†Ô∏è Not Logged In</strong>
                <div style="font-size: 12px; color: #666;">Login or register to access full features</div>
            </div>
            
            <div style="display: grid; gap: 8px;">
                <button onclick="closeQuickMenu(); showRealMemberLogin();" class="btn btn-small" style="width: 100%; background: #4169e1;">
                    üîê Member Login
                </button>
                <button onclick="closeQuickMenu(); showPublicRegistration();" class="btn btn-small" style="width: 100%; background: #27ae60;">
                    üåç Free Registration
                </button>
                <button onclick="closeQuickMenu(); openModal('taskRegistration');" class="btn btn-small" style="width: 100%; background: #ff6b6b;">
                    üìö Join TASK (KSH 500)
                </button>
                <button onclick="closeQuickMenu(); openModal('talkRegistration');" class="btn btn-small" style="width: 100%; background: #667eea;">
                    üíº Join TALK (KSH 2,000)
                </button>
            </div>
        `;
        
        menu.onclick = (e) => e.stopPropagation();
        
        document.body.appendChild(menu);
        
        setTimeout(() => {
            document.addEventListener('click', function closeHandler() {
                closeQuickMenu();
                document.removeEventListener('click', closeHandler);
            });
        }, 100);
    }
    
    // ============================================
    // 2. IMPROVED MEMBER DASHBOARD (NO DUPLICATION)
    // ============================================
    
    window.showRealMemberDashboard = window.showEnhancedMemberDashboard = function(member) {
        if (!member) {
            member = window.TauDB?.getCurrentMember();
            if (!member) {
                showNotification('Please login first', 'error');
                showRealMemberLogin();
                return;
            }
        }
        
        // Refresh member data
        const members = JSON.parse(localStorage.getItem('tauAfricaDB') || '[]');
        const freshMember = members.find(m => m.id === member.id) || member;
        
        const myTasks = freshMember.tasks || [];
        const myActivities = freshMember.activities || [];
        
        const completedTasks = myTasks.filter(t => t.status === 'Completed' || t.status === 'Approved').length;
        const completedActivities = myActivities.filter(a => a.status === 'Completed' || a.status === 'Approved').length;
        const pendingTasks = myTasks.filter(t => t.status === 'Pending Approval').length;
        const pendingActivities = myActivities.filter(a => a.status === 'Pending Approval').length;
        
        closeAllModals();
        
        const modal = document.createElement('div');
        modal.className = 'modal';
        modal.style.display = 'block';
        modal.innerHTML = `
            <div class="modal-content" style="max-width: 1200px; max-height: 90vh; overflow-y: auto;">
                <span class="close" onclick="sessionStorage.removeItem('tauCurrentUser'); this.parentElement.parentElement.remove(); location.reload();">&times;</span>
                
                <!-- HEADER -->
                <div style="background: linear-gradient(45deg, #4169e1, #87ceeb); color: white; padding: 25px; border-radius: 15px; margin-bottom: 20px;">
                    <div style="display: flex; justify-content: space-between; align-items: center; flex-wrap: wrap; gap: 15px;">
                        <div>
                            <h1 style="margin: 0;">Welcome, ${freshMember.fullName}! üëã</h1>
                            <p style="margin: 10px 0 0 0; opacity: 0.9;">
                                ${freshMember.team} Member ‚Ä¢ ID: ${freshMember.id}
                            </p>
                        </div>
                        <div style="display: flex; gap: 10px; flex-wrap: wrap;">
                            <button onclick="showAccountDetails('${freshMember.id}')" class="btn btn-small" style="background: rgba(255,255,255,0.2);">
                                üìã Details
                            </button>
                            <button onclick="sessionStorage.removeItem('tauCurrentUser'); location.reload();" class="btn btn-small" style="background: rgba(255,255,255,0.2);">
                                üö™ Logout
                            </button>
                        </div>
                    </div>
                </div>
                
                <!-- BALANCE CARDS -->
                <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(200px, 1fr)); gap: 15px; margin-bottom: 30px;">
                    <div style="background: linear-gradient(45deg, #ffd700, #ffed4e); padding: 20px; border-radius: 15px; text-align: center; color: #333;">
                        <h4 style="margin: 0 0 10px 0;">üí∞ iKbp</h4>
                        <h2 style="font-size: 2rem; margin: 0;">${(freshMember.iKbpBalance || 0).toLocaleString()}</h2>
                        <p style="margin: 10px 0 0 0; font-size: 14px;">${((freshMember.iKbpBalance || 0) / 10).toFixed(2)} KSH</p>
                    </div>
                    
                    <div style="background: linear-gradient(45deg, #667eea, #764ba2); padding: 20px; border-radius: 15px; text-align: center; color: white;">
                        <h4 style="margin: 0 0 10px 0;">üíé iKb</h4>
                        <h2 style="font-size: 2rem; margin: 0;">${(freshMember.iKbBalance || 0).toFixed(4)}</h2>
                        <p style="margin: 10px 0 0 0; font-size: 14px;">${((freshMember.iKbBalance || 0) * 100000).toLocaleString()} KSH</p>
                    </div>
                    
                    <div style="background: linear-gradient(45deg, #ff6b6b, #ee5a24); padding: 20px; border-radius: 15px; text-align: center; color: white;">
                        <h4 style="margin: 0 0 10px 0;">üéÅ Referral</h4>
                        <h2 style="font-size: 1.5rem; margin: 0; letter-spacing: 2px;">${freshMember.referralCode}</h2>
                        <button onclick="copyReferralLink('${freshMember.referralCode}')" class="btn btn-small" style="margin-top: 10px; background: rgba(255,255,255,0.2); width: 100%;">
                            üìã Copy
                        </button>
                    </div>
                </div>
                
                <!-- STATS -->
                <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(120px, 1fr)); gap: 10px; margin-bottom: 30px;">
                    <div style="background: #e3f2fd; padding: 15px; border-radius: 10px; text-align: center;">
                        <div style="font-size: 1.8rem; font-weight: bold; color: #2196f3;">${completedActivities}</div>
                        <div style="font-size: 0.85rem; color: #666;">Activities Done</div>
                    </div>
                    <div style="background: #f3e5f5; padding: 15px; border-radius: 10px; text-align: center;">
                        <div style="font-size: 1.8rem; font-weight: bold; color: #9c27b0;">${completedTasks}</div>
                        <div style="font-size: 0.85rem; color: #666;">Tasks Done</div>
                    </div>
                    <div style="background: #fff3e0; padding: 15px; border-radius: 10px; text-align: center;">
                        <div style="font-size: 1.8rem; font-weight: bold; color: #ff9800;">${pendingActivities}</div>
                        <div style="font-size: 0.85rem; color: #666;">Pending Activities</div>
                    </div>
                    <div style="background: #e8f5e9; padding: 15px; border-radius: 10px; text-align: center;">
                        <div style="font-size: 1.8rem; font-weight: bold; color: #4caf50;">${pendingTasks}</div>
                        <div style="font-size: 0.85rem; color: #666;">Pending Tasks</div>
                    </div>
                </div>
                
                <!-- MINING SECTIONS (Horizontal scroll on mobile) -->
                <h3 style="margin-bottom: 15px;">‚õèÔ∏è Mining Sections</h3>
                <div style="overflow-x: auto; -webkit-overflow-scrolling: touch; margin-bottom: 30px;">
                    <div style="display: flex; gap: 20px; padding-bottom: 10px; min-width: min-content;">
                        <div style="min-width: 280px; background: white; border: 3px solid #ff6b6b; border-radius: 15px; padding: 20px; flex-shrink: 0;">
                            <h4 style="color: #ff6b6b; margin: 0 0 10px 0;">üìö ACTIVITIES</h4>
                            <div style="font-size: 0.9rem; color: #666; margin-bottom: 15px;">
                                Completed: ${completedActivities} | Pending: ${pendingActivities}
                            </div>
                            <button onclick="showActivitiesMining('${freshMember.id}')" class="btn" style="width: 100%; background: #ff6b6b;">
                                ‚õèÔ∏è Mine Now
                            </button>
                        </div>
                        
                        <div style="min-width: 280px; background: white; border: 3px solid #667eea; border-radius: 15px; padding: 20px; flex-shrink: 0;">
                            <h4 style="color: #667eea; margin: 0 0 10px 0;">‚úÖ TASKS</h4>
                            <div style="font-size: 0.9rem; color: #666; margin-bottom: 15px;">
                                Completed: ${completedTasks} | Pending: ${pendingTasks}
                            </div>
                            <button onclick="showTasksMining('${freshMember.id}')" class="btn" style="width: 100%; background: #667eea;">
                                ‚õèÔ∏è Mine Now
                            </button>
                        </div>
                        
                        <div style="min-width: 280px; background: white; border: 3px solid #ffd700; border-radius: 15px; padding: 20px; flex-shrink: 0;">
                            <h4 style="color: #f39c12; margin: 0 0 10px 0;">üíé VALUES</h4>
                            <div style="font-size: 0.9rem; color: #666; margin-bottom: 15px;">
                                Submit & Claim Values
                            </div>
                            <button onclick="showValuesMining('${freshMember.id}')" class="btn" style="width: 100%; background: linear-gradient(45deg, #ffd700, #f39c12);">
                                ‚õèÔ∏è Mine Now
                            </button>
                        </div>
                    </div>
                </div>
                
                <!-- KABIRU TRANSFER (SINGLE, NO DUPLICATION) -->
                <div style="background: linear-gradient(45deg, #FFD700, #FFA500); padding: 20px; border-radius: 15px; text-align: center;">
                    <h4 style="color: #333; margin: 0 0 15px 0;">üí∏ Transfer to Kabiru Mining</h4>
                    <button onclick="initiateKabiruWithdrawal()" class="btn" style="width: 100%; max-width: 400px; background: #333; color: #FFD700;">
                        Transfer Tokens
                    </button>
                    <p style="color: #333; font-size: 12px; margin: 10px 0 0 0;">Minimum: 10,000 iKbp or 0.0001 iKb</p>
                </div>
            </div>
        `;
        
        document.body.appendChild(modal);
    };
    
    // ============================================
    // 3. ADD PULSING ANIMATION
    // ============================================
    
    const style = document.createElement('style');
    style.textContent = `
        @keyframes pulse {
            0%, 100% {
                opacity: 1;
                transform: scale(1);
            }
            50% {
                opacity: 0.5;
                transform: scale(1.1);
            }
        }
        
        @keyframes pulseIndicator {
            0%, 100% {
                box-shadow: 0 4px 12px rgba(231, 76, 60, 0.3);
            }
            50% {
                box-shadow: 0 4px 20px rgba(231, 76, 60, 0.6);
            }
        }
    `;
    document.head.appendChild(style);
    
    // ============================================
    // 4. INITIALIZE
    // ============================================
    
    // Create indicator when page loads
    if (document.readyState === 'loading') {
        document.addEventListener('DOMContentLoaded', createLoginStatusIndicator);
    } else {
        createLoginStatusIndicator();
    }
    
    console.log('‚úÖ UI improvements loaded');
    console.log('  ‚úÖ Login status indicator active');
    console.log('  ‚úÖ Member dashboard cleaned up');
    console.log('  ‚úÖ No more duplicate buttons');
    
})();
</script>
</body>
</html>
